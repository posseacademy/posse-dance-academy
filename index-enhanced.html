<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>posse dance academy é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
        }
        .tab-active { border-bottom: 3px solid #3B82F6; color: #3B82F6; }
        .status-tab-active { background-color: #3B82F6; color: white; }
        .status-badge-active { background-color: #10B981; color: white; }
        .status-badge-paused { background-color: #F59E0B; color: white; }
        .status-badge-withdrawn { background-color: #6B7280; color: white; }
        .gender-male { color: #2563EB; font-weight: 600; }
        .gender-female { color: #DC2626; font-weight: 600; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #F3F4F6; }
        .sort-icon { display: inline-block; margin-left: 4px; font-size: 10px; }
        
        table { table-layout: fixed; }
        td, th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        td.memo-cell { 
            white-space: normal !important;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.5;
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            vertical-align: top;
        }
        
        td.email-cell {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ã‚¯ãƒ©ã‚¹åˆ¥ã®è‰²åˆ†ã‘ */
        .class-red { background-color: #DC2626; }
        .class-orange { background-color: #EA580C; }
        .class-blue { background-color: #2563EB; }
        .class-green { background-color: #16A34A; }
        .class-purple { background-color: #9333EA; }
        
        .border-red-500 { border-color: #EF4444; }
        .border-orange-500 { border-color: #F97316; }
        .border-blue-500 { border-color: #3B82F6; }
        .border-green-500 { border-color: #22C55E; }
        .border-purple-500 { border-color: #A855F7; }
        
        .text-red-600 { color: #DC2626; }
        .text-orange-600 { color: #EA580C; }
        .text-blue-600 { color: #2563EB; }
        .text-green-600 { color: #16A34A; }
        .text-purple-600 { color: #9333EA; }
        
        .bg-red-600 { background-color: #DC2626; }
        .bg-orange-600 { background-color: #EA580C; }
        .bg-blue-600 { background-color: #2563EB; }
        .bg-green-600 { background-color: #16A34A; }
        .bg-purple-600 { background-color: #9333EA; }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .student-search-results {
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
        }
        
        .select-customer-btn:hover {
            background-color: #EFF6FF;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const firebaseConfig = {
            apiKey: "AIzaSyBp3_3UwgOKkILJuWx8usYdQhGfB_bAD34",
            authDomain: "posse-dance-academy.firebaseapp.com",
            projectId: "posse-dance-academy",
            storageBucket: "posse-dance-academy.firebasestorage.app",
            messagingSenderId: "613497046871",
            appId: "1:613497046871:web:8a31cbc6b947617113e012"
        };
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        class DanceStudioApp {
            constructor() {
                this.currentTab = 'dashboard';
                this.statusFilter = 'å…¥ä¼šä¸­';
                this.customers = [];
                this.editingId = null;
                this.editForm = {};
                this.showAddForm = false;
                this.searchTerm = '';
                this.sortField = 'memberNumber';
                this.sortOrder = 'asc';
                this.newCustomer = this.getEmptyCustomer();
                
                // å‡ºå¸­ç°¿ç”¨
                this.attendanceTab = 'overview';
                this.selectedMonth = new Date().toISOString().slice(0, 7);
                this.selectedDay = 'æœˆæ›œæ—¥';
                this.attendanceData = {};
                this.eventAttendanceData = []; // ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ãƒ‡ãƒ¼ã‚¿
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.isLoading = false;
                this.editingStudent = null; // ç·¨é›†ä¸­ã®ç”Ÿå¾’æƒ…å ±
                this.studentSearchTerm = ''; // ç”Ÿå¾’æ¤œç´¢ç”¨
                this.studentSearchResults = []; // æ¤œç´¢çµæœ
                this.selectedCustomerForStudent = null; // é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±
                
                // ãƒ“ã‚¸ã‚¿ãƒ¼è¿½åŠ ç”¨
                this.showVisitorModal = false;
                this.visitorData = {};
                
                this.pricing = {
                    '4ã‚¯ãƒ©ã‚¹': 18600,
                    'ï¼”ã‚¯ãƒ©ã‚¹': 18600,
                    '3ã‚¯ãƒ©ã‚¹': 14400,
                    'ï¼“ã‚¯ãƒ©ã‚¹': 14400,
                    '2ã‚¯ãƒ©ã‚¹': 10000,
                    'ï¼’ã‚¯ãƒ©ã‚¹': 10000,
                    '1ã‚¯ãƒ©ã‚¹': 6000,
                    'ï¼‘ã‚¯ãƒ©ã‚¹': 6000,
                    '1.5hã‚¯ãƒ©ã‚¹': 6600,
                    'åˆå›ä½“é¨“': 1000,
                    'åˆå›ç„¡æ–™': 0,
                    'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰': 2000,
                    'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰': 2300,
                    'ãƒ“ã‚¸ã‚¿ãƒ¼1.5hï¼ˆä¼šå“¡ï¼‰': 2200,
                    'ãƒ“ã‚¸ã‚¿ãƒ¼1.5hï¼ˆéä¼šå“¡ï¼‰': 2500,
                    'æœˆè¬ã‚¯ãƒ©ã‚¹æŒ¯æ›¿': 1000
                };
                this.planOrder = {
                    '4ã‚¯ãƒ©ã‚¹': 1,
                    'ï¼”ã‚¯ãƒ©ã‚¹': 1,
                    '3ã‚¯ãƒ©ã‚¹': 2,
                    'ï¼“ã‚¯ãƒ©ã‚¹': 2,
                    '2ã‚¯ãƒ©ã‚¹': 3,
                    'ï¼’ã‚¯ãƒ©ã‚¹': 3,
                    '1ã‚¯ãƒ©ã‚¹': 4,
                    'ï¼‘ã‚¯ãƒ©ã‚¹': 4,
                    '1.5hã‚¯ãƒ©ã‚¹': 5,
                    'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰': 6,
                    'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰': 7,
                    'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆæŒ¯æ›¿ï¼‰': 8,
                    'åˆå›ä½“é¨“': 9,
                    'åˆå›ç„¡æ–™': 10
                };
                this.scheduleData = {
                    'æœˆæ›œæ—¥': [
                        { location: 'å¤©ç¥', name: 'ã‚¢ã‚¯ãƒ­ãƒãƒƒãƒˆ SOYA', color: 'red', students: [
                            { lastName: 'ä¸­å³¶', firstName: 'ç«œå¾', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¼Šè—¤', firstName: 'å’Œé¦¬', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å››äº•', firstName: 'é™½éŸ³', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ´¥ç•™', firstName: 'å‰µçœŸ', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¸‰é‡é‡', firstName: 'ç‰ç”Ÿ', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ã²ã‚ãŸã—', firstName: 'ã“ã†ãŸ', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å¶‹å·', firstName: 'é™½å¤§', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: '', firstName: 'å¤§ç©º', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'ãƒ–ãƒ¬ã‚¤ã‚­ãƒ³å…¥é–€ SOYA', color: 'orange', students: [
                            { lastName: 'æ´¥ç•™', firstName: 'å‰µçœŸ', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¦Š', firstName: 'èŠ±æ¢¨', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ã²ã‚ãŸã—', firstName: 'ã“ã†ãŸ', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'ãƒˆãƒƒãƒ—ãƒ­ãƒƒã‚¯ ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ DAZ', color: 'blue', students: [
                            { lastName: 'ä¸­å³¶', firstName: 'ç«œå¾', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å››äº•', firstName: 'é™½éŸ³', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¼Šè—¤', firstName: 'å’Œé¦¬', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¸‰é‡é‡', firstName: 'ç‰ç”Ÿ', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æˆ¸ç”°', firstName: 'å”¯æ–—', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ£®è„‡', firstName: 'é³³ä»', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å¶‹å·', firstName: 'é™½å¤§', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: '', firstName: 'å¤§ç©º', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'K-POP AI', color: 'green', students: [
                            { lastName: 'å¹³å¶‹', firstName: 'å½©ä½³', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ‰æ‘', firstName: 'æ—©ç´€', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'çŸ³åŸ', firstName: 'ç¾é»', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ç”°ä»£', firstName: 'æå¥ˆ', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å”¯é‡', firstName: 'èŒç¶­', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'hiphop HIMEKA', color: 'purple', students: [
                            { lastName: 'çŸ³åŸ', firstName: 'ç¾é»', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¸­å·', firstName: 'å‡›éŸ³', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤§æ©‹', name: 'hiphop HIMEKA', color: 'purple', students: [
                            { lastName: 'æ¸…æ°´', firstName: 'ãã‚‹ã¿', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]}
                    ],
                    'ç«æ›œæ—¥': [
                        { location: 'å¤§æ©‹', name: 'ã‚­ãƒƒã‚ºãƒ€ãƒ³ã‚¹ AYANO', color: 'red', students: [
                            { lastName: 'å¤è³€', firstName: 'æ–‡äºº', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å¤è³€', firstName: 'å¯æœˆå¦ƒ', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'åŸå£', firstName: 'çœå¾', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ã‚ãŸãªã¹', firstName: 'ã„ã¨ã—', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å¯Œäº•', firstName: 'è—', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤§æ©‹', name: 'Bgirlã‚¯ãƒ©ã‚¹ AYANO HARUHIKO', color: 'orange', students: [
                            { lastName: 'æ„›ç”²', firstName: 'å¤§è¼ª', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'ç…§è‘‰', name: 'ãƒ–ãƒ¬ã‚¤ã‚­ãƒ³å…¥é–€ SOYA', color: 'blue', students: [
                            { lastName: 'è¥¿åœ’', firstName: 'åƒæ™ƒ', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¦Š', firstName: 'èŠ±æ¢¨', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'ç…§è‘‰', name: 'ã‚¢ã‚¯ãƒ­ï¼†ãƒ‘ãƒ¯ãƒ¼ SOYA', color: 'green', students: [
                            { lastName: 'å ¤', firstName: 'å‹‡ä»', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å‰æ­¦', firstName: 'å‡›ä¿', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' }
                        ]}
                    ],
                    'æ°´æ›œæ—¥': [
                        { location: 'å¤©ç¥', name: 'ãƒ–ãƒ¬ã‚¤ã‚­ãƒ³åˆç´š HARUHIKO', color: 'red', students: [
                            { lastName: 'ç”°å³¶', firstName: 'æ¸š', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å‰ç”°', firstName: 'æ™ºå¹¸', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æœ¬æ©‹', firstName: 'å»‰å£«', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'é…’äº•', firstName: 'å¤©å„ª', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ–°è—¤', firstName: 'å¤§å¸Œ', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è’å·»', firstName: 'å¤§å’Œ', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ã—ã‚“', firstName: 'ã‚ˆã—ã¨', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è—¤é‡', firstName: 'è’¼å£«', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'ãƒ–ãƒ¬ã‚¤ã‚­ãƒ³ä¸­ä¸Šç´š HARUHIKO', color: 'orange', students: [
                            { lastName: 'æ£®ç”°', firstName: 'ç¿”çœŸ', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¸­å±±', firstName: 'çµæ„›', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: '', firstName: 'å¤§ç©º', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è¿«ç”°', firstName: 'ã‚Šã‚Šã‚', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]}
                    ],
                    'æœ¨æ›œæ—¥': [
                        { location: 'å¤§æ©‹', name: 'ãƒ–ãƒ¬ã‚¤ã‚­ãƒ³å…¥é–€ SOYA', color: 'red', students: [
                            { lastName: 'è±Šç¦', firstName: 'æ‚ æˆ', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å‰æ‘', firstName: 'å¤ªå£±', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ± ç”°', firstName: 'å…¨', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¾¤æ±Ÿ', firstName: 'æ‚ ', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'åŸå£', firstName: 'è³¢ä¼¸', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¸¡é‚‰', firstName: 'å‰µå¤ª', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è—¤ç”°', firstName: 'å°†èˆ', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è—¤ç”°', firstName: 'å‡Œç¾½', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å°æŸ³', firstName: 'å‹é™½', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å±±ä¸‹', firstName: 'å¹¸å››éƒ', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤§æ©‹', name: 'ã‚¢ã‚¯ãƒ­ï¼†ãƒ‘ãƒ¯ãƒ¼ SOYA', color: 'orange', students: [
                            { lastName: 'ä¸­å±±', firstName: 'çµæ„›', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è±Šç¦', firstName: 'æ‚ æˆ', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å‰æ‘', firstName: 'å¤ªå£±', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'åŸå£', firstName: 'è³¢ä¼¸', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å››äº•', firstName: 'é™½éŸ³', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¸¡é‚‰', firstName: 'å‰µå¤ª', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è©åŸ', firstName: 'è–é¦™', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å°æŸ³', firstName: 'å‹é™½', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¾¤æ±Ÿ', firstName: 'æ‚ ', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'ç…§è‘‰', name: 'ãƒ–ãƒ¬ã‚¤ã‚­ãƒ³å…¥é–€ ãƒªãƒ¥ã‚¦ã‚»ã‚¤', color: 'blue', students: [
                            { lastName: 'æ¥Š', firstName: 'ãƒ“ãƒ³ãƒã‚§ãƒ³ã‚¨ã‚¤ãƒ‡ãƒ³', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¥Š', firstName: 'ã‚¨ã‚¯ã‚½', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ã—ãã‚‡ã†', firstName: 'ã¨ã†ã¾', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ã—ãã‚‡ã†', firstName: 'ã‚†ã†ã¾', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¢…é‡', firstName: 'å£®å¤§', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¢…é‡', firstName: 'çµ¢éŸ³', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'é•·è°·å·', firstName: 'ä¸ˆ', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'ç…§è‘‰', name: 'ã‚¢ã‚¯ãƒ­ï¼†ãƒ‘ãƒ¯ãƒ¼ ãƒªãƒ¥ã‚¦ã‚»ã‚¤', color: 'green', students: [
                            { lastName: 'å‰æ­¦', firstName: 'å‡›ä¿', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¥Š', firstName: 'ãƒ“ãƒ³ãƒã‚§ãƒ³ã‚¨ã‚¤ãƒ‡ãƒ³', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¥Š', firstName: 'ã‚¨ã‚¯ã‚½', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å·¥è—¤', firstName: 'å¤§åœ°', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'é•·è°·å·', firstName: 'ä¸ˆ', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¢…é‡', firstName: 'å£®å¤§', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'æ¢…é‡', firstName: 'çµ¢éŸ³', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' }
                        ]}
                    ],
                    'é‡‘æ›œæ—¥': [
                        { location: 'å¤©ç¥', name: 'ã‚¢ã‚¯ãƒ­ï¼†ãƒ‘ãƒ¯ãƒ¼ SOYA', color: 'red', students: [
                            { lastName: 'ä¸­å³¶', firstName: 'ç«œå¾', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¼Šè—¤', firstName: 'å’Œé¦¬', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è—¤é‡', firstName: 'è’¼å£«', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¸­å±±', firstName: 'éš¼', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¸‰é‡é‡', firstName: 'ç‰ç”Ÿ', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ã‚ˆã“ã‚„ã¾', firstName: 'ã‚†ã‚', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'ãƒ–ãƒ¬ã‚¤ã‚­ãƒ³åˆä¸­ç´š HARUHIKO', color: 'orange', students: [
                            { lastName: 'ä¸­å³¶', firstName: 'ç«œå¾', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¸‰é‡é‡', firstName: 'ç‰ç”Ÿ', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ã‚ˆã“ã‚„ã¾', firstName: 'ã‚†ã‚', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¼Šè—¤', firstName: 'å’Œé¦¬', plan: 'ï¼“ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤§æ©‹', name: 'ãƒ–ãƒ¬ã‚¤ã‚­ãƒ³å…¥é–€ HARUHIKO', color: 'blue', students: [
                            { lastName: 'è©å°¾', firstName: 'éƒæµ·', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'çŸ¢é‡', firstName: 'æ–°', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¼Šè±†æ°¸', firstName: 'æ™„é€¢', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è—¤å·', firstName: 'æ‚ åˆ©', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è—¤å·', firstName: 'æŸŠåˆ©', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¸‰é‡é‡', firstName: 'ã‹ãª', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¹…ä¿ç”°', firstName: 'æœ±é‡Œ', plan: '1ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å¤è³€', firstName: 'å¿ƒå¤ªéƒ', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]},
                        { location: 'å¤§æ©‹', name: 'ã‚¢ã‚¯ãƒ­ï¼†ãƒ‘ãƒ¯ãƒ¼ ryusei', color: 'green', students: [
                            { lastName: 'è©å°¾', firstName: 'éƒæµ·', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è—¤å·', firstName: 'æ‚ åˆ©', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'è—¤å·', firstName: 'æŸŠåˆ©', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'ä¸‰é‡é‡', firstName: 'ã‹ãª', plan: 'ï¼’ã‚¯ãƒ©ã‚¹' },
                            { lastName: 'å…ç‰', firstName: 'è›æ–—', plan: '1ã‚¯ãƒ©ã‚¹' }
                        ]}
                    ],
                    'ã‚¤ãƒ™ãƒ³ãƒˆ': []
                };
            }
            getEmptyCustomer() {
                return {
                    memberNumber: '', status: 'å…¥ä¼šä¸­', course: '', annualFee: '', hakomonoRegistration: '',
                    lastName: '', firstName: '', reading: '', guardianName: '', hakomonoName: '',
                    gender: '', birthDate: '', phone1: '', phone2: '', email: '',
                    postalCode: '', prefecture: '', city: '', address: '', building: '',
                    joinDate: '', memo: ''
                };
            }
            calculateAge(birthDate) {
                if (!birthDate) return '';
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age + 'æ­³';
            }
            async init() {
                await this.loadCustomers();
                await this.loadScheduleData();
                await this.loadAttendance();
                await this.loadEventAttendance();
                
                // å…¨ã‚¯ãƒ©ã‚¹ã®ç”Ÿå¾’ã‚’ãƒ—ãƒ©ãƒ³é †ã«ã‚½ãƒ¼ãƒˆ
                Object.keys(this.scheduleData).forEach(day => {
                    this.scheduleData[day].forEach(classInfo => {
                        classInfo.students = this.sortStudentsByPlan(classInfo.students);
                    });
                });
                
                this.render();
            }
            async loadCustomers() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'customers'));
                    this.customers = querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            status: data.status || (data.active === 'â—‹' ? 'å…¥ä¼šä¸­' : 'ä¼‘ä¼šä¸­')
                        };
                    });
                    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä¼šå“¡ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆ
                    this.customers.sort((a, b) => {
                        const aNum = a.memberNumber || '';
                        const bNum = b.memberNumber || '';
                        return aNum > bNum ? 1 : -1;
                    });
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.customers = [];
                }
            }
            async loadScheduleData() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'schedule'));
                    if (querySnapshot.empty) {
                        // Firestoreã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        console.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚');
                        await this.saveScheduleData();
                    } else {
                        // Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                        const loadedData = {};
                        querySnapshot.docs.forEach(doc => {
                            loadedData[doc.id] = doc.data().classes || [];
                        });
                        
                        // èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã§scheduleDataã‚’æ›´æ–°
                        if (Object.keys(loadedData).length > 0) {
                            this.scheduleData = loadedData;
                        }
                    }
                } catch (error) {
                    console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                }
            }
            async saveScheduleData() {
                try {
                    // å„æ›œæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ä¿å­˜
                    for (const day of Object.keys(this.scheduleData)) {
                        const docRef = doc(db, 'schedule', day);
                        await setDoc(docRef, {
                            classes: this.scheduleData[day]
                        });
                    }
                } catch (error) {
                    console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            async addCustomer() {
                if (!this.newCustomer.lastName || !this.newCustomer.firstName) {
                    alert('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                if (!this.newCustomer.memberNumber) {
                    alert('ä¼šå“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                try {
                    await addDoc(collection(db, 'customers'), this.newCustomer);
                    await this.loadCustomers();
                    this.newCustomer = this.getEmptyCustomer();
                    this.showAddForm = false;
                    this.render();
                    alert('ç™»éŒ²ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }
            async saveEdit() {
                if (!this.editForm.id) {
                    alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                try {
                    const customerRef = doc(db, 'customers', this.editForm.id);
                    const { id, ...dataToSave } = this.editForm;
                    await updateDoc(customerRef, dataToSave);
                    await this.loadCustomers();
                    this.editingId = null;
                    this.editForm = {};
                    this.render();
                    alert('æ›´æ–°ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    alert('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }
            async deleteCustomer(id) {
                if (!confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) return;
                try {
                    await deleteDoc(doc(db, 'customers', id));
                    await this.loadCustomers();
                    this.render();
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }
            startEdit(id) {
                this.editingId = id;
                const customer = this.customers.find(c => c.id === id);
                if (customer) {
                    this.editForm = { ...customer };
                    this.render();
                }
            }
            cancelEdit() {
                this.editingId = null;
                this.editForm = {};
                this.render();
            }
            updateEditField(field, value) {
                this.editForm[field] = value;
            }
            handleExport() {
                const headers = ['No', 'ä¼šå“¡ç•ªå·', 'ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'ã‚³ãƒ¼ã‚¹', 'å¹´ä¼šè²»æ›´æ–°æ—¥', 'æ°å', 'èª­ã¿', 'ä¿è­·è€…å', 'ãƒã‚³ãƒ¢ãƒç™»éŒ²å', 'æ€§åˆ¥', 'ç”Ÿå¹´æœˆæ—¥', 'å¹´é½¢', 'é›»è©±ç•ªå·', 'ãƒ¡ãƒ¼ãƒ«', 'å…¥ä¼šæ—¥', 'éƒµä¾¿ç•ªå·', 'éƒ½é“åºœçœŒ', 'å¸‚åŒºç”ºæ‘', 'ç•ªåœ°', 'å»ºç‰©ãƒ»éƒ¨å±‹ç•ªå·', 'å‚™è€ƒ'];
                const rows = this.customers.map((c, i) => [
                    i + 1, c.memberNumber || '', c.status, c.course, c.annualFee,
                    `${c.lastName} ${c.firstName}`, c.reading, c.guardianName, c.hakomonoName, c.gender,
                    c.birthDate, this.calculateAge(c.birthDate), c.phone1, c.email, c.joinDate,
                    c.postalCode, c.prefecture, c.city, c.address, c.building, c.memo
                ].map(f => `"${f || ''}"`).join(','));
                const csv = [headers.join(','), ...rows].join('\n');
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `é¡§å®¢ç®¡ç†_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }
            sortBy(field) {
                if (this.sortField === field) {
                    this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortField = field;
                    this.sortOrder = 'asc';
                }
                this.render();
            }
            getFilteredCustomers() {
                const s = this.searchTerm.toLowerCase();
                let filtered = this.customers.filter(c => 
                    c.status === this.statusFilter &&
                    ((c.lastName || '').toLowerCase().includes(s) ||
                    (c.firstName || '').toLowerCase().includes(s) ||
                    (c.reading || '').toLowerCase().includes(s) ||
                    (c.course || '').toLowerCase().includes(s) ||
                    (c.phone1 || '').includes(s) ||
                    (c.email || '').toLowerCase().includes(s) ||
                    (c.memberNumber || '').includes(s))
                );
                filtered.sort((a, b) => {
                    let aVal = a[this.sortField] || '';
                    let bVal = b[this.sortField] || '';
                    if (this.sortOrder === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
                return filtered;
            }
            render() {
                const filteredCustomers = this.getFilteredCustomers();
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen">
                        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
                            <div class="container mx-auto px-4 py-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-2xl font-bold">posse dance academy</h1>
                                        <p class="text-sm opacity-90">é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <nav class="bg-white shadow">
                            <div class="container mx-auto px-4">
                                <div class="flex space-x-8">
                                    <button id="dashboardTab" class="py-4 px-2 font-medium ${this.currentTab === 'dashboard' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
                                    <button id="customersTab" class="py-4 px-2 font-medium ${this.currentTab === 'customers' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">é¡§å®¢ç®¡ç†</button>
                                    <button id="attendanceTab" class="py-4 px-2 font-medium ${this.currentTab === 'attendance' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">å‡ºå¸­åç°¿</button>
                                </div>
                            </div>
                        </nav>
                        <main class="container mx-auto px-4 py-8">
                            ${this.currentTab === 'dashboard' ? this.renderDashboard() :
                              this.currentTab === 'customers' ? this.renderCustomers(filteredCustomers) :
                              this.renderAttendance()}
                        </main>
                        ${this.showVisitorModal ? `
                            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="z-index: 9999;" onclick="if(event.target === this) app.closeVisitorModal()">
                                <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl" onclick="event.stopPropagation()">
                                    <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ’° ãƒ“ã‚¸ã‚¿ãƒ¼å‚åŠ è€…ã‚’è¿½åŠ </h2>
                                    <div class="space-y-4">
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                            <p class="text-sm font-medium text-blue-800">${this.visitorData.day} - ${this.visitorData.location}</p>
                                            <p class="text-xs text-blue-600">${this.visitorData.className}</p>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-semibold mb-2 text-gray-700">å§“ *</label>
                                                <input type="text" id="visitor_lastName" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" placeholder="å±±ç”°">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold mb-2 text-gray-700">å *</label>
                                                <input type="text" id="visitor_firstName" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" placeholder="å¤ªéƒ">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold mb-2 text-gray-700">ãƒ—ãƒ©ãƒ³ *</label>
                                            <select id="visitor_plan" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                                                <option value="ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰">ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰ - Â¥2,000</option>
                                                <option value="ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰">ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰ - Â¥2,300</option>
                                                <option value="ãƒ“ã‚¸ã‚¿ãƒ¼1.5hï¼ˆä¼šå“¡ï¼‰">ãƒ“ã‚¸ã‚¿ãƒ¼1.5hï¼ˆä¼šå“¡ï¼‰ - Â¥2,200</option>
                                                <option value="ãƒ“ã‚¸ã‚¿ãƒ¼1.5hï¼ˆéä¼šå“¡ï¼‰">ãƒ“ã‚¸ã‚¿ãƒ¼1.5hï¼ˆéä¼šå“¡ï¼‰ - Â¥2,500</option>
                                                <option value="åˆå›ä½“é¨“">åˆå›ä½“é¨“ - Â¥1,000</option>
                                                <option value="åˆå›ç„¡æ–™">åˆå›ç„¡æ–™ - Â¥0</option>
                                                <option value="æœˆè¬ã‚¯ãƒ©ã‚¹æŒ¯æ›¿">æœˆè¬ã‚¯ãƒ©ã‚¹æŒ¯æ›¿ - Â¥1,000</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold mb-2 text-gray-700">å‡ºå¸­ã™ã‚‹é€± * ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                                            <div class="grid grid-cols-5 gap-2">
                                                ${['week1', 'week2', 'week3', 'week4', 'week5'].map((week, idx) => `
                                                    <label class="flex items-center justify-center border-2 border-gray-300 rounded-lg px-2 py-2 cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition">
                                                        <input type="checkbox" value="${week}" class="visitor-week-checkbox mr-1" />
                                                        <span class="text-xs font-medium">${idx + 1}é€±</span>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div class="flex gap-3 pt-4">
                                            <button onclick="app.closeVisitorModal()" class="flex-1 bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300 transition font-semibold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                            <button onclick="
                                                app.visitorData.lastName = document.getElementById('visitor_lastName').value;
                                                app.visitorData.firstName = document.getElementById('visitor_firstName').value;
                                                app.visitorData.plan = document.getElementById('visitor_plan').value;
                                                app.visitorData.weeks = Array.from(document.querySelectorAll('.visitor-week-checkbox:checked')).map(cb => cb.value);
                                                app.addVisitorParticipant()
                                            " class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition font-semibold shadow-md">è¿½åŠ ã™ã‚‹</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                document.getElementById('dashboardTab')?.addEventListener('click', () => { this.currentTab = 'dashboard'; this.render(); });
                document.getElementById('customersTab')?.addEventListener('click', () => { this.currentTab = 'customers'; this.render(); });
                document.getElementById('attendanceTab')?.addEventListener('click', () => { this.currentTab = 'attendance'; this.render(); });
                if (this.currentTab === 'customers') {
                    this.setupCustomerPageEvents();
                } else if (this.currentTab === 'attendance') {
                    this.setupAttendanceEvents();
                }
            }
            setupCustomerPageEvents() {
                document.getElementById('exportBtn')?.addEventListener('click', () => this.handleExport());
                document.getElementById('toggleAddFormBtn')?.addEventListener('click', () => { this.showAddForm = !this.showAddForm; this.render(); });
                document.getElementById('searchInput')?.addEventListener('input', (e) => { this.searchTerm = e.target.value; this.render(); });
                document.getElementById('addCustomerBtn')?.addEventListener('click', () => this.addCustomer());
                document.getElementById('cancelAddBtn')?.addEventListener('click', () => { this.showAddForm = false; this.render(); });
                
                ['å…¥ä¼šä¸­', 'ä¼‘ä¼šä¸­', 'é€€ä¼šæ¸ˆã¿'].forEach(status => {
                    document.getElementById(`status-${status}`)?.addEventListener('click', () => {
                        this.statusFilter = status;
                        this.render();
                    });
                });
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', () => {
                        this.sortBy(header.getAttribute('data-field'));
                    });
                });
                this.setupFormEvents();
                this.setupEditEvents();
            }
            setupFormEvents() {
                const fields = ['memberNumber', 'status', 'course', 'annualFee', 'lastName', 'firstName', 'reading', 'guardianName', 'hakomonoName', 'gender', 'birthDate', 'phone1', 'email', 'postalCode', 'prefecture', 'city', 'address', 'building', 'joinDate', 'memo'];
                fields.forEach(field => {
                    const el = document.getElementById(`new_${field}`);
                    if (el) {
                        el.addEventListener('change', (e) => { this.newCustomer[field] = e.target.value; });
                        el.addEventListener('input', (e) => { this.newCustomer[field] = e.target.value; });
                    }
                });
            }
            setupEditEvents() {
                document.querySelectorAll('[data-edit-action="start"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.startEdit(btn.getAttribute('data-id'));
                    });
                });
                document.querySelectorAll('[data-edit-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.deleteCustomer(btn.getAttribute('data-id'));
                    });
                });
                document.getElementById('saveEditBtn')?.addEventListener('click', () => this.saveEdit());
                document.getElementById('cancelEditBtn')?.addEventListener('click', () => this.cancelEdit());
                const editFields = ['memberNumber', 'status', 'course', 'annualFee', 'reading', 'guardianName', 'hakomonoName', 'gender', 'birthDate', 'phone1', 'email', 'postalCode', 'prefecture', 'city', 'address', 'building', 'joinDate', 'memo'];
                editFields.forEach(field => {
                    const el = document.getElementById(`edit_${field}`);
                    if (el) {
                        el.addEventListener('change', (e) => { this.updateEditField(field, e.target.value); });
                        el.addEventListener('input', (e) => { this.updateEditField(field, e.target.value); });
                    }
                });
                const nameField = document.getElementById('edit_fullName');
                if (nameField) {
                    nameField.addEventListener('input', (e) => {
                        const parts = e.target.value.split(' ');
                        this.editForm.lastName = parts[0] || '';
                        this.editForm.firstName = parts[1] || '';
                    });
                }
            }
            renderDashboard() {
                const total = this.customers.length;
                const activeCount = this.customers.filter(c => c.status === 'å…¥ä¼šä¸­').length;
                const pausedCount = this.customers.filter(c => c.status === 'ä¼‘ä¼šä¸­').length;
                const withdrawnCount = this.customers.filter(c => c.status === 'é€€ä¼šæ¸ˆã¿').length;
                
                const coursePrices = {
                    'ï¼‘': 6000,
                    'ï¼’': 10000,
                    'ï¼“': 14400,
                    'ï¼”': 18600
                };
                
                const courseCounts = {};
                this.customers.filter(c => c.status === 'å…¥ä¼šä¸­').forEach(c => { 
                    if (c.course) courseCounts[c.course] = (courseCounts[c.course] || 0) + 1; 
                });
                
                let totalRevenue = 0;
                Object.entries(courseCounts).forEach(([course, count]) => {
                    if (coursePrices[course]) {
                        totalRevenue += coursePrices[course] * count;
                    }
                });
                return `
                    <div>
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">ç·é¡§å®¢æ•°</div>
                                <div class="text-4xl font-bold text-blue-600">${total}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">å…¥ä¼šä¸­</div>
                                <div class="text-4xl font-bold text-green-600">${activeCount}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">ä¼‘ä¼šä¸­</div>
                                <div class="text-4xl font-bold text-orange-600">${pausedCount}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">é€€ä¼šæ¸ˆã¿</div>
                                <div class="text-4xl font-bold text-gray-600">${withdrawnCount}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ã‚³ãƒ¼ã‚¹åˆ¥å†…è¨³ï¼ˆå…¥ä¼šä¸­ï¼‰</h3>
                            <div class="space-y-3">
                                ${Object.keys(courseCounts).length > 0 ? Object.entries(courseCounts).map(([course, count]) => {
                                    const price = coursePrices[course] || 0;
                                    const subtotal = price * count;
                                    return `
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">ã‚³ãƒ¼ã‚¹${course || 'æœªè¨­å®š'}</span>
                                            <div class="flex gap-4 items-center">
                                                <span class="text-gray-600">Â¥${price.toLocaleString()} Ã— ${count}å</span>
                                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">Â¥${subtotal.toLocaleString()}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('') : '<p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
                                ${Object.keys(courseCounts).length > 0 ? `
                                    <div class="border-t pt-3 mt-3">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-lg">åˆè¨ˆ</span>
                                            <span class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-lg font-bold">Â¥${totalRevenue.toLocaleString()}</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            renderCustomers(filteredCustomers) {
                const getSortIcon = (field) => {
                    if (this.sortField === field) return this.sortOrder === 'asc' ? 'â–²' : 'â–¼';
                    return 'â¬';
                };
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800">é¡§å®¢ç®¡ç†</h2>
                            <div class="flex gap-2">
                                <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-sm">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                                <button id="toggleAddFormBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">${this.showAddForm ? 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹' : 'æ–°è¦ç™»éŒ²'}</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex gap-2 mb-4">
                                <button id="status-å…¥ä¼šä¸­" class="px-4 py-2 rounded transition ${this.statusFilter === 'å…¥ä¼šä¸­' ? 'status-tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    å…¥ä¼šä¸­ (${this.customers.filter(c => c.status === 'å…¥ä¼šä¸­').length})
                                </button>
                                <button id="status-ä¼‘ä¼šä¸­" class="px-4 py-2 rounded transition ${this.statusFilter === 'ä¼‘ä¼šä¸­' ? 'status-tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    ä¼‘ä¼šä¸­ (${this.customers.filter(c => c.status === 'ä¼‘ä¼šä¸­').length})
                                </button>
                                <button id="status-é€€ä¼šæ¸ˆã¿" class="px-4 py-2 rounded transition ${this.statusFilter === 'é€€ä¼šæ¸ˆã¿' ? 'status-tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    é€€ä¼šæ¸ˆã¿ (${this.customers.filter(c => c.status === 'é€€ä¼šæ¸ˆã¿').length})
                                </button>
                            </div>
                            <div class="mb-4">
                                <input type="text" id="searchInput" placeholder="ä¼šå“¡ç•ªå·ã€æ°åã€ã‚³ãƒ¼ã‚¹ã€é›»è©±ç•ªå·ã€ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢..." value="${this.searchTerm}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            ${this.showAddForm ? this.renderAddForm() : ''}
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 50px;">No</th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="memberNumber" style="width: 80px;">ä¼šå“¡ç•ªå·<span class="sort-icon">${getSortIcon('memberNumber')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="status" style="width: 120px;">ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹<span class="sort-icon">${getSortIcon('status')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="course" style="width: 80px;">ã‚³ãƒ¼ã‚¹<span class="sort-icon">${getSortIcon('course')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="annualFee" style="width: 120px;">å¹´ä¼šè²»æ›´æ–°æ—¥<span class="sort-icon">${getSortIcon('annualFee')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="lastName" style="width: 150px;">æ°å<span class="sort-icon">${getSortIcon('lastName')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="reading" style="width: 150px;">èª­ã¿<span class="sort-icon">${getSortIcon('reading')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="guardianName" style="width: 120px;">ä¿è­·è€…å<span class="sort-icon">${getSortIcon('guardianName')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="hakomonoName" style="width: 120px;">ãƒã‚³ãƒ¢ãƒç™»éŒ²å<span class="sort-icon">${getSortIcon('hakomonoName')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="gender" style="width: 60px;">æ€§åˆ¥<span class="sort-icon">${getSortIcon('gender')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="birthDate" style="width: 110px;">ç”Ÿå¹´æœˆæ—¥<span class="sort-icon">${getSortIcon('birthDate')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 70px;">å¹´é½¢</th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="phone1" style="width: 130px;">é›»è©±ç•ªå·<span class="sort-icon">${getSortIcon('phone1')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="email" style="width: 220px;">ãƒ¡ãƒ¼ãƒ«<span class="sort-icon">${getSortIcon('email')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="joinDate" style="width: 110px;">å…¥ä¼šæ—¥<span class="sort-icon">${getSortIcon('joinDate')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="postalCode" style="width: 100px;">éƒµä¾¿ç•ªå·<span class="sort-icon">${getSortIcon('postalCode')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="prefecture" style="width: 90px;">éƒ½é“åºœçœŒ<span class="sort-icon">${getSortIcon('prefecture')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="city" style="width: 120px;">å¸‚åŒºç”ºæ‘<span class="sort-icon">${getSortIcon('city')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="address" style="width: 150px;">ç•ªåœ°<span class="sort-icon">${getSortIcon('address')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="building" style="width: 150px;">å»ºç‰©ãƒ»éƒ¨å±‹ç•ªå·<span class="sort-icon">${getSortIcon('building')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 400px;">å‚™è€ƒ</th>
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 100px;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredCustomers.map((c, i) => this.renderCustomerRow(c, i + 1)).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 text-sm text-gray-600">
                                ${this.statusFilter}: ${filteredCustomers.length}å
                            </div>
                        </div>
                    </div>
                `;
            }
            renderAddForm() {
                return `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">æ–°è¦é¡§å®¢ç™»éŒ²</h3>
                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <div><label class="block text-sm font-medium mb-1">ä¼šå“¡ç•ªå· *</label><input type="text" id="new_memberNumber" class="w-full border rounded px-2 py-1 text-sm" placeholder="ä¾‹: 0001"></div>
                            <div><label class="block text-sm font-medium mb-1">ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label><select id="new_status" class="w-full border rounded px-2 py-1 text-sm"><option value="å…¥ä¼šä¸­">å…¥ä¼šä¸­</option><option value="ä¼‘ä¼šä¸­">ä¼‘ä¼šä¸­</option><option value="é€€ä¼šæ¸ˆã¿">é€€ä¼šæ¸ˆã¿</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">ã‚³ãƒ¼ã‚¹</label><select id="new_course" class="w-full border rounded px-2 py-1 text-sm"><option value="">é¸æŠã—ã¦ãã ã•ã„</option><option value="ãƒ“ã‚¸ã‚¿ãƒ¼">ãƒ“ã‚¸ã‚¿ãƒ¼</option><option value="ï¼‘">ï¼‘</option><option value="ï¼’">ï¼’</option><option value="ï¼“">ï¼“</option><option value="ï¼”">ï¼”</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">å¹´ä¼šè²»æ›´æ–°æ—¥</label><input type="date" id="new_annualFee" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">æ°å(å§“) *</label><input type="text" id="new_lastName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">æ°å(å) *</label><input type="text" id="new_firstName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">èª­ã¿</label><input type="text" id="new_reading" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">ä¿è­·è€…å</label><input type="text" id="new_guardianName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">ãƒã‚³ãƒ¢ãƒç™»éŒ²å</label><input type="text" id="new_hakomonoName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">æ€§åˆ¥</label><select id="new_gender" class="w-full border rounded px-2 py-1 text-sm"><option value="">é¸æŠ</option><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">ç”Ÿå¹´æœˆæ—¥</label><input type="date" id="new_birthDate" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">é›»è©±ç•ªå·</label><input type="tel" id="new_phone1" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div class="col-span-2"><label class="block text-sm font-medium mb-1">ãƒ¡ãƒ¼ãƒ«</label><input type="email" id="new_email" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">å…¥ä¼šæ—¥</label><input type="date" id="new_joinDate" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">éƒµä¾¿ç•ªå·</label><input type="text" id="new_postalCode" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">éƒ½é“åºœçœŒ</label><input type="text" id="new_prefecture" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">å¸‚åŒºç”ºæ‘</label><input type="text" id="new_city" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">ç•ªåœ°</label><input type="text" id="new_address" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">å»ºç‰©ãƒ»éƒ¨å±‹ç•ªå·</label><input type="text" id="new_building" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div class="col-span-3"><label class="block text-sm font-medium mb-1">å‚™è€ƒ</label><input type="text" id="new_memo" class="w-full border rounded px-2 py-1 text-sm"></div>
                        </div>
                        <div class="flex gap-2">
                            <button id="addCustomerBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">ç™»éŒ²</button>
                            <button id="cancelAddBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                `;
            }
            renderCustomerRow(customer, no) {
                const statusBadgeClass = customer.status === 'å…¥ä¼šä¸­' ? 'status-badge-active' : customer.status === 'ä¼‘ä¼šä¸­' ? 'status-badge-paused' : 'status-badge-withdrawn';
                const genderClass = customer.gender === 'ç”·' ? 'gender-male' : customer.gender === 'å¥³' ? 'gender-female' : '';
                const age = this.calculateAge(customer.birthDate);
                
                if (this.editingId === customer.id) {
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-2 py-3">${no}</td>
                            <td class="px-2 py-3"><input type="text" id="edit_memberNumber" value="${this.editForm.memberNumber || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><select id="edit_status" class="w-full border rounded px-1 py-1 text-xs"><option value="å…¥ä¼šä¸­" ${this.editForm.status === 'å…¥ä¼šä¸­' ? 'selected' : ''}>å…¥ä¼šä¸­</option><option value="ä¼‘ä¼šä¸­" ${this.editForm.status === 'ä¼‘ä¼šä¸­' ? 'selected' : ''}>ä¼‘ä¼šä¸­</option><option value="é€€ä¼šæ¸ˆã¿" ${this.editForm.status === 'é€€ä¼šæ¸ˆã¿' ? 'selected' : ''}>é€€ä¼šæ¸ˆã¿</option></select></td>
                            <td class="px-2 py-3"><select id="edit_course" class="w-full border rounded px-1 py-1 text-xs"><option value="">é¸æŠ</option><option value="ãƒ“ã‚¸ã‚¿ãƒ¼" ${this.editForm.course === 'ãƒ“ã‚¸ã‚¿ãƒ¼' ? 'selected' : ''}>ãƒ“ã‚¸ã‚¿ãƒ¼</option><option value="ï¼‘" ${this.editForm.course === 'ï¼‘' ? 'selected' : ''}>ï¼‘</option><option value="ï¼’" ${this.editForm.course === 'ï¼’' ? 'selected' : ''}>ï¼’</option><option value="ï¼“" ${this.editForm.course === 'ï¼“' ? 'selected' : ''}>ï¼“</option><option value="ï¼”" ${this.editForm.course === 'ï¼”' ? 'selected' : ''}>ï¼”</option></select></td>
                            <td class="px-2 py-3"><input type="date" id="edit_annualFee" value="${this.editForm.annualFee || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_fullName" value="${this.editForm.lastName || ''} ${this.editForm.firstName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_reading" value="${this.editForm.reading || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_guardianName" value="${this.editForm.guardianName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_hakomonoName" value="${this.editForm.hakomonoName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><select id="edit_gender" class="w-full border rounded px-1 py-1 text-xs"><option value="">-</option><option value="ç”·" ${this.editForm.gender === 'ç”·' ? 'selected' : ''}>ç”·</option><option value="å¥³" ${this.editForm.gender === 'å¥³' ? 'selected' : ''}>å¥³</option></select></td>
                            <td class="px-2 py-3"><input type="date" id="edit_birthDate" value="${this.editForm.birthDate || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3 text-center">${this.calculateAge(this.editForm.birthDate)}</td>
                            <td class="px-2 py-3"><input type="tel" id="edit_phone1" value="${this.editForm.phone1 || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="email" id="edit_email" value="${this.editForm.email || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="date" id="edit_joinDate" value="${this.editForm.joinDate || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_postalCode" value="${this.editForm.postalCode || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_prefecture" value="${this.editForm.prefecture || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_city" value="${this.editForm.city || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_address" value="${this.editForm.address || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_building" value="${this.editForm.building || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3 memo-cell"><textarea id="edit_memo" class="w-full border rounded px-1 py-1 text-xs" rows="2">${this.editForm.memo || ''}</textarea></td>
                            <td class="px-2 py-3"><div class="flex flex-col gap-1"><button id="saveEditBtn" class="text-green-600 hover:text-green-800 text-xs">ä¿å­˜</button><button id="cancelEditBtn" class="text-gray-600 hover:text-gray-800 text-xs">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button data-edit-action="delete" data-id="${customer.id}" class="text-red-600 hover:text-red-800 text-xs">å‰Šé™¤</button></div></td>
                        </tr>
                    `;
                }
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-2 py-3">${no}</td>
                        <td class="px-2 py-3 font-mono">${customer.memberNumber || ''}</td>
                        <td class="px-2 py-3"><span class="px-2 py-1 rounded text-xs font-semibold ${statusBadgeClass}">${customer.status || ''}</span></td>
                        <td class="px-2 py-3">${customer.course || ''}</td>
                        <td class="px-2 py-3">${customer.annualFee || ''}</td>
                        <td class="px-2 py-3 font-medium">${customer.lastName || ''} ${customer.firstName || ''}</td>
                        <td class="px-2 py-3">${customer.reading || ''}</td>
                        <td class="px-2 py-3">${customer.guardianName || ''}</td>
                        <td class="px-2 py-3">${customer.hakomonoName || ''}</td>
                        <td class="px-2 py-3 text-center ${genderClass}">${customer.gender || ''}</td>
                        <td class="px-2 py-3">${customer.birthDate || ''}</td>
                        <td class="px-2 py-3 text-center">${age}</td>
                        <td class="px-2 py-3">${customer.phone1 || ''}</td>
                        <td class="px-2 py-3 email-cell">${customer.email || ''}</td>
                        <td class="px-2 py-3">${customer.joinDate || ''}</td>
                        <td class="px-2 py-3">${customer.postalCode || ''}</td>
                        <td class="px-2 py-3">${customer.prefecture || ''}</td>
                        <td class="px-2 py-3">${customer.city || ''}</td>
                        <td class="px-2 py-3">${customer.address || ''}</td>
                        <td class="px-2 py-3">${customer.building || ''}</td>
                        <td class="px-2 py-3 memo-cell">${customer.memo || ''}</td>
                        <td class="px-2 py-3"><button data-edit-action="start" data-id="${customer.id}" class="text-blue-600 hover:text-blue-800 text-xs">ç·¨é›†</button></td>
                    </tr>
                `;
            }
            sortStudentsByPlan(students) {
                return students.sort((a, b) => {
                    // ãƒ—ãƒ©ãƒ³åã‚’æ­£è¦åŒ–ï¼ˆå…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›ï¼‰
                    const normalizePlan = (plan) => {
                        return plan.replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                    };
                    
                    const planA = normalizePlan(a.plan);
                    const planB = normalizePlan(b.plan);
                    
                    const orderA = this.planOrder[planA] || 999;
                    const orderB = this.planOrder[planB] || 999;
                    return orderA - orderB;
                });
            }
            // é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã®è¡¨ç¤ºã®ã¿ã‚’æ›´æ–°
            updateSelectedCustomerInfo() {
                const selectedInfoContainer = document.getElementById('selectedCustomerInfo');
                const planSelect = document.getElementById('new_student_plan');
                const nameInputContainer = document.getElementById('nameInputContainer');
                const planSelectContainer = document.getElementById('planSelectContainer');
                
                if (!selectedInfoContainer) return;
                
                if (this.selectedCustomerForStudent) {
                    selectedInfoContainer.innerHTML = `
                        <div class="mb-3 p-3 bg-green-50 border-2 border-green-400 rounded text-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold text-green-800">âœ“ é¸æŠä¸­: ${this.selectedCustomerForStudent.lastName} ${this.selectedCustomerForStudent.firstName}</div>
                                    <div class="text-xs text-gray-700 mt-1">
                                        ${this.selectedCustomerForStudent.memberNumber ? `ä¼šå“¡ç•ªå·: ${this.selectedCustomerForStudent.memberNumber} | ` : ''}
                                        ${this.selectedCustomerForStudent.reading ? `èª­ã¿: ${this.selectedCustomerForStudent.reading} | ` : ''}
                                        ã‚³ãƒ¼ã‚¹: ${this.selectedCustomerForStudent.course || 'ãªã—'}
                                    </div>
                                </div>
                                <button 
                                    id="clearSelectedCustomer"
                                    class="text-red-600 hover:text-red-800 text-xs underline">
                                    é¸æŠè§£é™¤
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // å§“åå…¥åŠ›æ¬„ã‚’éè¡¨ç¤º
                    if (nameInputContainer) {
                        nameInputContainer.classList.add('hidden');
                        nameInputContainer.classList.remove('col-span-2', 'grid', 'grid-cols-2', 'gap-3');
                    }
                    
                    // ãƒ—ãƒ©ãƒ³ã‚»ãƒ¬ã‚¯ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´
                    if (planSelectContainer) {
                        planSelectContainer.classList.add('col-span-3');
                    }
                    
                    // é¸æŠè§£é™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
                    document.getElementById('clearSelectedCustomer')?.addEventListener('click', () => {
                        this.selectedCustomerForStudent = null;
                
                // ãƒ“ã‚¸ã‚¿ãƒ¼è¿½åŠ ç”¨
                this.showVisitorModal = false;
                this.visitorData = {};
                        this.studentSearchTerm = '';
                        this.studentSearchResults = [];
                        this.updateSelectedCustomerInfo();
                        // æ¤œç´¢å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                        const searchInput = document.getElementById('student_search_input');
                        if (searchInput) searchInput.value = '';
                        // æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢
                        this.updateSearchResults();
                        // ãƒ—ãƒ©ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                        if (planSelect) planSelect.value = '';
                    });
                    
                    // ãƒ—ãƒ©ãƒ³ã‚’è‡ªå‹•è¨­å®š
                    if (planSelect && this.selectedCustomerForStudent.course) {
                        const courseMap = {'ï¼‘': 'ï¼‘ã‚¯ãƒ©ã‚¹', 'ï¼’': 'ï¼’ã‚¯ãƒ©ã‚¹', 'ï¼“': 'ï¼“ã‚¯ãƒ©ã‚¹', 'ï¼”': 'ï¼”ã‚¯ãƒ©ã‚¹'};
                        const planValue = courseMap[this.selectedCustomerForStudent.course] || '';
                        if (planValue) planSelect.value = planValue;
                    }
                } else {
                    selectedInfoContainer.innerHTML = '';
                    
                    // å§“åå…¥åŠ›æ¬„ã‚’è¡¨ç¤º
                    if (nameInputContainer) {
                        nameInputContainer.classList.remove('hidden');
                        nameInputContainer.classList.add('col-span-2', 'grid', 'grid-cols-2', 'gap-3');
                    }
                    
                    // ãƒ—ãƒ©ãƒ³ã‚»ãƒ¬ã‚¯ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å…ƒã«æˆ»ã™
                    if (planSelectContainer) {
                        planSelectContainer.classList.remove('col-span-3');
                    }
                }
            }
            // æ¤œç´¢çµæœã®ã¿ã‚’æ›´æ–°ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¶­æŒï¼‰
            updateSearchResults() {
                const resultsContainer = document.getElementById('searchResultsContainer');
                if (!resultsContainer) return;
                if (this.studentSearchResults.length > 0) {
                    resultsContainer.innerHTML = `
                        <div class="mt-2 border rounded bg-white student-search-results shadow-lg">
                            ${this.studentSearchResults.map(customer => `
                                <div 
                                    data-select-customer-id="${customer.id}"
                                    class="select-customer-btn p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm transition">
                                    <div class="font-medium text-blue-600">
                                        ${customer.lastName} ${customer.firstName}
                                        ${customer.memberNumber ? `<span class="text-xs text-gray-500 ml-2">[${customer.memberNumber}]</span>` : ''}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        ${customer.reading ? `èª­ã¿: ${customer.reading}` : ''}
                                        ${customer.reading && customer.course ? ' | ' : ''}
                                        ${customer.course ? `ã‚³ãƒ¼ã‚¹: ${customer.course}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // æ¤œç´¢çµæœã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
                    resultsContainer.querySelectorAll('.select-customer-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const customerId = btn.getAttribute('data-select-customer-id');
                            const customer = this.customers.find(c => c.id === customerId);
                            if (customer) {
                                this.selectCustomerForStudent(customer);
                            }
                        });
                    });
                } else if (this.studentSearchTerm.trim()) {
                    resultsContainer.innerHTML = `
                        <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                            âš ï¸ è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '';
                }
            }
            // ã²ã‚‰ãŒãªâ†’ã‚«ã‚¿ã‚«ãƒŠå¤‰æ›
            hiraganaToKatakana(str) {
                return str.replace(/[\u3041-\u3096]/g, (match) => {
                    const chr = match.charCodeAt(0) + 0x60;
                    return String.fromCharCode(chr);
                });
            }
            // ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãªå¤‰æ›
            katakanaToHiragana(str) {
                return str.replace(/[\u30a1-\u30f6]/g, (match) => {
                    const chr = match.charCodeAt(0) - 0x60;
                    return String.fromCharCode(chr);
                });
            }
            // é¡§å®¢æ¤œç´¢æ©Ÿèƒ½ï¼ˆå¼·åŒ–ç‰ˆï¼‰
            searchCustomerByName(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                if (!term) {
                    return [];
                }
                
                // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠä¸¡æ–¹ã§æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«
                const termHiragana = this.katakanaToHiragana(term);
                const termKatakana = this.hiraganaToKatakana(term);
                
                return this.customers.filter(c => {
                    // æ°åï¼ˆå§“ååˆ¥ã€…ãƒ»ãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰
                    const lastName = (c.lastName || '').toLowerCase();
                    const firstName = (c.firstName || '').toLowerCase();
                    const fullName = `${lastName}${firstName}`;
                    const fullNameWithSpace = `${lastName} ${firstName}`;
                    
                    // èª­ã¿ï¼ˆã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠä¸¡å¯¾å¿œï¼‰
                    const reading = (c.reading || '').toLowerCase();
                    const readingHiragana = this.katakanaToHiragana(reading);
                    const readingKatakana = this.hiraganaToKatakana(reading);
                    
                    // ä¼šå“¡ç•ªå·
                    const memberNumber = (c.memberNumber || '').toLowerCase();
                    
                    // è¤‡æ•°ã®æ¡ä»¶ã§æ¤œç´¢
                    return lastName.includes(term) ||
                           firstName.includes(term) ||
                           fullName.includes(term) ||
                           fullNameWithSpace.includes(term) ||
                           reading.includes(term) ||
                           reading.includes(termHiragana) ||
                           reading.includes(termKatakana) ||
                           readingHiragana.includes(term) ||
                           readingHiragana.includes(termHiragana) ||
                           readingKatakana.includes(term) ||
                           readingKatakana.includes(termKatakana) ||
                           memberNumber.includes(term);
                }).slice(0, 10); // æœ€å¤§10ä»¶ã¾ã§è¡¨ç¤º
            }
            // é¡§å®¢ã‚’é¸æŠã—ã¦ç”Ÿå¾’æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
            selectCustomerForStudent(customer) {
                this.selectedCustomerForStudent = customer;
                this.studentSearchResults = [];
                this.studentSearchTerm = `${customer.lastName} ${customer.firstName}`;
                
                // æ¤œç´¢å…¥åŠ›æ¬„ã‚’æ›´æ–°
                const searchInput = document.getElementById('student_search_input');
                if (searchInput) {
                    searchInput.value = this.studentSearchTerm;
                }
                
                // æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢
                this.updateSearchResults();
                
                // é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º
                this.updateSelectedCustomerInfo();
            }
            async addStudentToClass(day, location, className) {
                this.selectedClassForAdd = { day, location, className };
                this.showAddStudentForm = true;
                this.selectedCustomerForStudent = null;
                
                // ãƒ“ã‚¸ã‚¿ãƒ¼è¿½åŠ ç”¨
                this.showVisitorModal = false;
                this.visitorData = {};
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.render();
            }
            async saveNewStudent() {
                let lastName, firstName, plan;
                
                // é¡§å®¢ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
                if (this.selectedCustomerForStudent) {
                    lastName = this.selectedCustomerForStudent.lastName;
                    firstName = this.selectedCustomerForStudent.firstName;
                    plan = document.getElementById('new_student_plan')?.value || '';
                } else {
                    lastName = document.getElementById('new_student_lastName')?.value || '';
                    firstName = document.getElementById('new_student_firstName')?.value || '';
                    plan = document.getElementById('new_student_plan')?.value || '';
                }
                if (!lastName || !firstName || !plan) {
                    alert('å§“åã¨ãƒ—ãƒ©ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                const { day, location, className } = this.selectedClassForAdd;
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);

                if (classIndex !== -1) {
                    const visitorPlans = ['ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰', 'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰', 'åˆå›ä½“é¨“'];
                    const newStudent = { lastName, firstName, plan };

                    // ãƒ“ã‚¸ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³ã®å ´åˆã€å‚åŠ æœˆã‚’è¨˜éŒ²
                    if (visitorPlans.includes(plan)) {
                        newStudent.visitorMonth = this.selectedMonth;
                    }

                    this.scheduleData[day][classIndex].students.push(newStudent);
                    this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(this.scheduleData[day][classIndex].students);

                    // Firestoreã«ä¿å­˜
                    await this.saveScheduleData();
                }
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.selectedCustomerForStudent = null;
                
                // ãƒ“ã‚¸ã‚¿ãƒ¼è¿½åŠ ç”¨
                this.showVisitorModal = false;
                this.visitorData = {};
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.render();
                alert('ç”Ÿå¾’ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            }
            // ç”Ÿå¾’ã®ç·¨é›†ã‚’é–‹å§‹
            startEditStudent(day, location, className, lastName, firstName) {
                this.editingStudent = { day, location, className, lastName, firstName };
                this.render();
            }
            // ç”Ÿå¾’æƒ…å ±ã®ä¿å­˜
            async saveEditStudent() {
                const newPlan = document.getElementById('edit_student_plan')?.value;
                if (!newPlan) {
                    alert('ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                const { day, location, className, lastName, firstName } = this.editingStudent;
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    const studentIndex = this.scheduleData[day][classIndex].students.findIndex(
                        s => s.lastName === lastName && s.firstName === firstName
                    );
                    
                    if (studentIndex !== -1) {
                        this.scheduleData[day][classIndex].students[studentIndex].plan = newPlan;
                        this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(this.scheduleData[day][classIndex].students);
                        
                        // Firestoreã«ä¿å­˜
                        await this.saveScheduleData();
                    }
                }
                this.editingStudent = null;
                this.render();
                alert('ç”Ÿå¾’æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            }
            // ç”Ÿå¾’ã®å‰Šé™¤
            async deleteStudent(day, location, className, lastName, firstName) {
                if (!confirm(`${lastName} ${firstName} ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                    return;
                }
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    this.scheduleData[day][classIndex].students = this.scheduleData[day][classIndex].students.filter(
                        s => !(s.lastName === lastName && s.firstName === firstName)
                    );
                    
                    // Firestoreã«ä¿å­˜
                    await this.saveScheduleData();
                }
                // å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
                const studentKey = `${day}_${location}_${className}_${lastName}${firstName}`;
                const monthKey = this.selectedMonth.replace('-', '');
                try {
                    await deleteDoc(doc(db, `attendance_${monthKey}`, studentKey));
                } catch (error) {
                    console.log('å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰');
                }
                await this.loadAttendance();
                this.render();
                alert('ç”Ÿå¾’ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
            calculateVisitorRevenue() {
                let revenue = 0;
                const monthKey = this.selectedMonth.replace('-', '');
                
                Object.keys(this.attendanceData).forEach(key => {
                    const attendance = this.attendanceData[key];
                    const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                    
                    weeks.forEach(week => {
                        if (attendance[week] === 'â—‹') {
                            // keyã‹ã‚‰ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€scheduleDataã‹ã‚‰æ¤œç´¢
                            const parts = key.split('_');
                            const day = parts[0];
                            const location = parts[1];
                            const className = parts[2];
                            const studentName = parts.slice(3).join('_');
                            
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            const student = classData?.students.find(s => `${s.lastName}${s.firstName}` === studentName);
                            
                            // ãƒ“ã‚¸ã‚¿ãƒ¼ã€ä½“é¨“ã€ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®ã¿å£²ä¸Šã«è¨ˆä¸Š
                            if (student && (student.plan.includes('ãƒ“ã‚¸ã‚¿ãƒ¼') || student.plan.includes('ä½“é¨“') || student.plan.includes('ç„¡æ–™'))) {
                                if (this.pricing[student.plan]) {
                                    revenue += this.pricing[student.plan];
                                }
                            }
                        }
                    });
                });
                
                return revenue;
            }
            // å‡ºå¸­ç°¿é–¢é€£ã®ãƒ¡ã‚½ãƒƒãƒ‰
            async loadAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const querySnapshot = await getDocs(collection(db, `attendance_${monthKey}`));
                    this.attendanceData = {};
                    querySnapshot.docs.forEach(doc => {
                        this.attendanceData[doc.id] = doc.data();
                    });
                } catch (error) {
                    console.error('å‡ºå¸­ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.attendanceData = {};
                }
            }
            // ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ã®å‡ºå¸­ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async loadEventAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const querySnapshot = await getDocs(collection(db, `event_attendance_${monthKey}`));
                    this.eventAttendanceData = [];
                    querySnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        this.eventAttendanceData.push({
                            id: doc.id,
                            isMember: data.isMember || false,
                            ...data
                        });
                    });
                    // ä¸¦ã³é †ã‚’ä¿æŒã™ã‚‹ãŸã‚ã€indexã§ã‚½ãƒ¼ãƒˆ
                    this.eventAttendanceData.sort((a, b) => (a.index || 0) - (b.index || 0));
                } catch (error) {
                    console.error('ã‚¤ãƒ™ãƒ³ãƒˆå‡ºå¸­ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.eventAttendanceData = [];
                }
            }
            // ã‚¤ãƒ™ãƒ³ãƒˆå‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            async saveEventAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆindexã‚’è¿½åŠ ï¼‰
                    for (let i = 0; i < this.eventAttendanceData.length; i++) {
                        const data = this.eventAttendanceData[i];
                        const docId = data.id || `event_${Date.now()}_${i}`;
                        const docRef = doc(db, `event_attendance_${monthKey}`, docId);
                        await setDoc(docRef, {
                            isMember: data.isMember || false,
                            lastName: data.lastName || '',
                            firstName: data.firstName || '',
                            week1: data.week1 || 'Ã—',
                            week2: data.week2 || 'Ã—',
                            week3: data.week3 || 'Ã—',
                            fee: data.fee || 0,
                            memo: data.memo || '',
                            index: i
                        });
                        if (!data.id) {
                            this.eventAttendanceData[i].id = docId;
                        }
                    }
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('ã‚¤ãƒ™ãƒ³ãƒˆå‡ºå¸­ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            // ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ è€…ã‚’è¿½åŠ 
            addEventParticipant() {
                this.eventAttendanceData.push({
                    id: null,
                    isMember: false,
                    lastName: '',
                    firstName: '',
                    week1: 'Ã—',
                    week2: 'Ã—',
                    week3: 'Ã—',
                    fee: 0,
                    memo: ''
                });
                this.render();
            }
            // ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ è€…ã‚’å‰Šé™¤
            async deleteEventParticipant(index) {
                if (!confirm('ã“ã®å‚åŠ è€…ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    return;
                }
                
                const participant = this.eventAttendanceData[index];
                if (participant.id) {
                    try {
                        const monthKey = this.selectedMonth.replace('-', '');
                        await deleteDoc(doc(db, `event_attendance_${monthKey}`, participant.id));
                    } catch (error) {
                        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                this.eventAttendanceData.splice(index, 1);
                await this.saveEventAttendance();
                this.render();
            }
            // ã‚¤ãƒ™ãƒ³ãƒˆã®åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
            calculateEventTotal() {
                return this.eventAttendanceData.reduce((sum, p) => sum + (parseFloat(p.fee) || 0), 0);
            }

            // ãƒ“ã‚¸ã‚¿ãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            openVisitorModal(day, location, className) {
                this.showVisitorModal = true;
                this.visitorData = {
                    day: day,
                    location: location,
                    className: className,
                    lastName: '',
                    firstName: '',
                    plan: 'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰',
                    weeks: []
                };
                this.render();
            }

            // ãƒ“ã‚¸ã‚¿ãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            closeVisitorModal() {
                this.showVisitorModal = false;
                this.render();
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            async downloadBackup() {
                try {
                    const backup = {
                        timestamp: new Date().toISOString(),
                        description: 'posse dance academy ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—',
                        version: '1.0',
                        selectedMonth: this.selectedMonth,
                        data: {
                            scheduleData: JSON.parse(JSON.stringify(this.scheduleData)),
                            attendanceData: JSON.parse(JSON.stringify(this.attendanceData)),
                            customers: JSON.parse(JSON.stringify(this.customers)),
                            eventAttendanceData: JSON.parse(JSON.stringify(this.eventAttendanceData))
                        }
                    };

                    const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateStr = new Date().toISOString().split('T')[0];
                    a.download = `firebase_backup_${dateStr}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            // èª¤ã£ã¦å¾©å…ƒã•ã‚ŒãŸç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            async cleanupDuplicateStudents() {
                try {
                    // 1. é¡§å®¢ãƒã‚¹ã‚¿ãƒ¼ã‚’å–å¾—
                    const customerNames = new Set();
                    this.customers.forEach(customer => {
                        const fullName = `${customer.lastName}${customer.firstName}`;
                        customerNames.add(fullName);
                    });

                    // 2. scheduleDataã‹ã‚‰é¡§å®¢ãƒã‚¹ã‚¿ãƒ¼ã«å­˜åœ¨ã—ãªã„ã€Œãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰ã€ãƒ—ãƒ©ãƒ³ã®ç”Ÿå¾’ã‚’æŠ½å‡º
                    const studentsToDelete = [];
                    Object.keys(this.scheduleData).forEach(day => {
                        this.scheduleData[day].forEach(classInfo => {
                            if (classInfo.students && classInfo.students.length > 0) {
                                classInfo.students.forEach((student, index) => {
                                    const fullName = `${student.lastName}${student.firstName}`;
                                    if (student.plan === 'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰' && !customerNames.has(fullName)) {
                                        studentsToDelete.push({
                                            day, location: classInfo.location, className: classInfo.name,
                                            lastName: student.lastName, firstName: student.firstName,
                                            plan: student.plan, index
                                        });
                                    }
                                });
                            }
                        });
                    });

                    if (studentsToDelete.length === 0) {
                        alert('âœ… å‰Šé™¤ã™ã‚‹å¿…è¦ã®ã‚ã‚‹ç”Ÿå¾’ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                        return;
                    }

                    const proceed = confirm(`${studentsToDelete.length}åã®èª¤ã£ã¦å¾©å…ƒã•ã‚ŒãŸç”Ÿå¾’ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\n\né¡§å®¢ãƒã‚¹ã‚¿ãƒ¼ã«å­˜åœ¨ã—ãªã„åå‰ã®ç”Ÿå¾’ã§ã™ã€‚\n\nå‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
                    if (!proceed) return;

                    // 3. å‰Šé™¤å‡¦ç†
                    const groupedByDay = {};
                    studentsToDelete.forEach(s => {
                        if (!groupedByDay[s.day]) groupedByDay[s.day] = {};
                        const classKey = `${s.location}_${s.className}`;
                        if (!groupedByDay[s.day][classKey]) groupedByDay[s.day][classKey] = [];
                        groupedByDay[s.day][classKey].push(s);
                    });

                    let deletedCount = 0;
                    Object.keys(groupedByDay).forEach(day => {
                        Object.keys(groupedByDay[day]).forEach(classKey => {
                            const students = groupedByDay[day][classKey];
                            const [location, ...classNameParts] = classKey.split('_');
                            const className = classNameParts.join('_');
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            if (classData && classData.students) {
                                students.sort((a, b) => b.index - a.index);
                                students.forEach(student => {
                                    classData.students.splice(student.index, 1);
                                    deletedCount++;
                                });
                            }
                        });
                    });

                    await this.saveScheduleData();
                    await this.loadScheduleData();
                    await this.loadAttendance();

                    alert(`âœ… ${deletedCount}åã®èª¤ã£ãŸç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼\n\nãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ“ã‚¸ã‚¿ãƒ¼å£²ä¸Šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    this.currentTab = 'dashboard';
                    this.render();
                } catch (error) {
                    console.error('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            // ãƒ“ã‚¸ã‚¿ãƒ¼å±¥æ­´ã‚’å¾©å…ƒ
            async restoreVisitorHistory() {
                try {
                    const missingStudents = [];
                    Object.keys(this.attendanceData).forEach(key => {
                        const parts = key.split('_');
                        if (parts.length >= 4) {
                            const day = parts[0], location = parts[1], className = parts[2], studentName = parts.slice(3).join('_');
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            if (classData) {
                                const student = classData.students?.find(s => `${s.lastName}${s.firstName}` === studentName);
                                if (!student) {
                                    const attendance = this.attendanceData[key];
                                    const hasAttendance = Object.values(attendance).some(v => v === 'â—‹');
                                    if (hasAttendance) {
                                        missingStudents.push({ key, day, location, className, studentName, attendance });
                                    }
                                }
                            }
                        }
                    });

                    if (missingStudents.length === 0) {
                        alert('âœ… ã™ã¹ã¦ã®ç”Ÿå¾’ãŒscheduleDataã«å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚å¾©å…ƒã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                        return;
                    }

                    const proceed = confirm(`${missingStudents.length}åã®ç”Ÿå¾’ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\n\nã“ã‚Œã‚‰ã‚’ã€Œãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰ã€ãƒ—ãƒ©ãƒ³ã§å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»å¾©å…ƒå¾Œã€å¿…è¦ã«å¿œã˜ã¦å‡ºå¸­è¨˜éŒ²ç”»é¢ã‹ã‚‰å€‹åˆ¥ã«ãƒ—ãƒ©ãƒ³ã‚’ç·¨é›†ã§ãã¾ã™ã€‚`);
                    if (!proceed) return;

                    let restoredCount = 0;
                    missingStudents.forEach(student => {
                        const lastName = student.studentName.length > 2 ? student.studentName.slice(0, -2) : student.studentName;
                        const firstName = student.studentName.length > 2 ? student.studentName.slice(-2) : '';
                        const classData = this.scheduleData[student.day]?.find(c => c.location === student.location && c.name === student.className);
                        if (classData) {
                            if (!classData.students) classData.students = [];
                            classData.students.push({ lastName, firstName, plan: 'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰' });
                            restoredCount++;
                        }
                    });

                    await this.saveScheduleData();
                    await this.loadScheduleData();
                    await this.loadAttendance();

                    alert(`âœ… ${restoredCount}åã®ãƒ“ã‚¸ã‚¿ãƒ¼å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼\n\nâ€»ãƒ—ãƒ©ãƒ³ã¯å…¨ã¦ã€Œãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰- Â¥2,000ã€ã§ã™ã€‚\nå®Ÿéš›ã®ãƒ—ãƒ©ãƒ³ãŒç•°ãªã‚‹å ´åˆã¯ã€å‡ºå¸­è¨˜éŒ²ç”»é¢ã‹ã‚‰ç·¨é›†ã—ã¦ãã ã•ã„ã€‚`);

                    this.currentTab = 'dashboard';
                    this.render();
                } catch (error) {
                    console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            // ãƒ“ã‚¸ã‚¿ãƒ¼å‚åŠ è€…ã‚’è¿½åŠ 
            async addVisitorParticipant() {
                const { day, location, className, lastName, firstName, plan, weeks } = this.visitorData;

                if (!lastName || !firstName) {
                    alert('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                if (!weeks || weeks.length === 0) {
                    alert('å‡ºå¸­ã™ã‚‹é€±ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                try {
                    // scheduleDataã«è¿½åŠ ï¼ˆã¾ã å­˜åœ¨ã—ãªã„å ´åˆï¼‰
                    const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                    if (classData) {
                        const existingStudent = classData.students.find(s => s.lastName === lastName && s.firstName === firstName);
                        if (!existingStudent) {
                            classData.students.push({
                                lastName: lastName,
                                firstName: firstName,
                                plan: plan,
                                visitorMonth: this.selectedMonth  // ãƒ“ã‚¸ã‚¿ãƒ¼å‚åŠ æœˆã‚’è¨˜éŒ²
                            });
                            await this.saveScheduleData();
                        }
                    }

                    // å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                    const studentKey = `${day}_${location}_${className}_${lastName}${firstName}`;
                    if (!this.attendanceData[studentKey]) {
                        this.attendanceData[studentKey] = {
                            week1: '-',
                            week2: '-',
                            week3: '-',
                            week4: '-',
                            week5: '-'
                        };
                    }

                    // é¸æŠã•ã‚ŒãŸé€±ã«å‡ºå¸­ã‚’ã¤ã‘ã‚‹
                    weeks.forEach(week => {
                        this.attendanceData[studentKey][week] = 'â—‹';
                    });

                    await this.saveAttendance(studentKey, this.attendanceData[studentKey]);
                    await this.loadAttendance();

                    this.showVisitorModal = false;
                    this.render();
                    alert(`ãƒ“ã‚¸ã‚¿ãƒ¼å‚åŠ è€…ã€Œ${lastName} ${firstName}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                } catch (error) {
                    console.error('ãƒ“ã‚¸ã‚¿ãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            async saveAttendance(studentId, weekData) {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const docRef = doc(db, `attendance_${monthKey}`, studentId);
                    await setDoc(docRef, weekData, { merge: true });
                    await this.loadAttendance();
                } catch (error) {
                    console.error('å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            toggleAttendance(classId, week) {
                const current = this.attendanceData[classId]?.[week] || '';
                const next = current === 'â—‹' ? 'Ã—' : current === 'Ã—' ? 'ä¼‘è¬›' : current === 'ä¼‘è¬›' ? '' : 'â—‹';
                
                if (!this.attendanceData[classId]) {
                    this.attendanceData[classId] = {};
                }
                this.attendanceData[classId][week] = next;
                
                this.saveAttendance(classId, this.attendanceData[classId]);
                this.render();
            }
            getAttendanceRate(classId) {
                const data = this.attendanceData[classId] || {};
                const weeks = ['week1', 'week2', 'week3', 'week4']; // äºˆå‚™é€±ã‚’é™¤å¤–
                const attended = weeks.filter(w => data[w] === 'â—‹').length;
                const recorded = weeks.filter(w => data[w] === 'â—‹' || data[w] === 'Ã—').length; // ä¼‘è¬›ã‚’é™¤å¤–
                return recorded > 0 ? Math.round((attended / recorded) * 100) : 0;
            }
            // æœˆåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’ä¿®æ­£
            async changeMonth(direction) {
                this.isLoading = true;
                this.render();
                
                try {
                    // ç¾åœ¨ã®å¹´æœˆã‚’å–å¾—
                    const [currentYear, currentMonth] = this.selectedMonth.split('-').map(Number);
                    
                    // æ–°ã—ã„å¹´æœˆã‚’è¨ˆç®—
                    let newYear = currentYear;
                    let newMonth = currentMonth + direction;
                    
                    // æœˆã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ã¨å¹´ã®èª¿æ•´
                    if (newMonth > 12) {
                        newMonth = 1;
                        newYear++;
                    } else if (newMonth < 1) {
                        newMonth = 12;
                        newYear--;
                    }
                    
                    // YYYY-MMå½¢å¼ã«å¤‰æ›ï¼ˆæœˆã¯2æ¡ã«ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
                    this.selectedMonth = `${newYear}-${String(newMonth).padStart(2, '0')}`;
                    
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('æœˆåˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }
            // æœˆã‚’ç›´æ¥é¸æŠ
            async selectMonth(monthValue) {
                if (!monthValue) return;
                
                this.isLoading = true;
                this.selectedMonth = monthValue;
                this.render();
                
                try {
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('æœˆé¸æŠã‚¨ãƒ©ãƒ¼:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }
            // ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒ©ã‚¹è¿½åŠ æ©Ÿèƒ½
            addClassToEvent() {
                this.showAddClassForm = true;
                this.render();
            }
            async saveNewClass() {
                const className = document.getElementById('new_class_name')?.value || '';
                const location = document.getElementById('new_class_location')?.value || 'å¤©ç¥';
                const color = document.getElementById('new_class_color')?.value || 'red';
                if (!className) {
                    alert('ã‚¯ãƒ©ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                this.scheduleData['ã‚¤ãƒ™ãƒ³ãƒˆ'].push({
                    location,
                    name: className,
                    color,
                    students: []
                });
                
                // Firestoreã«ä¿å­˜
                await this.saveScheduleData();
                
                this.showAddClassForm = false;
                this.render();
                alert('ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            }
            renderAttendance() {
                return `
                    <div>
                        <div class="bg-white rounded-lg shadow mb-6">
                            <div class="border-b">
                                <div class="flex">
                                    <button id="attendanceOverviewTab" class="px-6 py-3 font-medium ${this.attendanceTab === 'overview' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:text-blue-600'}">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
                                    <button id="attendanceRecordTab" class="px-6 py-3 font-medium ${this.attendanceTab === 'record' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:text-blue-600'}">ğŸ“ å‡ºå¸­è¨˜éŒ²</button>
                                </div>
                            </div>
                        </div>
                        ${this.attendanceTab === 'overview' ? this.renderAttendanceOverview() : this.renderAttendanceRecord()}
                    </div>
                `;
            }
            renderAttendanceOverview() {
                const [year, month] = this.selectedMonth.split('-');
                
                // å…¨æ›œæ—¥ã®ã‚¯ãƒ©ã‚¹æ•°ã¨ç”Ÿå¾’æ•°ã‚’é›†è¨ˆï¼ˆãƒ“ã‚¸ã‚¿ãƒ¼å‚åŠ è€…ã¯ç¾åœ¨ã®æœˆã®ã‚‚ã®ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆï¼‰
                const visitorPlans = ['ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰', 'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰', 'åˆå›ä½“é¨“'];
                let totalClasses = 0;
                let totalStudents = 0;
                Object.keys(this.scheduleData).forEach(day => {
                    totalClasses += this.scheduleData[day].length;
                    this.scheduleData[day].forEach(cls => {
                        const filteredStudents = cls.students.filter(student => {
                            if (visitorPlans.includes(student.plan)) {
                                // visitorMonthãŒãªã„å ´åˆï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼‰ã¯å¸¸ã«è¡¨ç¤ºã€ã‚ã‚‹å ´åˆã¯ç¾åœ¨ã®æœˆã¨ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿è¡¨ç¤º
                                return !student.visitorMonth || student.visitorMonth === this.selectedMonth;
                            }
                            return true;
                        });
                        totalStudents += filteredStudents.length;
                    });
                });
                const dayStats = Object.keys(this.scheduleData).map(day => {
                    const classes = this.scheduleData[day];
                    const studentCount = classes.reduce((sum, cls) => {
                        const filteredStudents = cls.students.filter(student => {
                            if (visitorPlans.includes(student.plan)) {
                                // visitorMonthãŒãªã„å ´åˆï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼‰ã¯å¸¸ã«è¡¨ç¤ºã€ã‚ã‚‹å ´åˆã¯ç¾åœ¨ã®æœˆã¨ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿è¡¨ç¤º
                                return !student.visitorMonth || student.visitorMonth === this.selectedMonth;
                            }
                            return true;
                        });
                        return sum + filteredStudents.length;
                    }, 0);
                    return { day, classCount: classes.length, studentCount };
                });
                const visitorRevenue = this.calculateVisitorRevenue();
                
                // ãƒ“ã‚¸ã‚¿ãƒ¼åˆ¥å£²ä¸Šè¨ˆç®—
                const visitorBreakdown = {};
                Object.keys(this.attendanceData).forEach(key => {
                    const attendance = this.attendanceData[key];
                    const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                    
                    weeks.forEach(week => {
                        if (attendance[week] === 'â—‹') {
                            const parts = key.split('_');
                            const day = parts[0];
                            const location = parts[1];
                            const className = parts[2];
                            const studentName = parts.slice(3).join('_');
                            
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            const student = classData?.students.find(s => `${s.lastName}${s.firstName}` === studentName);
                            
                            // ãƒ“ã‚¸ã‚¿ãƒ¼ã€ä½“é¨“ã€ç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚’å¯¾è±¡ã¨ã™ã‚‹
                            if (student && (student.plan.includes('ãƒ“ã‚¸ã‚¿ãƒ¼') || student.plan.includes('ä½“é¨“') || student.plan.includes('ç„¡æ–™'))) {
                                const price = this.pricing[student.plan] || 0;
                                if (!visitorBreakdown[student.plan]) {
                                    visitorBreakdown[student.plan] = { count: 0, revenue: 0 };
                                }
                                visitorBreakdown[student.plan].count++;
                                visitorBreakdown[student.plan].revenue += price;
                            }
                        }
                    });
                });
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800">å‡ºå¸­çŠ¶æ³</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition">â—€ å‰æœˆ</button>
                                <input 
                                    type="month" 
                                    id="monthSelectorOverview" 
                                    value="${this.selectedMonth}" 
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition">æ¬¡æœˆ â–¶</button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">ç·ã‚¯ãƒ©ã‚¹æ•°</div>
                                <div class="text-4xl font-bold text-blue-600">${totalClasses}</div>
                                <div class="text-xs text-gray-500 mt-2">ã‚¯ãƒ©ã‚¹</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">ç·ç”Ÿå¾’æ•°ï¼ˆå»¶ã¹ï¼‰</div>
                                <div class="text-4xl font-bold text-green-600">${totalStudents}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
                                <div class="text-gray-600 text-sm mb-2">ãƒ“ã‚¸ã‚¿ãƒ¼å£²ä¸Šï¼ˆä»Šæœˆï¼‰</div>
                                <div class="text-4xl font-bold text-yellow-600">Â¥${visitorRevenue.toLocaleString()}</div>
                                <div class="text-xs text-gray-500 mt-2">å††</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">æ›œæ—¥åˆ¥ã‚¯ãƒ©ã‚¹æ•°</h3>
                                <div class="space-y-3">
                                    ${dayStats.map(stat => `
                                        <div class="flex justify-between items-center p-3 border rounded hover:bg-gray-50">
                                            <span class="font-medium">${stat.day}</span>
                                            <div class="flex gap-4">
                                                <span class="text-gray-600">${stat.classCount}ã‚¯ãƒ©ã‚¹</span>
                                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">${stat.studentCount}å</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">ãƒ“ã‚¸ã‚¿ãƒ¼å£²ä¸Šå†…è¨³</h3>
                                <div class="space-y-3">
                                    ${Object.keys(visitorBreakdown).length > 0 ? Object.entries(visitorBreakdown).map(([plan, data]) => `
                                        <div class="flex justify-between items-center p-3 border rounded">
                                            <span class="font-medium">${plan}</span>
                                            <div class="flex gap-4">
                                                <span class="text-gray-600">${data.count}å›</span>
                                                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">Â¥${data.revenue.toLocaleString()}</span>
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-gray-500 text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ä½¿ã„æ–¹</h3>
                            <div class="space-y-2 text-gray-600">
                                <p>â€¢ ã€ŒğŸ“ å‡ºå¸­è¨˜éŒ²ã€ã‚¿ãƒ–ã‹ã‚‰å„æ›œæ—¥ã®ã‚¯ãƒ©ã‚¹ã®å‡ºå¸­ã‚’è¨˜éŒ²ã§ãã¾ã™</p>
                                <p>â€¢ ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ <span class="text-green-600 font-bold">â—‹</span> â†’ <span class="text-red-600 font-bold">Ã—</span> â†’ <span class="text-gray-600 font-bold">ä¼‘</span> â†’ <span class="text-gray-400 font-bold">-</span> ã¨åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™</p>
                                <p>â€¢ ã€Œäºˆå‚™ã€åˆ—ã¯æŒ¯æ›¿ã‚¯ãƒ©ã‚¹ç”¨ã§ã€å‡ºå¸­ç‡ã«ã¯å«ã¾ã‚Œã¾ã›ã‚“</p>
                                <p>â€¢ ã€Œä¼‘è¬›ã€ã¯å‡ºå¸­ç‡ã®è¨ˆç®—ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™</p>
                                <p>â€¢ å„ã‚¯ãƒ©ã‚¹ã«ã€Œç”Ÿå¾’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ–°è¦ç”Ÿå¾’ã‚’è¿½åŠ ã§ãã¾ã™</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            renderAttendanceRecord() {
                // ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ãƒ–ã¯å°‚ç”¨ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                if (this.selectedDay === 'ã‚¤ãƒ™ãƒ³ãƒˆ') {
                    return this.renderEventRecord();
                }
                const [year, month] = this.selectedMonth.split('-');
                const dayClasses = this.scheduleData[this.selectedDay] || [];
                if (this.isLoading) {
                    return `
                        <div class="flex items-center justify-center h-96">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                                <p class="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">å‡ºå¸­è¨˜éŒ²</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>â—€ å‰æœˆ</button>
                                <input
                                    type="month"
                                    id="monthSelector"
                                    value="${this.selectedMonth}"
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>æ¬¡æœˆ â–¶</button>
                                <button id="downloadBackupBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition text-sm font-semibold ml-4">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                                <button id="restoreVisitorBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded transition text-sm font-semibold ml-2">ğŸ”„ ãƒ“ã‚¸ã‚¿ãƒ¼å±¥æ­´ã‚’å¾©å…ƒ</button>
                                <button id="cleanupStudentsBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition text-sm font-semibold ml-2">ğŸ§¹ èª¤ã£ãŸç”Ÿå¾’ã‚’å‰Šé™¤</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow mb-4">
                            <div class="flex border-b overflow-x-auto">
                                ${['æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'ã‚¤ãƒ™ãƒ³ãƒˆ'].map(day => `
                                    <button id="day-${day}" class="px-4 py-2 text-sm font-medium whitespace-nowrap ${this.selectedDay === day ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'}">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        ${this.showAddStudentForm ? this.renderAddStudentForm() : ''}
                        ${dayClasses.map((classInfo, idx) => {
                            // ç¾åœ¨ã®æœˆã«è©²å½“ã™ã‚‹ç”Ÿå¾’ã®ã¿è¡¨ç¤ºï¼ˆãƒ“ã‚¸ã‚¿ãƒ¼å‚åŠ è€…ã¯å‚åŠ æœˆã®ã¿è¡¨ç¤ºï¼‰
                            const visitorPlans = ['ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰', 'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰', 'åˆå›ä½“é¨“'];
                            const filteredStudents = classInfo.students.filter(student => {
                                if (visitorPlans.includes(student.plan)) {
                                    // visitorMonthãŒãªã„å ´åˆï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼‰ã¯å¸¸ã«è¡¨ç¤ºã€ã‚ã‚‹å ´åˆã¯ç¾åœ¨ã®æœˆã¨ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿è¡¨ç¤º
                                    return !student.visitorMonth || student.visitorMonth === this.selectedMonth;
                                }
                                // é€šå¸¸ã®ä¼šå“¡ã¯å¸¸ã«è¡¨ç¤º
                                return true;
                            });
                            const sortedStudents = this.sortStudentsByPlan(filteredStudents);
                            return `
                                <div class="bg-white rounded-lg shadow mb-3">
                                    <div class="bg-${classInfo.color}-600 text-white px-4 py-2 rounded-t-lg flex justify-between items-center">
                                        <h3 class="text-base font-bold">${classInfo.location} - ${classInfo.name}</h3>
                                        <div class="flex gap-2 items-center">
                                            <span class="text-xs opacity-90">${sortedStudents.length}å</span>
                                            <button 
                                                data-add-day="${this.selectedDay}" 
                                                data-add-location="${classInfo.location}" 
                                                data-add-class="${classInfo.name}"
                                                class="add-student-btn bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-xs transition">
                                                + ç”Ÿå¾’è¿½åŠ 
                                            </button>
                                            <button
                                                data-visitor-day="${this.selectedDay}"
                                                data-visitor-location="${classInfo.location}"
                                                data-visitor-class="${classInfo.name}"
                                                class="add-visitor-btn bg-yellow-500 bg-opacity-90 hover:bg-opacity-100 px-2 py-1 rounded text-xs transition ml-1">
                                                ğŸ’° ãƒ“ã‚¸ã‚¿ãƒ¼
                                            </button>
                                        </div>
                                    </div>
                                    <div class="p-3 overflow-x-auto">
                                        <table class="w-full text-xs">
                                            <thead>
                                                <tr class="bg-gray-50 border-b">
                                                    <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">æ°å</th>
                                                    <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">ãƒ—ãƒ©ãƒ³</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç¬¬1é€±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç¬¬2é€±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç¬¬3é€±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç¬¬4é€±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">äºˆå‚™</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 60px;">å‡ºå¸­ç‡</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç·¨é›†</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${sortedStudents.map(student => {
                                                    const studentKey = `${this.selectedDay}_${classInfo.location}_${classInfo.name}_${student.lastName}${student.firstName}`;
                                                    const attendance = this.attendanceData[studentKey] || {};
                                                    const rate = this.getAttendanceRate(studentKey);
                                                    const isEditing = this.editingStudent && 
                                                                     this.editingStudent.day === this.selectedDay &&
                                                                     this.editingStudent.location === classInfo.location &&
                                                                     this.editingStudent.className === classInfo.name &&
                                                                     this.editingStudent.lastName === student.lastName &&
                                                                     this.editingStudent.firstName === student.firstName;
                                                    
                                                    if (isEditing) {
                                                        return `
                                                            <tr class="border-b bg-blue-50">
                                                                <td class="px-2 py-2 text-xs">${student.lastName} ${student.firstName}</td>
                                                                <td class="px-2 py-2 text-xs">
                                                                    <select id="edit_student_plan" class="w-full border rounded px-1 py-1 text-xs">
                                                                        <option value="ï¼”ã‚¯ãƒ©ã‚¹" ${student.plan === 'ï¼”ã‚¯ãƒ©ã‚¹' ? 'selected' : ''}>ï¼”ã‚¯ãƒ©ã‚¹</option>
                                                                        <option value="ï¼“ã‚¯ãƒ©ã‚¹" ${student.plan === 'ï¼“ã‚¯ãƒ©ã‚¹' ? 'selected' : ''}>ï¼“ã‚¯ãƒ©ã‚¹</option>
                                                                        <option value="ï¼’ã‚¯ãƒ©ã‚¹" ${student.plan === 'ï¼’ã‚¯ãƒ©ã‚¹' ? 'selected' : ''}>ï¼’ã‚¯ãƒ©ã‚¹</option>
                                                                        <option value="ï¼‘ã‚¯ãƒ©ã‚¹" ${student.plan === 'ï¼‘ã‚¯ãƒ©ã‚¹' ? 'selected' : ''}>ï¼‘ã‚¯ãƒ©ã‚¹</option>
                                                                        <option value="ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰" ${student.plan === 'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰' ? 'selected' : ''}>ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰</option>
                                                                        <option value="ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰" ${student.plan === 'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰' ? 'selected' : ''}>ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰</option>
                                                                        <option value="ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆæŒ¯æ›¿ï¼‰" ${student.plan === 'ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆæŒ¯æ›¿ï¼‰' ? 'selected' : ''}>ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆæŒ¯æ›¿ï¼‰</option>
                                                                        <option value="åˆå›ä½“é¨“" ${student.plan === 'åˆå›ä½“é¨“' ? 'selected' : ''}>åˆå›ä½“é¨“</option>
                                                                        <option value="åˆå›ç„¡æ–™" ${student.plan === 'åˆå›ç„¡æ–™' ? 'selected' : ''}>åˆå›ç„¡æ–™</option>
                                                                    </select>
                                                                </td>
                                                                ${['week1', 'week2', 'week3', 'week4', 'week5'].map(week => `
                                                                    <td class="px-2 py-2 text-center">
                                                                        <button 
                                                                            data-class="${studentKey}" 
                                                                            data-week="${week}"
                                                                            class="attendance-btn w-8 h-8 rounded border text-xs ${
                                                                                attendance[week] === 'â—‹' ? 'bg-green-500 border-green-600 text-white' :
                                                                                attendance[week] === 'Ã—' ? 'bg-red-500 border-red-600 text-white' :
                                                                                attendance[week] === 'ä¼‘è¬›' ? 'bg-gray-500 border-gray-600 text-white' :
                                                                                'bg-gray-100 border-gray-300 text-gray-400'
                                                                            } hover:opacity-80 transition font-bold">
                                                                            ${attendance[week] === 'ä¼‘è¬›' ? 'ä¼‘' : attendance[week] || '-'}
                                                                        </button>
                                                                    </td>
                                                                `).join('')}
                                                                <td class="px-2 py-2 text-center">
                                                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                                        rate >= 80 ? 'bg-green-100 text-green-800' :
                                                                        rate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                                        rate > 0 ? 'bg-red-100 text-red-800' :
                                                                        'bg-gray-100 text-gray-600'
                                                                    }">${rate > 0 ? rate + '%' : '-'}</span>
                                                                </td>
                                                                <td class="px-2 py-2 text-center">
                                                                    <div class="flex flex-col gap-1">
                                                                        <button 
                                                                            id="saveEditStudentBtn"
                                                                            class="text-green-600 hover:text-green-800 text-xs">
                                                                            ä¿å­˜
                                                                        </button>
                                                                        <button 
                                                                            id="cancelEditStudentBtn"
                                                                            class="text-gray-600 hover:text-gray-800 text-xs">
                                                                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                                                        </button>
                                                                        <button 
                                                                            data-delete-day="${this.selectedDay}"
                                                                            data-delete-location="${classInfo.location}"
                                                                            data-delete-class="${classInfo.name}"
                                                                            data-delete-lastname="${student.lastName}"
                                                                            data-delete-firstname="${student.firstName}"
                                                                            class="delete-student-btn text-red-600 hover:text-red-800 text-xs">
                                                                            å‰Šé™¤
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }
                                                    
                                                    return `
                                                        <tr class="border-b hover:bg-gray-50">
                                                            <td class="px-2 py-2 text-xs">${student.lastName} ${student.firstName}</td>
                                                            <td class="px-2 py-2 text-xs">${student.plan}</td>
                                                            ${['week1', 'week2', 'week3', 'week4', 'week5'].map(week => `
                                                                <td class="px-2 py-2 text-center">
                                                                    <button 
                                                                        data-class="${studentKey}" 
                                                                        data-week="${week}"
                                                                        class="attendance-btn w-8 h-8 rounded border text-xs ${
                                                                            attendance[week] === 'â—‹' ? 'bg-green-500 border-green-600 text-white' :
                                                                            attendance[week] === 'Ã—' ? 'bg-red-500 border-red-600 text-white' :
                                                                            attendance[week] === 'ä¼‘è¬›' ? 'bg-gray-500 border-gray-600 text-white' :
                                                                            'bg-gray-100 border-gray-300 text-gray-400'
                                                                        } hover:opacity-80 transition font-bold">
                                                                        ${attendance[week] === 'ä¼‘è¬›' ? 'ä¼‘' : attendance[week] || '-'}
                                                                    </button>
                                                                </td>
                                                            `).join('')}
                                                            <td class="px-2 py-2 text-center">
                                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                                    rate >= 80 ? 'bg-green-100 text-green-800' :
                                                                    rate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                                    rate > 0 ? 'bg-red-100 text-red-800' :
                                                                    'bg-gray-100 text-gray-600'
                                                                }">${rate > 0 ? rate + '%' : '-'}</span>
                                                            </td>
                                                            <td class="px-2 py-2 text-center">
                                                                <button 
                                                                    data-edit-student-day="${this.selectedDay}"
                                                                    data-edit-student-location="${classInfo.location}"
                                                                    data-edit-student-class="${classInfo.name}"
                                                                    data-edit-student-lastname="${student.lastName}"
                                                                    data-edit-student-firstname="${student.firstName}"
                                                                    class="edit-student-btn text-blue-600 hover:text-blue-800 text-xs">
                                                                    ç·¨é›†
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        ${dayClasses.length === 0 ? `
                            <div class="bg-white rounded-lg shadow p-12 text-center">
                                <p class="text-gray-500 text-lg">ã“ã®æ›œæ—¥ã«ã¯ã‚¯ãƒ©ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            renderAddStudentForm() {
                return `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                        <h3 class="text-base font-semibold mb-3 text-gray-800">ç”Ÿå¾’è¿½åŠ </h3>
                        
                        <!-- é¡§å®¢æ¤œç´¢ -->
                        <div class="mb-3">
                            <label class="block text-xs font-medium mb-1">é¡§å®¢æ¤œç´¢ï¼ˆæ°åãƒ»èª­ã¿ãƒ»ä¼šå“¡ç•ªå·ï¼‰</label>
                            <input 
                                type="text" 
                                id="student_search_input" 
                                value="${this.studentSearchTerm}"
                                class="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="ä¾‹: ä¸­å³¶ã€ãªã‹ã—ã¾ã€ãƒŠã‚«ã‚·ãƒã€nakashimaã€0001"
                                autocomplete="off"
                            />
                            <div class="text-xs text-gray-500 mt-1">ğŸ’¡ æ¼¢å­—ãƒ»ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»è‹±èªãƒ»ä¼šå“¡ç•ªå·ã§æ¤œç´¢ã§ãã¾ã™</div>
                            <!-- æ¤œç´¢çµæœè¡¨ç¤ºç”¨ã‚³ãƒ³ãƒ†ãƒŠ -->
                            <div id="searchResultsContainer">
                                ${this.studentSearchResults.length > 0 ? `
                                    <div class="mt-2 border rounded bg-white student-search-results shadow-lg">
                                        ${this.studentSearchResults.map(customer => `
                                            <div 
                                                data-select-customer-id="${customer.id}"
                                                class="select-customer-btn p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm transition">
                                                <div class="font-medium text-blue-600">
                                                    ${customer.lastName} ${customer.firstName}
                                                    ${customer.memberNumber ? `<span class="text-xs text-gray-500 ml-2">[${customer.memberNumber}]</span>` : ''}
                                                </div>
                                                <div class="text-xs text-gray-600 mt-1">
                                                    ${customer.reading ? `èª­ã¿: ${customer.reading}` : ''}
                                                    ${customer.reading && customer.course ? ' | ' : ''}
                                                    ${customer.course ? `ã‚³ãƒ¼ã‚¹: ${customer.course}` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : this.studentSearchTerm.trim() && this.studentSearchResults.length === 0 ? `
                                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                                        âš ï¸ è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ${this.selectedCustomerForStudent ? `
                            <div id="selectedCustomerInfo" class="mb-3 p-3 bg-green-50 border-2 border-green-400 rounded text-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-bold text-green-800">âœ“ é¸æŠä¸­: ${this.selectedCustomerForStudent.lastName} ${this.selectedCustomerForStudent.firstName}</div>
                                        <div class="text-xs text-gray-700 mt-1">
                                            ${this.selectedCustomerForStudent.memberNumber ? `ä¼šå“¡ç•ªå·: ${this.selectedCustomerForStudent.memberNumber} | ` : ''}
                                            ${this.selectedCustomerForStudent.reading ? `èª­ã¿: ${this.selectedCustomerForStudent.reading} | ` : ''}
                                            ã‚³ãƒ¼ã‚¹: ${this.selectedCustomerForStudent.course || 'ãªã—'}
                                        </div>
                                    </div>
                                    <button 
                                        id="clearSelectedCustomer"
                                        class="text-red-600 hover:text-red-800 text-xs underline">
                                        é¸æŠè§£é™¤
                                    </button>
                                </div>
                            </div>
                        ` : '<div id="selectedCustomerInfo"></div>'}
                        <div class="grid grid-cols-3 gap-3 mb-3">
                            <div id="nameInputContainer" class="${!this.selectedCustomerForStudent ? 'col-span-2 grid grid-cols-2 gap-3' : 'hidden'}">
                                <div>
                                    <label class="block text-xs font-medium mb-1">å§“ *</label>
                                    <input type="text" id="new_student_lastName" class="w-full border rounded px-2 py-1 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">å *</label>
                                    <input type="text" id="new_student_firstName" class="w-full border rounded px-2 py-1 text-sm">
                                </div>
                            </div>
                            <div id="planSelectContainer" class="${!this.selectedCustomerForStudent ? '' : 'col-span-3'}">
                                <label class="block text-xs font-medium mb-1">ãƒ—ãƒ©ãƒ³ *</label>
                                <select id="new_student_plan" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="ï¼”ã‚¯ãƒ©ã‚¹" ${this.selectedCustomerForStudent?.course === 'ï¼”' ? 'selected' : ''}>ï¼”ã‚¯ãƒ©ã‚¹</option>
                                    <option value="ï¼“ã‚¯ãƒ©ã‚¹" ${this.selectedCustomerForStudent?.course === 'ï¼“' ? 'selected' : ''}>ï¼“ã‚¯ãƒ©ã‚¹</option>
                                    <option value="ï¼’ã‚¯ãƒ©ã‚¹" ${this.selectedCustomerForStudent?.course === 'ï¼’' ? 'selected' : ''}>ï¼’ã‚¯ãƒ©ã‚¹</option>
                                    <option value="ï¼‘ã‚¯ãƒ©ã‚¹" ${this.selectedCustomerForStudent?.course === 'ï¼‘' ? 'selected' : ''}>ï¼‘ã‚¯ãƒ©ã‚¹</option>
                                    <option value="ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰">ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆä¼šå“¡ï¼‰</option>
                                    <option value="ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰">ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆéä¼šå“¡ï¼‰</option>
                                    <option value="ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆæŒ¯æ›¿ï¼‰">ãƒ“ã‚¸ã‚¿ãƒ¼ï¼ˆæŒ¯æ›¿ï¼‰</option>
                                    <option value="åˆå›ä½“é¨“">åˆå›ä½“é¨“</option>
                                    <option value="åˆå›ç„¡æ–™">åˆå›ç„¡æ–™</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 mb-3">
                            â€» é¡§å®¢ç®¡ç†ã‹ã‚‰ãƒ—ãƒ©ãƒ³ãŒè‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ãŒã€ãƒ“ã‚¸ã‚¿ãƒ¼ã¨ã—ã¦å—è¬›ã™ã‚‹å ´åˆã¯å¤‰æ›´ã—ã¦ãã ã•ã„
                        </div>
                        <div class="flex gap-2">
                            <button id="saveNewStudentBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">è¿½åŠ </button>
                            <button id="cancelAddStudentBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                `;
            }
            // ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderEventRecord() {
                const [year, month] = this.selectedMonth.split('-');
                const total = this.calculateEventTotal();
                if (this.isLoading) {
                    return `
                        <div class="flex items-center justify-center h-96">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                                <p class="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">ã‚¤ãƒ™ãƒ³ãƒˆå‡ºå¸­è¨˜éŒ²</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>â—€ å‰æœˆ</button>
                                <input 
                                    type="month" 
                                    id="monthSelector" 
                                    value="${this.selectedMonth}" 
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>æ¬¡æœˆ â–¶</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow mb-4">
                            <div class="flex border-b overflow-x-auto">
                                ${['æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'ã‚¤ãƒ™ãƒ³ãƒˆ'].map(day => `
                                    <button id="day-${day}" class="px-4 py-2 text-sm font-medium whitespace-nowrap ${this.selectedDay === day ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'}">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-gray-800">ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ è€…ä¸€è¦§</h3>
                                <button id="addEventParticipantBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-sm">
                                    + å‚åŠ è€…ã‚’è¿½åŠ 
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 100px;">æ°åï¼ˆå§“ï¼‰</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 100px;">æ°åï¼ˆåï¼‰</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">â‘ </th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">â‘¡</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">â‘¢</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 120px;">æ–™é‡‘ï¼ˆå††ï¼‰</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 200px;">å‚™è€ƒ</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 80px;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.eventAttendanceData.length === 0 ? `
                                            <tr>
                                                <td colspan="8" class="px-3 py-8 text-center text-gray-500">
                                                    å‚åŠ è€…ãŒã„ã¾ã›ã‚“ã€‚ã€Œ+ å‚åŠ è€…ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
                                                </td>
                                            </tr>
                                        ` : this.eventAttendanceData.map((participant, index) => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="lastName" 
                                                        data-event-index="${index}"
                                                        value="${participant.lastName || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="å§“"
                                                    />
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="firstName" 
                                                        data-event-index="${index}"
                                                        value="${participant.firstName || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="å"
                                                    />
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week1" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week1 === 'â—‹' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week1 === 'â—‹' ? 'â—‹' : 'Ã—'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week2" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week2 === 'â—‹' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week2 === 'â—‹' ? 'â—‹' : 'Ã—'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week3" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week3 === 'â—‹' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week3 === 'â—‹' ? 'â—‹' : 'Ã—'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="number" 
                                                        data-event-field="fee" 
                                                        data-event-index="${index}"
                                                        value="${participant.fee || 0}"
                                                        class="w-full border rounded px-2 py-1 text-sm text-right"
                                                        placeholder="0"
                                                        min="0"
                                                    />
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="memo" 
                                                        data-event-index="${index}"
                                                        value="${participant.memo || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="å‚™è€ƒ"
                                                    />
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-delete-event-index="${index}"
                                                        class="delete-event-participant-btn text-red-600 hover:text-red-800 text-xs">
                                                        å‰Šé™¤
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-blue-50 border-t-2 border-blue-300">
                                            <td colspan="5" class="px-3 py-4 text-right font-bold text-gray-800">åˆè¨ˆé‡‘é¡:</td>
                                            <td class="px-3 py-4 font-bold text-blue-600 text-lg">Â¥${total.toLocaleString()}</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="mt-6 p-4 bg-gray-50 rounded border">
                                <h4 class="font-semibold mb-2 text-sm">ä½¿ã„æ–¹</h4>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li>â€¢ æ°åãƒ»æ–™é‡‘ãƒ»å‚™è€ƒã¯ç›´æ¥å…¥åŠ›ã§ãã¾ã™</li>
                                    <li>â€¢ â‘ â‘¡â‘¢ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ <span class="text-green-600 font-bold">â—‹</span> â†’ <span class="text-red-600 font-bold">Ã—</span> â†’ <span class="text-gray-600 font-bold">ä¼‘</span> â†’ <span class="text-gray-400 font-bold">-</span> ã¨åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™</li>
                                    <li>â€¢ å…¥åŠ›å†…å®¹ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</li>
                                    <li>â€¢ æ–™é‡‘ã®åˆè¨ˆé‡‘é¡ãŒè‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã¾ã™</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            setupAttendanceEvents() {
                document.getElementById('attendanceOverviewTab')?.addEventListener('click', () => {
                    this.attendanceTab = 'overview';
                    this.render();
                });
                document.getElementById('attendanceRecordTab')?.addEventListener('click', () => {
                    this.attendanceTab = 'record';
                    this.render();
                });
                // æœˆé¸æŠinputã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå‡ºå¸­è¨˜éŒ²ï¼‰
                const monthSelector = document.getElementById('monthSelector');
                if (monthSelector) {
                    monthSelector.addEventListener('change', (e) => {
                        this.selectMonth(e.target.value);
                    });
                }
                // æœˆé¸æŠinputã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰
                const monthSelectorOverview = document.getElementById('monthSelectorOverview');
                if (monthSelectorOverview) {
                    monthSelectorOverview.addEventListener('change', (e) => {
                        this.selectMonth(e.target.value);
                    });
                }
                const prevMonthBtn = document.getElementById('prevMonth');
                const nextMonthBtn = document.getElementById('nextMonth');
                const prevMonthRecordBtn = document.getElementById('prevMonthRecord');
                const nextMonthRecordBtn = document.getElementById('nextMonthRecord');
                if (prevMonthBtn) {
                    prevMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(-1);
                    });
                }
                if (nextMonthBtn) {
                    nextMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(1);
                    });
                }
                if (prevMonthRecordBtn) {
                    prevMonthRecordBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(-1);
                    });
                }
                if (nextMonthRecordBtn) {
                    nextMonthRecordBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(1);
                    });
                }
                ['æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'ã‚¤ãƒ™ãƒ³ãƒˆ'].forEach(day => {
                    document.getElementById(`day-${day}`)?.addEventListener('click', () => {
                        this.selectedDay = day;
                        this.render();
                    });
                });
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const classId = btn.getAttribute('data-class');
                        const week = btn.getAttribute('data-week');
                        this.toggleAttendance(classId, week);
                    });
                });
                document.querySelectorAll('.add-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-add-day');
                        const location = btn.getAttribute('data-add-location');
                        const className = btn.getAttribute('data-add-class');
                        this.addStudentToClass(day, location, className);
                    });
                });
                // ç”Ÿå¾’ç·¨é›†ãƒœã‚¿ãƒ³
                document.querySelectorAll('.edit-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-edit-student-day');
                        const location = btn.getAttribute('data-edit-student-location');
                        const className = btn.getAttribute('data-edit-student-class');
                        const lastName = btn.getAttribute('data-edit-student-lastname');
                        const firstName = btn.getAttribute('data-edit-student-firstname');
                        this.startEditStudent(day, location, className, lastName, firstName);
                    });
                });
                // ç”Ÿå¾’å‰Šé™¤ãƒœã‚¿ãƒ³
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-delete-day');
                        const location = btn.getAttribute('data-delete-location');
                        const className = btn.getAttribute('data-delete-class');
                        const lastName = btn.getAttribute('data-delete-lastname');
                        const firstName = btn.getAttribute('data-delete-firstname');
                        this.deleteStudent(day, location, className, lastName, firstName);
                    });
                });
                // ç”Ÿå¾’ç·¨é›†ä¿å­˜ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                document.getElementById('saveEditStudentBtn')?.addEventListener('click', () => this.saveEditStudent());
                document.getElementById('cancelEditStudentBtn')?.addEventListener('click', () => {
                    this.editingStudent = null;
                    this.render();
                });
                // ç”Ÿå¾’æ¤œç´¢ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒã®ãŸã‚æ¤œç´¢çµæœã®ã¿æ›´æ–°
                const searchInput = document.getElementById('student_search_input');
                if (searchInput) {
                    // inputã‚¤ãƒ™ãƒ³ãƒˆã§æ¤œç´¢çµæœã®ã¿æ›´æ–°ï¼ˆå…¨ä½“ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„ï¼‰
                    searchInput.addEventListener('input', (e) => {
                        this.studentSearchTerm = e.target.value;
                        if (this.studentSearchTerm.trim()) {
                            this.studentSearchResults = this.searchCustomerByName(this.studentSearchTerm);
                        } else {
                            this.studentSearchResults = [];
                            this.selectedCustomerForStudent = null;
                        }
                        // æ¤œç´¢çµæœã®ã¿ã‚’æ›´æ–°ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¶­æŒï¼‰
                        this.updateSearchResults();
                    });
                    
                    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ã‚‚æ¤œç´¢çµæœã‚’è¡¨ç¤º
                    searchInput.addEventListener('focus', (e) => {
                        if (this.studentSearchTerm.trim()) {
                            this.studentSearchResults = this.searchCustomerByName(this.studentSearchTerm);
                            this.updateSearchResults();
                        }
                    });
                }
                // é¡§å®¢é¸æŠï¼ˆåˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ï¼‰
                document.querySelectorAll('.select-customer-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.getAttribute('data-select-customer-id');
                        const customer = this.customers.find(c => c.id === customerId);
                        if (customer) {
                            this.selectCustomerForStudent(customer);
                        }
                    });
                });
                // é¡§å®¢é¸æŠè§£é™¤ï¼ˆåˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ï¼‰
                document.getElementById('clearSelectedCustomer')?.addEventListener('click', () => {
                    this.selectedCustomerForStudent = null;
                    this.studentSearchTerm = '';
                    this.studentSearchResults = [];
                    this.updateSelectedCustomerInfo();
                    // æ¤œç´¢å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                    const searchInput = document.getElementById('student_search_input');
                    if (searchInput) searchInput.value = '';
                    // æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢
                    this.updateSearchResults();
                    // ãƒ—ãƒ©ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const planSelect = document.getElementById('new_student_plan');
                    if (planSelect) planSelect.value = '';
                });
                // ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                document.getElementById('addEventParticipantBtn')?.addEventListener('click', () => {
                    this.addEventParticipant();
                });
                // ã‚¤ãƒ™ãƒ³ãƒˆå‡ºå¸­ãƒœã‚¿ãƒ³
                document.querySelectorAll('.event-attendance-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-event-index'));
                        const week = btn.getAttribute('data-event-week');
                        const current = this.eventAttendanceData[index][week] || '';
                        const next = current === 'â—‹' ? 'Ã—' : 'â—‹';
                        this.eventAttendanceData[index][week] = next;
                        this.saveEventAttendance();
                        this.render();
                    });
                });
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…¥åŠ›
                document.querySelectorAll('[data-event-field]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-event-index'));
                        const field = e.target.getAttribute('data-event-field');
                        let value = e.target.value;
                        
                        // æ–™é‡‘ã¯æ•°å€¤ã«å¤‰æ›
                        if (field === 'fee') {
                            value = parseFloat(value) || 0;
                        }
                        
                        this.eventAttendanceData[index][field] = value;
                        this.saveEventAttendance();
                    });
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆæ–™é‡‘ã®ã¿ï¼‰
                    if (input.getAttribute('data-event-field') === 'fee') {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-event-index'));
                            const value = parseFloat(e.target.value) || 0;
                            this.eventAttendanceData[index].fee = value;
                            this.render();
                        });
                    }
                });
                // ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ è€…å‰Šé™¤
                document.querySelectorAll('.delete-event-participant-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-delete-event-index'));
                        this.deleteEventParticipant(index);
                    });
                });
                document.getElementById('saveNewStudentBtn')?.addEventListener('click', () => this.saveNewStudent());
                document.getElementById('cancelAddStudentBtn')?.addEventListener('click', () => {
                    this.showAddStudentForm = false;
                    this.selectedClassForAdd = null;
                    this.selectedCustomerForStudent = null;
                    this.studentSearchTerm = '';
                    this.studentSearchResults = [];
                    this.render();
                });

                // ãƒ“ã‚¸ã‚¿ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³
                document.querySelectorAll('.add-visitor-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.dataset.visitorDay;
                        const location = btn.dataset.visitorLocation;
                        const className = btn.dataset.visitorClass;
                        this.openVisitorModal(day, location, className);
                    });
                });

                // ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³
                document.getElementById('downloadBackupBtn')?.addEventListener('click', () => {
                    this.downloadBackup();
                });

                // ãƒ“ã‚¸ã‚¿ãƒ¼å±¥æ­´å¾©å…ƒãƒœã‚¿ãƒ³
                document.getElementById('restoreVisitorBtn')?.addEventListener('click', () => {
                    this.restoreVisitorHistory();
                });

                // èª¤ã£ãŸç”Ÿå¾’å‰Šé™¤ãƒœã‚¿ãƒ³
                document.getElementById('cleanupStudentsBtn')?.addEventListener('click', () => {
                    this.cleanupDuplicateStudents();
                });
            }
        }
        window.app = new DanceStudioApp();
        app.init();
    </script>
</body>
</html>
