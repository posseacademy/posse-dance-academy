<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>posse dance academy é¡§å®¢ç®¡çã·ã¹ãã </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
        }
        .tab-active { border-bottom: 3px solid #3B82F6; color: #3B82F6; }
        .status-tab-active { background-color: #3B82F6; color: white; }
        .status-badge-active { background-color: #10B981; color: white; }
        .status-badge-paused { background-color: #F59E0B; color: white; }
        .status-badge-withdrawn { background-color: #6B7280; color: white; }
        .gender-male { color: #2563EB; font-weight: 600; }
        .gender-female { color: #DC2626; font-weight: 600; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #F3F4F6; }
        .sort-icon { display: inline-block; margin-left: 4px; font-size: 10px; }
        
        table { table-layout: fixed; }
        td, th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        td.memo-cell { 
            white-space: normal !important;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.5;
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            vertical-align: top;
        }
        
        td.email-cell {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ã¯ã©ã¹å¥ã®è²åã */
        .class-red { background-color: #DC2626; }
        .class-orange { background-color: #EA580C; }
        .class-blue { background-color: #2563EB; }
        .class-green { background-color: #16A34A; }
        .class-purple { background-color: #9333EA; }
        
        .border-red-500 { border-color: #EF4444; }
        .border-orange-500 { border-color: #F97316; }
        .border-blue-500 { border-color: #3B82F6; }
        .border-green-500 { border-color: #22C55E; }
        .border-purple-500 { border-color: #A855F7; }
        
        .text-red-600 { color: #DC2626; }
        .text-orange-600 { color: #EA580C; }
        .text-blue-600 { color: #2563EB; }
        .text-green-600 { color: #16A34A; }
        .text-purple-600 { color: #9333EA; }
        
        .bg-red-600 { background-color: #DC2626; }
        .bg-orange-600 { background-color: #EA580C; }
        .bg-blue-600 { background-color: #2563EB; }
        .bg-green-600 { background-color: #16A34A; }
        .bg-purple-600 { background-color: #9333EA; }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .student-search-results {
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
        }
        
        .select-customer-btn:hover {
            background-color: #EFF6FF;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const firebaseConfig = {
            apiKey: "AIzaSyBp3_3UwgOKkILJuWx8usYdQhGfB_bAD34",
            authDomain: "posse-dance-academy.firebaseapp.com",
            projectId: "posse-dance-academy",
            storageBucket: "posse-dance-academy.firebasestorage.app",
            messagingSenderId: "613497046871",
            appId: "1:613497046871:web:8a31cbc6b947617113e012"
        };
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        class DanceStudioApp {
            constructor() {
                this.currentTab = 'dashboard';
                this.statusFilter = 'å¥ä¼ä¸­';
                this.customers = [];
                this.editingId = null;
                this.editForm = {};
                this.showAddForm = false;
                this.searchTerm = '';
                this.sortField = 'memberNumber';
                this.sortOrder = 'asc';
                this.newCustomer = this.getEmptyCustomer();
                
                // åºå¸­ç°¿ç¨
                this.attendanceTab = 'overview';
                this.selectedMonth = new Date().toISOString().slice(0, 7);
                this.selectedDay = 'æææ¥';
                this.attendanceData = {};
                this.eventAttendanceData = []; // ã¤ãã³ãå°ç¨ãã¼ã¿
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.isLoading = false;
                this.editingStudent = null; // ç·¨éä¸­ã®çå¾æå ±
                this.studentSearchTerm = ''; // çå¾æ¤ç´¢ç¨
                this.studentSearchResults = []; // æ¤ç´¢çµæ
                this.selectedCustomerForStudent = null; // é¸æãããé¡§å®¢æå ±
                
                this.pricing = {
                    '4ã¯ã©ã¹': 18600,
                    'ï¼ã¯ã©ã¹': 18600,
                    '3ã¯ã©ã¹': 14400,
                    'ï¼ã¯ã©ã¹': 14400,
                    '2ã¯ã©ã¹': 10000,
                    'ï¼ã¯ã©ã¹': 10000,
                    '1ã¯ã©ã¹': 6000,
                    'ï¼ã¯ã©ã¹': 6000,
                    '1.5hã¯ã©ã¹': 6600,
                    'ååä½é¨': 1000,
                    'ååç¡æ': 0,
                    'ãã¸ã¿ã¼ï¼ä¼å¡ï¼': 2000,
                    'ãã¸ã¿ã¼ï¼éä¼å¡ï¼': 2300,
                    'ãã¸ã¿ã¼1.5hï¼ä¼å¡ï¼': 2200,
                    'ãã¸ã¿ã¼1.5hï¼éä¼å¡ï¼': 2500,
                    'æè¬ã¯ã©ã¹æ¯æ¿': 1000,
                    'ç·´ç¿ä¼': 500
                };
                this.planOrder = {
                    '4ã¯ã©ã¹': 1,
                    'ï¼ã¯ã©ã¹': 1,
                    '3ã¯ã©ã¹': 2,
                    'ï¼ã¯ã©ã¹': 2,
                    '2ã¯ã©ã¹': 3,
                    'ï¼ã¯ã©ã¹': 3,
                    '1ã¯ã©ã¹': 4,
                    'ï¼ã¯ã©ã¹': 4,
                    '1.5hã¯ã©ã¹': 5,
                    'ãã¸ã¿ã¼ï¼ä¼å¡ï¼': 6,
                    'ãã¸ã¿ã¼ï¼éä¼å¡ï¼': 7,
                    'ãã¸ã¿ã¼ï¼æ¯æ¿ï¼': 8,
                    'ååä½é¨': 9,
                    'ååç¡æ': 10
                };
                this.scheduleData = {
                    'æææ¥': [
                        { location: 'å¤©ç¥', name: 'ã¢ã¯ã­ããã SOYA', color: 'red', students: [
                            { lastName: 'ä¸­å³¶', firstName: 'ç«å¾', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ä¼è¤', firstName: 'åé¦¬', plan: '1ã¯ã©ã¹' },
                            { lastName: 'åäº', firstName: 'é½é³', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ´¥ç', firstName: 'åµç', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ä¸éé', firstName: 'çç', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ã²ããã', firstName: 'ããã', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'å¶å·', firstName: 'é½å¤§', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: '', firstName: 'å¤§ç©º', plan: 'ï¼ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'ãã¬ã¤ã­ã³å¥é SOYA', color: 'orange', students: [
                            { lastName: 'æ´¥ç', firstName: 'åµç', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¦', firstName: 'è±æ¢¨', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ã²ããã', firstName: 'ããã', plan: 'ï¼ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'ãããã­ãã¯ ãããã¯ã¼ã¯ DAZ', color: 'blue', students: [
                            { lastName: 'ä¸­å³¶', firstName: 'ç«å¾', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'åäº', firstName: 'é½é³', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ä¼è¤', firstName: 'åé¦¬', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ä¸éé', firstName: 'çç', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¸ç°', firstName: 'å¯æ', plan: '1ã¯ã©ã¹' },
                            { lastName: 'æ£®è', firstName: 'é³³ä»', plan: '1ã¯ã©ã¹' },
                            { lastName: 'å¶å·', firstName: 'é½å¤§', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: '', firstName: 'å¤§ç©º', plan: 'ï¼ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'K-POP AI', color: 'green', students: [
                            { lastName: 'å¹³å¶', firstName: 'å½©ä½³', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ææ', firstName: 'æ©ç´', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ç³å', firstName: 'ç¾é»', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ç°ä»£', firstName: 'æå¥', plan: '1ã¯ã©ã¹' },
                            { lastName: 'å¯é', firstName: 'èç¶­', plan: '1ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'hiphop HIMEKA', color: 'purple', students: [
                            { lastName: 'ç³å', firstName: 'ç¾é»', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ä¸­å·', firstName: 'åé³', plan: 'ï¼ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤§æ©', name: 'hiphop HIMEKA', color: 'purple', students: [
                            { lastName: 'æ¸æ°´', firstName: 'ããã¿', plan: '1ã¯ã©ã¹' }
                        ]}
                    ],
                    'ç«ææ¥': [
                        { location: 'å¤§æ©', name: 'ã­ããºãã³ã¹ AYANO', color: 'red', students: [
                            { lastName: 'å¤è³', firstName: 'æäºº', plan: '1ã¯ã©ã¹' },
                            { lastName: 'å¤è³', firstName: 'å¯æå¦', plan: '1ã¯ã©ã¹' },
                            { lastName: 'åå£', firstName: 'çå¾', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ãããªã¹', firstName: 'ãã¨ã', plan: '1ã¯ã©ã¹' },
                            { lastName: 'å¯äº', firstName: 'è', plan: '1ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤§æ©', name: 'Bgirlã¯ã©ã¹ AYANO HARUHIKO', color: 'orange', students: [
                            { lastName: 'æç²', firstName: 'å¤§è¼ª', plan: '1ã¯ã©ã¹' }
                        ]},
                        { location: 'ç§è', name: 'ãã¬ã¤ã­ã³å¥é SOYA', color: 'blue', students: [
                            { lastName: 'è¥¿å', firstName: 'åæ', plan: '1ã¯ã©ã¹' },
                            { lastName: 'æ¦', firstName: 'è±æ¢¨', plan: 'ï¼ã¯ã©ã¹' }
                        ]},
                        { location: 'ç§è', name: 'ã¢ã¯ã­ï¼ãã¯ã¼ SOYA', color: 'green', students: [
                            { lastName: 'å ¤', firstName: 'åä»', plan: '1ã¯ã©ã¹' },
                            { lastName: 'åæ­¦', firstName: 'åä¿', plan: 'ï¼ã¯ã©ã¹' }
                        ]}
                    ],
                    'æ°´ææ¥': [
                        { location: 'å¤©ç¥', name: 'ãã¬ã¤ã­ã³åç´ HARUHIKO', color: 'red', students: [
                            { lastName: 'ç°å³¶', firstName: 'æ¸', plan: '1ã¯ã©ã¹' },
                            { lastName: 'åç°', firstName: 'æºå¹¸', plan: '1ã¯ã©ã¹' },
                            { lastName: 'æ¬æ©', firstName: 'å»å£«', plan: '1ã¯ã©ã¹' },
                            { lastName: 'éäº', firstName: 'å¤©åª', plan: '1ã¯ã©ã¹' },
                            { lastName: 'æ°è¤', firstName: 'å¤§å¸', plan: '1ã¯ã©ã¹' },
                            { lastName: 'èå·»', firstName: 'å¤§å', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ãã', firstName: 'ããã¨', plan: '1ã¯ã©ã¹' },
                            { lastName: 'è¤é', firstName: 'è¼å£«', plan: '1ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'ãã¬ã¤ã­ã³ä¸­ä¸ç´ HARUHIKO', color: 'orange', students: [
                            { lastName: 'æ£®ç°', firstName: 'ç¿ç', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ä¸­å±±', firstName: 'çµæ', plan: '1ã¯ã©ã¹' },
                            { lastName: '', firstName: 'å¤§ç©º', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'è¿«ç°', firstName: 'ããã', plan: '1ã¯ã©ã¹' }
                        ]}
                    ],
                    'æ¨ææ¥': [
                        { location: 'å¤§æ©', name: 'ãã¬ã¤ã­ã³å¥é SOYA', color: 'red', students: [
                            { lastName: 'è±ç¦', firstName: 'æ æ', plan: '1ã¯ã©ã¹' },
                            { lastName: 'åæ', firstName: 'å¤ªå£±', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ± ç°', firstName: 'å¨', plan: '1ã¯ã©ã¹' },
                            { lastName: 'æ¾¤æ±', firstName: 'æ ', plan: '1ã¯ã©ã¹' },
                            { lastName: 'åå£', firstName: 'è³¢ä¼¸', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¸¡é', firstName: 'åµå¤ª', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'è¤ç°', firstName: 'å°è', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'è¤ç°', firstName: 'åç¾½', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'å°æ³', firstName: 'åé½', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'å±±ä¸', firstName: 'å¹¸åé', plan: '1ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤§æ©', name: 'ã¢ã¯ã­ï¼ãã¯ã¼ SOYA', color: 'orange', students: [
                            { lastName: 'ä¸­å±±', firstName: 'çµæ', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'è±ç¦', firstName: 'æ æ', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'åæ', firstName: 'å¤ªå£±', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'åå£', firstName: 'è³¢ä¼¸', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'åäº', firstName: 'é½é³', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¸¡é', firstName: 'åµå¤ª', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'è©å', firstName: 'èé¦', plan: '1ã¯ã©ã¹' },
                            { lastName: 'å°æ³', firstName: 'åé½', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¾¤æ±', firstName: 'æ ', plan: '1ã¯ã©ã¹' }
                        ]},
                        { location: 'ç§è', name: 'ãã¬ã¤ã­ã³å¥é ãªã¥ã¦ã»ã¤', color: 'blue', students: [
                            { lastName: 'æ¥', firstName: 'ãã³ãã§ã³ã¨ã¤ãã³', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¥', firstName: 'ã¨ã¯ã½', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ãããã', firstName: 'ã¨ãã¾', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ãããã', firstName: 'ããã¾', plan: '1ã¯ã©ã¹' },
                            { lastName: 'æ¢é', firstName: 'å£®å¤§', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¢é', firstName: 'çµ¢é³', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'é·è°·å·', firstName: 'ä¸', plan: 'ï¼ã¯ã©ã¹' }
                        ]},
                        { location: 'ç§è', name: 'ã¢ã¯ã­ï¼ãã¯ã¼ ãªã¥ã¦ã»ã¤', color: 'green', students: [
                            { lastName: 'åæ­¦', firstName: 'åä¿', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¥', firstName: 'ãã³ãã§ã³ã¨ã¤ãã³', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¥', firstName: 'ã¨ã¯ã½', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'å·¥è¤', firstName: 'å¤§å°', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'é·è°·å·', firstName: 'ä¸', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¢é', firstName: 'å£®å¤§', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'æ¢é', firstName: 'çµ¢é³', plan: 'ï¼ã¯ã©ã¹' }
                        ]}
                    ],
                    'éææ¥': [
                        { location: 'å¤©ç¥', name: 'ã¢ã¯ã­ï¼ãã¯ã¼ SOYA', color: 'red', students: [
                            { lastName: 'ä¸­å³¶', firstName: 'ç«å¾', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ä¼è¤', firstName: 'åé¦¬', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'è¤é', firstName: 'è¼å£«', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ä¸­å±±', firstName: 'é¼', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ä¸éé', firstName: 'çç', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ãããã¾', firstName: 'ãã', plan: 'ï¼ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤©ç¥', name: 'ãã¬ã¤ã­ã³åä¸­ç´ HARUHIKO', color: 'orange', students: [
                            { lastName: 'ä¸­å³¶', firstName: 'ç«å¾', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ä¸éé', firstName: 'çç', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ãããã¾', firstName: 'ãã', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ä¼è¤', firstName: 'åé¦¬', plan: 'ï¼ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤§æ©', name: 'ãã¬ã¤ã­ã³å¥é HARUHIKO', color: 'blue', students: [
                            { lastName: 'è©å°¾', firstName: 'éæµ·', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ç¢é', firstName: 'æ°', plan: '1ã¯ã©ã¹' },
                            { lastName: 'ä¼è±æ°¸', firstName: 'æé¢', plan: '1ã¯ã©ã¹' },
                            { lastName: 'è¤å·', firstName: 'æ å©', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'è¤å·', firstName: 'æå©', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ä¸éé', firstName: 'ããª', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ä¹ä¿ç°', firstName: 'æ±é', plan: '1ã¯ã©ã¹' },
                            { lastName: 'å¤è³', firstName: 'å¿å¤ªé', plan: '1ã¯ã©ã¹' }
                        ]},
                        { location: 'å¤§æ©', name: 'ã¢ã¯ã­ï¼ãã¯ã¼ ryusei', color: 'green', students: [
                            { lastName: 'è©å°¾', firstName: 'éæµ·', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'è¤å·', firstName: 'æ å©', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'è¤å·', firstName: 'æå©', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'ä¸éé', firstName: 'ããª', plan: 'ï¼ã¯ã©ã¹' },
                            { lastName: 'åç', firstName: 'èæ', plan: '1ã¯ã©ã¹' }
                        ]}
                    ],
                    'ã¤ãã³ã': []
                };
            }
            getEmptyCustomer() {
                return {
                    memberNumber: '', status: 'å¥ä¼ä¸­', course: '', annualFee: '', hakomonoRegistration: '',
                    lastName: '', firstName: '', reading: '', guardianName: '', hakomonoName: '',
                    gender: '', birthDate: '', phone1: '', phone2: '', email: '',
                    postalCode: '', prefecture: '', city: '', address: '', building: '',
                    joinDate: '', memo: ''
                };
            }
            calculateAge(birthDate) {
                if (!birthDate) return '';
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age + 'æ­³';
            }
            async init() {
                await this.loadCustomers();
                await this.loadScheduleData();
                await this.loadAttendance();
                await this.loadEventAttendance();
                
                // å¨ã¯ã©ã¹ã®çå¾ããã©ã³é ã«ã½ã¼ã
                Object.keys(this.scheduleData).forEach(day => {
                    this.scheduleData[day].forEach(classInfo => {
                        classInfo.students = this.sortStudentsByPlan(classInfo.students);
                    });
                });
                
                this.render();
            }
            async loadCustomers() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'customers'));
                    this.customers = querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            status: data.status || (data.active === 'â' ? 'å¥ä¼ä¸­' : 'ä¼ä¼ä¸­')
                        };
                    });
                    // ã¯ã©ã¤ã¢ã³ãå´ã§ä¼å¡çªå·é ã«ã½ã¼ã
                    this.customers.sort((a, b) => {
                        const aNum = a.memberNumber || '';
                        const bNum = b.memberNumber || '';
                        return aNum > bNum ? 1 : -1;
                    });
                } catch (error) {
                    console.error('ãã¼ã¿èª­ã¿è¾¼ã¿ã¨ã©ã¼:', error);
                    this.customers = [];
                }
            }
            async loadScheduleData() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'schedule'));
                    if (querySnapshot.empty) {
                        // Firestoreã«ãã¼ã¿ããªãå ´åã¯åæãã¼ã¿ãä¿å­
                        console.log('ã¹ã±ã¸ã¥ã¼ã«ãã¼ã¿ãè¦ã¤ããã¾ãããåæãã¼ã¿ãä¿å­ãã¾ãã');
                        await this.saveScheduleData();
                    } else {
                        // Firestoreãããã¼ã¿ãèª­ã¿è¾¼ã¿
                        const loadedData = {};
                        querySnapshot.docs.forEach(doc => {
                            loadedData[doc.id] = doc.data().classes || [];
                        });
                        
                        // èª­ã¿è¾¼ãã ãã¼ã¿ã§scheduleDataãæ´æ°
                        if (Object.keys(loadedData).length > 0) {
                            this.scheduleData = loadedData;
                        }
                    }
                } catch (error) {
                    console.error('ã¹ã±ã¸ã¥ã¼ã«ãã¼ã¿èª­ã¿è¾¼ã¿ã¨ã©ã¼:', error);
                    // ã¨ã©ã¼ã®å ´åã¯åæãã¼ã¿ãä½¿ç¨
                }
            }
            async saveScheduleData() {
                try {
                    // åææ¥ã®ãã¼ã¿ãFirestoreã«ä¿å­
                    for (const day of Object.keys(this.scheduleData)) {
                        const docRef = doc(db, 'schedule', day);
                        await setDoc(docRef, {
                            classes: this.scheduleData[day]
                        });
                    }
                } catch (error) {
                    console.error('ã¹ã±ã¸ã¥ã¼ã«ãã¼ã¿ä¿å­ã¨ã©ã¼:', error);
                }
            }
            async addCustomer() {
                if (!this.newCustomer.lastName || !this.newCustomer.firstName) {
                    alert('æ°åãå¥åãã¦ãã ãã');
                    return;
                }
                if (!this.newCustomer.memberNumber) {
                    alert('ä¼å¡çªå·ãå¥åãã¦ãã ãã');
                    return;
                }
                try {
                    await addDoc(collection(db, 'customers'), this.newCustomer);
                    await this.loadCustomers();
                    this.newCustomer = this.getEmptyCustomer();
                    this.showAddForm = false;
                    this.render();
                    alert('ç»é²ãã¾ãã');
                } catch (error) {
                    console.error('ç»é²ã¨ã©ã¼:', error);
                    alert('ç»é²ã¨ã©ã¼: ' + error.message);
                }
            }
            async saveEdit() {
                if (!this.editForm.id) {
                    alert('ä¿å­ã¨ã©ã¼: IDãè¦ã¤ããã¾ãã');
                    return;
                }
                try {
                    const customerRef = doc(db, 'customers', this.editForm.id);
                    const { id, ...dataToSave } = this.editForm;
                    await updateDoc(customerRef, dataToSave);
                    await this.loadCustomers();
                    this.editingId = null;
                    this.editForm = {};
                    this.render();
                    alert('æ´æ°ãã¾ãã');
                } catch (error) {
                    console.error('æ´æ°ã¨ã©ã¼:', error);
                    alert('æ´æ°ã¨ã©ã¼: ' + error.message);
                }
            }
            async deleteCustomer(id) {
                if (!confirm('ãã®é¡§å®¢ãåé¤ãã¦ãããããã§ãã?')) return;
                try {
                    await deleteDoc(doc(db, 'customers', id));
                    await this.loadCustomers();
                    this.render();
                    alert('åé¤ãã¾ãã');
                } catch (error) {
                    console.error('åé¤ã¨ã©ã¼:', error);
                    alert('åé¤ã¨ã©ã¼: ' + error.message);
                }
            }
            startEdit(id) {
                this.editingId = id;
                const customer = this.customers.find(c => c.id === id);
                if (customer) {
                    this.editForm = { ...customer };
                    this.render();
                }
            }
            cancelEdit() {
                this.editingId = null;
                this.editForm = {};
                this.render();
            }
            updateEditField(field, value) {
                this.editForm[field] = value;
            }
            handleExport() {
                const headers = ['No', 'ä¼å¡çªå·', 'ä¼å¡ã¹ãã¼ã¿ã¹', 'ã³ã¼ã¹', 'å¹´ä¼è²»æ´æ°æ¥', 'æ°å', 'èª­ã¿', 'ä¿è­·èå', 'ãã³ã¢ãç»é²å', 'æ§å¥', 'çå¹´ææ¥', 'å¹´é½¢', 'é»è©±çªå·', 'ã¡ã¼ã«', 'å¥ä¼æ¥', 'éµä¾¿çªå·', 'é½éåºç', 'å¸åºçºæ', 'çªå°', 'å»ºç©ã»é¨å±çªå·', 'åè'];
                const rows = this.customers.map((c, i) => [
                    i + 1, c.memberNumber || '', c.status, c.course, c.annualFee,
                    `${c.lastName} ${c.firstName}`, c.reading, c.guardianName, c.hakomonoName, c.gender,
                    c.birthDate, this.calculateAge(c.birthDate), c.phone1, c.email, c.joinDate,
                    c.postalCode, c.prefecture, c.city, c.address, c.building, c.memo
                ].map(f => `"${f || ''}"`).join(','));
                const csv = [headers.join(','), ...rows].join('\n');
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `é¡§å®¢ç®¡ç_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }
            sortBy(field) {
                if (this.sortField === field) {
                    this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortField = field;
                    this.sortOrder = 'asc';
                }
                this.render();
            }
            getFilteredCustomers() {
                const s = this.searchTerm.toLowerCase();
                let filtered = this.customers.filter(c => 
                    c.status === this.statusFilter &&
                    ((c.lastName || '').toLowerCase().includes(s) ||
                    (c.firstName || '').toLowerCase().includes(s) ||
                    (c.reading || '').toLowerCase().includes(s) ||
                    (c.course || '').toLowerCase().includes(s) ||
                    (c.phone1 || '').includes(s) ||
                    (c.email || '').toLowerCase().includes(s) ||
                    (c.memberNumber || '').includes(s))
                );
                filtered.sort((a, b) => {
                    let aVal = a[this.sortField] || '';
                    let bVal = b[this.sortField] || '';
                    if (this.sortOrder === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
                return filtered;
            }
            render() {
                const filteredCustomers = this.getFilteredCustomers();
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen">
                        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
                            <div class="container mx-auto px-4 py-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-2xl font-bold">posse dance academy</h1>
                                        <p class="text-sm opacity-90">é¡§å®¢ç®¡çã·ã¹ãã </p>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <nav class="bg-white shadow">
                            <div class="container mx-auto px-4">
                                <div class="flex space-x-8">
                                    <button id="dashboardTab" class="py-4 px-2 font-medium ${this.currentTab === 'dashboard' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">ããã·ã¥ãã¼ã</button>
                                    <button id="customersTab" class="py-4 px-2 font-medium ${this.currentTab === 'customers' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">é¡§å®¢ç®¡ç</button>
                                    <button id="attendanceTab" class="py-4 px-2 font-medium ${this.currentTab === 'attendance' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">åºå¸­åç°¿</button>
                                </div>
                            </div>
                        </nav>
                        <main class="container mx-auto px-4 py-8">
                            ${this.currentTab === 'dashboard' ? this.renderDashboard() : 
                              this.currentTab === 'customers' ? this.renderCustomers(filteredCustomers) :
                              this.renderAttendance()}
                        </main>
                    </div>
                `;
                document.getElementById('dashboardTab')?.addEventListener('click', () => { this.currentTab = 'dashboard'; this.render(); });
                document.getElementById('customersTab')?.addEventListener('click', () => { this.currentTab = 'customers'; this.render(); });
                document.getElementById('attendanceTab')?.addEventListener('click', () => { this.currentTab = 'attendance'; this.render(); });
                if (this.currentTab === 'customers') {
                    this.setupCustomerPageEvents();
                } else if (this.currentTab === 'attendance') {
                    this.setupAttendanceEvents();
                }
            }
            setupCustomerPageEvents() {
                document.getElementById('exportBtn')?.addEventListener('click', () => this.handleExport());
                document.getElementById('toggleAddFormBtn')?.addEventListener('click', () => { this.showAddForm = !this.showAddForm; this.render(); });
                document.getElementById('searchInput')?.addEventListener('input', (e) => { this.searchTerm = e.target.value; this.render(); });
                document.getElementById('addCustomerBtn')?.addEventListener('click', () => this.addCustomer());
                document.getElementById('cancelAddBtn')?.addEventListener('click', () => { this.showAddForm = false; this.render(); });
                
                ['å¥ä¼ä¸­', 'ä¼ä¼ä¸­', 'éä¼æ¸ã¿'].forEach(status => {
                    document.getElementById(`status-${status}`)?.addEventListener('click', () => {
                        this.statusFilter = status;
                        this.render();
                    });
                });
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', () => {
                        this.sortBy(header.getAttribute('data-field'));
                    });
                });
                this.setupFormEvents();
                this.setupEditEvents();
            }
            setupFormEvents() {
                const fields = ['memberNumber', 'status', 'course', 'annualFee', 'lastName', 'firstName', 'reading', 'guardianName', 'hakomonoName', 'gender', 'birthDate', 'phone1', 'email', 'postalCode', 'prefecture', 'city', 'address', 'building', 'joinDate', 'memo'];
                fields.forEach(field => {
                    const el = document.getElementById(`new_${field}`);
                    if (el) {
                        el.addEventListener('change', (e) => { this.newCustomer[field] = e.target.value; });
                        el.addEventListener('input', (e) => { this.newCustomer[field] = e.target.value; });
                    }
                });
            }
            setupEditEvents() {
                document.querySelectorAll('[data-edit-action="start"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.startEdit(btn.getAttribute('data-id'));
                    });
                });
                document.querySelectorAll('[data-edit-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.deleteCustomer(btn.getAttribute('data-id'));
                    });
                });
                document.getElementById('saveEditBtn')?.addEventListener('click', () => this.saveEdit());
                document.getElementById('cancelEditBtn')?.addEventListener('click', () => this.cancelEdit());
                const editFields = ['memberNumber', 'status', 'course', 'annualFee', 'reading', 'guardianName', 'hakomonoName', 'gender', 'birthDate', 'phone1', 'email', 'postalCode', 'prefecture', 'city', 'address', 'building', 'joinDate', 'memo'];
                editFields.forEach(field => {
                    const el = document.getElementById(`edit_${field}`);
                    if (el) {
                        el.addEventListener('change', (e) => { this.updateEditField(field, e.target.value); });
                        el.addEventListener('input', (e) => { this.updateEditField(field, e.target.value); });
                    }
                });
                const nameField = document.getElementById('edit_fullName');
                if (nameField) {
                    nameField.addEventListener('input', (e) => {
                        const parts = e.target.value.split(' ');
                        this.editForm.lastName = parts[0] || '';
                        this.editForm.firstName = parts[1] || '';
                    });
                }
            }
            renderDashboard() {
                const total = this.customers.length;
                const activeCount = this.customers.filter(c => c.status === 'å¥ä¼ä¸­').length;
                const pausedCount = this.customers.filter(c => c.status === 'ä¼ä¼ä¸­').length;
                const withdrawnCount = this.customers.filter(c => c.status === 'éä¼æ¸ã¿').length;
                
                const coursePrices = {
                    'ï¼': 6000,
                    'ï¼': 10000,
                    'ï¼': 14400,
                    'ï¼': 18600
                };
                
                const courseCounts = {};
                this.customers.filter(c => c.status === 'å¥ä¼ä¸­').forEach(c => { 
                    if (c.course) courseCounts[c.course] = (courseCounts[c.course] || 0) + 1; 
                });
                
                let totalRevenue = 0;
                Object.entries(courseCounts).forEach(([course, count]) => {
                    if (coursePrices[course]) {
                        totalRevenue += coursePrices[course] * count;
                    }
                });
                return `
                    <div>
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">ããã·ã¥ãã¼ã</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">ç·é¡§å®¢æ°</div>
                                <div class="text-4xl font-bold text-blue-600">${total}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">å¥ä¼ä¸­</div>
                                <div class="text-4xl font-bold text-green-600">${activeCount}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">ä¼ä¼ä¸­</div>
                                <div class="text-4xl font-bold text-orange-600">${pausedCount}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">éä¼æ¸ã¿</div>
                                <div class="text-4xl font-bold text-gray-600">${withdrawnCount}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ã³ã¼ã¹å¥åè¨³ï¼å¥ä¼ä¸­ï¼</h3>
                            <div class="space-y-3">
                                ${Object.keys(courseCounts).length > 0 ? Object.entries(courseCounts).map(([course, count]) => {
                                    const price = coursePrices[course] || 0;
                                    const subtotal = price * count;
                                    return `
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">ã³ã¼ã¹${course || 'æªè¨­å®'}</span>
                                            <div class="flex gap-4 items-center">
                                                <span class="text-gray-600">Â¥${price.toLocaleString()} Ã ${count}å</span>
                                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">Â¥${subtotal.toLocaleString()}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('') : '<p class="text-gray-500">ãã¼ã¿ãããã¾ãã</p>'}
                                ${Object.keys(courseCounts).length > 0 ? `
                                    <div class="border-t pt-3 mt-3">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-lg">åè¨</span>
                                            <span class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-lg font-bold">Â¥${totalRevenue.toLocaleString()}</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            renderCustomers(filteredCustomers) {
                const getSortIcon = (field) => {
                    if (this.sortField === field) return this.sortOrder === 'asc' ? 'â²' : 'â¼';
                    return 'â¬';
                };
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800">é¡§å®¢ç®¡ç</h2>
                            <div class="flex gap-2">
                                <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-sm">CSVã¨ã¯ã¹ãã¼ã</button>
                                <button id="toggleAddFormBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">${this.showAddForm ? 'ãã©ã¼ã ãéãã' : 'æ°è¦ç»é²'}</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex gap-2 mb-4">
                                <button id="status-å¥ä¼ä¸­" class="px-4 py-2 rounded transition ${this.statusFilter === 'å¥ä¼ä¸­' ? 'status-tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    å¥ä¼ä¸­ (${this.customers.filter(c => c.status === 'å¥ä¼ä¸­').length})
                                </button>
                                <button id="status-ä¼ä¼ä¸­" class="px-4 py-2 rounded transition ${this.statusFilter === 'ä¼ä¼ä¸­' ? 'status-tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    ä¼ä¼ä¸­ (${this.customers.filter(c => c.status === 'ä¼ä¼ä¸­').length})
                                </button>
                                <button id="status-éä¼æ¸ã¿" class="px-4 py-2 rounded transition ${this.statusFilter === 'éä¼æ¸ã¿' ? 'status-tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    éä¼æ¸ã¿ (${this.customers.filter(c => c.status === 'éä¼æ¸ã¿').length})
                                </button>
                            </div>
                            <div class="mb-4">
                                <input type="text" id="searchInput" placeholder="ä¼å¡çªå·ãæ°åãã³ã¼ã¹ãé»è©±çªå·ãã¡ã¼ã«ã§æ¤ç´¢..." value="${this.searchTerm}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            ${this.showAddForm ? this.renderAddForm() : ''}
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 50px;">No</th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="memberNumber" style="width: 80px;">ä¼å¡çªå·<span class="sort-icon">${getSortIcon('memberNumber')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="status" style="width: 120px;">ä¼å¡ã¹ãã¼ã¿ã¹<span class="sort-icon">${getSortIcon('status')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="course" style="width: 80px;">ã³ã¼ã¹<span class="sort-icon">${getSortIcon('course')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="annualFee" style="width: 120px;">å¹´ä¼è²»æ´æ°æ¥<span class="sort-icon">${getSortIcon('annualFee')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="lastName" style="width: 150px;">æ°å<span class="sort-icon">${getSortIcon('lastName')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="reading" style="width: 150px;">èª­ã¿<span class="sort-icon">${getSortIcon('reading')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="guardianName" style="width: 120px;">ä¿è­·èå<span class="sort-icon">${getSortIcon('guardianName')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="hakomonoName" style="width: 120px;">ãã³ã¢ãç»é²å<span class="sort-icon">${getSortIcon('hakomonoName')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="gender" style="width: 60px;">æ§å¥<span class="sort-icon">${getSortIcon('gender')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="birthDate" style="width: 110px;">çå¹´ææ¥<span class="sort-icon">${getSortIcon('birthDate')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 70px;">å¹´é½¢</th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="phone1" style="width: 130px;">é»è©±çªå·<span class="sort-icon">${getSortIcon('phone1')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="email" style="width: 220px;">ã¡ã¼ã«<span class="sort-icon">${getSortIcon('email')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="joinDate" style="width: 110px;">å¥ä¼æ¥<span class="sort-icon">${getSortIcon('joinDate')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="postalCode" style="width: 100px;">éµä¾¿çªå·<span class="sort-icon">${getSortIcon('postalCode')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="prefecture" style="width: 90px;">é½éåºç<span class="sort-icon">${getSortIcon('prefecture')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="city" style="width: 120px;">å¸åºçºæ<span class="sort-icon">${getSortIcon('city')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="address" style="width: 150px;">çªå°<span class="sort-icon">${getSortIcon('address')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="building" style="width: 150px;">å»ºç©ã»é¨å±çªå·<span class="sort-icon">${getSortIcon('building')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 400px;">åè</th>
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 100px;">æä½</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredCustomers.map((c, i) => this.renderCustomerRow(c, i + 1)).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 text-sm text-gray-600">
                                ${this.statusFilter}: ${filteredCustomers.length}å
                            </div>
                        </div>
                    </div>
                `;
            }
            renderAddForm() {
                return `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">æ°è¦é¡§å®¢ç»é²</h3>
                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <div><label class="block text-sm font-medium mb-1">ä¼å¡çªå· *</label><input type="text" id="new_memberNumber" class="w-full border rounded px-2 py-1 text-sm" placeholder="ä¾: 0001"></div>
                            <div><label class="block text-sm font-medium mb-1">ä¼å¡ã¹ãã¼ã¿ã¹</label><select id="new_status" class="w-full border rounded px-2 py-1 text-sm"><option value="å¥ä¼ä¸­">å¥ä¼ä¸­</option><option value="ä¼ä¼ä¸­">ä¼ä¼ä¸­</option><option value="éä¼æ¸ã¿">éä¼æ¸ã¿</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">ã³ã¼ã¹</label><select id="new_course" class="w-full border rounded px-2 py-1 text-sm"><option value="">é¸æãã¦ãã ãã</option><option value="ãã¸ã¿ã¼">ãã¸ã¿ã¼</option><option value="ï¼">ï¼</option><option value="ï¼">ï¼</option><option value="ï¼">ï¼</option><option value="ï¼">ï¼</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">å¹´ä¼è²»æ´æ°æ¥</label><input type="date" id="new_annualFee" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">æ°å(å§) *</label><input type="text" id="new_lastName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">æ°å(å) *</label><input type="text" id="new_firstName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">èª­ã¿</label><input type="text" id="new_reading" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">ä¿è­·èå</label><input type="text" id="new_guardianName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">ãã³ã¢ãç»é²å</label><input type="text" id="new_hakomonoName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">æ§å¥</label><select id="new_gender" class="w-full border rounded px-2 py-1 text-sm"><option value="">é¸æ</option><option value="ç·">ç·</option><option value="å¥³">å¥³</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">çå¹´ææ¥</label><input type="date" id="new_birthDate" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">é»è©±çªå·</label><input type="tel" id="new_phone1" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div class="col-span-2"><label class="block text-sm font-medium mb-1">ã¡ã¼ã«</label><input type="email" id="new_email" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">å¥ä¼æ¥</label><input type="date" id="new_joinDate" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">éµä¾¿çªå·</label><input type="text" id="new_postalCode" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">é½éåºç</label><input type="text" id="new_prefecture" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">å¸åºçºæ</label><input type="text" id="new_city" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">çªå°</label><input type="text" id="new_address" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">å»ºç©ã»é¨å±çªå·</label><input type="text" id="new_building" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div class="col-span-3"><label class="block text-sm font-medium mb-1">åè</label><input type="text" id="new_memo" class="w-full border rounded px-2 py-1 text-sm"></div>
                        </div>
                        <div class="flex gap-2">
                            <button id="addCustomerBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">ç»é²</button>
                            <button id="cancelAddBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400 transition">ã­ã£ã³ã»ã«</button>
                        </div>
                    </div>
                `;
            }
            renderCustomerRow(customer, no) {
                const statusBadgeClass = customer.status === 'å¥ä¼ä¸­' ? 'status-badge-active' : customer.status === 'ä¼ä¼ä¸­' ? 'status-badge-paused' : 'status-badge-withdrawn';
                const genderClass = customer.gender === 'ç·' ? 'gender-male' : customer.gender === 'å¥³' ? 'gender-female' : '';
                const age = this.calculateAge(customer.birthDate);
                
                if (this.editingId === customer.id) {
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-2 py-3">${no}</td>
                            <td class="px-2 py-3"><input type="text" id="edit_memberNumber" value="${this.editForm.memberNumber || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><select id="edit_status" class="w-full border rounded px-1 py-1 text-xs"><option value="å¥ä¼ä¸­" ${this.editForm.status === 'å¥ä¼ä¸­' ? 'selected' : ''}>å¥ä¼ä¸­</option><option value="ä¼ä¼ä¸­" ${this.editForm.status === 'ä¼ä¼ä¸­' ? 'selected' : ''}>ä¼ä¼ä¸­</option><option value="éä¼æ¸ã¿" ${this.editForm.status === 'éä¼æ¸ã¿' ? 'selected' : ''}>éä¼æ¸ã¿</option></select></td>
                            <td class="px-2 py-3"><select id="edit_course" class="w-full border rounded px-1 py-1 text-xs"><option value="">é¸æ</option><option value="ãã¸ã¿ã¼" ${this.editForm.course === 'ãã¸ã¿ã¼' ? 'selected' : ''}>ãã¸ã¿ã¼</option><option value="ï¼" ${this.editForm.course === 'ï¼' ? 'selected' : ''}>ï¼</option><option value="ï¼" ${this.editForm.course === 'ï¼' ? 'selected' : ''}>ï¼</option><option value="ï¼" ${this.editForm.course === 'ï¼' ? 'selected' : ''}>ï¼</option><option value="ï¼" ${this.editForm.course === 'ï¼' ? 'selected' : ''}>ï¼</option></select></td>
                            <td class="px-2 py-3"><input type="date" id="edit_annualFee" value="${this.editForm.annualFee || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_fullName" value="${this.editForm.lastName || ''} ${this.editForm.firstName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_reading" value="${this.editForm.reading || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_guardianName" value="${this.editForm.guardianName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_hakomonoName" value="${this.editForm.hakomonoName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><select id="edit_gender" class="w-full border rounded px-1 py-1 text-xs"><option value="">-</option><option value="ç·" ${this.editForm.gender === 'ç·' ? 'selected' : ''}>ç·</option><option value="å¥³" ${this.editForm.gender === 'å¥³' ? 'selected' : ''}>å¥³</option></select></td>
                            <td class="px-2 py-3"><input type="date" id="edit_birthDate" value="${this.editForm.birthDate || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3 text-center">${this.calculateAge(this.editForm.birthDate)}</td>
                            <td class="px-2 py-3"><input type="tel" id="edit_phone1" value="${this.editForm.phone1 || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="email" id="edit_email" value="${this.editForm.email || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="date" id="edit_joinDate" value="${this.editForm.joinDate || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_postalCode" value="${this.editForm.postalCode || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_prefecture" value="${this.editForm.prefecture || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_city" value="${this.editForm.city || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_address" value="${this.editForm.address || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_building" value="${this.editForm.building || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3 memo-cell"><textarea id="edit_memo" class="w-full border rounded px-1 py-1 text-xs" rows="2">${this.editForm.memo || ''}</textarea></td>
                            <td class="px-2 py-3"><div class="flex flex-col gap-1"><button id="saveEditBtn" class="text-green-600 hover:text-green-800 text-xs">ä¿å­</button><button id="cancelEditBtn" class="text-gray-600 hover:text-gray-800 text-xs">ã­ã£ã³ã»ã«</button><button data-edit-action="delete" data-id="${customer.id}" class="text-red-600 hover:text-red-800 text-xs">åé¤</button></div></td>
                        </tr>
                    `;
                }
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-2 py-3">${no}</td>
                        <td class="px-2 py-3 font-mono">${customer.memberNumber || ''}</td>
                        <td class="px-2 py-3"><span class="px-2 py-1 rounded text-xs font-semibold ${statusBadgeClass}">${customer.status || ''}</span></td>
                        <td class="px-2 py-3">${customer.course || ''}</td>
                        <td class="px-2 py-3">${customer.annualFee || ''}</td>
                        <td class="px-2 py-3 font-medium">${customer.lastName || ''} ${customer.firstName || ''}</td>
                        <td class="px-2 py-3">${customer.reading || ''}</td>
                        <td class="px-2 py-3">${customer.guardianName || ''}</td>
                        <td class="px-2 py-3">${customer.hakomonoName || ''}</td>
                        <td class="px-2 py-3 text-center ${genderClass}">${customer.gender || ''}</td>
                        <td class="px-2 py-3">${customer.birthDate || ''}</td>
                        <td class="px-2 py-3 text-center">${age}</td>
                        <td class="px-2 py-3">${customer.phone1 || ''}</td>
                        <td class="px-2 py-3 email-cell">${customer.email || ''}</td>
                        <td class="px-2 py-3">${customer.joinDate || ''}</td>
                        <td class="px-2 py-3">${customer.postalCode || ''}</td>
                        <td class="px-2 py-3">${customer.prefecture || ''}</td>
                        <td class="px-2 py-3">${customer.city || ''}</td>
                        <td class="px-2 py-3">${customer.address || ''}</td>
                        <td class="px-2 py-3">${customer.building || ''}</td>
                        <td class="px-2 py-3 memo-cell">${customer.memo || ''}</td>
                        <td class="px-2 py-3"><button data-edit-action="start" data-id="${customer.id}" class="text-blue-600 hover:text-blue-800 text-xs">ç·¨é</button></td>
                    </tr>
                `;
            }
            sortStudentsByPlan(students) {
                return students.sort((a, b) => {
                    // ãã©ã³åãæ­£è¦åï¼å¨è§æ°å­ãåè§ã«å¤æï¼
                    const normalizePlan = (plan) => {
                        return plan.replace(/[ï¼-ï¼]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                    };
                    
                    const planA = normalizePlan(a.plan);
                    const planB = normalizePlan(b.plan);
                    
                    const orderA = this.planOrder[planA] || 999;
                    const orderB = this.planOrder[planB] || 999;
                    return orderA - orderB;
                });
            }
            // é¸æãããé¡§å®¢æå ±ã®è¡¨ç¤ºã®ã¿ãæ´æ°
            updateSelectedCustomerInfo() {
                const selectedInfoContainer = document.getElementById('selectedCustomerInfo');
                const planSelect = document.getElementById('new_student_plan');
                const nameInputContainer = document.getElementById('nameInputContainer');
                const planSelectContainer = document.getElementById('planSelectContainer');
                
                if (!selectedInfoContainer) return;
                
                if (this.selectedCustomerForStudent) {
                    selectedInfoContainer.innerHTML = `
                        <div class="mb-3 p-3 bg-green-50 border-2 border-green-400 rounded text-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold text-green-800">â é¸æä¸­: ${this.selectedCustomerForStudent.lastName} ${this.selectedCustomerForStudent.firstName}</div>
                                    <div class="text-xs text-gray-700 mt-1">
                                        ${this.selectedCustomerForStudent.memberNumber ? `ä¼å¡çªå·: ${this.selectedCustomerForStudent.memberNumber} | ` : ''}
                                        ${this.selectedCustomerForStudent.reading ? `èª­ã¿: ${this.selectedCustomerForStudent.reading} | ` : ''}
                                        ã³ã¼ã¹: ${this.selectedCustomerForStudent.course || 'ãªã'}
                                    </div>
                                </div>
                                <button 
                                    id="clearSelectedCustomer"
                                    class="text-red-600 hover:text-red-800 text-xs underline">
                                    é¸æè§£é¤
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // å§åå¥åæ¬ãéè¡¨ç¤º
                    if (nameInputContainer) {
                        nameInputContainer.classList.add('hidden');
                        nameInputContainer.classList.remove('col-span-2', 'grid', 'grid-cols-2', 'gap-3');
                    }
                    
                    // ãã©ã³ã»ã¬ã¯ãã®ã¹ã¿ã¤ã«ãèª¿æ´
                    if (planSelectContainer) {
                        planSelectContainer.classList.add('col-span-3');
                    }
                    
                    // é¸æè§£é¤ãã¿ã³ã®ã¤ãã³ããåè¨­å®
                    document.getElementById('clearSelectedCustomer')?.addEventListener('click', () => {
                        this.selectedCustomerForStudent = null;
                        this.studentSearchTerm = '';
                        this.studentSearchResults = [];
                        this.updateSelectedCustomerInfo();
                        // æ¤ç´¢å¥åæ¬ãã¯ãªã¢
                        const searchInput = document.getElementById('student_search_input');
                        if (searchInput) searchInput.value = '';
                        // æ¤ç´¢çµæãã¯ãªã¢
                        this.updateSearchResults();
                        // ãã©ã³ããªã»ãã
                        if (planSelect) planSelect.value = '';
                    });
                    
                    // ãã©ã³ãèªåè¨­å®
                    if (planSelect && this.selectedCustomerForStudent.course) {
                        const courseMap = {'ï¼': 'ï¼ã¯ã©ã¹', 'ï¼': 'ï¼ã¯ã©ã¹', 'ï¼': 'ï¼ã¯ã©ã¹', 'ï¼': 'ï¼ã¯ã©ã¹'};
                        const planValue = courseMap[this.selectedCustomerForStudent.course] || '';
                        if (planValue) planSelect.value = planValue;
                    }
                } else {
                    selectedInfoContainer.innerHTML = '';
                    
                    // å§åå¥åæ¬ãè¡¨ç¤º
                    if (nameInputContainer) {
                        nameInputContainer.classList.remove('hidden');
                        nameInputContainer.classList.add('col-span-2', 'grid', 'grid-cols-2', 'gap-3');
                    }
                    
                    // ãã©ã³ã»ã¬ã¯ãã®ã¹ã¿ã¤ã«ãåã«æ»ã
                    if (planSelectContainer) {
                        planSelectContainer.classList.remove('col-span-3');
                    }
                }
            }
            // æ¤ç´¢çµæã®ã¿ãæ´æ°ï¼ãã©ã¼ã«ã¹ãç¶­æï¼
            updateSearchResults() {
                const resultsContainer = document.getElementById('searchResultsContainer');
                if (!resultsContainer) return;
                if (this.studentSearchResults.length > 0) {
                    resultsContainer.innerHTML = `
                        <div class="mt-2 border rounded bg-white student-search-results shadow-lg">
                            ${this.studentSearchResults.map(customer => `
                                <div 
                                    data-select-customer-id="${customer.id}"
                                    class="select-customer-btn p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm transition">
                                    <div class="font-medium text-blue-600">
                                        ${customer.lastName} ${customer.firstName}
                                        ${customer.memberNumber ? `<span class="text-xs text-gray-500 ml-2">[${customer.memberNumber}]</span>` : ''}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        ${customer.reading ? `èª­ã¿: ${customer.reading}` : ''}
                                        ${customer.reading && customer.course ? ' | ' : ''}
                                        ${customer.course ? `ã³ã¼ã¹: ${customer.course}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // æ¤ç´¢çµæã®ã¯ãªãã¯ã¤ãã³ããåè¨­å®
                    resultsContainer.querySelectorAll('.select-customer-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const customerId = btn.getAttribute('data-select-customer-id');
                            const customer = this.customers.find(c => c.id === customerId);
                            if (customer) {
                                this.selectCustomerForStudent(customer);
                            }
                        });
                    });
                } else if (this.studentSearchTerm.trim()) {
                    resultsContainer.innerHTML = `
                        <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                            â ï¸ è©²å½ããé¡§å®¢ãè¦ã¤ããã¾ããã§ãã
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '';
                }
            }
            // ã²ãããªâã«ã¿ã«ãå¤æ
            hiraganaToKatakana(str) {
                return str.replace(/[\u3041-\u3096]/g, (match) => {
                    const chr = match.charCodeAt(0) + 0x60;
                    return String.fromCharCode(chr);
                });
            }
            // ã«ã¿ã«ãâã²ãããªå¤æ
            katakanaToHiragana(str) {
                return str.replace(/[\u30a1-\u30f6]/g, (match) => {
                    const chr = match.charCodeAt(0) - 0x60;
                    return String.fromCharCode(chr);
                });
            }
            // é¡§å®¢æ¤ç´¢æ©è½ï¼å¼·åçï¼
            searchCustomerByName(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                if (!term) {
                    return [];
                }
                
                // ã²ãããªã»ã«ã¿ã«ãä¸¡æ¹ã§æ¤ç´¢ã§ããããã«
                const termHiragana = this.katakanaToHiragana(term);
                const termKatakana = this.hiraganaToKatakana(term);
                
                return this.customers.filter(c => {
                    // æ°åï¼å§åå¥ãã»ãã«ãã¼ã ï¼
                    const lastName = (c.lastName || '').toLowerCase();
                    const firstName = (c.firstName || '').toLowerCase();
                    const fullName = `${lastName}${firstName}`;
                    const fullNameWithSpace = `${lastName} ${firstName}`;
                    
                    // èª­ã¿ï¼ã²ãããªã»ã«ã¿ã«ãä¸¡å¯¾å¿ï¼
                    const reading = (c.reading || '').toLowerCase();
                    const readingHiragana = this.katakanaToHiragana(reading);
                    const readingKatakana = this.hiraganaToKatakana(reading);
                    
                    // ä¼å¡çªå·
                    const memberNumber = (c.memberNumber || '').toLowerCase();
                    
                    // è¤æ°ã®æ¡ä»¶ã§æ¤ç´¢
                    return lastName.includes(term) ||
                           firstName.includes(term) ||
                           fullName.includes(term) ||
                           fullNameWithSpace.includes(term) ||
                           reading.includes(term) ||
                           reading.includes(termHiragana) ||
                           reading.includes(termKatakana) ||
                           readingHiragana.includes(term) ||
                           readingHiragana.includes(termHiragana) ||
                           readingKatakana.includes(term) ||
                           readingKatakana.includes(termKatakana) ||
                           memberNumber.includes(term);
                }).slice(0, 10); // æå¤§10ä»¶ã¾ã§è¡¨ç¤º
            }
            // é¡§å®¢ãé¸æãã¦çå¾æå ±ãèªåå¥å
            selectCustomerForStudent(customer) {
                this.selectedCustomerForStudent = customer;
                this.studentSearchResults = [];
                this.studentSearchTerm = `${customer.lastName} ${customer.firstName}`;
                
                // æ¤ç´¢å¥åæ¬ãæ´æ°
                const searchInput = document.getElementById('student_search_input');
                if (searchInput) {
                    searchInput.value = this.studentSearchTerm;
                }
                
                // æ¤ç´¢çµæãã¯ãªã¢
                this.updateSearchResults();
                
                // é¸æãããé¡§å®¢æå ±ãè¡¨ç¤º
                this.updateSelectedCustomerInfo();
            }
            async addStudentToClass(day, location, className) {
                this.selectedClassForAdd = { day, location, className };
                this.showAddStudentForm = true;
                this.selectedCustomerForStudent = null;
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.render();
            }
            async saveNewStudent() {
                let lastName, firstName, plan;
                
                // é¡§å®¢ãé¸æããã¦ããå ´å
                if (this.selectedCustomerForStudent) {
                    lastName = this.selectedCustomerForStudent.lastName;
                    firstName = this.selectedCustomerForStudent.firstName;
                    plan = document.getElementById('new_student_plan')?.value || '';
                } else {
                    lastName = document.getElementById('new_student_lastName')?.value || '';
                    firstName = document.getElementById('new_student_firstName')?.value || '';
                    plan = document.getElementById('new_student_plan')?.value || '';
                }
                if (!lastName || !firstName || !plan) {
                    alert('å§åã¨ãã©ã³ãå¥åãã¦ãã ãã');
                    return;
                }
                const { day, location, className } = this.selectedClassForAdd;
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    this.scheduleData[day][classIndex].students.push({ lastName, firstName, plan });
                    this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(this.scheduleData[day][classIndex].students);
                    
                    // Firestoreã«ä¿å­
                    await this.saveScheduleData();
                }
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.selectedCustomerForStudent = null;
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.render();
                alert('çå¾ãè¿½å ãã¾ãã');
            }
            // çå¾ã®ç·¨éãéå§
            startEditStudent(day, location, className, lastName, firstName) {
                this.editingStudent = { day, location, className, lastName, firstName };
                this.render();
            }
            // çå¾æå ±ã®ä¿å­
            async saveEditStudent() {
                const newPlan = document.getElementById('edit_student_plan')?.value;
                if (!newPlan) {
                    alert('ãã©ã³ãé¸æãã¦ãã ãã');
                    return;
                }
                const { day, location, className, lastName, firstName } = this.editingStudent;
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    const studentIndex = this.scheduleData[day][classIndex].students.findIndex(
                        s => s.lastName === lastName && s.firstName === firstName
                    );
                    
                    if (studentIndex !== -1) {
                        this.scheduleData[day][classIndex].students[studentIndex].plan = newPlan;
                        this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(this.scheduleData[day][classIndex].students);
                        
                        // Firestoreã«ä¿å­
                        await this.saveScheduleData();
                    }
                }
                this.editingStudent = null;
                this.render();
                alert('çå¾æå ±ãæ´æ°ãã¾ãã');
            }
            // çå¾ã®åé¤
            async deleteStudent(day, location, className, lastName, firstName) {
                if (!confirm(`${lastName} ${firstName} ãåé¤ãã¦ãããããã§ããï¼`)) {
                    return;
                }
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    this.scheduleData[day][classIndex].students = this.scheduleData[day][classIndex].students.filter(
                        s => !(s.lastName === lastName && s.firstName === firstName)
                    );
                    
                    // Firestoreã«ä¿å­
                    await this.saveScheduleData();
                }
                // åºå¸­ãã¼ã¿ãåé¤
                const studentKey = `${day}_${location}_${className}_${lastName}${firstName}`;
                const monthKey = this.selectedMonth.replace('-', '');
                try {
                    await deleteDoc(doc(db, `attendance_${monthKey}`, studentKey));
                } catch (error) {
                    console.log('åºå¸­ãã¼ã¿ã®åé¤ã¨ã©ã¼ï¼ãã¼ã¿ãå­å¨ããªãå¯è½æ§ãããã¾ãï¼');
                }
                await this.loadAttendance();
                this.render();
                alert('çå¾ãåé¤ãã¾ãã');
            }
            calculateVisitorRevenue() {
                let revenue = 0;
                const monthKey = this.selectedMonth.replace('-', '');
                
                Object.keys(this.attendanceData).forEach(key => {
                    const attendance = this.attendanceData[key];
                    const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                    
                    weeks.forEach(week => {
                        if (attendance[week] === 'â') {
                            // keyãããã©ã³æå ±ãåå¾ããå¿è¦ããããããscheduleDataããæ¤ç´¢
                            const parts = key.split('_');
                            const day = parts[0];
                            const location = parts[1];
                            const className = parts[2];
                            const studentName = parts.slice(3).join('_');
                            
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            const student = classData?.students.find(s => `${s.lastName}${s.firstName}` === studentName);
                            
                            // ãã¸ã¿ã¼ãä½é¨ãç¡æãã©ã³ã®ã¿å£²ä¸ã«è¨ä¸
                            if (student && (student.plan.includes('ãã¸ã¿ã¼') || student.plan.includes('ä½é¨') || student.plan.includes('ç¡æ'))) {
                                if (this.pricing[student.plan]) {
                                    revenue += this.pricing[student.plan];
                                }
                            }
                        }
                    });
                });
                
                return revenue;
            }
            // ç·´ç¿ä¼ã®å£²ä¸è¨ç®
            calculatePracticeRevenue() {
                let totalParticipants = 0;
                const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                const details = {};
                ['æææ¥', 'æ¨ææ¥'].forEach(day => {
                    const key = `ç·´ç¿ä¼_${day}`;
                    const data = this.attendanceData[key];
                    let dayTotal = 0;
                    if (data) {
                        weeks.forEach(week => {
                            const count = parseInt(data[week]) || 0;
                            dayTotal += count;
                        });
                    }
                    details[day] = dayTotal;
                    totalParticipants += dayTotal;
                });
                return { participants: totalParticipants, revenue: totalParticipants * 500, details };
            }
            // è©³ç´°å£²ä¸è¨ç®ï¼å¨ã«ãã´ãªå¥ï¼
            calculateDetailedRevenue() {
                const categories = {
                    'ç·´ç¿ä¼': { count: 0, revenue: 0 },
                    'ãã¸ã¿ã¼ï¼ä¼å¡ï¼': { count: 0, revenue: 0 },
                    'ãã¸ã¿ã¼ï¼éä¼å¡ï¼': { count: 0, revenue: 0 },
                    'ãã¸ã¿ã¼1.5hï¼ä¼å¡ï¼': { count: 0, revenue: 0 },
                    'ãã¸ã¿ã¼1.5hï¼éä¼å¡ï¼': { count: 0, revenue: 0 },
                    'æè¬ã¯ã©ã¹æ¯æ¿': { count: 0, revenue: 0 },
                    'ååä½é¨': { count: 0, revenue: 0 },
                    'ååç¡æ': { count: 0, revenue: 0 }
                };
                // ç·´ç¿ä¼
                const practice = this.calculatePracticeRevenue();
                categories['ç·´ç¿ä¼'] = { count: practice.participants, revenue: practice.revenue };
                // ãã¸ã¿ã¼ã»ä½é¨ç³»
                const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                Object.keys(this.attendanceData).forEach(key => {
                    if (key.startsWith('ç·´ç¿ä¼_')) return; // ç·´ç¿ä¼ã¯å¥å¦çæ¸ã¿
                    const attendance = this.attendanceData[key];
                    weeks.forEach(week => {
                        if (attendance[week] === 'â') {
                            const parts = key.split('_');
                            const day = parts[0];
                            const location = parts[1];
                            const className = parts[2];
                            const studentName = parts.slice(3).join('_');
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            const student = classData?.students.find(s => `${s.lastName}${s.firstName}` === studentName);
                            if (student && categories[student.plan] !== undefined) {
                                const price = this.pricing[student.plan] || 0;
                                categories[student.plan].count++;
                                categories[student.plan].revenue += price;
                            }
                        }
                    });
                });
                return categories;
            }
            // ç·´ç¿ä¼ã®å£²ä¸è¨ç®
            addEventParticipant() {
                this.eventAttendanceData.push({
                    id: null,
                    isMember: false,
                    lastName: '',
                    firstName: '',
                    week1: 'Ã',
                    week2: 'Ã',
                    week3: 'Ã',
                    fee: 0,
                    memo: ''
                });
                this.render();
            }
            // ã¤ãã³ãåå èãåé¤
            async deleteEventParticipant(index) {
                if (!confirm('ãã®åå èãåé¤ãã¦ãããããã§ããï¼')) {
                    return;
                }
                
                const participant = this.eventAttendanceData[index];
                if (participant.id) {
                    try {
                        const monthKey = this.selectedMonth.replace('-', '');
                        await deleteDoc(doc(db, `event_attendance_${monthKey}`, participant.id));
                    } catch (error) {
                        console.error('åé¤ã¨ã©ã¼:', error);
                    }
                }
                
                this.eventAttendanceData.splice(index, 1);
                await this.saveEventAttendance();
                this.render();
            }
            // ã¤ãã³ãã®åè¨éé¡ãè¨ç®
            calculateEventTotal() {
                return this.eventAttendanceData.reduce((sum, p) => sum + (parseFloat(p.fee) || 0), 0);
            }
            async saveAttendance(studentId, weekData) {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const docRef = doc(db, `attendance_${monthKey}`, studentId);
                    await setDoc(docRef, weekData, { merge: true });
                    await this.loadAttendance();
                } catch (error) {
                    console.error('åºå¸­ãã¼ã¿ä¿å­ã¨ã©ã¼:', error);
                }
            }
            toggleAttendance(classId, week) {
                const current = this.attendanceData[classId]?.[week] || '';
                const next = current === 'â' ? 'Ã' : current === 'Ã' ? 'ä¼è¬' : current === 'ä¼è¬' ? '' : 'â';
                
                if (!this.attendanceData[classId]) {
                    this.attendanceData[classId] = {};
                }
                this.attendanceData[classId][week] = next;
                
                this.saveAttendance(classId, this.attendanceData[classId]);
                this.render();
            }
            getAttendanceRate(classId) {
                const data = this.attendanceData[classId] || {};
                const weeks = ['week1', 'week2', 'week3', 'week4']; // äºåé±ãé¤å¤
                const attended = weeks.filter(w => data[w] === 'â').length;
                const recorded = weeks.filter(w => data[w] === 'â' || data[w] === 'Ã').length; // ä¼è¬ãé¤å¤
                return recorded > 0 ? Math.round((attended / recorded) * 100) : 0;
            }
            // æåãæ¿ãæ©è½ãä¿®æ­£
            async changeMonth(direction) {
                this.isLoading = true;
                this.render();
                
                try {
                    // ç¾å¨ã®å¹´æãåå¾
                    const [currentYear, currentMonth] = this.selectedMonth.split('-').map(Number);
                    
                    // æ°ããå¹´æãè¨ç®
                    let newYear = currentYear;
                    let newMonth = currentMonth + direction;
                    
                    // æã®ç¯å²ãã§ãã¯ã¨å¹´ã®èª¿æ´
                    if (newMonth > 12) {
                        newMonth = 1;
                        newYear++;
                    } else if (newMonth < 1) {
                        newMonth = 12;
                        newYear--;
                    }
                    
                    // YYYY-MMå½¢å¼ã«å¤æï¼æã¯2æ¡ã«ã¼ã­ããã£ã³ã°ï¼
                    this.selectedMonth = `${newYear}-${String(newMonth).padStart(2, '0')}`;
                    
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('æåãæ¿ãã¨ã©ã¼:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }
            // æãç´æ¥é¸æ
            async selectMonth(monthValue) {
                if (!monthValue) return;
                
                this.isLoading = true;
                this.selectedMonth = monthValue;
                this.render();
                
                try {
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('æé¸æã¨ã©ã¼:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }
            // ã¤ãã³ãã¯ã©ã¹è¿½å æ©è½
            addClassToEvent() {
                this.showAddClassForm = true;
                this.render();
            }
            async saveNewClass() {
                const className = document.getElementById('new_class_name')?.value || '';
                const location = document.getElementById('new_class_location')?.value || 'å¤©ç¥';
                const color = document.getElementById('new_class_color')?.value || 'red';
                if (!className) {
                    alert('ã¯ã©ã¹åãå¥åãã¦ãã ãã');
                    return;
                }
                this.scheduleData['ã¤ãã³ã'].push({
                    location,
                    name: className,
                    color,
                    students: []
                });
                
                // Firestoreã«ä¿å­
                await this.saveScheduleData();
                
                this.showAddClassForm = false;
                this.render();
                alert('ã¯ã©ã¹ãè¿½å ãã¾ãã');
            }
            renderAttendance() {
                return `
                    <div>
                        <div class="bg-white rounded-lg shadow mb-6">
                            <div class="border-b">
                                <div class="flex">
                                    <button id="attendanceOverviewTab" class="px-6 py-3 font-medium ${this.attendanceTab === 'overview' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:text-blue-600'}">ð ããã·ã¥ãã¼ã</button>
                                    <button id="attendanceRecordTab" class="px-6 py-3 font-medium ${this.attendanceTab === 'record' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:text-blue-600'}">ð åºå¸­è¨é²</button>
                                </div>
                            </div>
                        </div>
                        ${this.attendanceTab === 'overview' ? this.renderAttendanceOverview() : this.renderAttendanceRecord()}
                    </div>
                `;
            }
            renderAttendanceOverview() {
                const [year, month] = this.selectedMonth.split('-');

                // å¨ææ¥ã®ã¯ã©ã¹æ°ã¨çå¾æ°ãéè¨
                let totalClasses = 0;
                let totalStudents = 0;
                Object.keys(this.scheduleData).forEach(day => {
                    totalClasses += this.scheduleData[day].length;
                    this.scheduleData[day].forEach(cls => {
                        totalStudents += cls.students.length;
                    });
                });
                const dayStats = Object.keys(this.scheduleData).map(day => {
                    const classes = this.scheduleData[day];
                    const studentCount = classes.reduce((sum, cls) => sum + cls.students.length, 0);
                    return { day, classCount: classes.length, studentCount };
                });

                // è©³ç´°å£²ä¸è¨ç®
                const detailed = this.calculateDetailedRevenue();
                const visitorRevenue = this.calculateVisitorRevenue();
                const practiceRevenue = detailed['ç·´ç¿ä¼'].revenue;
                const totalExtraRevenue = Object.values(detailed).reduce((sum, d) => sum + d.revenue, 0);

                // è¡¨ç¤ºé åºãå®ç¾©
                const displayOrder = ['ç·´ç¿ä¼', 'ãã¸ã¿ã¼ï¼ä¼å¡ï¼', 'ãã¸ã¿ã¼ï¼éä¼å¡ï¼', 'ãã¸ã¿ã¼1.5hï¼ä¼å¡ï¼', 'ãã¸ã¿ã¼1.5hï¼éä¼å¡ï¼', 'æè¬ã¯ã©ã¹æ¯æ¿', 'ååä½é¨', 'ååç¡æ'];

                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800">åºå¸­ç¶æ³</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition">â åæ</button>
                                <input
                                    type="month"
                                    id="monthSelectorOverview"
                                    value="${this.selectedMonth}"
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition">æ¬¡æ â¶</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">ç·ã¯ã©ã¹æ°</div>
                                <div class="text-4xl font-bold text-blue-600">${totalClasses}</div>
                                <div class="text-xs text-gray-500 mt-2">ã¯ã©ã¹</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">ç·çå¾æ°ï¼å»¶ã¹ï¼</div>
                                <div class="text-4xl font-bold text-green-600">${totalStudents}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
                                <div class="text-gray-600 text-sm mb-2">ãã¸ã¿ã¼å£²ä¸</div>
                                <div class="text-4xl font-bold text-yellow-600">Â¥${visitorRevenue.toLocaleString()}</div>
                                <div class="text-xs text-gray-500 mt-2">å</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                                <div class="text-gray-600 text-sm mb-2">ç·´ç¿ä¼å£²ä¸</div>
                                <div class="text-4xl font-bold text-purple-600">Â¥${practiceRevenue.toLocaleString()}</div>
                                <div class="text-xs text-gray-500 mt-2">${detailed['ç·´ç¿ä¼'].count}ååå </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-8">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">å£²ä¸åè¨³ï¼åè¬äººæ°ã»å£²ä¸ï¼</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-4 py-3 text-left font-semibold">ã«ãã´ãª</th>
                                            <th class="px-4 py-3 text-center font-semibold">åä¾¡</th>
                                            <th class="px-4 py-3 text-center font-semibold">åè¬äººæ°</th>
                                            <th class="px-4 py-3 text-right font-semibold">å£²ä¸</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${displayOrder.map(plan => {
                                            const data = detailed[plan] || { count: 0, revenue: 0 };
                                            const price = this.pricing[plan] || 0;
                                            const bgColor = plan === 'ç·´ç¿ä¼' ? 'bg-purple-50' : data.count > 0 ? 'bg-yellow-50' : '';
                                            return `
                                                <tr class="border-b ${bgColor}">
                                                    <td class="px-4 py-3 font-medium">${plan}</td>
                                                    <td class="px-4 py-3 text-center text-gray-600">Â¥${price.toLocaleString()}</td>
                                                    <td class="px-4 py-3 text-center">
                                                        ${data.count > 0 ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">${data.count}${plan === 'ç·´ç¿ä¼' ? 'å' : 'å'}</span>` : '<span class="text-gray-400">-</span>'}
                                                    </td>
                                                    <td class="px-4 py-3 text-right font-semibold ${data.revenue > 0 ? 'text-green-700' : 'text-gray-400'}">
                                                        ${data.revenue > 0 ? 'Â¥' + data.revenue.toLocaleString() : '-'}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-blue-50 border-t-2 border-blue-300">
                                            <td class="px-4 py-3 font-bold" colspan="3">åè¨</td>
                                            <td class="px-4 py-3 text-right font-bold text-lg text-blue-700">Â¥${totalExtraRevenue.toLocaleString()}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">ææ¥å¥ã¯ã©ã¹æ°</h3>
                                <div class="space-y-3">
                                    ${dayStats.map(stat => `
                                        <div class="flex justify-between items-center p-3 border rounded hover:bg-gray-50">
                                            <span class="font-medium">${stat.day}</span>
                                            <div class="flex gap-4">
                                                <span class="text-gray-600">${stat.classCount}ã¯ã©ã¹</span>
                                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">${stat.studentCount}å</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">ããã¯ã¢ãã</h3>
                                <div class="space-y-3">
                                    <p class="text-sm text-gray-600">ãã¼ã¿ã®å®å¨ã®ãããå®æçã«ããã¯ã¢ãããåå¾ãã¦ãã ããã</p>
                                    <button id="backupBtn" class="w-full bg-green-600 text-white px-4 py-3 rounded hover:bg-green-700 transition font-medium">
                                        ð¦ ããã¯ã¢ãããåå¾
                                    </button>
                                    <div id="backupStatus" class="text-xs text-gray-500 text-center"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ä½¿ãæ¹</h3>
                            <div class="space-y-2 text-gray-600">
                                <p>â¢ ãð åºå¸­è¨é²ãã¿ãããåææ¥ã®ã¯ã©ã¹ã®åºå¸­ãè¨é²ã§ãã¾ã</p>
                                <p>â¢ ãã¿ã³ãã¯ãªãã¯ã§ <span class="text-green-600 font-bold">â</span> â <span class="text-red-600 font-bold">Ã</span> â <span class="text-gray-600 font-bold">ä¼</span> â <span class="text-gray-400 font-bold">-</span> ã¨åãæ¿ããã¾ã</p>
                                <p>â¢ æææ¥ã»æ¨ææ¥ã«ã¯ãç·´ç¿ä¼ãæ¬ããããåå äººæ°ãå¥åã§ãã¾ãï¼Â¥500/äººï¼</p>
                                <p>â¢ åã¯ã©ã¹ã«ãçå¾è¿½å ããã¿ã³ããæ°è¦çå¾ãè¿½å ã§ãã¾ã</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            renderAttendanceRecord() {
                // ã¤ãã³ãã¿ãã¯å°ç¨ã®ã¬ã³ããªã³ã°
                if (this.selectedDay === 'ã¤ãã³ã') {
                    return this.renderEventRecord();
                }
                const [year, month] = this.selectedMonth.split('-');
                const dayClasses = this.scheduleData[this.selectedDay] || [];
                if (this.isLoading) {
                    return `
                        <div class="flex items-center justify-center h-96">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                                <p class="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">åºå¸­è¨é²</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>â åæ</button>
                                <input 
                                    type="month" 
                                    id="monthSelector" 
                                    value="${this.selectedMonth}" 
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>æ¬¡æ â¶</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow mb-4">
                            <div class="flex border-b overflow-x-auto">
                                ${['æææ¥', 'ç«ææ¥', 'æ°´ææ¥', 'æ¨ææ¥', 'éææ¥', 'ã¤ãã³ã'].map(day => `
                                    <button id="day-${day}" class="px-4 py-2 text-sm font-medium whitespace-nowrap ${this.selectedDay === day ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'}">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        ${this.showAddStudentForm ? this.renderAddStudentForm() : ''}
                        ${dayClasses.map((classInfo, idx) => {
                            const sortedStudents = this.sortStudentsByPlan([...classInfo.students]);
                            return `
                                <div class="bg-white rounded-lg shadow mb-3">
                                    <div class="bg-${classInfo.color}-600 text-white px-4 py-2 rounded-t-lg flex justify-between items-center">
                                        <h3 class="text-base font-bold">${classInfo.location} - ${classInfo.name}</h3>
                                        <div class="flex gap-2 items-center">
                                            <span class="text-xs opacity-90">${sortedStudents.length}å</span>
                                            <button 
                                                data-add-day="${this.selectedDay}" 
                                                data-add-location="${classInfo.location}" 
                                                data-add-class="${classInfo.name}"
                                                class="add-student-btn bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-xs transition">
                                                + çå¾è¿½å 
                                            </button>
                                        </div>
                                    </div>
                                    <div class="p-3 overflow-x-auto">
                                        <table class="w-full text-xs">
                                            <thead>
                                                <tr class="bg-gray-50 border-b">
                                                    <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">æ°å</th>
                                                    <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">ãã©ã³</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç¬¬1é±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç¬¬2é±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç¬¬3é±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç¬¬4é±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">äºå</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 60px;">åºå¸­ç</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">ç·¨é</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${sortedStudents.map(student => {
                                                    const studentKey = `${this.selectedDay}_${classInfo.location}_${classInfo.name}_${student.lastName}${student.firstName}`;
                                                    const attendance = this.attendanceData[studentKey] || {};
                                                    const rate = this.getAttendanceRate(studentKey);
                                                    const isEditing = this.editingStudent && 
                                                                     this.editingStudent.day === this.selectedDay &&
                                                                     this.editingStudent.location === classInfo.location &&
                                                                     this.editingStudent.className === classInfo.name &&
                                                                     this.editingStudent.lastName === student.lastName &&
                                                                     this.editingStudent.firstName === student.firstName;
                                                    
                                                    if (isEditing) {
                                                        return `
                                                            <tr class="border-b bg-blue-50">
                                                                <td class="px-2 py-2 text-xs">${student.lastName} ${student.firstName}</td>
                                                                <td class="px-2 py-2 text-xs">
                                                                    <select id="edit_student_plan" class="w-full border rounded px-1 py-1 text-xs">
                                                                        <option value="ï¼ã¯ã©ã¹" ${student.plan === 'ï¼ã¯ã©ã¹' ? 'selected' : ''}>ï¼ã¯ã©ã¹</option>
                                                                        <option value="ï¼ã¯ã©ã¹" ${student.plan === 'ï¼ã¯ã©ã¹' ? 'selected' : ''}>ï¼ã¯ã©ã¹</option>
                                                                        <option value="ï¼ã¯ã©ã¹" ${student.plan === 'ï¼ã¯ã©ã¹' ? 'selected' : ''}>ï¼ã¯ã©ã¹</option>
                                                                        <option value="ï¼ã¯ã©ã¹" ${student.plan === 'ï¼ã¯ã©ã¹' ? 'selected' : ''}>ï¼ã¯ã©ã¹</option>
                                                                        <option value="ãã¸ã¿ã¼ï¼ä¼å¡ï¼" ${student.plan === 'ãã¸ã¿ã¼ï¼ä¼å¡ï¼' ? 'selected' : ''}>ãã¸ã¿ã¼ï¼ä¼å¡ï¼</option>
                                                                        <option value="ãã¸ã¿ã¼ï¼éä¼å¡ï¼" ${student.plan === 'ãã¸ã¿ã¼ï¼éä¼å¡ï¼' ? 'selected' : ''}>ãã¸ã¿ã¼ï¼éä¼å¡ï¼</option>
                                                                        <option value="ãã¸ã¿ã¼ï¼æ¯æ¿ï¼" ${student.plan === 'ãã¸ã¿ã¼ï¼æ¯æ¿ï¼' ? 'selected' : ''}>ãã¸ã¿ã¼ï¼æ¯æ¿ï¼</option>
                                                                        <option value="ååä½é¨" ${student.plan === 'ååä½é¨' ? 'selected' : ''}>ååä½é¨</option>
                                                                        <option value="ååç¡æ" ${student.plan === 'ååç¡æ' ? 'selected' : ''}>ååç¡æ</option>
                                                                    </select>
                                                                </td>
                                                                ${['week1', 'week2', 'week3', 'week4', 'week5'].map(week => `
                                                                    <td class="px-2 py-2 text-center">
                                                                        <button 
                                                                            data-class="${studentKey}" 
                                                                            data-week="${week}"
                                                                            class="attendance-btn w-8 h-8 rounded border text-xs ${
                                                                                attendance[week] === 'â' ? 'bg-green-500 border-green-600 text-white' :
                                                                                attendance[week] === 'Ã' ? 'bg-red-500 border-red-600 text-white' :
                                                                                attendance[week] === 'ä¼è¬' ? 'bg-gray-500 border-gray-600 text-white' :
                                                                                'bg-gray-100 border-gray-300 text-gray-400'
                                                                            } hover:opacity-80 transition font-bold">
                                                                            ${attendance[week] === 'ä¼è¬' ? 'ä¼' : attendance[week] || '-'}
                                                                        </button>
                                                                    </td>
                                                                `).join('')}
                                                                <td class="px-2 py-2 text-center">
                                                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                                        rate >= 80 ? 'bg-green-100 text-green-800' :
                                                                        rate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                                        rate > 0 ? 'bg-red-100 text-red-800' :
                                                                        'bg-gray-100 text-gray-600'
                                                                    }">${rate > 0 ? rate + '%' : '-'}</span>
                                                                </td>
                                                                <td class="px-2 py-2 text-center">
                                                                    <div class="flex flex-col gap-1">
                                                                        <button 
                                                                            id="saveEditStudentBtn"
                                                                            class="text-green-600 hover:text-green-800 text-xs">
                                                                            ä¿å­
                                                                        </button>
                                                                        <button 
                                                                            id="cancelEditStudentBtn"
                                                                            class="text-gray-600 hover:text-gray-800 text-xs">
                                                                            ã­ã£ã³ã»ã«
                                                                        </button>
                                                                        <button 
                                                                            data-delete-day="${this.selectedDay}"
                                                                            data-delete-location="${classInfo.location}"
                                                                            data-delete-class="${classInfo.name}"
                                                                            data-delete-lastname="${student.lastName}"
                                                                            data-delete-firstname="${student.firstName}"
                                                                            class="delete-student-btn text-red-600 hover:text-red-800 text-xs">
                                                                            åé¤
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }
                                                    
                                                    return `
                                                        <tr class="border-b hover:bg-gray-50">
                                                            <td class="px-2 py-2 text-xs">${student.lastName} ${student.firstName}</td>
                                                            <td class="px-2 py-2 text-xs">${student.plan}</td>
                                                            ${['week1', 'week2', 'week3', 'week4', 'week5'].map(week => `
                                                                <td class="px-2 py-2 text-center">
                                                                    <button 
                                                                        data-class="${studentKey}" 
                                                                        data-week="${week}"
                                                                        class="attendance-btn w-8 h-8 rounded border text-xs ${
                                                                            attendance[week] === 'â' ? 'bg-green-500 border-green-600 text-white' :
                                                                            attendance[week] === 'Ã' ? 'bg-red-500 border-red-600 text-white' :
                                                                            attendance[week] === 'ä¼è¬' ? 'bg-gray-500 border-gray-600 text-white' :
                                                                            'bg-gray-100 border-gray-300 text-gray-400'
                                                                        } hover:opacity-80 transition font-bold">
                                                                        ${attendance[week] === 'ä¼è¬' ? 'ä¼' : attendance[week] || '-'}
                                                                    </button>
                                                                </td>
                                                            `).join('')}
                                                            <td class="px-2 py-2 text-center">
                                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                                    rate >= 80 ? 'bg-green-100 text-green-800' :
                                                                    rate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                                    rate > 0 ? 'bg-red-100 text-red-800' :
                                                                    'bg-gray-100 text-gray-600'
                                                                }">${rate > 0 ? rate + '%' : '-'}</span>
                                                            </td>
                                                            <td class="px-2 py-2 text-center">
                                                                <button 
                                                                    data-edit-student-day="${this.selectedDay}"
                                                                    data-edit-student-location="${classInfo.location}"
                                                                    data-edit-student-class="${classInfo.name}"
                                                                    data-edit-student-lastname="${student.lastName}"
                                                                    data-edit-student-firstname="${student.firstName}"
                                                                    class="edit-student-btn text-blue-600 hover:text-blue-800 text-xs">
                                                                    ç·¨é
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        ${dayClasses.length === 0 ? `
                            <div class="bg-white rounded-lg shadow p-12 text-center">
                                <p class="text-gray-500 text-lg">ãã®ææ¥ã«ã¯ã¯ã©ã¹ãããã¾ãã</p>
                            </div>
                        ` : ''}

                        ${(this.selectedDay === 'æææ¥' || this.selectedDay === 'æ¨ææ¥') ? this.renderPracticeSession() : ''}
                    </div>
                `;
            }
            // ç·´ç¿ä¼ã»ã¯ã·ã§ã³ã®ã¬ã³ããªã³ã°
            renderPracticeSession() {
                const practiceKey = `ç·´ç¿ä¼_${this.selectedDay}`;
                const practiceData = this.attendanceData[practiceKey] || {};
                const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                const weekLabels = ['ç¬¬1é±', 'ç¬¬2é±', 'ç¬¬3é±', 'ç¬¬4é±', 'äºå'];
                let totalParticipants = 0;
                weeks.forEach(w => { totalParticipants += (parseInt(practiceData[w]) || 0); });
                const totalRevenue = totalParticipants * 500;

                return `
                    <div class="bg-white rounded-lg shadow mb-3">
                        <div class="bg-purple-600 text-white px-4 py-2 rounded-t-lg flex justify-between items-center">
                            <h3 class="text-base font-bold">ç·´ç¿ä¼ï¼Â¥500/äººï¼</h3>
                            <span class="text-xs opacity-90">åè¨: ${totalParticipants}å / Â¥${totalRevenue.toLocaleString()}</span>
                        </div>
                        <div class="p-3">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="bg-gray-50 border-b">
                                        <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">é ç®</th>
                                        ${weekLabels.map(label => `
                                            <th class="px-2 py-2 text-center font-semibold" style="width: 70px;">${label}</th>
                                        `).join('')}
                                        <th class="px-2 py-2 text-center font-semibold" style="width: 70px;">åè¨</th>
                                        <th class="px-2 py-2 text-right font-semibold" style="width: 90px;">å£²ä¸</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b">
                                        <td class="px-2 py-2 font-medium">åå äººæ°</td>
                                        ${weeks.map(week => `
                                            <td class="px-2 py-2 text-center">
                                                <input
                                                    type="number"
                                                    min="0"
                                                    value="${parseInt(practiceData[week]) || 0}"
                                                    data-practice-day="${this.selectedDay}"
                                                    data-practice-week="${week}"
                                                    class="practice-input w-14 border rounded px-1 py-1 text-xs text-center focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                />
                                            </td>
                                        `).join('')}
                                        <td class="px-2 py-2 text-center">
                                            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-semibold">${totalParticipants}å</span>
                                        </td>
                                        <td class="px-2 py-2 text-right font-bold text-purple-700">Â¥${totalRevenue.toLocaleString()}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            renderAddStudentForm() {
                return `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                        <h3 class="text-base font-semibold mb-3 text-gray-800">çå¾è¿½å </h3>
                        
                        <!-- é¡§å®¢æ¤ç´¢ -->
                        <div class="mb-3">
                            <label class="block text-xs font-medium mb-1">é¡§å®¢æ¤ç´¢ï¼æ°åã»èª­ã¿ã»ä¼å¡çªå·ï¼</label>
                            <input 
                                type="text" 
                                id="student_search_input" 
                                value="${this.studentSearchTerm}"
                                class="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="ä¾: ä¸­å³¶ããªããã¾ããã«ã·ããnakashimaã0001"
                                autocomplete="off"
                            />
                            <div class="text-xs text-gray-500 mt-1">ð¡ æ¼¢å­ã»ã²ãããªã»ã«ã¿ã«ãã»è±èªã»ä¼å¡çªå·ã§æ¤ç´¢ã§ãã¾ã</div>
                            <!-- æ¤ç´¢çµæè¡¨ç¤ºç¨ã³ã³ãã -->
                            <div id="searchResultsContainer">
                                ${this.studentSearchResults.length > 0 ? `
                                    <div class="mt-2 border rounded bg-white student-search-results shadow-lg">
                                        ${this.studentSearchResults.map(customer => `
                                            <div 
                                                data-select-customer-id="${customer.id}"
                                                class="select-customer-btn p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm transition">
                                                <div class="font-medium text-blue-600">
                                                    ${customer.lastName} ${customer.firstName}
                                                    ${customer.memberNumber ? `<span class="text-xs text-gray-500 ml-2">[${customer.memberNumber}]</span>` : ''}
                                                </div>
                                                <div class="text-xs text-gray-600 mt-1">
                                                    ${customer.reading ? `èª­ã¿: ${customer.reading}` : ''}
                                                    ${customer.reading && customer.course ? ' | ' : ''}
                                                    ${customer.course ? `ã³ã¼ã¹: ${customer.course}` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : this.studentSearchTerm.trim() && this.studentSearchResults.length === 0 ? `
                                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                                        â ï¸ è©²å½ããé¡§å®¢ãè¦ã¤ããã¾ããã§ãã
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ${this.selectedCustomerForStudent ? `
                            <div id="selectedCustomerInfo" class="mb-3 p-3 bg-green-50 border-2 border-green-400 rounded text-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-bold text-green-800">â é¸æä¸­: ${this.selectedCustomerForStudent.lastName} ${this.selectedCustomerForStudent.firstName}</div>
                                        <div class="text-xs text-gray-700 mt-1">
                                            ${this.selectedCustomerForStudent.memberNumber ? `ä¼å¡çªå·: ${this.selectedCustomerForStudent.memberNumber} | ` : ''}
                                            ${this.selectedCustomerForStudent.reading ? `èª­ã¿: ${this.selectedCustomerForStudent.reading} | ` : ''}
                                            ã³ã¼ã¹: ${this.selectedCustomerForStudent.course || 'ãªã'}
                                        </div>
                                    </div>
                                    <button 
                                        id="clearSelectedCustomer"
                                        class="text-red-600 hover:text-red-800 text-xs underline">
                                        é¸æè§£é¤
                                    </button>
                                </div>
                            </div>
                        ` : '<div id="selectedCustomerInfo"></div>'}
                        <div class="grid grid-cols-3 gap-3 mb-3">
                            <div id="nameInputContainer" class="${!this.selectedCustomerForStudent ? 'col-span-2 grid grid-cols-2 gap-3' : 'hidden'}">
                                <div>
                                    <label class="block text-xs font-medium mb-1">å§ *</label>
                                    <input type="text" id="new_student_lastName" class="w-full border rounded px-2 py-1 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">å *</label>
                                    <input type="text" id="new_student_firstName" class="w-full border rounded px-2 py-1 text-sm">
                                </div>
                            </div>
                            <div id="planSelectContainer" class="${!this.selectedCustomerForStudent ? '' : 'col-span-3'}">
                                <label class="block text-xs font-medium mb-1">ãã©ã³ *</label>
                                <select id="new_student_plan" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="">é¸æãã¦ãã ãã</option>
                                    <option value="ï¼ã¯ã©ã¹" ${this.selectedCustomerForStudent?.course === 'ï¼' ? 'selected' : ''}>ï¼ã¯ã©ã¹</option>
                                    <option value="ï¼ã¯ã©ã¹" ${this.selectedCustomerForStudent?.course === 'ï¼' ? 'selected' : ''}>ï¼ã¯ã©ã¹</option>
                                    <option value="ï¼ã¯ã©ã¹" ${this.selectedCustomerForStudent?.course === 'ï¼' ? 'selected' : ''}>ï¼ã¯ã©ã¹</option>
                                    <option value="ï¼ã¯ã©ã¹" ${this.selectedCustomerForStudent?.course === 'ï¼' ? 'selected' : ''}>ï¼ã¯ã©ã¹</option>
                                    <option value="ãã¸ã¿ã¼ï¼ä¼å¡ï¼">ãã¸ã¿ã¼ï¼ä¼å¡ï¼</option>
                                    <option value="ãã¸ã¿ã¼ï¼éä¼å¡ï¼">ãã¸ã¿ã¼ï¼éä¼å¡ï¼</option>
                                    <option value="ãã¸ã¿ã¼ï¼æ¯æ¿ï¼">ãã¸ã¿ã¼ï¼æ¯æ¿ï¼</option>
                                    <option value="ååä½é¨">ååä½é¨</option>
                                    <option value="ååç¡æ">ååç¡æ</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 mb-3">
                            â» é¡§å®¢ç®¡çãããã©ã³ãèªååæ ããã¾ããããã¸ã¿ã¼ã¨ãã¦åè¬ããå ´åã¯å¤æ´ãã¦ãã ãã
                        </div>
                        <div class="flex gap-2">
                            <button id="saveNewStudentBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">è¿½å </button>
                            <button id="cancelAddStudentBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition text-sm">ã­ã£ã³ã»ã«</button>
                        </div>
                    </div>
                `;
            }
            // ã¤ãã³ãå°ç¨ã®ã¬ã³ããªã³ã°
            renderEventRecord() {
                const [year, month] = this.selectedMonth.split('-');
                const total = this.calculateEventTotal();
                if (this.isLoading) {
                    return `
                        <div class="flex items-center justify-center h-96">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                                <p class="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">ã¤ãã³ãåºå¸­è¨é²</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>â åæ</button>
                                <input 
                                    type="month" 
                                    id="monthSelector" 
                                    value="${this.selectedMonth}" 
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>æ¬¡æ â¶</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow mb-4">
                            <div class="flex border-b overflow-x-auto">
                                ${['æææ¥', 'ç«ææ¥', 'æ°´ææ¥', 'æ¨ææ¥', 'éææ¥', 'ã¤ãã³ã'].map(day => `
                                    <button id="day-${day}" class="px-4 py-2 text-sm font-medium whitespace-nowrap ${this.selectedDay === day ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'}">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-gray-800">ã¤ãã³ãåå èä¸è¦§</h3>
                                <button id="addEventParticipantBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-sm">
                                    + åå èãè¿½å 
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 100px;">æ°åï¼å§ï¼</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 100px;">æ°åï¼åï¼</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">â </th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">â¡</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">â¢</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 120px;">æéï¼åï¼</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 200px;">åè</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 80px;">æä½</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.eventAttendanceData.length === 0 ? `
                                            <tr>
                                                <td colspan="8" class="px-3 py-8 text-center text-gray-500">
                                                    åå èããã¾ãããã+ åå èãè¿½å ããã¿ã³ããè¿½å ãã¦ãã ããã
                                                </td>
                                            </tr>
                                        ` : this.eventAttendanceData.map((participant, index) => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="lastName" 
                                                        data-event-index="${index}"
                                                        value="${participant.lastName || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="å§"
                                                    />
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="firstName" 
                                                        data-event-index="${index}"
                                                        value="${participant.firstName || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="å"
                                                    />
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week1" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week1 === 'â' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week1 === 'â' ? 'â' : 'Ã'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week2" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week2 === 'â' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week2 === 'â' ? 'â' : 'Ã'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week3" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week3 === 'â' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week3 === 'â' ? 'â' : 'Ã'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="number" 
                                                        data-event-field="fee" 
                                                        data-event-index="${index}"
                                                        value="${participant.fee || 0}"
                                                        class="w-full border rounded px-2 py-1 text-sm text-right"
                                                        placeholder="0"
                                                        min="0"
                                                    />
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="memo" 
                                                        data-event-index="${index}"
                                                        value="${participant.memo || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="åè"
                                                    />
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-delete-event-index="${index}"
                                                        class="delete-event-participant-btn text-red-600 hover:text-red-800 text-xs">
                                                        åé¤
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-blue-50 border-t-2 border-blue-300">
                                            <td colspan="5" class="px-3 py-4 text-right font-bold text-gray-800">åè¨éé¡:</td>
                                            <td class="px-3 py-4 font-bold text-blue-600 text-lg">Â¥${total.toLocaleString()}</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="mt-6 p-4 bg-gray-50 rounded border">
                                <h4 class="font-semibold mb-2 text-sm">ä½¿ãæ¹</h4>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li>â¢ æ°åã»æéã»åèã¯ç´æ¥å¥åã§ãã¾ã</li>
                                    <li>â¢ â â¡â¢ã®ãã¿ã³ãã¯ãªãã¯ããã¨ <span class="text-green-600 font-bold">â</span> â <span class="text-red-600 font-bold">Ã</span> â <span class="text-gray-600 font-bold">ä¼</span> â <span class="text-gray-400 font-bold">-</span> ã¨åãæ¿ããã¾ã</li>
                                    <li>â¢ å¥ååå®¹ã¯èªåä¿å­ããã¾ã</li>
                                    <li>â¢ æéã®åè¨éé¡ãèªåã§è¡¨ç¤ºããã¾ã</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            setupAttendanceEvents() {
                document.getElementById('attendanceOverviewTab')?.addEventListener('click', () => {
                    this.attendanceTab = 'overview';
                    this.render();
                });
                document.getElementById('attendanceRecordTab')?.addEventListener('click', () => {
                    this.attendanceTab = 'record';
                    this.render();
                });
                // æé¸æinputã®ã¤ãã³ãï¼åºå¸­è¨é²ï¼
                const monthSelector = document.getElementById('monthSelector');
                if (monthSelector) {
                    monthSelector.addEventListener('change', (e) => {
                        this.selectMonth(e.target.value);
                    });
                }
                // æé¸æinputã®ã¤ãã³ãï¼ããã·ã¥ãã¼ãï¼
                const monthSelectorOverview = document.getElementById('monthSelectorOverview');
                if (monthSelectorOverview) {
                    monthSelectorOverview.addEventListener('change', (e) => {
                        this.selectMonth(e.target.value);
                    });
                }
                const prevMonthBtn = document.getElementById('prevMonth');
                const nextMonthBtn = document.getElementById('nextMonth');
                const prevMonthRecordBtn = document.getElementById('prevMonthRecord');
                const nextMonthRecordBtn = document.getElementById('nextMonthRecord');
                if (prevMonthBtn) {
                    prevMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(-1);
                    });
                }
                if (nextMonthBtn) {
                    nextMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(1);
                    });
                }
                if (prevMonthRecordBtn) {
                    prevMonthRecordBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(-1);
                    });
                }
                if (nextMonthRecordBtn) {
                    nextMonthRecordBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(1);
                    });
                }
                ['æææ¥', 'ç«ææ¥', 'æ°´ææ¥', 'æ¨ææ¥', 'éææ¥', 'ã¤ãã³ã'].forEach(day => {
                    document.getElementById(`day-${day}`)?.addEventListener('click', () => {
                        this.selectedDay = day;
                        this.render();
                    });
                });
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const classId = btn.getAttribute('data-class');
                        const week = btn.getAttribute('data-week');
                        this.toggleAttendance(classId, week);
                    });
                });
                document.querySelectorAll('.add-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-add-day');
                        const location = btn.getAttribute('data-add-location');
                        const className = btn.getAttribute('data-add-class');
                        this.addStudentToClass(day, location, className);
                    });
                });
                // çå¾ç·¨éãã¿ã³
                document.querySelectorAll('.edit-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-edit-student-day');
                        const location = btn.getAttribute('data-edit-student-location');
                        const className = btn.getAttribute('data-edit-student-class');
                        const lastName = btn.getAttribute('data-edit-student-lastname');
                        const firstName = btn.getAttribute('data-edit-student-firstname');
                        this.startEditStudent(day, location, className, lastName, firstName);
                    });
                });
                // çå¾åé¤ãã¿ã³
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-delete-day');
                        const location = btn.getAttribute('data-delete-location');
                        const className = btn.getAttribute('data-delete-class');
                        const lastName = btn.getAttribute('data-delete-lastname');
                        const firstName = btn.getAttribute('data-delete-firstname');
                        this.deleteStudent(day, location, className, lastName, firstName);
                    });
                });
                // çå¾ç·¨éä¿å­ã»ã­ã£ã³ã»ã«
                document.getElementById('saveEditStudentBtn')?.addEventListener('click', () => this.saveEditStudent());
                document.getElementById('cancelEditStudentBtn')?.addEventListener('click', () => {
                    this.editingStudent = null;
                    this.render();
                });
                // çå¾æ¤ç´¢ï¼ãªã¢ã«ã¿ã¤ã ï¼- ãã©ã¼ã«ã¹ç¶­æã®ããæ¤ç´¢çµæã®ã¿æ´æ°
                const searchInput = document.getElementById('student_search_input');
                if (searchInput) {
                    // inputã¤ãã³ãã§æ¤ç´¢çµæã®ã¿æ´æ°ï¼å¨ä½ãåã¬ã³ããªã³ã°ããªãï¼
                    searchInput.addEventListener('input', (e) => {
                        this.studentSearchTerm = e.target.value;
                        if (this.studentSearchTerm.trim()) {
                            this.studentSearchResults = this.searchCustomerByName(this.studentSearchTerm);
                        } else {
                            this.studentSearchResults = [];
                            this.selectedCustomerForStudent = null;
                        }
                        // æ¤ç´¢çµæã®ã¿ãæ´æ°ï¼ãã©ã¼ã«ã¹ãç¶­æï¼
                        this.updateSearchResults();
                    });
                    
                    // ãã©ã¼ã«ã¹æã«ãæ¤ç´¢çµæãè¡¨ç¤º
                    searchInput.addEventListener('focus', (e) => {
                        if (this.studentSearchTerm.trim()) {
                            this.studentSearchResults = this.searchCustomerByName(this.studentSearchTerm);
                            this.updateSearchResults();
                        }
                    });
                }
                // é¡§å®¢é¸æï¼åæã¬ã³ããªã³ã°æï¼
                document.querySelectorAll('.select-customer-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.getAttribute('data-select-customer-id');
                        const customer = this.customers.find(c => c.id === customerId);
                        if (customer) {
                            this.selectCustomerForStudent(customer);
                        }
                    });
                });
                // é¡§å®¢é¸æè§£é¤ï¼åæã¬ã³ããªã³ã°æï¼
                document.getElementById('clearSelectedCustomer')?.addEventListener('click', () => {
                    this.selectedCustomerForStudent = null;
                    this.studentSearchTerm = '';
                    this.studentSearchResults = [];
                    this.updateSelectedCustomerInfo();
                    // æ¤ç´¢å¥åæ¬ãã¯ãªã¢
                    const searchInput = document.getElementById('student_search_input');
                    if (searchInput) searchInput.value = '';
                    // æ¤ç´¢çµæãã¯ãªã¢
                    this.updateSearchResults();
                    // ãã©ã³ããªã»ãã
                    const planSelect = document.getElementById('new_student_plan');
                    if (planSelect) planSelect.value = '';
                });
                // ã¤ãã³ãå°ç¨ã®ã¤ãã³ããªã¹ãã¼
                document.getElementById('addEventParticipantBtn')?.addEventListener('click', () => {
                    this.addEventParticipant();
                });
                // ã¤ãã³ãåºå¸­ãã¿ã³
                document.querySelectorAll('.event-attendance-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-event-index'));
                        const week = btn.getAttribute('data-event-week');
                        const current = this.eventAttendanceData[index][week] || '';
                        const next = current === 'â' ? 'Ã' : 'â';
                        this.eventAttendanceData[index][week] = next;
                        this.saveEventAttendance();
                        this.render();
                    });
                });
                // ã¤ãã³ããã£ã¼ã«ãå¥å
                document.querySelectorAll('[data-event-field]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-event-index'));
                        const field = e.target.getAttribute('data-event-field');
                        let value = e.target.value;
                        
                        // æéã¯æ°å¤ã«å¤æ
                        if (field === 'fee') {
                            value = parseFloat(value) || 0;
                        }
                        
                        this.eventAttendanceData[index][field] = value;
                        this.saveEventAttendance();
                    });
                    // ãªã¢ã«ã¿ã¤ã æ´æ°ï¼æéã®ã¿ï¼
                    if (input.getAttribute('data-event-field') === 'fee') {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-event-index'));
                            const value = parseFloat(e.target.value) || 0;
                            this.eventAttendanceData[index].fee = value;
                            this.render();
                        });
                    }
                });
                // ã¤ãã³ãåå èåé¤
                document.querySelectorAll('.delete-event-participant-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-delete-event-index'));
                        this.deleteEventParticipant(index);
                    });
                });
                document.getElementById('saveNewStudentBtn')?.addEventListener('click', () => this.saveNewStudent());
                document.getElementById('cancelAddStudentBtn')?.addEventListener('click', () => {
                    this.showAddStudentForm = false;
                    this.selectedClassForAdd = null;
                    this.selectedCustomerForStudent = null;
                    this.studentSearchTerm = '';
                    this.studentSearchResults = [];
                    this.render();
                });
                // ç·´ç¿ä¼ã®åå äººæ°å¥å
                document.querySelectorAll('.practice-input').forEach(input => {
                    input.addEventListener('change', async (e) => {
                        const day = e.target.getAttribute('data-practice-day');
                        const week = e.target.getAttribute('data-practice-week');
                        const value = parseInt(e.target.value) || 0;
                        const practiceKey = `ç·´ç¿ä¼_${day}`;
                        if (!this.attendanceData[practiceKey]) {
                            this.attendanceData[practiceKey] = {};
                        }
                        this.attendanceData[practiceKey][week] = value;
                        await this.saveAttendance(practiceKey, this.attendanceData[practiceKey]);
                        this.render();
                    });
                });
                // ããã¯ã¢ãããã¿ã³
                document.getElementById('backupBtn')?.addEventListener('click', async () => {
                    await this.createBackup();
                });
            }
            // ããã¯ã¢ããæ©è½
            async createBackup() {
                const statusEl = document.getElementById('backupStatus');
                if (statusEl) statusEl.textContent = 'ããã¯ã¢ããä½æä¸­...';
                try {
                    const backup = { timestamp: new Date().toISOString(), collections: {} };
                    // schedule
                    const scheduleSnap = await getDocs(collection(db, 'schedule'));
                    backup.collections.schedule = {};
                    scheduleSnap.docs.forEach(d => { backup.collections.schedule[d.id] = d.data(); });
                    // customers
                    const custSnap = await getDocs(collection(db, 'customers'));
                    backup.collections.customers = {};
                    custSnap.docs.forEach(d => { backup.collections.customers[d.id] = d.data(); });
                    // attendance months
                    const months = ['202509','202511','202512','202601','202602','202603'];
                    for (const m of months) {
                        try {
                            const snap = await getDocs(collection(db, `attendance_${m}`));
                            if (!snap.empty) {
                                backup.collections[`attendance_${m}`] = {};
                                snap.docs.forEach(d => { backup.collections[`attendance_${m}`][d.id] = d.data(); });
                            }
                        } catch(e) {}
                    }
                    // event_attendance months
                    for (const m of months) {
                        try {
                            const snap = await getDocs(collection(db, `event_attendance_${m}`));
                            if (!snap.empty) {
                                backup.collections[`event_attendance_${m}`] = {};
                                snap.docs.forEach(d => { backup.collections[`event_attendance_${m}`][d.id] = d.data(); });
                            }
                        } catch(e) {}
                    }
                    // ãã¦ã³ã­ã¼ã
                    const json = JSON.stringify(backup, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    if (statusEl) statusEl.textContent = `â ããã¯ã¢ããå®äº (${new Date().toLocaleString('ja-JP')})`;
                } catch (error) {
                    console.error('ããã¯ã¢ããã¨ã©ã¼:', error);
                    if (statusEl) statusEl.textContent = `â ããã¯ã¢ããå¤±æ: ${error.message}`;
                }
            }
        }
        window.app = new DanceStudioApp();
        app.init();
    </script>
</body>
</html>
