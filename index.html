<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>posse dance academy Ã©Â¡Â§Ã¥Â®Â¢Ã§Â®Â¡Ã§ÂÂÃ£ÂÂ·Ã£ÂÂ¹Ã£ÂÂÃ£ÂÂ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
        }
        .tab-active { border-bottom: 3px solid #3B82F6; color: #3B82F6; }
        .status-tab-active { background-color: #3B82F6; color: white; }
        .status-badge-active { background-color: #10B981; color: white; }
        .status-badge-paused { background-color: #F59E0B; color: white; }
        .status-badge-withdrawn { background-color: #6B7280; color: white; }
        .gender-male { color: #2563EB; font-weight: 600; }
        .gender-female { color: #DC2626; font-weight: 600; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #F3F4F6; }
        .sort-icon { display: inline-block; margin-left: 4px; font-size: 10px; }
        
        table { table-layout: fixed; }
        td, th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        td.memo-cell { 
            white-space: normal !important;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.5;
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            vertical-align: top;
        }
        
        td.email-cell {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã¥ÂÂ¥Ã£ÂÂ®Ã¨ÂÂ²Ã¥ÂÂÃ£ÂÂ */
        .class-red { background-color: #DC2626; }
        .class-orange { background-color: #EA580C; }
        .class-blue { background-color: #2563EB; }
        .class-green { background-color: #16A34A; }
        .class-purple { background-color: #9333EA; }
        
        .border-red-500 { border-color: #EF4444; }
        .border-orange-500 { border-color: #F97316; }
        .border-blue-500 { border-color: #3B82F6; }
        .border-green-500 { border-color: #22C55E; }
        .border-purple-500 { border-color: #A855F7; }
        
        .text-red-600 { color: #DC2626; }
        .text-orange-600 { color: #EA580C; }
        .text-blue-600 { color: #2563EB; }
        .text-green-600 { color: #16A34A; }
        .text-purple-600 { color: #9333EA; }
        
        .bg-red-600 { background-color: #DC2626; }
        .bg-orange-600 { background-color: #EA580C; }
        .bg-blue-600 { background-color: #2563EB; }
        .bg-green-600 { background-color: #16A34A; }
        .bg-purple-600 { background-color: #9333EA; }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .student-search-results {
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
        }
        
        .select-customer-btn:hover {
            background-color: #EFF6FF;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const firebaseConfig = {
            apiKey: "AIzaSyBp3_3UwgOKkILJuWx8usYdQhGfB_bAD34",
            authDomain: "posse-dance-academy.firebaseapp.com",
            projectId: "posse-dance-academy",
            storageBucket: "posse-dance-academy.firebasestorage.app",
            messagingSenderId: "613497046871",
            appId: "1:613497046871:web:8a31cbc6b947617113e012"
        };
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        class DanceStudioApp {
            constructor() {
                this.currentTab = 'dashboard';
                this.statusFilter = 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­';
                this.customers = [];
                this.editingId = null;
                this.editForm = {};
                this.showAddForm = false;
                this.searchTerm = '';
                this.sortField = 'memberNumber';
                this.sortOrder = 'asc';
                this.newCustomer = this.getEmptyCustomer();
                
                // Ã¥ÂÂºÃ¥Â¸Â­Ã§Â°Â¿Ã§ÂÂ¨
                this.attendanceTab = 'overview';
                this.selectedMonth = new Date().toISOString().slice(0, 7);
                this.selectedDay = 'Ã¦ÂÂÃ¦ÂÂÃ¦ÂÂ¥';
                this.attendanceData = {};
                this.eventAttendanceData = []; // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¥Â°ÂÃ§ÂÂ¨Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.isLoading = false;
                this.editingStudent = null; // Ã§Â·Â¨Ã©ÂÂÃ¤Â¸Â­Ã£ÂÂ®Ã§ÂÂÃ¥Â¾ÂÃ¦ÂÂÃ¥Â Â±
                this.studentSearchTerm = ''; // Ã§ÂÂÃ¥Â¾ÂÃ¦Â¤ÂÃ§Â´Â¢Ã§ÂÂ¨
                this.studentSearchResults = []; // Ã¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂ
                this.selectedCustomerForStudent = null; // Ã©ÂÂ¸Ã¦ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ©Â¡Â§Ã¥Â®Â¢Ã¦ÂÂÃ¥Â Â±
                
                this.pricing = {
                    '4Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 18600,
                    'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 18600,
                    '3Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 14400,
                    'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 14400,
                    '2Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 10000,
                    'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 10000,
                    '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 6000,
                    'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 6000,
                    '1.5hÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 6600,
                    'Ã¥ÂÂÃ¥ÂÂÃ¤Â½ÂÃ©Â¨Â': 1000,
                    'Ã¥ÂÂÃ¥ÂÂÃ§ÂÂ¡Ã¦ÂÂ': 0,
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': 2000,
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': 2300,
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼1.5hÃ¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': 2200,
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼1.5hÃ¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': 2500,
                    'Ã¦ÂÂÃ¨Â¬ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã¦ÂÂ¯Ã¦ÂÂ¿': 1000,
                    'Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â': 500
                };
                this.planOrder = {
                    '4Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 1,
                    'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 1,
                    '3Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 2,
                    'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 2,
                    '2Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 3,
                    'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 3,
                    '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 4,
                    'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 4,
                    '1.5hÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹': 5,
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': 6,
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': 7,
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¦ÂÂ¯Ã¦ÂÂ¿Ã¯Â¼Â': 8,
                    'Ã¥ÂÂÃ¥ÂÂÃ¤Â½ÂÃ©Â¨Â': 9,
                    'Ã¥ÂÂÃ¥ÂÂÃ§ÂÂ¡Ã¦ÂÂ': 10
                };
                this.scheduleData = {
                    'Ã¦ÂÂÃ¦ÂÂÃ¦ÂÂ¥': [
                        { location: 'Ã¥Â¤Â©Ã§Â¥Â', name: 'Ã£ÂÂ¢Ã£ÂÂ¯Ã£ÂÂ­Ã£ÂÂÃ£ÂÂÃ£ÂÂ SOYA', color: 'red', students: [
                            { lastName: 'Ã¤Â¸Â­Ã¥Â³Â¶', firstName: 'Ã§Â«ÂÃ¥ÂÂ¾', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¼ÂÃ¨ÂÂ¤', firstName: 'Ã¥ÂÂÃ©Â¦Â¬', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ¤ÂºÂ', firstName: 'Ã©ÂÂ½Ã©ÂÂ³', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â´Â¥Ã§ÂÂ', firstName: 'Ã¥ÂÂµÃ§ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¸ÂÃ©ÂÂÃ©ÂÂ', firstName: 'Ã§ÂÂÃ§ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã£ÂÂ²Ã£ÂÂÃ£ÂÂÃ£ÂÂ', firstName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥Â¶ÂÃ¥Â·Â', firstName: 'Ã©ÂÂ½Ã¥Â¤Â§', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: '', firstName: 'Ã¥Â¤Â§Ã§Â©Âº', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â©Ã§Â¥Â', name: 'Ã£ÂÂÃ£ÂÂ¬Ã£ÂÂ¤Ã£ÂÂ­Ã£ÂÂ³Ã¥ÂÂ¥Ã©ÂÂ SOYA', color: 'orange', students: [
                            { lastName: 'Ã¦Â´Â¥Ã§ÂÂ', firstName: 'Ã¥ÂÂµÃ§ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¦Â', firstName: 'Ã¨ÂÂ±Ã¦Â¢Â¨', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã£ÂÂ²Ã£ÂÂÃ£ÂÂÃ£ÂÂ', firstName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â©Ã§Â¥Â', name: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ­Ã£ÂÂÃ£ÂÂ¯ Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¼Ã£ÂÂ¯ DAZ', color: 'blue', students: [
                            { lastName: 'Ã¤Â¸Â­Ã¥Â³Â¶', firstName: 'Ã§Â«ÂÃ¥ÂÂ¾', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ¤ÂºÂ', firstName: 'Ã©ÂÂ½Ã©ÂÂ³', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¼ÂÃ¨ÂÂ¤', firstName: 'Ã¥ÂÂÃ©Â¦Â¬', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¸ÂÃ©ÂÂÃ©ÂÂ', firstName: 'Ã§ÂÂÃ§ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦ÂÂ¸Ã§ÂÂ°', firstName: 'Ã¥ÂÂ¯Ã¦ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â£Â®Ã¨ÂÂ', firstName: 'Ã©Â³Â³Ã¤Â»Â', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥Â¶ÂÃ¥Â·Â', firstName: 'Ã©ÂÂ½Ã¥Â¤Â§', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: '', firstName: 'Ã¥Â¤Â§Ã§Â©Âº', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â©Ã§Â¥Â', name: 'K-POP AI', color: 'green', students: [
                            { lastName: 'Ã¥Â¹Â³Ã¥Â¶Â', firstName: 'Ã¥Â½Â©Ã¤Â½Â³', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦ÂÂÃ¦ÂÂ', firstName: 'Ã¦ÂÂ©Ã§Â´Â', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã§ÂÂ³Ã¥ÂÂ', firstName: 'Ã§Â¾ÂÃ©Â»Â', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã§ÂÂ°Ã¤Â»Â£', firstName: 'Ã¦ÂÂÃ¥Â¥Â', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂ¯Ã©ÂÂ', firstName: 'Ã¨ÂÂÃ§Â¶Â­', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â©Ã§Â¥Â', name: 'hiphop HIMEKA', color: 'purple', students: [
                            { lastName: 'Ã§ÂÂ³Ã¥ÂÂ', firstName: 'Ã§Â¾ÂÃ©Â»Â', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¸Â­Ã¥Â·Â', firstName: 'Ã¥ÂÂÃ©ÂÂ³', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â§Ã¦Â©Â', name: 'hiphop HIMEKA', color: 'purple', students: [
                            { lastName: 'Ã¦Â¸ÂÃ¦Â°Â´', firstName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂ¿', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]}
                    ],
                    'Ã§ÂÂ«Ã¦ÂÂÃ¦ÂÂ¥': [
                        { location: 'Ã¥Â¤Â§Ã¦Â©Â', name: 'Ã£ÂÂ­Ã£ÂÂÃ£ÂÂºÃ£ÂÂÃ£ÂÂ³Ã£ÂÂ¹ AYANO', color: 'red', students: [
                            { lastName: 'Ã¥ÂÂ¤Ã¨Â³Â', firstName: 'Ã¦ÂÂÃ¤ÂºÂº', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂ¤Ã¨Â³Â', firstName: 'Ã¥ÂÂ¯Ã¦ÂÂÃ¥Â¦Â', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ¥ÂÂ£', firstName: 'Ã§ÂÂÃ¥ÂÂ¾', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂªÃ£ÂÂ¹', firstName: 'Ã£ÂÂÃ£ÂÂ¨Ã£ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥Â¯ÂÃ¤ÂºÂ', firstName: 'Ã¨ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â§Ã¦Â©Â', name: 'BgirlÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹ AYANO HARUHIKO', color: 'orange', students: [
                            { lastName: 'Ã¦ÂÂÃ§ÂÂ²', firstName: 'Ã¥Â¤Â§Ã¨Â¼Âª', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã§ÂÂ§Ã¨ÂÂ', name: 'Ã£ÂÂÃ£ÂÂ¬Ã£ÂÂ¤Ã£ÂÂ­Ã£ÂÂ³Ã¥ÂÂ¥Ã©ÂÂ SOYA', color: 'blue', students: [
                            { lastName: 'Ã¨Â¥Â¿Ã¥ÂÂ', firstName: 'Ã¥ÂÂÃ¦ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¦Â', firstName: 'Ã¨ÂÂ±Ã¦Â¢Â¨', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã§ÂÂ§Ã¨ÂÂ', name: 'Ã£ÂÂ¢Ã£ÂÂ¯Ã£ÂÂ­Ã¯Â¼ÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¼ SOYA', color: 'green', students: [
                            { lastName: 'Ã¥Â Â¤', firstName: 'Ã¥ÂÂÃ¤Â»Â', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ¦Â­Â¦', firstName: 'Ã¥ÂÂÃ¤Â¿Â', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]}
                    ],
                    'Ã¦Â°Â´Ã¦ÂÂÃ¦ÂÂ¥': [
                        { location: 'Ã¥Â¤Â©Ã§Â¥Â', name: 'Ã£ÂÂÃ£ÂÂ¬Ã£ÂÂ¤Ã£ÂÂ­Ã£ÂÂ³Ã¥ÂÂÃ§Â´Â HARUHIKO', color: 'red', students: [
                            { lastName: 'Ã§ÂÂ°Ã¥Â³Â¶', firstName: 'Ã¦Â¸Â', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ§ÂÂ°', firstName: 'Ã¦ÂÂºÃ¥Â¹Â¸', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦ÂÂ¬Ã¦Â©Â', firstName: 'Ã¥Â»ÂÃ¥Â£Â«', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã©ÂÂÃ¤ÂºÂ', firstName: 'Ã¥Â¤Â©Ã¥ÂÂª', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦ÂÂ°Ã¨ÂÂ¤', firstName: 'Ã¥Â¤Â§Ã¥Â¸Â', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂÃ¥Â·Â»', firstName: 'Ã¥Â¤Â§Ã¥ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã£ÂÂÃ£ÂÂ', firstName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂ¨', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂ¤Ã©ÂÂ', firstName: 'Ã¨ÂÂ¼Ã¥Â£Â«', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â©Ã§Â¥Â', name: 'Ã£ÂÂÃ£ÂÂ¬Ã£ÂÂ¤Ã£ÂÂ­Ã£ÂÂ³Ã¤Â¸Â­Ã¤Â¸ÂÃ§Â´Â HARUHIKO', color: 'orange', students: [
                            { lastName: 'Ã¦Â£Â®Ã§ÂÂ°', firstName: 'Ã§Â¿ÂÃ§ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¸Â­Ã¥Â±Â±', firstName: 'Ã§ÂµÂÃ¦ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: '', firstName: 'Ã¥Â¤Â§Ã§Â©Âº', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨Â¿Â«Ã§ÂÂ°', firstName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]}
                    ],
                    'Ã¦ÂÂ¨Ã¦ÂÂÃ¦ÂÂ¥': [
                        { location: 'Ã¥Â¤Â§Ã¦Â©Â', name: 'Ã£ÂÂÃ£ÂÂ¬Ã£ÂÂ¤Ã£ÂÂ­Ã£ÂÂ³Ã¥ÂÂ¥Ã©ÂÂ SOYA', color: 'red', students: [
                            { lastName: 'Ã¨Â±ÂÃ§Â¦Â', firstName: 'Ã¦ÂÂ Ã¦ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ¦ÂÂ', firstName: 'Ã¥Â¤ÂªÃ¥Â£Â±', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â±Â Ã§ÂÂ°', firstName: 'Ã¥ÂÂ¨', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¾Â¤Ã¦Â±Â', firstName: 'Ã¦ÂÂ ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ¥ÂÂ£', firstName: 'Ã¨Â³Â¢Ã¤Â¼Â¸', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¸Â¡Ã©ÂÂ', firstName: 'Ã¥ÂÂµÃ¥Â¤Âª', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂ¤Ã§ÂÂ°', firstName: 'Ã¥Â°ÂÃ¨ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂ¤Ã§ÂÂ°', firstName: 'Ã¥ÂÂÃ§Â¾Â½', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥Â°ÂÃ¦ÂÂ³', firstName: 'Ã¥ÂÂÃ©ÂÂ½', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥Â±Â±Ã¤Â¸Â', firstName: 'Ã¥Â¹Â¸Ã¥ÂÂÃ©ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â§Ã¦Â©Â', name: 'Ã£ÂÂ¢Ã£ÂÂ¯Ã£ÂÂ­Ã¯Â¼ÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¼ SOYA', color: 'orange', students: [
                            { lastName: 'Ã¤Â¸Â­Ã¥Â±Â±', firstName: 'Ã§ÂµÂÃ¦ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨Â±ÂÃ§Â¦Â', firstName: 'Ã¦ÂÂ Ã¦ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ¦ÂÂ', firstName: 'Ã¥Â¤ÂªÃ¥Â£Â±', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ¥ÂÂ£', firstName: 'Ã¨Â³Â¢Ã¤Â¼Â¸', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ¤ÂºÂ', firstName: 'Ã©ÂÂ½Ã©ÂÂ³', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¸Â¡Ã©ÂÂ', firstName: 'Ã¥ÂÂµÃ¥Â¤Âª', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂ©Ã¥ÂÂ', firstName: 'Ã¨ÂÂÃ©Â¦Â', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥Â°ÂÃ¦ÂÂ³', firstName: 'Ã¥ÂÂÃ©ÂÂ½', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¾Â¤Ã¦Â±Â', firstName: 'Ã¦ÂÂ ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã§ÂÂ§Ã¨ÂÂ', name: 'Ã£ÂÂÃ£ÂÂ¬Ã£ÂÂ¤Ã£ÂÂ­Ã£ÂÂ³Ã¥ÂÂ¥Ã©ÂÂ Ã£ÂÂªÃ£ÂÂ¥Ã£ÂÂ¦Ã£ÂÂ»Ã£ÂÂ¤', color: 'blue', students: [
                            { lastName: 'Ã¦Â¥Â', firstName: 'Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂ§Ã£ÂÂ³Ã£ÂÂ¨Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¥Â', firstName: 'Ã£ÂÂ¨Ã£ÂÂ¯Ã£ÂÂ½', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ', firstName: 'Ã£ÂÂ¨Ã£ÂÂÃ£ÂÂ¾', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ', firstName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂ¾', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¢ÂÃ©ÂÂ', firstName: 'Ã¥Â£Â®Ã¥Â¤Â§', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¢ÂÃ©ÂÂ', firstName: 'Ã§ÂµÂ¢Ã©ÂÂ³', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã©ÂÂ·Ã¨Â°Â·Ã¥Â·Â', firstName: 'Ã¤Â¸Â', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã§ÂÂ§Ã¨ÂÂ', name: 'Ã£ÂÂ¢Ã£ÂÂ¯Ã£ÂÂ­Ã¯Â¼ÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¼ Ã£ÂÂªÃ£ÂÂ¥Ã£ÂÂ¦Ã£ÂÂ»Ã£ÂÂ¤', color: 'green', students: [
                            { lastName: 'Ã¥ÂÂÃ¦Â­Â¦', firstName: 'Ã¥ÂÂÃ¤Â¿Â', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¥Â', firstName: 'Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂ§Ã£ÂÂ³Ã£ÂÂ¨Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¥Â', firstName: 'Ã£ÂÂ¨Ã£ÂÂ¯Ã£ÂÂ½', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥Â·Â¥Ã¨ÂÂ¤', firstName: 'Ã¥Â¤Â§Ã¥ÂÂ°', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã©ÂÂ·Ã¨Â°Â·Ã¥Â·Â', firstName: 'Ã¤Â¸Â', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¢ÂÃ©ÂÂ', firstName: 'Ã¥Â£Â®Ã¥Â¤Â§', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¦Â¢ÂÃ©ÂÂ', firstName: 'Ã§ÂµÂ¢Ã©ÂÂ³', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]}
                    ],
                    'Ã©ÂÂÃ¦ÂÂÃ¦ÂÂ¥': [
                        { location: 'Ã¥Â¤Â©Ã§Â¥Â', name: 'Ã£ÂÂ¢Ã£ÂÂ¯Ã£ÂÂ­Ã¯Â¼ÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¼ SOYA', color: 'red', students: [
                            { lastName: 'Ã¤Â¸Â­Ã¥Â³Â¶', firstName: 'Ã§Â«ÂÃ¥ÂÂ¾', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¼ÂÃ¨ÂÂ¤', firstName: 'Ã¥ÂÂÃ©Â¦Â¬', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂ¤Ã©ÂÂ', firstName: 'Ã¨ÂÂ¼Ã¥Â£Â«', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¸Â­Ã¥Â±Â±', firstName: 'Ã©ÂÂ¼', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¸ÂÃ©ÂÂÃ©ÂÂ', firstName: 'Ã§ÂÂÃ§ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¾', firstName: 'Ã£ÂÂÃ£ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â©Ã§Â¥Â', name: 'Ã£ÂÂÃ£ÂÂ¬Ã£ÂÂ¤Ã£ÂÂ­Ã£ÂÂ³Ã¥ÂÂÃ¤Â¸Â­Ã§Â´Â HARUHIKO', color: 'orange', students: [
                            { lastName: 'Ã¤Â¸Â­Ã¥Â³Â¶', firstName: 'Ã§Â«ÂÃ¥ÂÂ¾', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¸ÂÃ©ÂÂÃ©ÂÂ', firstName: 'Ã§ÂÂÃ§ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¾', firstName: 'Ã£ÂÂÃ£ÂÂ', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¼ÂÃ¨ÂÂ¤', firstName: 'Ã¥ÂÂÃ©Â¦Â¬', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â§Ã¦Â©Â', name: 'Ã£ÂÂÃ£ÂÂ¬Ã£ÂÂ¤Ã£ÂÂ­Ã£ÂÂ³Ã¥ÂÂ¥Ã©ÂÂ HARUHIKO', color: 'blue', students: [
                            { lastName: 'Ã¨ÂÂ©Ã¥Â°Â¾', firstName: 'Ã©ÂÂÃ¦ÂµÂ·', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã§ÂÂ¢Ã©ÂÂ', firstName: 'Ã¦ÂÂ°', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¼ÂÃ¨Â±ÂÃ¦Â°Â¸', firstName: 'Ã¦ÂÂÃ©ÂÂ¢', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂ¤Ã¥Â·Â', firstName: 'Ã¦ÂÂ Ã¥ÂÂ©', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂ¤Ã¥Â·Â', firstName: 'Ã¦ÂÂÃ¥ÂÂ©', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¸ÂÃ©ÂÂÃ©ÂÂ', firstName: 'Ã£ÂÂÃ£ÂÂª', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¹ÂÃ¤Â¿ÂÃ§ÂÂ°', firstName: 'Ã¦ÂÂ±Ã©ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂ¤Ã¨Â³Â', firstName: 'Ã¥Â¿ÂÃ¥Â¤ÂªÃ©ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]},
                        { location: 'Ã¥Â¤Â§Ã¦Â©Â', name: 'Ã£ÂÂ¢Ã£ÂÂ¯Ã£ÂÂ­Ã¯Â¼ÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¼ ryusei', color: 'green', students: [
                            { lastName: 'Ã¨ÂÂ©Ã¥Â°Â¾', firstName: 'Ã©ÂÂÃ¦ÂµÂ·', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂ¤Ã¥Â·Â', firstName: 'Ã¦ÂÂ Ã¥ÂÂ©', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¨ÂÂ¤Ã¥Â·Â', firstName: 'Ã¦ÂÂÃ¥ÂÂ©', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¤Â¸ÂÃ©ÂÂÃ©ÂÂ', firstName: 'Ã£ÂÂÃ£ÂÂª', plan: 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' },
                            { lastName: 'Ã¥ÂÂÃ§ÂÂ', firstName: 'Ã¨ÂÂÃ¦ÂÂ', plan: '1Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' }
                        ]}
                    ],
                    'Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂ': []
                };
            }
            getEmptyCustomer() {
                return {
                    memberNumber: '', status: 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­', course: '', annualFee: '', hakomonoRegistration: '',
                    lastName: '', firstName: '', reading: '', guardianName: '', hakomonoName: '',
                    gender: '', birthDate: '', phone1: '', phone2: '', email: '',
                    postalCode: '', prefecture: '', city: '', address: '', building: '',
                    joinDate: '', memo: ''
                };
            }
            calculateAge(birthDate) {
                if (!birthDate) return '';
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age + 'Ã¦Â­Â³';
            }
            async init() {
                await this.loadCustomers();
                await this.loadScheduleData();
                await this.loadAttendance();
                await this.loadEventAttendance();
                
                // Ã¥ÂÂ¨Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã£ÂÂ®Ã§ÂÂÃ¥Â¾ÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã©Â ÂÃ£ÂÂ«Ã£ÂÂ½Ã£ÂÂ¼Ã£ÂÂ
                Object.keys(this.scheduleData).forEach(day => {
                    this.scheduleData[day].forEach(classInfo => {
                        classInfo.students = this.sortStudentsByPlan(classInfo.students);
                    });
                });
                
                this.render();
            }
            async loadCustomers() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'customers'));
                    this.customers = querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            status: data.status || (data.active === 'Ã¢ÂÂ' ? 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­' : 'Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­')
                        };
                    });
                    // Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¤Ã£ÂÂ¢Ã£ÂÂ³Ã£ÂÂÃ¥ÂÂ´Ã£ÂÂ§Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·Ã©Â ÂÃ£ÂÂ«Ã£ÂÂ½Ã£ÂÂ¼Ã£ÂÂ
                    this.customers.sort((a, b) => {
                        const aNum = a.memberNumber || '';
                        const bNum = b.memberNumber || '';
                        return aNum > bNum ? 1 : -1;
                    });
                } catch (error) {
                    console.error('Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã¨ÂªÂ­Ã£ÂÂ¿Ã¨Â¾Â¼Ã£ÂÂ¿Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                    this.customers = [];
                }
            }
            async loadScheduleData() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'schedule'));
                    if (querySnapshot.empty) {
                        // FirestoreÃ£ÂÂ«Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂÃ£ÂÂªÃ£ÂÂÃ¥Â Â´Ã¥ÂÂÃ£ÂÂ¯Ã¥ÂÂÃ¦ÂÂÃ£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂÃ¤Â¿ÂÃ¥Â­Â
                        console.log('Ã£ÂÂ¹Ã£ÂÂ±Ã£ÂÂ¸Ã£ÂÂ¥Ã£ÂÂ¼Ã£ÂÂ«Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂÃ¨Â¦ÂÃ£ÂÂ¤Ã£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ¥ÂÂÃ¦ÂÂÃ£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂÃ¤Â¿ÂÃ¥Â­ÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ');
                        await this.saveScheduleData();
                    } else {
                        // FirestoreÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂÃ¨ÂªÂ­Ã£ÂÂ¿Ã¨Â¾Â¼Ã£ÂÂ¿
                        const loadedData = {};
                        querySnapshot.docs.forEach(doc => {
                            loadedData[doc.id] = doc.data().classes || [];
                        });
                        
                        // Ã¨ÂªÂ­Ã£ÂÂ¿Ã¨Â¾Â¼Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂ§scheduleDataÃ£ÂÂÃ¦ÂÂ´Ã¦ÂÂ°
                        if (Object.keys(loadedData).length > 0) {
                            this.scheduleData = loadedData;
                        }
                    }
                } catch (error) {
                    console.error('Ã£ÂÂ¹Ã£ÂÂ±Ã£ÂÂ¸Ã£ÂÂ¥Ã£ÂÂ¼Ã£ÂÂ«Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã¨ÂªÂ­Ã£ÂÂ¿Ã¨Â¾Â¼Ã£ÂÂ¿Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                    // Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼Ã£ÂÂ®Ã¥Â Â´Ã¥ÂÂÃ£ÂÂ¯Ã¥ÂÂÃ¦ÂÂÃ£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂÃ¤Â½Â¿Ã§ÂÂ¨
                }
            }
            async saveScheduleData() {
                try {
                    // Ã¥ÂÂÃ¦ÂÂÃ¦ÂÂ¥Ã£ÂÂ®Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂFirestoreÃ£ÂÂ«Ã¤Â¿ÂÃ¥Â­Â
                    for (const day of Object.keys(this.scheduleData)) {
                        const docRef = doc(db, 'schedule', day);
                        await setDoc(docRef, {
                            classes: this.scheduleData[day]
                        });
                    }
                } catch (error) {
                    console.error('Ã£ÂÂ¹Ã£ÂÂ±Ã£ÂÂ¸Ã£ÂÂ¥Ã£ÂÂ¼Ã£ÂÂ«Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã¤Â¿ÂÃ¥Â­ÂÃ£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                }
            }
            async addCustomer() {
                if (!this.newCustomer.lastName || !this.newCustomer.firstName) {
                    alert('Ã¦Â°ÂÃ¥ÂÂÃ£ÂÂÃ¥ÂÂ¥Ã¥ÂÂÃ£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂ');
                    return;
                }
                if (!this.newCustomer.memberNumber) {
                    alert('Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·Ã£ÂÂÃ¥ÂÂ¥Ã¥ÂÂÃ£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂ');
                    return;
                }
                try {
                    await addDoc(collection(db, 'customers'), this.newCustomer);
                    await this.loadCustomers();
                    this.newCustomer = this.getEmptyCustomer();
                    this.showAddForm = false;
                    this.render();
                    alert('Ã§ÂÂ»Ã©ÂÂ²Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ');
                } catch (error) {
                    console.error('Ã§ÂÂ»Ã©ÂÂ²Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                    alert('Ã§ÂÂ»Ã©ÂÂ²Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼: ' + error.message);
                }
            }
            async saveEdit() {
                if (!this.editForm.id) {
                    alert('Ã¤Â¿ÂÃ¥Â­ÂÃ£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼: IDÃ£ÂÂÃ¨Â¦ÂÃ£ÂÂ¤Ã£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ');
                    return;
                }
                try {
                    const customerRef = doc(db, 'customers', this.editForm.id);
                    const { id, ...dataToSave } = this.editForm;
                    await updateDoc(customerRef, dataToSave);
                    await this.loadCustomers();
                    this.editingId = null;
                    this.editForm = {};
                    this.render();
                    alert('Ã¦ÂÂ´Ã¦ÂÂ°Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ');
                } catch (error) {
                    console.error('Ã¦ÂÂ´Ã¦ÂÂ°Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                    alert('Ã¦ÂÂ´Ã¦ÂÂ°Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼: ' + error.message);
                }
            }
            async deleteCustomer(id) {
                if (!confirm('Ã£ÂÂÃ£ÂÂ®Ã©Â¡Â§Ã¥Â®Â¢Ã£ÂÂÃ¥ÂÂÃ©ÂÂ¤Ã£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ§Ã£ÂÂÃ£ÂÂ?')) return;
                try {
                    await deleteDoc(doc(db, 'customers', id));
                    await this.loadCustomers();
                    this.render();
                    alert('Ã¥ÂÂÃ©ÂÂ¤Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ');
                } catch (error) {
                    console.error('Ã¥ÂÂÃ©ÂÂ¤Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                    alert('Ã¥ÂÂÃ©ÂÂ¤Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼: ' + error.message);
                }
            }
            startEdit(id) {
                this.editingId = id;
                const customer = this.customers.find(c => c.id === id);
                if (customer) {
                    this.editForm = { ...customer };
                    this.render();
                }
            }
            cancelEdit() {
                this.editingId = null;
                this.editForm = {};
                this.render();
            }
            updateEditField(field, value) {
                this.editForm[field] = value;
            }
            handleExport() {
                const headers = ['No', 'Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·', 'Ã¤Â¼ÂÃ¥ÂÂ¡Ã£ÂÂ¹Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂ¹', 'Ã£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹', 'Ã¥Â¹Â´Ã¤Â¼ÂÃ¨Â²Â»Ã¦ÂÂ´Ã¦ÂÂ°Ã¦ÂÂ¥', 'Ã¦Â°ÂÃ¥ÂÂ', 'Ã¨ÂªÂ­Ã£ÂÂ¿', 'Ã¤Â¿ÂÃ¨Â­Â·Ã¨ÂÂÃ¥ÂÂ', 'Ã£ÂÂÃ£ÂÂ³Ã£ÂÂ¢Ã£ÂÂÃ§ÂÂ»Ã©ÂÂ²Ã¥ÂÂ', 'Ã¦ÂÂ§Ã¥ÂÂ¥', 'Ã§ÂÂÃ¥Â¹Â´Ã¦ÂÂÃ¦ÂÂ¥', 'Ã¥Â¹Â´Ã©Â½Â¢', 'Ã©ÂÂ»Ã¨Â©Â±Ã§ÂÂªÃ¥ÂÂ·', 'Ã£ÂÂ¡Ã£ÂÂ¼Ã£ÂÂ«', 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¦ÂÂ¥', 'Ã©ÂÂµÃ¤Â¾Â¿Ã§ÂÂªÃ¥ÂÂ·', 'Ã©ÂÂ½Ã©ÂÂÃ¥ÂºÂÃ§ÂÂ', 'Ã¥Â¸ÂÃ¥ÂÂºÃ§ÂÂºÃ¦ÂÂ', 'Ã§ÂÂªÃ¥ÂÂ°', 'Ã¥Â»ÂºÃ§ÂÂ©Ã£ÂÂ»Ã©ÂÂ¨Ã¥Â±ÂÃ§ÂÂªÃ¥ÂÂ·', 'Ã¥ÂÂÃ¨ÂÂ'];
                const rows = this.customers.map((c, i) => [
                    i + 1, c.memberNumber || '', c.status, c.course, c.annualFee,
                    `${c.lastName} ${c.firstName}`, c.reading, c.guardianName, c.hakomonoName, c.gender,
                    c.birthDate, this.calculateAge(c.birthDate), c.phone1, c.email, c.joinDate,
                    c.postalCode, c.prefecture, c.city, c.address, c.building, c.memo
                ].map(f => `"${f || ''}"`).join(','));
                const csv = [headers.join(','), ...rows].join('\n');
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Ã©Â¡Â§Ã¥Â®Â¢Ã§Â®Â¡Ã§ÂÂ_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }
            sortBy(field) {
                if (this.sortField === field) {
                    this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortField = field;
                    this.sortOrder = 'asc';
                }
                this.render();
            }
            getFilteredCustomers() {
                const s = this.searchTerm.toLowerCase();
                let filtered = this.customers.filter(c => 
                    c.status === this.statusFilter &&
                    ((c.lastName || '').toLowerCase().includes(s) ||
                    (c.firstName || '').toLowerCase().includes(s) ||
                    (c.reading || '').toLowerCase().includes(s) ||
                    (c.course || '').toLowerCase().includes(s) ||
                    (c.phone1 || '').includes(s) ||
                    (c.email || '').toLowerCase().includes(s) ||
                    (c.memberNumber || '').includes(s))
                );
                filtered.sort((a, b) => {
                    let aVal = a[this.sortField] || '';
                    let bVal = b[this.sortField] || '';
                    if (this.sortOrder === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
                return filtered;
            }
            render() {
                const filteredCustomers = this.getFilteredCustomers();
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen">
                        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
                            <div class="container mx-auto px-4 py-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-2xl font-bold">posse dance academy</h1>
                                        <p class="text-sm opacity-90">Ã©Â¡Â§Ã¥Â®Â¢Ã§Â®Â¡Ã§ÂÂÃ£ÂÂ·Ã£ÂÂ¹Ã£ÂÂÃ£ÂÂ </p>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <nav class="bg-white shadow">
                            <div class="container mx-auto px-4">
                                <div class="flex space-x-8">
                                    <button id="dashboardTab" class="py-4 px-2 font-medium ${this.currentTab === 'dashboard' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">Ã£ÂÂÃ£ÂÂÃ£ÂÂ·Ã£ÂÂ¥Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ</button>
                                    <button id="customersTab" class="py-4 px-2 font-medium ${this.currentTab === 'customers' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">Ã©Â¡Â§Ã¥Â®Â¢Ã§Â®Â¡Ã§ÂÂ</button>
                                    <button id="attendanceTab" class="py-4 px-2 font-medium ${this.currentTab === 'attendance' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">Ã¥ÂÂºÃ¥Â¸Â­Ã¥ÂÂÃ§Â°Â¿</button>
                                </div>
                            </div>
                        </nav>
                        <main class="container mx-auto px-4 py-8">
                            ${this.currentTab === 'dashboard' ? this.renderDashboard() : 
                              this.currentTab === 'customers' ? this.renderCustomers(filteredCustomers) :
                              this.renderAttendance()}
                        </main>
                    </div>
                `;
                document.getElementById('dashboardTab')?.addEventListener('click', () => { this.currentTab = 'dashboard'; this.render(); });
                document.getElementById('customersTab')?.addEventListener('click', () => { this.currentTab = 'customers'; this.render(); });
                document.getElementById('attendanceTab')?.addEventListener('click', () => { this.currentTab = 'attendance'; this.render(); });
                if (this.currentTab === 'customers') {
                    this.setupCustomerPageEvents();
                } else if (this.currentTab === 'attendance') {
                    this.setupAttendanceEvents();
                }
            }
            setupCustomerPageEvents() {
                document.getElementById('exportBtn')?.addEventListener('click', () => this.handleExport());
                document.getElementById('toggleAddFormBtn')?.addEventListener('click', () => { this.showAddForm = !this.showAddForm; this.render(); });
                document.getElementById('searchInput')?.addEventListener('input', (e) => { this.searchTerm = e.target.value; this.render(); });
                document.getElementById('addCustomerBtn')?.addEventListener('click', () => this.addCustomer());
                document.getElementById('cancelAddBtn')?.addEventListener('click', () => { this.showAddForm = false; this.render(); });
                
                ['Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­', 'Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­', 'Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿'].forEach(status => {
                    document.getElementById(`status-${status}`)?.addEventListener('click', () => {
                        this.statusFilter = status;
                        this.render();
                    });
                });
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', () => {
                        this.sortBy(header.getAttribute('data-field'));
                    });
                });
                this.setupFormEvents();
                this.setupEditEvents();
            }
            setupFormEvents() {
                const fields = ['memberNumber', 'status', 'course', 'annualFee', 'lastName', 'firstName', 'reading', 'guardianName', 'hakomonoName', 'gender', 'birthDate', 'phone1', 'email', 'postalCode', 'prefecture', 'city', 'address', 'building', 'joinDate', 'memo'];
                fields.forEach(field => {
                    const el = document.getElementById(`new_${field}`);
                    if (el) {
                        el.addEventListener('change', (e) => { this.newCustomer[field] = e.target.value; });
                        el.addEventListener('input', (e) => { this.newCustomer[field] = e.target.value; });
                    }
                });
            }
            setupEditEvents() {
                document.querySelectorAll('[data-edit-action="start"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.startEdit(btn.getAttribute('data-id'));
                    });
                });
                document.querySelectorAll('[data-edit-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.deleteCustomer(btn.getAttribute('data-id'));
                    });
                });
                document.getElementById('saveEditBtn')?.addEventListener('click', () => this.saveEdit());
                document.getElementById('cancelEditBtn')?.addEventListener('click', () => this.cancelEdit());
                const editFields = ['memberNumber', 'status', 'course', 'annualFee', 'reading', 'guardianName', 'hakomonoName', 'gender', 'birthDate', 'phone1', 'email', 'postalCode', 'prefecture', 'city', 'address', 'building', 'joinDate', 'memo'];
                editFields.forEach(field => {
                    const el = document.getElementById(`edit_${field}`);
                    if (el) {
                        el.addEventListener('change', (e) => { this.updateEditField(field, e.target.value); });
                        el.addEventListener('input', (e) => { this.updateEditField(field, e.target.value); });
                    }
                });
                const nameField = document.getElementById('edit_fullName');
                if (nameField) {
                    nameField.addEventListener('input', (e) => {
                        const parts = e.target.value.split(' ');
                        this.editForm.lastName = parts[0] || '';
                        this.editForm.firstName = parts[1] || '';
                    });
                }
            }
            renderDashboard() {
                const total = this.customers.length;
                const activeCount = this.customers.filter(c => c.status === 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­').length;
                const pausedCount = this.customers.filter(c => c.status === 'Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­').length;
                const withdrawnCount = this.customers.filter(c => c.status === 'Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿').length;
                
                const coursePrices = {
                    'Ã¯Â¼Â': 6000,
                    'Ã¯Â¼Â': 10000,
                    'Ã¯Â¼Â': 14400,
                    'Ã¯Â¼Â': 18600
                };
                
                const courseCounts = {};
                this.customers.filter(c => c.status === 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­').forEach(c => { 
                    if (c.course) courseCounts[c.course] = (courseCounts[c.course] || 0) + 1; 
                });
                
                let totalRevenue = 0;
                Object.entries(courseCounts).forEach(([course, count]) => {
                    if (coursePrices[course]) {
                        totalRevenue += coursePrices[course] * count;
                    }
                });
                return `
                    <div>
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">Ã£ÂÂÃ£ÂÂÃ£ÂÂ·Ã£ÂÂ¥Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">Ã§Â·ÂÃ©Â¡Â§Ã¥Â®Â¢Ã¦ÂÂ°</div>
                                <div class="text-4xl font-bold text-blue-600">${total}</div>
                                <div class="text-xs text-gray-500 mt-2">Ã¥ÂÂ</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­</div>
                                <div class="text-4xl font-bold text-green-600">${activeCount}</div>
                                <div class="text-xs text-gray-500 mt-2">Ã¥ÂÂ</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­</div>
                                <div class="text-4xl font-bold text-orange-600">${pausedCount}</div>
                                <div class="text-xs text-gray-500 mt-2">Ã¥ÂÂ</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿</div>
                                <div class="text-4xl font-bold text-gray-600">${withdrawnCount}</div>
                                <div class="text-xs text-gray-500 mt-2">Ã¥ÂÂ</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">Ã£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹Ã¥ÂÂ¥Ã¥ÂÂÃ¨Â¨Â³Ã¯Â¼ÂÃ¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­Ã¯Â¼Â</h3>
                            <div class="space-y-3">
                                ${Object.keys(courseCounts).length > 0 ? Object.entries(courseCounts).map(([course, count]) => {
                                    const price = coursePrices[course] || 0;
                                    const subtotal = price * count;
                                    return `
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">Ã£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹${course || 'Ã¦ÂÂªÃ¨Â¨Â­Ã¥Â®Â'}</span>
                                            <div class="flex gap-4 items-center">
                                                <span class="text-gray-600">ÃÂ¥${price.toLocaleString()} ÃÂ ${count}Ã¥ÂÂ</span>
                                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">ÃÂ¥${subtotal.toLocaleString()}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('') : '<p class="text-gray-500">Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ</p>'}
                                ${Object.keys(courseCounts).length > 0 ? `
                                    <div class="border-t pt-3 mt-3">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-lg">Ã¥ÂÂÃ¨Â¨Â</span>
                                            <span class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-lg font-bold">ÃÂ¥${totalRevenue.toLocaleString()}</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            renderCustomers(filteredCustomers) {
                const getSortIcon = (field) => {
                    if (this.sortField === field) return this.sortOrder === 'asc' ? 'Ã¢ÂÂ²' : 'Ã¢ÂÂ¼';
                    return 'Ã¢Â¬Â';
                };
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800">Ã©Â¡Â§Ã¥Â®Â¢Ã§Â®Â¡Ã§ÂÂ</h2>
                            <div class="flex gap-2">
                                <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-sm">CSVÃ£ÂÂ¨Ã£ÂÂ¯Ã£ÂÂ¹Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ</button>
                                <button id="toggleAddFormBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">${this.showAddForm ? 'Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ¼Ã£ÂÂ Ã£ÂÂÃ©ÂÂÃ£ÂÂÃ£ÂÂ' : 'Ã¦ÂÂ°Ã¨Â¦ÂÃ§ÂÂ»Ã©ÂÂ²'}</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex gap-2 mb-4">
                                <button id="status-Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­" class="px-4 py-2 rounded transition ${this.statusFilter === 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­' ? 'status-tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­ (${this.customers.filter(c => c.status === 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­').length})
                                </button>
                                <button id="status-Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­" class="px-4 py-2 rounded transition ${this.statusFilter === 'Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­' ? 'status-tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­ (${this.customers.filter(c => c.status === 'Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­').length})
                                </button>
                                <button id="status-Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿" class="px-4 py-2 rounded transition ${this.statusFilter === 'Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿' ? 'status-tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿ (${this.customers.filter(c => c.status === 'Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿').length})
                                </button>
                            </div>
                            <div class="mb-4">
                                <input type="text" id="searchInput" placeholder="Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·Ã£ÂÂÃ¦Â°ÂÃ¥ÂÂÃ£ÂÂÃ£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹Ã£ÂÂÃ©ÂÂ»Ã¨Â©Â±Ã§ÂÂªÃ¥ÂÂ·Ã£ÂÂÃ£ÂÂ¡Ã£ÂÂ¼Ã£ÂÂ«Ã£ÂÂ§Ã¦Â¤ÂÃ§Â´Â¢..." value="${this.searchTerm}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            ${this.showAddForm ? this.renderAddForm() : ''}
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 50px;">No</th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="memberNumber" style="width: 80px;">Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·<span class="sort-icon">${getSortIcon('memberNumber')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="status" style="width: 120px;">Ã¤Â¼ÂÃ¥ÂÂ¡Ã£ÂÂ¹Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂ¹<span class="sort-icon">${getSortIcon('status')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="course" style="width: 80px;">Ã£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹<span class="sort-icon">${getSortIcon('course')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="annualFee" style="width: 120px;">Ã¥Â¹Â´Ã¤Â¼ÂÃ¨Â²Â»Ã¦ÂÂ´Ã¦ÂÂ°Ã¦ÂÂ¥<span class="sort-icon">${getSortIcon('annualFee')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="lastName" style="width: 150px;">Ã¦Â°ÂÃ¥ÂÂ<span class="sort-icon">${getSortIcon('lastName')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="reading" style="width: 150px;">Ã¨ÂªÂ­Ã£ÂÂ¿<span class="sort-icon">${getSortIcon('reading')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="guardianName" style="width: 120px;">Ã¤Â¿ÂÃ¨Â­Â·Ã¨ÂÂÃ¥ÂÂ<span class="sort-icon">${getSortIcon('guardianName')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="hakomonoName" style="width: 120px;">Ã£ÂÂÃ£ÂÂ³Ã£ÂÂ¢Ã£ÂÂÃ§ÂÂ»Ã©ÂÂ²Ã¥ÂÂ<span class="sort-icon">${getSortIcon('hakomonoName')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="gender" style="width: 60px;">Ã¦ÂÂ§Ã¥ÂÂ¥<span class="sort-icon">${getSortIcon('gender')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="birthDate" style="width: 110px;">Ã§ÂÂÃ¥Â¹Â´Ã¦ÂÂÃ¦ÂÂ¥<span class="sort-icon">${getSortIcon('birthDate')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 70px;">Ã¥Â¹Â´Ã©Â½Â¢</th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="phone1" style="width: 130px;">Ã©ÂÂ»Ã¨Â©Â±Ã§ÂÂªÃ¥ÂÂ·<span class="sort-icon">${getSortIcon('phone1')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="email" style="width: 220px;">Ã£ÂÂ¡Ã£ÂÂ¼Ã£ÂÂ«<span class="sort-icon">${getSortIcon('email')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="joinDate" style="width: 110px;">Ã¥ÂÂ¥Ã¤Â¼ÂÃ¦ÂÂ¥<span class="sort-icon">${getSortIcon('joinDate')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="postalCode" style="width: 100px;">Ã©ÂÂµÃ¤Â¾Â¿Ã§ÂÂªÃ¥ÂÂ·<span class="sort-icon">${getSortIcon('postalCode')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="prefecture" style="width: 90px;">Ã©ÂÂ½Ã©ÂÂÃ¥ÂºÂÃ§ÂÂ<span class="sort-icon">${getSortIcon('prefecture')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="city" style="width: 120px;">Ã¥Â¸ÂÃ¥ÂÂºÃ§ÂÂºÃ¦ÂÂ<span class="sort-icon">${getSortIcon('city')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="address" style="width: 150px;">Ã§ÂÂªÃ¥ÂÂ°<span class="sort-icon">${getSortIcon('address')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold sortable-header" data-field="building" style="width: 150px;">Ã¥Â»ÂºÃ§ÂÂ©Ã£ÂÂ»Ã©ÂÂ¨Ã¥Â±ÂÃ§ÂÂªÃ¥ÂÂ·<span class="sort-icon">${getSortIcon('building')}</span></th>
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 400px;">Ã¥ÂÂÃ¨ÂÂ</th>
                                            <th class="px-2 py-3 text-left font-semibold" style="width: 100px;">Ã¦ÂÂÃ¤Â½Â</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredCustomers.map((c, i) => this.renderCustomerRow(c, i + 1)).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 text-sm text-gray-600">
                                ${this.statusFilter}: ${filteredCustomers.length}Ã¥ÂÂ
                            </div>
                        </div>
                    </div>
                `;
            }
            renderAddForm() {
                return `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Ã¦ÂÂ°Ã¨Â¦ÂÃ©Â¡Â§Ã¥Â®Â¢Ã§ÂÂ»Ã©ÂÂ²</h3>
                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <div><label class="block text-sm font-medium mb-1">Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ· *</label><input type="text" id="new_memberNumber" class="w-full border rounded px-2 py-1 text-sm" placeholder="Ã¤Â¾Â: 0001"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¤Â¼ÂÃ¥ÂÂ¡Ã£ÂÂ¹Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂ¹</label><select id="new_status" class="w-full border rounded px-2 py-1 text-sm"><option value="Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­">Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­</option><option value="Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­">Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­</option><option value="Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿">Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">Ã£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹</label><select id="new_course" class="w-full border rounded px-2 py-1 text-sm"><option value="">Ã©ÂÂ¸Ã¦ÂÂÃ£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂ</option><option value="Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼">Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼</option><option value="Ã¯Â¼Â">Ã¯Â¼Â</option><option value="Ã¯Â¼Â">Ã¯Â¼Â</option><option value="Ã¯Â¼Â">Ã¯Â¼Â</option><option value="Ã¯Â¼Â">Ã¯Â¼Â</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¥Â¹Â´Ã¤Â¼ÂÃ¨Â²Â»Ã¦ÂÂ´Ã¦ÂÂ°Ã¦ÂÂ¥</label><input type="date" id="new_annualFee" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¦Â°ÂÃ¥ÂÂ(Ã¥Â§Â) *</label><input type="text" id="new_lastName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¦Â°ÂÃ¥ÂÂ(Ã¥ÂÂ) *</label><input type="text" id="new_firstName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¨ÂªÂ­Ã£ÂÂ¿</label><input type="text" id="new_reading" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¤Â¿ÂÃ¨Â­Â·Ã¨ÂÂÃ¥ÂÂ</label><input type="text" id="new_guardianName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã£ÂÂÃ£ÂÂ³Ã£ÂÂ¢Ã£ÂÂÃ§ÂÂ»Ã©ÂÂ²Ã¥ÂÂ</label><input type="text" id="new_hakomonoName" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¦ÂÂ§Ã¥ÂÂ¥</label><select id="new_gender" class="w-full border rounded px-2 py-1 text-sm"><option value="">Ã©ÂÂ¸Ã¦ÂÂ</option><option value="Ã§ÂÂ·">Ã§ÂÂ·</option><option value="Ã¥Â¥Â³">Ã¥Â¥Â³</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">Ã§ÂÂÃ¥Â¹Â´Ã¦ÂÂÃ¦ÂÂ¥</label><input type="date" id="new_birthDate" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã©ÂÂ»Ã¨Â©Â±Ã§ÂÂªÃ¥ÂÂ·</label><input type="tel" id="new_phone1" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div class="col-span-2"><label class="block text-sm font-medium mb-1">Ã£ÂÂ¡Ã£ÂÂ¼Ã£ÂÂ«</label><input type="email" id="new_email" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¥ÂÂ¥Ã¤Â¼ÂÃ¦ÂÂ¥</label><input type="date" id="new_joinDate" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã©ÂÂµÃ¤Â¾Â¿Ã§ÂÂªÃ¥ÂÂ·</label><input type="text" id="new_postalCode" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã©ÂÂ½Ã©ÂÂÃ¥ÂºÂÃ§ÂÂ</label><input type="text" id="new_prefecture" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¥Â¸ÂÃ¥ÂÂºÃ§ÂÂºÃ¦ÂÂ</label><input type="text" id="new_city" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã§ÂÂªÃ¥ÂÂ°</label><input type="text" id="new_address" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div><label class="block text-sm font-medium mb-1">Ã¥Â»ÂºÃ§ÂÂ©Ã£ÂÂ»Ã©ÂÂ¨Ã¥Â±ÂÃ§ÂÂªÃ¥ÂÂ·</label><input type="text" id="new_building" class="w-full border rounded px-2 py-1 text-sm"></div>
                            <div class="col-span-3"><label class="block text-sm font-medium mb-1">Ã¥ÂÂÃ¨ÂÂ</label><input type="text" id="new_memo" class="w-full border rounded px-2 py-1 text-sm"></div>
                        </div>
                        <div class="flex gap-2">
                            <button id="addCustomerBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">Ã§ÂÂ»Ã©ÂÂ²</button>
                            <button id="cancelAddBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400 transition">Ã£ÂÂ­Ã£ÂÂ£Ã£ÂÂ³Ã£ÂÂ»Ã£ÂÂ«</button>
                        </div>
                    </div>
                `;
            }
            renderCustomerRow(customer, no) {
                const statusBadgeClass = customer.status === 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­' ? 'status-badge-active' : customer.status === 'Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­' ? 'status-badge-paused' : 'status-badge-withdrawn';
                const genderClass = customer.gender === 'Ã§ÂÂ·' ? 'gender-male' : customer.gender === 'Ã¥Â¥Â³' ? 'gender-female' : '';
                const age = this.calculateAge(customer.birthDate);
                
                if (this.editingId === customer.id) {
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-2 py-3">${no}</td>
                            <td class="px-2 py-3"><input type="text" id="edit_memberNumber" value="${this.editForm.memberNumber || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><select id="edit_status" class="w-full border rounded px-1 py-1 text-xs"><option value="Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­" ${this.editForm.status === 'Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­' ? 'selected' : ''}>Ã¥ÂÂ¥Ã¤Â¼ÂÃ¤Â¸Â­</option><option value="Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­" ${this.editForm.status === 'Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­' ? 'selected' : ''}>Ã¤Â¼ÂÃ¤Â¼ÂÃ¤Â¸Â­</option><option value="Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿" ${this.editForm.status === 'Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿' ? 'selected' : ''}>Ã©ÂÂÃ¤Â¼ÂÃ¦Â¸ÂÃ£ÂÂ¿</option></select></td>
                            <td class="px-2 py-3"><select id="edit_course" class="w-full border rounded px-1 py-1 text-xs"><option value="">Ã©ÂÂ¸Ã¦ÂÂ</option><option value="Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼" ${this.editForm.course === 'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼' ? 'selected' : ''}>Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼</option><option value="Ã¯Â¼Â" ${this.editForm.course === 'Ã¯Â¼Â' ? 'selected' : ''}>Ã¯Â¼Â</option><option value="Ã¯Â¼Â" ${this.editForm.course === 'Ã¯Â¼Â' ? 'selected' : ''}>Ã¯Â¼Â</option><option value="Ã¯Â¼Â" ${this.editForm.course === 'Ã¯Â¼Â' ? 'selected' : ''}>Ã¯Â¼Â</option><option value="Ã¯Â¼Â" ${this.editForm.course === 'Ã¯Â¼Â' ? 'selected' : ''}>Ã¯Â¼Â</option></select></td>
                            <td class="px-2 py-3"><input type="date" id="edit_annualFee" value="${this.editForm.annualFee || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_fullName" value="${this.editForm.lastName || ''} ${this.editForm.firstName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_reading" value="${this.editForm.reading || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_guardianName" value="${this.editForm.guardianName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_hakomonoName" value="${this.editForm.hakomonoName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><select id="edit_gender" class="w-full border rounded px-1 py-1 text-xs"><option value="">-</option><option value="Ã§ÂÂ·" ${this.editForm.gender === 'Ã§ÂÂ·' ? 'selected' : ''}>Ã§ÂÂ·</option><option value="Ã¥Â¥Â³" ${this.editForm.gender === 'Ã¥Â¥Â³' ? 'selected' : ''}>Ã¥Â¥Â³</option></select></td>
                            <td class="px-2 py-3"><input type="date" id="edit_birthDate" value="${this.editForm.birthDate || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3 text-center">${this.calculateAge(this.editForm.birthDate)}</td>
                            <td class="px-2 py-3"><input type="tel" id="edit_phone1" value="${this.editForm.phone1 || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="email" id="edit_email" value="${this.editForm.email || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="date" id="edit_joinDate" value="${this.editForm.joinDate || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_postalCode" value="${this.editForm.postalCode || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_prefecture" value="${this.editForm.prefecture || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_city" value="${this.editForm.city || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_address" value="${this.editForm.address || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_building" value="${this.editForm.building || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3 memo-cell"><textarea id="edit_memo" class="w-full border rounded px-1 py-1 text-xs" rows="2">${this.editForm.memo || ''}</textarea></td>
                            <td class="px-2 py-3"><div class="flex flex-col gap-1"><button id="saveEditBtn" class="text-green-600 hover:text-green-800 text-xs">Ã¤Â¿ÂÃ¥Â­Â</button><button id="cancelEditBtn" class="text-gray-600 hover:text-gray-800 text-xs">Ã£ÂÂ­Ã£ÂÂ£Ã£ÂÂ³Ã£ÂÂ»Ã£ÂÂ«</button><button data-edit-action="delete" data-id="${customer.id}" class="text-red-600 hover:text-red-800 text-xs">Ã¥ÂÂÃ©ÂÂ¤</button></div></td>
                        </tr>
                    `;
                }
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-2 py-3">${no}</td>
                        <td class="px-2 py-3 font-mono">${customer.memberNumber || ''}</td>
                        <td class="px-2 py-3"><span class="px-2 py-1 rounded text-xs font-semibold ${statusBadgeClass}">${customer.status || ''}</span></td>
                        <td class="px-2 py-3">${customer.course || ''}</td>
                        <td class="px-2 py-3">${customer.annualFee || ''}</td>
                        <td class="px-2 py-3 font-medium">${customer.lastName || ''} ${customer.firstName || ''}</td>
                        <td class="px-2 py-3">${customer.reading || ''}</td>
                        <td class="px-2 py-3">${customer.guardianName || ''}</td>
                        <td class="px-2 py-3">${customer.hakomonoName || ''}</td>
                        <td class="px-2 py-3 text-center ${genderClass}">${customer.gender || ''}</td>
                        <td class="px-2 py-3">${customer.birthDate || ''}</td>
                        <td class="px-2 py-3 text-center">${age}</td>
                        <td class="px-2 py-3">${customer.phone1 || ''}</td>
                        <td class="px-2 py-3 email-cell">${customer.email || ''}</td>
                        <td class="px-2 py-3">${customer.joinDate || ''}</td>
                        <td class="px-2 py-3">${customer.postalCode || ''}</td>
                        <td class="px-2 py-3">${customer.prefecture || ''}</td>
                        <td class="px-2 py-3">${customer.city || ''}</td>
                        <td class="px-2 py-3">${customer.address || ''}</td>
                        <td class="px-2 py-3">${customer.building || ''}</td>
                        <td class="px-2 py-3 memo-cell">${customer.memo || ''}</td>
                        <td class="px-2 py-3"><button data-edit-action="start" data-id="${customer.id}" class="text-blue-600 hover:text-blue-800 text-xs">Ã§Â·Â¨Ã©ÂÂ</button></td>
                    </tr>
                `;
            }
            sortStudentsByPlan(students) {
                return students.sort((a, b) => {
                    // Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã¥ÂÂÃ£ÂÂÃ¦Â­Â£Ã¨Â¦ÂÃ¥ÂÂÃ¯Â¼ÂÃ¥ÂÂ¨Ã¨Â§ÂÃ¦ÂÂ°Ã¥Â­ÂÃ£ÂÂÃ¥ÂÂÃ¨Â§ÂÃ£ÂÂ«Ã¥Â¤ÂÃ¦ÂÂÃ¯Â¼Â
                    const normalizePlan = (plan) => {
                        return plan.replace(/[Ã¯Â¼Â-Ã¯Â¼Â]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                    };
                    
                    const planA = normalizePlan(a.plan);
                    const planB = normalizePlan(b.plan);
                    
                    const orderA = this.planOrder[planA] || 999;
                    const orderB = this.planOrder[planB] || 999;
                    return orderA - orderB;
                });
            }
            // Ã©ÂÂ¸Ã¦ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ©Â¡Â§Ã¥Â®Â¢Ã¦ÂÂÃ¥Â Â±Ã£ÂÂ®Ã¨Â¡Â¨Ã§Â¤ÂºÃ£ÂÂ®Ã£ÂÂ¿Ã£ÂÂÃ¦ÂÂ´Ã¦ÂÂ°
            updateSelectedCustomerInfo() {
                const selectedInfoContainer = document.getElementById('selectedCustomerInfo');
                const planSelect = document.getElementById('new_student_plan');
                const nameInputContainer = document.getElementById('nameInputContainer');
                const planSelectContainer = document.getElementById('planSelectContainer');
                
                if (!selectedInfoContainer) return;
                
                if (this.selectedCustomerForStudent) {
                    selectedInfoContainer.innerHTML = `
                        <div class="mb-3 p-3 bg-green-50 border-2 border-green-400 rounded text-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold text-green-800">Ã¢ÂÂ Ã©ÂÂ¸Ã¦ÂÂÃ¤Â¸Â­: ${this.selectedCustomerForStudent.lastName} ${this.selectedCustomerForStudent.firstName}</div>
                                    <div class="text-xs text-gray-700 mt-1">
                                        ${this.selectedCustomerForStudent.memberNumber ? `Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·: ${this.selectedCustomerForStudent.memberNumber} | ` : ''}
                                        ${this.selectedCustomerForStudent.reading ? `Ã¨ÂªÂ­Ã£ÂÂ¿: ${this.selectedCustomerForStudent.reading} | ` : ''}
                                        Ã£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹: ${this.selectedCustomerForStudent.course || 'Ã£ÂÂªÃ£ÂÂ'}
                                    </div>
                                </div>
                                <button 
                                    id="clearSelectedCustomer"
                                    class="text-red-600 hover:text-red-800 text-xs underline">
                                    Ã©ÂÂ¸Ã¦ÂÂÃ¨Â§Â£Ã©ÂÂ¤
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Ã¥Â§ÂÃ¥ÂÂÃ¥ÂÂ¥Ã¥ÂÂÃ¦Â¬ÂÃ£ÂÂÃ©ÂÂÃ¨Â¡Â¨Ã§Â¤Âº
                    if (nameInputContainer) {
                        nameInputContainer.classList.add('hidden');
                        nameInputContainer.classList.remove('col-span-2', 'grid', 'grid-cols-2', 'gap-3');
                    }
                    
                    // Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã£ÂÂ»Ã£ÂÂ¬Ã£ÂÂ¯Ã£ÂÂÃ£ÂÂ®Ã£ÂÂ¹Ã£ÂÂ¿Ã£ÂÂ¤Ã£ÂÂ«Ã£ÂÂÃ¨ÂªÂ¿Ã¦ÂÂ´
                    if (planSelectContainer) {
                        planSelectContainer.classList.add('col-span-3');
                    }
                    
                    // Ã©ÂÂ¸Ã¦ÂÂÃ¨Â§Â£Ã©ÂÂ¤Ã£ÂÂÃ£ÂÂ¿Ã£ÂÂ³Ã£ÂÂ®Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂÃ¥ÂÂÃ¨Â¨Â­Ã¥Â®Â
                    document.getElementById('clearSelectedCustomer')?.addEventListener('click', () => {
                        this.selectedCustomerForStudent = null;
                        this.studentSearchTerm = '';
                        this.studentSearchResults = [];
                        this.updateSelectedCustomerInfo();
                        // Ã¦Â¤ÂÃ§Â´Â¢Ã¥ÂÂ¥Ã¥ÂÂÃ¦Â¬ÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂªÃ£ÂÂ¢
                        const searchInput = document.getElementById('student_search_input');
                        if (searchInput) searchInput.value = '';
                        // Ã¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂªÃ£ÂÂ¢
                        this.updateSearchResults();
                        // Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã£ÂÂÃ£ÂÂªÃ£ÂÂ»Ã£ÂÂÃ£ÂÂ
                        if (planSelect) planSelect.value = '';
                    });
                    
                    // Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã£ÂÂÃ¨ÂÂªÃ¥ÂÂÃ¨Â¨Â­Ã¥Â®Â
                    if (planSelect && this.selectedCustomerForStudent.course) {
                        const courseMap = {'Ã¯Â¼Â': 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹', 'Ã¯Â¼Â': 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹', 'Ã¯Â¼Â': 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹', 'Ã¯Â¼Â': 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹'};
                        const planValue = courseMap[this.selectedCustomerForStudent.course] || '';
                        if (planValue) planSelect.value = planValue;
                    }
                } else {
                    selectedInfoContainer.innerHTML = '';
                    
                    // Ã¥Â§ÂÃ¥ÂÂÃ¥ÂÂ¥Ã¥ÂÂÃ¦Â¬ÂÃ£ÂÂÃ¨Â¡Â¨Ã§Â¤Âº
                    if (nameInputContainer) {
                        nameInputContainer.classList.remove('hidden');
                        nameInputContainer.classList.add('col-span-2', 'grid', 'grid-cols-2', 'gap-3');
                    }
                    
                    // Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã£ÂÂ»Ã£ÂÂ¬Ã£ÂÂ¯Ã£ÂÂÃ£ÂÂ®Ã£ÂÂ¹Ã£ÂÂ¿Ã£ÂÂ¤Ã£ÂÂ«Ã£ÂÂÃ¥ÂÂÃ£ÂÂ«Ã¦ÂÂ»Ã£ÂÂ
                    if (planSelectContainer) {
                        planSelectContainer.classList.remove('col-span-3');
                    }
                }
            }
            // Ã¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ£ÂÂ®Ã£ÂÂ¿Ã£ÂÂÃ¦ÂÂ´Ã¦ÂÂ°Ã¯Â¼ÂÃ£ÂÂÃ£ÂÂ©Ã£ÂÂ¼Ã£ÂÂ«Ã£ÂÂ¹Ã£ÂÂÃ§Â¶Â­Ã¦ÂÂÃ¯Â¼Â
            updateSearchResults() {
                const resultsContainer = document.getElementById('searchResultsContainer');
                if (!resultsContainer) return;
                if (this.studentSearchResults.length > 0) {
                    resultsContainer.innerHTML = `
                        <div class="mt-2 border rounded bg-white student-search-results shadow-lg">
                            ${this.studentSearchResults.map(customer => `
                                <div 
                                    data-select-customer-id="${customer.id}"
                                    class="select-customer-btn p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm transition">
                                    <div class="font-medium text-blue-600">
                                        ${customer.lastName} ${customer.firstName}
                                        ${customer.memberNumber ? `<span class="text-xs text-gray-500 ml-2">[${customer.memberNumber}]</span>` : ''}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        ${customer.reading ? `Ã¨ÂªÂ­Ã£ÂÂ¿: ${customer.reading}` : ''}
                                        ${customer.reading && customer.course ? ' | ' : ''}
                                        ${customer.course ? `Ã£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹: ${customer.course}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // Ã¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ£ÂÂ®Ã£ÂÂ¯Ã£ÂÂªÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂÃ¥ÂÂÃ¨Â¨Â­Ã¥Â®Â
                    resultsContainer.querySelectorAll('.select-customer-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const customerId = btn.getAttribute('data-select-customer-id');
                            const customer = this.customers.find(c => c.id === customerId);
                            if (customer) {
                                this.selectCustomerForStudent(customer);
                            }
                        });
                    });
                } else if (this.studentSearchTerm.trim()) {
                    resultsContainer.innerHTML = `
                        <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                            Ã¢ÂÂ Ã¯Â¸Â Ã¨Â©Â²Ã¥Â½ÂÃ£ÂÂÃ£ÂÂÃ©Â¡Â§Ã¥Â®Â¢Ã£ÂÂÃ¨Â¦ÂÃ£ÂÂ¤Ã£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂÃ£ÂÂ§Ã£ÂÂÃ£ÂÂ
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '';
                }
            }
            // Ã£ÂÂ²Ã£ÂÂÃ£ÂÂÃ£ÂÂªÃ¢ÂÂÃ£ÂÂ«Ã£ÂÂ¿Ã£ÂÂ«Ã£ÂÂÃ¥Â¤ÂÃ¦ÂÂ
            hiraganaToKatakana(str) {
                return str.replace(/[\u3041-\u3096]/g, (match) => {
                    const chr = match.charCodeAt(0) + 0x60;
                    return String.fromCharCode(chr);
                });
            }
            // Ã£ÂÂ«Ã£ÂÂ¿Ã£ÂÂ«Ã£ÂÂÃ¢ÂÂÃ£ÂÂ²Ã£ÂÂÃ£ÂÂÃ£ÂÂªÃ¥Â¤ÂÃ¦ÂÂ
            katakanaToHiragana(str) {
                return str.replace(/[\u30a1-\u30f6]/g, (match) => {
                    const chr = match.charCodeAt(0) - 0x60;
                    return String.fromCharCode(chr);
                });
            }
            // Ã©Â¡Â§Ã¥Â®Â¢Ã¦Â¤ÂÃ§Â´Â¢Ã¦Â©ÂÃ¨ÂÂ½Ã¯Â¼ÂÃ¥Â¼Â·Ã¥ÂÂÃ§ÂÂÃ¯Â¼Â
            searchCustomerByName(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                if (!term) {
                    return [];
                }
                
                // Ã£ÂÂ²Ã£ÂÂÃ£ÂÂÃ£ÂÂªÃ£ÂÂ»Ã£ÂÂ«Ã£ÂÂ¿Ã£ÂÂ«Ã£ÂÂÃ¤Â¸Â¡Ã¦ÂÂ¹Ã£ÂÂ§Ã¦Â¤ÂÃ§Â´Â¢Ã£ÂÂ§Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ«
                const termHiragana = this.katakanaToHiragana(term);
                const termKatakana = this.hiraganaToKatakana(term);
                
                return this.customers.filter(c => {
                    // Ã¦Â°ÂÃ¥ÂÂÃ¯Â¼ÂÃ¥Â§ÂÃ¥ÂÂÃ¥ÂÂ¥Ã£ÂÂÃ£ÂÂ»Ã£ÂÂÃ£ÂÂ«Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ Ã¯Â¼Â
                    const lastName = (c.lastName || '').toLowerCase();
                    const firstName = (c.firstName || '').toLowerCase();
                    const fullName = `${lastName}${firstName}`;
                    const fullNameWithSpace = `${lastName} ${firstName}`;
                    
                    // Ã¨ÂªÂ­Ã£ÂÂ¿Ã¯Â¼ÂÃ£ÂÂ²Ã£ÂÂÃ£ÂÂÃ£ÂÂªÃ£ÂÂ»Ã£ÂÂ«Ã£ÂÂ¿Ã£ÂÂ«Ã£ÂÂÃ¤Â¸Â¡Ã¥Â¯Â¾Ã¥Â¿ÂÃ¯Â¼Â
                    const reading = (c.reading || '').toLowerCase();
                    const readingHiragana = this.katakanaToHiragana(reading);
                    const readingKatakana = this.hiraganaToKatakana(reading);
                    
                    // Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·
                    const memberNumber = (c.memberNumber || '').toLowerCase();
                    
                    // Ã¨Â¤ÂÃ¦ÂÂ°Ã£ÂÂ®Ã¦ÂÂ¡Ã¤Â»Â¶Ã£ÂÂ§Ã¦Â¤ÂÃ§Â´Â¢
                    return lastName.includes(term) ||
                           firstName.includes(term) ||
                           fullName.includes(term) ||
                           fullNameWithSpace.includes(term) ||
                           reading.includes(term) ||
                           reading.includes(termHiragana) ||
                           reading.includes(termKatakana) ||
                           readingHiragana.includes(term) ||
                           readingHiragana.includes(termHiragana) ||
                           readingKatakana.includes(term) ||
                           readingKatakana.includes(termKatakana) ||
                           memberNumber.includes(term);
                }).slice(0, 10); // Ã¦ÂÂÃ¥Â¤Â§10Ã¤Â»Â¶Ã£ÂÂ¾Ã£ÂÂ§Ã¨Â¡Â¨Ã§Â¤Âº
            }
            // Ã©Â¡Â§Ã¥Â®Â¢Ã£ÂÂÃ©ÂÂ¸Ã¦ÂÂÃ£ÂÂÃ£ÂÂ¦Ã§ÂÂÃ¥Â¾ÂÃ¦ÂÂÃ¥Â Â±Ã£ÂÂÃ¨ÂÂªÃ¥ÂÂÃ¥ÂÂ¥Ã¥ÂÂ
            selectCustomerForStudent(customer) {
                this.selectedCustomerForStudent = customer;
                this.studentSearchResults = [];
                this.studentSearchTerm = `${customer.lastName} ${customer.firstName}`;
                
                // Ã¦Â¤ÂÃ§Â´Â¢Ã¥ÂÂ¥Ã¥ÂÂÃ¦Â¬ÂÃ£ÂÂÃ¦ÂÂ´Ã¦ÂÂ°
                const searchInput = document.getElementById('student_search_input');
                if (searchInput) {
                    searchInput.value = this.studentSearchTerm;
                }
                
                // Ã¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂªÃ£ÂÂ¢
                this.updateSearchResults();
                
                // Ã©ÂÂ¸Ã¦ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ©Â¡Â§Ã¥Â®Â¢Ã¦ÂÂÃ¥Â Â±Ã£ÂÂÃ¨Â¡Â¨Ã§Â¤Âº
                this.updateSelectedCustomerInfo();
            }
            async addStudentToClass(day, location, className) {
                this.selectedClassForAdd = { day, location, className };
                this.showAddStudentForm = true;
                this.selectedCustomerForStudent = null;
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.render();
            }
            async saveNewStudent() {
                let lastName, firstName, plan;
                
                // Ã©Â¡Â§Ã¥Â®Â¢Ã£ÂÂÃ©ÂÂ¸Ã¦ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂÃ¥Â Â´Ã¥ÂÂ
                if (this.selectedCustomerForStudent) {
                    lastName = this.selectedCustomerForStudent.lastName;
                    firstName = this.selectedCustomerForStudent.firstName;
                    plan = document.getElementById('new_student_plan')?.value || '';
                } else {
                    lastName = document.getElementById('new_student_lastName')?.value || '';
                    firstName = document.getElementById('new_student_firstName')?.value || '';
                    plan = document.getElementById('new_student_plan')?.value || '';
                }
                if (!lastName || !firstName || !plan) {
                    alert('Ã¥Â§ÂÃ¥ÂÂÃ£ÂÂ¨Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã£ÂÂÃ¥ÂÂ¥Ã¥ÂÂÃ£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂ');
                    return;
                }
                const { day, location, className } = this.selectedClassForAdd;
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    this.scheduleData[day][classIndex].students.push({ lastName, firstName, plan });
                    this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(this.scheduleData[day][classIndex].students);
                    
                    // FirestoreÃ£ÂÂ«Ã¤Â¿ÂÃ¥Â­Â
                    await this.saveScheduleData();
                }
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.selectedCustomerForStudent = null;
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.render();
                alert('Ã§ÂÂÃ¥Â¾ÂÃ£ÂÂÃ¨Â¿Â½Ã¥ÂÂ Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ');
            }
            // Ã§ÂÂÃ¥Â¾ÂÃ£ÂÂ®Ã§Â·Â¨Ã©ÂÂÃ£ÂÂÃ©ÂÂÃ¥Â§Â
            startEditStudent(day, location, className, lastName, firstName) {
                this.editingStudent = { day, location, className, lastName, firstName };
                this.render();
            }
            // Ã§ÂÂÃ¥Â¾ÂÃ¦ÂÂÃ¥Â Â±Ã£ÂÂ®Ã¤Â¿ÂÃ¥Â­Â
            async saveEditStudent() {
                const newPlan = document.getElementById('edit_student_plan')?.value;
                if (!newPlan) {
                    alert('Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã£ÂÂÃ©ÂÂ¸Ã¦ÂÂÃ£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂ');
                    return;
                }
                const { day, location, className, lastName, firstName } = this.editingStudent;
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    const studentIndex = this.scheduleData[day][classIndex].students.findIndex(
                        s => s.lastName === lastName && s.firstName === firstName
                    );
                    
                    if (studentIndex !== -1) {
                        this.scheduleData[day][classIndex].students[studentIndex].plan = newPlan;
                        this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(this.scheduleData[day][classIndex].students);
                        
                        // FirestoreÃ£ÂÂ«Ã¤Â¿ÂÃ¥Â­Â
                        await this.saveScheduleData();
                    }
                }
                this.editingStudent = null;
                this.render();
                alert('Ã§ÂÂÃ¥Â¾ÂÃ¦ÂÂÃ¥Â Â±Ã£ÂÂÃ¦ÂÂ´Ã¦ÂÂ°Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ');
            }
            // Ã§ÂÂÃ¥Â¾ÂÃ£ÂÂ®Ã¥ÂÂÃ©ÂÂ¤
            async deleteStudent(day, location, className, lastName, firstName) {
                if (!confirm(`${lastName} ${firstName} Ã£ÂÂÃ¥ÂÂÃ©ÂÂ¤Ã£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ§Ã£ÂÂÃ£ÂÂÃ¯Â¼Â`)) {
                    return;
                }
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    this.scheduleData[day][classIndex].students = this.scheduleData[day][classIndex].students.filter(
                        s => !(s.lastName === lastName && s.firstName === firstName)
                    );
                    
                    // FirestoreÃ£ÂÂ«Ã¤Â¿ÂÃ¥Â­Â
                    await this.saveScheduleData();
                }
                // Ã¥ÂÂºÃ¥Â¸Â­Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂÃ¥ÂÂÃ©ÂÂ¤
                const studentKey = `${day}_${location}_${className}_${lastName}${firstName}`;
                const monthKey = this.selectedMonth.replace('-', '');
                try {
                    await deleteDoc(doc(db, `attendance_${monthKey}`, studentKey));
                } catch (error) {
                    console.log('Ã¥ÂÂºÃ¥Â¸Â­Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂ®Ã¥ÂÂÃ©ÂÂ¤Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼Ã¯Â¼ÂÃ£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂÃ¥Â­ÂÃ¥ÂÂ¨Ã£ÂÂÃ£ÂÂªÃ£ÂÂÃ¥ÂÂ¯Ã¨ÂÂ½Ã¦ÂÂ§Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ¯Â¼Â');
                }
                await this.loadAttendance();
                this.render();
                alert('Ã§ÂÂÃ¥Â¾ÂÃ£ÂÂÃ¥ÂÂÃ©ÂÂ¤Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ');
            }
            calculateVisitorRevenue() {
                let revenue = 0;
                const monthKey = this.selectedMonth.replace('-', '');
                
                Object.keys(this.attendanceData).forEach(key => {
                    const attendance = this.attendanceData[key];
                    const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                    
                    weeks.forEach(week => {
                        if (attendance[week] === 'Ã¢ÂÂ') {
                            // keyÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã¦ÂÂÃ¥Â Â±Ã£ÂÂÃ¥ÂÂÃ¥Â¾ÂÃ£ÂÂÃ£ÂÂÃ¥Â¿ÂÃ¨Â¦ÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂscheduleDataÃ£ÂÂÃ£ÂÂÃ¦Â¤ÂÃ§Â´Â¢
                            const parts = key.split('_');
                            const day = parts[0];
                            const location = parts[1];
                            const className = parts[2];
                            const studentName = parts.slice(3).join('_');
                            
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            const student = classData?.students.find(s => `${s.lastName}${s.firstName}` === studentName);
                            
                            // Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã£ÂÂÃ¤Â½ÂÃ©Â¨ÂÃ£ÂÂÃ§ÂÂ¡Ã¦ÂÂÃ£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã£ÂÂ®Ã£ÂÂ¿Ã¥Â£Â²Ã¤Â¸ÂÃ£ÂÂ«Ã¨Â¨ÂÃ¤Â¸Â
                            if (student && (student.plan.includes('Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼') || student.plan.includes('Ã¤Â½ÂÃ©Â¨Â') || student.plan.includes('Ã§ÂÂ¡Ã¦ÂÂ'))) {
                                if (this.pricing[student.plan]) {
                                    revenue += this.pricing[student.plan];
                                }
                            }
                        }
                    });
                });
                
                return revenue;
            }
            // Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼ÂÃ£ÂÂ®Ã¥Â£Â²Ã¤Â¸ÂÃ¨Â¨ÂÃ§Â®Â
            calculatePracticeRevenue() {
                let totalParticipants = 0;
                const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                const details = {};
                ['Ã¦ÂÂÃ¦ÂÂÃ¦ÂÂ¥', 'Ã¦ÂÂ¨Ã¦ÂÂÃ¦ÂÂ¥'].forEach(day => {
                    const key = `Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â_${day}`;
                    const data = this.attendanceData[key];
                    let dayTotal = 0;
                    if (data) {
                        weeks.forEach(week => {
                            const count = parseInt(data[week]) || 0;
                            dayTotal += count;
                        });
                    }
                    details[day] = dayTotal;
                    totalParticipants += dayTotal;
                });
                return { participants: totalParticipants, revenue: totalParticipants * 500, details };
            }
            // Ã¨Â©Â³Ã§Â´Â°Ã¥Â£Â²Ã¤Â¸ÂÃ¨Â¨ÂÃ§Â®ÂÃ¯Â¼ÂÃ¥ÂÂ¨Ã£ÂÂ«Ã£ÂÂÃ£ÂÂ´Ã£ÂÂªÃ¥ÂÂ¥Ã¯Â¼Â
            calculateDetailedRevenue() {
                const categories = {
                    'Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â': { count: 0, revenue: 0 },
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': { count: 0, revenue: 0 },
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': { count: 0, revenue: 0 },
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼1.5hÃ¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': { count: 0, revenue: 0 },
                    'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼1.5hÃ¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â': { count: 0, revenue: 0 },
                    'Ã¦ÂÂÃ¨Â¬ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã¦ÂÂ¯Ã¦ÂÂ¿': { count: 0, revenue: 0 },
                    'Ã¥ÂÂÃ¥ÂÂÃ¤Â½ÂÃ©Â¨Â': { count: 0, revenue: 0 },
                    'Ã¥ÂÂÃ¥ÂÂÃ§ÂÂ¡Ã¦ÂÂ': { count: 0, revenue: 0 }
                };
                // Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â
                const practice = this.calculatePracticeRevenue();
                categories['Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â'] = { count: practice.participants, revenue: practice.revenue };
                // Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã£ÂÂ»Ã¤Â½ÂÃ©Â¨ÂÃ§Â³Â»
                const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                Object.keys(this.attendanceData).forEach(key => {
                    if (key.startsWith('Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â_')) return; // Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼ÂÃ£ÂÂ¯Ã¥ÂÂ¥Ã¥ÂÂ¦Ã§ÂÂÃ¦Â¸ÂÃ£ÂÂ¿
                    const attendance = this.attendanceData[key];
                    weeks.forEach(week => {
                        if (attendance[week] === 'Ã¢ÂÂ') {
                            const parts = key.split('_');
                            const day = parts[0];
                            const location = parts[1];
                            const className = parts[2];
                            const studentName = parts.slice(3).join('_');
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            const student = classData?.students.find(s => `${s.lastName}${s.firstName}` === studentName);
                            if (student && categories[student.plan] !== undefined) {
                                const price = this.pricing[student.plan] || 0;
                                categories[student.plan].count++;
                                categories[student.plan].revenue += price;
                            }
                        }
                    });
                });
                return categories;
            }
            // Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼ÂÃ£ÂÂ®Ã¥Â£Â²Ã¤Â¸ÂÃ¨Â¨ÂÃ§Â®Â
            // åºå¸­ç°¿é¢é£ã®ã¡ã½ãã
            async loadAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const querySnapshot = await getDocs(collection(db, `attendance_${monthKey}`));
                    this.attendanceData = {};
                    querySnapshot.docs.forEach(doc => {
                        this.attendanceData[doc.id] = doc.data();
                    });
                } catch (error) {
                    console.error('åºå¸­ãã¼ã¿èª­ã¿è¾¼ã¿ã¨ã©ã¼:', error);
                    this.attendanceData = {};
                }
            }
            // ã¤ãã³ãå°ç¨ã®åºå¸­ãã¼ã¿èª­ã¿è¾¼ã¿
            async loadEventAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const querySnapshot = await getDocs(collection(db, `event_attendance_${monthKey}`));
                    this.eventAttendanceData = [];
                    querySnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        this.eventAttendanceData.push({
                            id: doc.id,
                            isMember: data.isMember || false,
                            ...data
                        });
                    });
                    // ä¸¦ã³é ãä¿æãããããindexã§ã½ã¼ã
                    this.eventAttendanceData.sort((a, b) => (a.index || 0) - (b.index || 0));
                } catch (error) {
                    console.error('ã¤ãã³ãåºå¸­ãã¼ã¿èª­ã¿è¾¼ã¿ã¨ã©ã¼:', error);
                    this.eventAttendanceData = [];
                }
            }
            // ã¤ãã³ãåºå¸­ãã¼ã¿ãä¿å­
            async saveEventAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    // å¨ãã¼ã¿ãä¿å­ï¼indexãè¿½å ï¼
                    for (let i = 0; i < this.eventAttendanceData.length; i++) {
                        const data = this.eventAttendanceData[i];
                        const docId = data.id || `event_${Date.now()}_${i}`;
                        const docRef = doc(db, `event_attendance_${monthKey}`, docId);
                        await setDoc(docRef, {
                            isMember: data.isMember || false,
                            lastName: data.lastName || '',
                            firstName: data.firstName || '',
                            week1: data.week1 || 'Ã',
                            week2: data.week2 || 'Ã',
                            week3: data.week3 || 'Ã',
                            fee: data.fee || 0,
                            memo: data.memo || '',
                            index: i
                        });
                        if (!data.id) {
                            this.eventAttendanceData[i].id = docId;
                        }
                    }
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('ã¤ãã³ãåºå¸­ãã¼ã¿ä¿å­ã¨ã©ã¼:', error);
                }
            }
            addEventParticipant() {
                this.eventAttendanceData.push({
                    id: null,
                    isMember: false,
                    lastName: '',
                    firstName: '',
                    week1: 'ÃÂ',
                    week2: 'ÃÂ',
                    week3: 'ÃÂ',
                    fee: 0,
                    memo: ''
                });
                this.render();
            }
            // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¥ÂÂÃ¥ÂÂ Ã¨ÂÂÃ£ÂÂÃ¥ÂÂÃ©ÂÂ¤
            async deleteEventParticipant(index) {
                if (!confirm('Ã£ÂÂÃ£ÂÂ®Ã¥ÂÂÃ¥ÂÂ Ã¨ÂÂÃ£ÂÂÃ¥ÂÂÃ©ÂÂ¤Ã£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ§Ã£ÂÂÃ£ÂÂÃ¯Â¼Â')) {
                    return;
                }
                
                const participant = this.eventAttendanceData[index];
                if (participant.id) {
                    try {
                        const monthKey = this.selectedMonth.replace('-', '');
                        await deleteDoc(doc(db, `event_attendance_${monthKey}`, participant.id));
                    } catch (error) {
                        console.error('Ã¥ÂÂÃ©ÂÂ¤Ã£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                    }
                }
                
                this.eventAttendanceData.splice(index, 1);
                await this.saveEventAttendance();
                this.render();
            }
            // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂ®Ã¥ÂÂÃ¨Â¨ÂÃ©ÂÂÃ©Â¡ÂÃ£ÂÂÃ¨Â¨ÂÃ§Â®Â
            calculateEventTotal() {
                return this.eventAttendanceData.reduce((sum, p) => sum + (parseFloat(p.fee) || 0), 0);
            }
            async saveAttendance(studentId, weekData) {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const docRef = doc(db, `attendance_${monthKey}`, studentId);
                    await setDoc(docRef, weekData, { merge: true });
                    await this.loadAttendance();
                } catch (error) {
                    console.error('Ã¥ÂÂºÃ¥Â¸Â­Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã¤Â¿ÂÃ¥Â­ÂÃ£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                }
            }
            toggleAttendance(classId, week) {
                const current = this.attendanceData[classId]?.[week] || '';
                const next = current === 'Ã¢ÂÂ' ? 'ÃÂ' : current === 'ÃÂ' ? 'Ã¤Â¼ÂÃ¨Â¬Â' : current === 'Ã¤Â¼ÂÃ¨Â¬Â' ? '' : 'Ã¢ÂÂ';
                
                if (!this.attendanceData[classId]) {
                    this.attendanceData[classId] = {};
                }
                this.attendanceData[classId][week] = next;
                
                this.saveAttendance(classId, this.attendanceData[classId]);
                this.render();
            }
            getAttendanceRate(classId) {
                const data = this.attendanceData[classId] || {};
                const weeks = ['week1', 'week2', 'week3', 'week4']; // Ã¤ÂºÂÃ¥ÂÂÃ©ÂÂ±Ã£ÂÂÃ©ÂÂ¤Ã¥Â¤Â
                const attended = weeks.filter(w => data[w] === 'Ã¢ÂÂ').length;
                const recorded = weeks.filter(w => data[w] === 'Ã¢ÂÂ' || data[w] === 'ÃÂ').length; // Ã¤Â¼ÂÃ¨Â¬ÂÃ£ÂÂÃ©ÂÂ¤Ã¥Â¤Â
                return recorded > 0 ? Math.round((attended / recorded) * 100) : 0;
            }
            // Ã¦ÂÂÃ¥ÂÂÃ£ÂÂÃ¦ÂÂ¿Ã£ÂÂÃ¦Â©ÂÃ¨ÂÂ½Ã£ÂÂÃ¤Â¿Â®Ã¦Â­Â£
            async changeMonth(direction) {
                this.isLoading = true;
                this.render();
                
                try {
                    // Ã§ÂÂ¾Ã¥ÂÂ¨Ã£ÂÂ®Ã¥Â¹Â´Ã¦ÂÂÃ£ÂÂÃ¥ÂÂÃ¥Â¾Â
                    const [currentYear, currentMonth] = this.selectedMonth.split('-').map(Number);
                    
                    // Ã¦ÂÂ°Ã£ÂÂÃ£ÂÂÃ¥Â¹Â´Ã¦ÂÂÃ£ÂÂÃ¨Â¨ÂÃ§Â®Â
                    let newYear = currentYear;
                    let newMonth = currentMonth + direction;
                    
                    // Ã¦ÂÂÃ£ÂÂ®Ã§Â¯ÂÃ¥ÂÂ²Ã£ÂÂÃ£ÂÂ§Ã£ÂÂÃ£ÂÂ¯Ã£ÂÂ¨Ã¥Â¹Â´Ã£ÂÂ®Ã¨ÂªÂ¿Ã¦ÂÂ´
                    if (newMonth > 12) {
                        newMonth = 1;
                        newYear++;
                    } else if (newMonth < 1) {
                        newMonth = 12;
                        newYear--;
                    }
                    
                    // YYYY-MMÃ¥Â½Â¢Ã¥Â¼ÂÃ£ÂÂ«Ã¥Â¤ÂÃ¦ÂÂÃ¯Â¼ÂÃ¦ÂÂÃ£ÂÂ¯2Ã¦Â¡ÂÃ£ÂÂ«Ã£ÂÂ¼Ã£ÂÂ­Ã£ÂÂÃ£ÂÂÃ£ÂÂ£Ã£ÂÂ³Ã£ÂÂ°Ã¯Â¼Â
                    this.selectedMonth = `${newYear}-${String(newMonth).padStart(2, '0')}`;
                    
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('Ã¦ÂÂÃ¥ÂÂÃ£ÂÂÃ¦ÂÂ¿Ã£ÂÂÃ£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }
            // Ã¦ÂÂÃ£ÂÂÃ§ÂÂ´Ã¦ÂÂ¥Ã©ÂÂ¸Ã¦ÂÂ
            async selectMonth(monthValue) {
                if (!monthValue) return;
                
                this.isLoading = true;
                this.selectedMonth = monthValue;
                this.render();
                
                try {
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('Ã¦ÂÂÃ©ÂÂ¸Ã¦ÂÂÃ£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }
            // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã¨Â¿Â½Ã¥ÂÂ Ã¦Â©ÂÃ¨ÂÂ½
            addClassToEvent() {
                this.showAddClassForm = true;
                this.render();
            }
            async saveNewClass() {
                const className = document.getElementById('new_class_name')?.value || '';
                const location = document.getElementById('new_class_location')?.value || 'Ã¥Â¤Â©Ã§Â¥Â';
                const color = document.getElementById('new_class_color')?.value || 'red';
                if (!className) {
                    alert('Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã¥ÂÂÃ£ÂÂÃ¥ÂÂ¥Ã¥ÂÂÃ£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂ');
                    return;
                }
                this.scheduleData['Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂ'].push({
                    location,
                    name: className,
                    color,
                    students: []
                });
                
                // FirestoreÃ£ÂÂ«Ã¤Â¿ÂÃ¥Â­Â
                await this.saveScheduleData();
                
                this.showAddClassForm = false;
                this.render();
                alert('Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã£ÂÂÃ¨Â¿Â½Ã¥ÂÂ Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ');
            }
            renderAttendance() {
                return `
                    <div>
                        <div class="bg-white rounded-lg shadow mb-6">
                            <div class="border-b">
                                <div class="flex">
                                    <button id="attendanceOverviewTab" class="px-6 py-3 font-medium ${this.attendanceTab === 'overview' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:text-blue-600'}">Ã°ÂÂÂ Ã£ÂÂÃ£ÂÂÃ£ÂÂ·Ã£ÂÂ¥Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ</button>
                                    <button id="attendanceRecordTab" class="px-6 py-3 font-medium ${this.attendanceTab === 'record' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 hover:text-blue-600'}">Ã°ÂÂÂ Ã¥ÂÂºÃ¥Â¸Â­Ã¨Â¨ÂÃ©ÂÂ²</button>
                                </div>
                            </div>
                        </div>
                        ${this.attendanceTab === 'overview' ? this.renderAttendanceOverview() : this.renderAttendanceRecord()}
                    </div>
                `;
            }
            renderAttendanceOverview() {
                const [year, month] = this.selectedMonth.split('-');

                // Ã¥ÂÂ¨Ã¦ÂÂÃ¦ÂÂ¥Ã£ÂÂ®Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã¦ÂÂ°Ã£ÂÂ¨Ã§ÂÂÃ¥Â¾ÂÃ¦ÂÂ°Ã£ÂÂÃ©ÂÂÃ¨Â¨Â
                let totalClasses = 0;
                let totalStudents = 0;
                Object.keys(this.scheduleData).forEach(day => {
                    totalClasses += this.scheduleData[day].length;
                    this.scheduleData[day].forEach(cls => {
                        totalStudents += cls.students.length;
                    });
                });
                const dayStats = Object.keys(this.scheduleData).map(day => {
                    const classes = this.scheduleData[day];
                    const studentCount = classes.reduce((sum, cls) => sum + cls.students.length, 0);
                    return { day, classCount: classes.length, studentCount };
                });

                // Ã¨Â©Â³Ã§Â´Â°Ã¥Â£Â²Ã¤Â¸ÂÃ¨Â¨ÂÃ§Â®Â
                const detailed = this.calculateDetailedRevenue();
                const visitorRevenue = this.calculateVisitorRevenue();
                const practiceRevenue = detailed['Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â'].revenue;
                const totalExtraRevenue = Object.values(detailed).reduce((sum, d) => sum + d.revenue, 0);

                // Ã¨Â¡Â¨Ã§Â¤ÂºÃ©Â ÂÃ¥ÂºÂÃ£ÂÂÃ¥Â®ÂÃ§Â¾Â©
                const displayOrder = ['Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â', 'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â', 'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â', 'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼1.5hÃ¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â', 'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼1.5hÃ¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â', 'Ã¦ÂÂÃ¨Â¬ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã¦ÂÂ¯Ã¦ÂÂ¿', 'Ã¥ÂÂÃ¥ÂÂÃ¤Â½ÂÃ©Â¨Â', 'Ã¥ÂÂÃ¥ÂÂÃ§ÂÂ¡Ã¦ÂÂ'];

                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800">Ã¥ÂÂºÃ¥Â¸Â­Ã§ÂÂ¶Ã¦Â³Â</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition">Ã¢ÂÂ Ã¥ÂÂÃ¦ÂÂ</button>
                                <input
                                    type="month"
                                    id="monthSelectorOverview"
                                    value="${this.selectedMonth}"
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition">Ã¦Â¬Â¡Ã¦ÂÂ Ã¢ÂÂ¶</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">Ã§Â·ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã¦ÂÂ°</div>
                                <div class="text-4xl font-bold text-blue-600">${totalClasses}</div>
                                <div class="text-xs text-gray-500 mt-2">Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">Ã§Â·ÂÃ§ÂÂÃ¥Â¾ÂÃ¦ÂÂ°Ã¯Â¼ÂÃ¥Â»Â¶Ã£ÂÂ¹Ã¯Â¼Â</div>
                                <div class="text-4xl font-bold text-green-600">${totalStudents}</div>
                                <div class="text-xs text-gray-500 mt-2">Ã¥ÂÂ</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
                                <div class="text-gray-600 text-sm mb-2">Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¥Â£Â²Ã¤Â¸Â</div>
                                <div class="text-4xl font-bold text-yellow-600">ÃÂ¥${visitorRevenue.toLocaleString()}</div>
                                <div class="text-xs text-gray-500 mt-2">Ã¥ÂÂ</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                                <div class="text-gray-600 text-sm mb-2">Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼ÂÃ¥Â£Â²Ã¤Â¸Â</div>
                                <div class="text-4xl font-bold text-purple-600">ÃÂ¥${practiceRevenue.toLocaleString()}</div>
                                <div class="text-xs text-gray-500 mt-2">${detailed['Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â'].count}Ã¥ÂÂÃ¥ÂÂÃ¥ÂÂ </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-8">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">Ã¥Â£Â²Ã¤Â¸ÂÃ¥ÂÂÃ¨Â¨Â³Ã¯Â¼ÂÃ¥ÂÂÃ¨Â¬ÂÃ¤ÂºÂºÃ¦ÂÂ°Ã£ÂÂ»Ã¥Â£Â²Ã¤Â¸ÂÃ¯Â¼Â</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-4 py-3 text-left font-semibold">Ã£ÂÂ«Ã£ÂÂÃ£ÂÂ´Ã£ÂÂª</th>
                                            <th class="px-4 py-3 text-center font-semibold">Ã¥ÂÂÃ¤Â¾Â¡</th>
                                            <th class="px-4 py-3 text-center font-semibold">Ã¥ÂÂÃ¨Â¬ÂÃ¤ÂºÂºÃ¦ÂÂ°</th>
                                            <th class="px-4 py-3 text-right font-semibold">Ã¥Â£Â²Ã¤Â¸Â</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${displayOrder.map(plan => {
                                            const data = detailed[plan] || { count: 0, revenue: 0 };
                                            const price = this.pricing[plan] || 0;
                                            const bgColor = plan === 'Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â' ? 'bg-purple-50' : data.count > 0 ? 'bg-yellow-50' : '';
                                            return `
                                                <tr class="border-b ${bgColor}">
                                                    <td class="px-4 py-3 font-medium">${plan}</td>
                                                    <td class="px-4 py-3 text-center text-gray-600">ÃÂ¥${price.toLocaleString()}</td>
                                                    <td class="px-4 py-3 text-center">
                                                        ${data.count > 0 ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">${data.count}${plan === 'Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â' ? 'Ã¥ÂÂ' : 'Ã¥ÂÂ'}</span>` : '<span class="text-gray-400">-</span>'}
                                                    </td>
                                                    <td class="px-4 py-3 text-right font-semibold ${data.revenue > 0 ? 'text-green-700' : 'text-gray-400'}">
                                                        ${data.revenue > 0 ? 'ÃÂ¥' + data.revenue.toLocaleString() : '-'}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-blue-50 border-t-2 border-blue-300">
                                            <td class="px-4 py-3 font-bold" colspan="3">Ã¥ÂÂÃ¨Â¨Â</td>
                                            <td class="px-4 py-3 text-right font-bold text-lg text-blue-700">ÃÂ¥${totalExtraRevenue.toLocaleString()}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">Ã¦ÂÂÃ¦ÂÂ¥Ã¥ÂÂ¥Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã¦ÂÂ°</h3>
                                <div class="space-y-3">
                                    ${dayStats.map(stat => `
                                        <div class="flex justify-between items-center p-3 border rounded hover:bg-gray-50">
                                            <span class="font-medium">${stat.day}</span>
                                            <div class="flex gap-4">
                                                <span class="text-gray-600">${stat.classCount}Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</span>
                                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">${stat.studentCount}Ã¥ÂÂ</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">Ã£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¢Ã£ÂÂÃ£ÂÂ</h3>
                                <div class="space-y-3">
                                    <p class="text-sm text-gray-600">Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂ¿Ã£ÂÂ®Ã¥Â®ÂÃ¥ÂÂ¨Ã£ÂÂ®Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ¥Â®ÂÃ¦ÂÂÃ§ÂÂÃ£ÂÂ«Ã£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¢Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ¥ÂÂÃ¥Â¾ÂÃ£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂÃ£ÂÂ</p>
                                    <button id="backupBtn" class="w-full bg-green-600 text-white px-4 py-3 rounded hover:bg-green-700 transition font-medium">
                                        Ã°ÂÂÂ¦ Ã£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¢Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ¥ÂÂÃ¥Â¾Â
                                    </button>
                                    <div id="backupStatus" class="text-xs text-gray-500 text-center"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">Ã¤Â½Â¿Ã£ÂÂÃ¦ÂÂ¹</h3>
                            <div class="space-y-2 text-gray-600">
                                <p>Ã¢ÂÂ¢ Ã£ÂÂÃ°ÂÂÂ Ã¥ÂÂºÃ¥Â¸Â­Ã¨Â¨ÂÃ©ÂÂ²Ã£ÂÂÃ£ÂÂ¿Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ¥ÂÂÃ¦ÂÂÃ¦ÂÂ¥Ã£ÂÂ®Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã£ÂÂ®Ã¥ÂÂºÃ¥Â¸Â­Ã£ÂÂÃ¨Â¨ÂÃ©ÂÂ²Ã£ÂÂ§Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂ</p>
                                <p>Ã¢ÂÂ¢ Ã£ÂÂÃ£ÂÂ¿Ã£ÂÂ³Ã£ÂÂÃ£ÂÂ¯Ã£ÂÂªÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ§ <span class="text-green-600 font-bold">Ã¢ÂÂ</span> Ã¢ÂÂ <span class="text-red-600 font-bold">ÃÂ</span> Ã¢ÂÂ <span class="text-gray-600 font-bold">Ã¤Â¼Â</span> Ã¢ÂÂ <span class="text-gray-400 font-bold">-</span> Ã£ÂÂ¨Ã¥ÂÂÃ£ÂÂÃ¦ÂÂ¿Ã£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂ</p>
                                <p>Ã¢ÂÂ¢ Ã¦ÂÂÃ¦ÂÂÃ¦ÂÂ¥Ã£ÂÂ»Ã¦ÂÂ¨Ã¦ÂÂÃ¦ÂÂ¥Ã£ÂÂ«Ã£ÂÂ¯Ã£ÂÂÃ§Â·Â´Ã§Â¿ÂÃ¤Â¼ÂÃ£ÂÂÃ¦Â¬ÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ¥ÂÂÃ¥ÂÂ Ã¤ÂºÂºÃ¦ÂÂ°Ã£ÂÂÃ¥ÂÂ¥Ã¥ÂÂÃ£ÂÂ§Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ¯Â¼ÂÃÂ¥500/Ã¤ÂºÂºÃ¯Â¼Â</p>
                                <p>Ã¢ÂÂ¢ Ã¥ÂÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã£ÂÂ«Ã£ÂÂÃ§ÂÂÃ¥Â¾ÂÃ¨Â¿Â½Ã¥ÂÂ Ã£ÂÂÃ£ÂÂÃ£ÂÂ¿Ã£ÂÂ³Ã£ÂÂÃ£ÂÂÃ¦ÂÂ°Ã¨Â¦ÂÃ§ÂÂÃ¥Â¾ÂÃ£ÂÂÃ¨Â¿Â½Ã¥ÂÂ Ã£ÂÂ§Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂ</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            renderAttendanceRecord() {
                // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂ¿Ã£ÂÂÃ£ÂÂ¯Ã¥Â°ÂÃ§ÂÂ¨Ã£ÂÂ®Ã£ÂÂ¬Ã£ÂÂ³Ã£ÂÂÃ£ÂÂªÃ£ÂÂ³Ã£ÂÂ°
                if (this.selectedDay === 'Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂ') {
                    return this.renderEventRecord();
                }
                const [year, month] = this.selectedMonth.split('-');
                const dayClasses = this.scheduleData[this.selectedDay] || [];
                if (this.isLoading) {
                    return `
                        <div class="flex items-center justify-center h-96">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                                <p class="text-gray-600">Ã¨ÂªÂ­Ã£ÂÂ¿Ã¨Â¾Â¼Ã£ÂÂ¿Ã¤Â¸Â­...</p>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Ã¥ÂÂºÃ¥Â¸Â­Ã¨Â¨ÂÃ©ÂÂ²</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>Ã¢ÂÂ Ã¥ÂÂÃ¦ÂÂ</button>
                                <input 
                                    type="month" 
                                    id="monthSelector" 
                                    value="${this.selectedMonth}" 
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>Ã¦Â¬Â¡Ã¦ÂÂ Ã¢ÂÂ¶</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow mb-4">
                            <div class="flex border-b overflow-x-auto">
                                ${['Ã¦ÂÂÃ¦ÂÂÃ¦ÂÂ¥', 'Ã§ÂÂ«Ã¦ÂÂÃ¦ÂÂ¥', 'Ã¦Â°Â´Ã¦ÂÂÃ¦ÂÂ¥', 'Ã¦ÂÂ¨Ã¦ÂÂÃ¦ÂÂ¥', 'Ã©ÂÂÃ¦ÂÂÃ¦ÂÂ¥', 'Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂ'].map(day => `
                                    <button id="day-${day}" class="px-4 py-2 text-sm font-medium whitespace-nowrap ${this.selectedDay === day ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'}">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        ${this.showAddStudentForm ? this.renderAddStudentForm() : ''}
                        ${dayClasses.map((classInfo, idx) => {
                            const sortedStudents = this.sortStudentsByPlan([...classInfo.students]);
                            return `
                                <div class="bg-white rounded-lg shadow mb-3">
                                    <div class="bg-${classInfo.color}-600 text-white px-4 py-2 rounded-t-lg flex justify-between items-center">
                                        <h3 class="text-base font-bold">${classInfo.location} - ${classInfo.name}</h3>
                                        <div class="flex gap-2 items-center">
                                            <span class="text-xs opacity-90">${sortedStudents.length}Ã¥ÂÂ</span>
                                            <button 
                                                data-add-day="${this.selectedDay}" 
                                                data-add-location="${classInfo.location}" 
                                                data-add-class="${classInfo.name}"
                                                class="add-student-btn bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-xs transition">
                                                + Ã§ÂÂÃ¥Â¾ÂÃ¨Â¿Â½Ã¥ÂÂ 
                                            </button>
                                        </div>
                                    </div>
                                    <div class="p-3 overflow-x-auto">
                                        <table class="w-full text-xs">
                                            <thead>
                                                <tr class="bg-gray-50 border-b">
                                                    <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">Ã¦Â°ÂÃ¥ÂÂ</th>
                                                    <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">Ã§Â¬Â¬1Ã©ÂÂ±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">Ã§Â¬Â¬2Ã©ÂÂ±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">Ã§Â¬Â¬3Ã©ÂÂ±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">Ã§Â¬Â¬4Ã©ÂÂ±</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">Ã¤ÂºÂÃ¥ÂÂ</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 60px;">Ã¥ÂÂºÃ¥Â¸Â­Ã§ÂÂ</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">Ã§Â·Â¨Ã©ÂÂ</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${sortedStudents.map(student => {
                                                    const studentKey = `${this.selectedDay}_${classInfo.location}_${classInfo.name}_${student.lastName}${student.firstName}`;
                                                    const attendance = this.attendanceData[studentKey] || {};
                                                    const rate = this.getAttendanceRate(studentKey);
                                                    const isEditing = this.editingStudent && 
                                                                     this.editingStudent.day === this.selectedDay &&
                                                                     this.editingStudent.location === classInfo.location &&
                                                                     this.editingStudent.className === classInfo.name &&
                                                                     this.editingStudent.lastName === student.lastName &&
                                                                     this.editingStudent.firstName === student.firstName;
                                                    
                                                    if (isEditing) {
                                                        return `
                                                            <tr class="border-b bg-blue-50">
                                                                <td class="px-2 py-2 text-xs">${student.lastName} ${student.firstName}</td>
                                                                <td class="px-2 py-2 text-xs">
                                                                    <select id="edit_student_plan" class="w-full border rounded px-1 py-1 text-xs">
                                                                        <option value="Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹" ${student.plan === 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' ? 'selected' : ''}>Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</option>
                                                                        <option value="Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹" ${student.plan === 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' ? 'selected' : ''}>Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</option>
                                                                        <option value="Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹" ${student.plan === 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' ? 'selected' : ''}>Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</option>
                                                                        <option value="Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹" ${student.plan === 'Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹' ? 'selected' : ''}>Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</option>
                                                                        <option value="Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â" ${student.plan === 'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â' ? 'selected' : ''}>Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â</option>
                                                                        <option value="Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â" ${student.plan === 'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â' ? 'selected' : ''}>Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â</option>
                                                                        <option value="Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¦ÂÂ¯Ã¦ÂÂ¿Ã¯Â¼Â" ${student.plan === 'Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¦ÂÂ¯Ã¦ÂÂ¿Ã¯Â¼Â' ? 'selected' : ''}>Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¦ÂÂ¯Ã¦ÂÂ¿Ã¯Â¼Â</option>
                                                                        <option value="Ã¥ÂÂÃ¥ÂÂÃ¤Â½ÂÃ©Â¨Â" ${student.plan === 'Ã¥ÂÂÃ¥ÂÂÃ¤Â½ÂÃ©Â¨Â' ? 'selected' : ''}>Ã¥ÂÂÃ¥ÂÂÃ¤Â½ÂÃ©Â¨Â</option>
                                                                        <option value="Ã¥ÂÂÃ¥ÂÂÃ§ÂÂ¡Ã¦ÂÂ" ${student.plan === 'Ã¥ÂÂÃ¥ÂÂÃ§ÂÂ¡Ã¦ÂÂ' ? 'selected' : ''}>Ã¥ÂÂÃ¥ÂÂÃ§ÂÂ¡Ã¦ÂÂ</option>
                                                                    </select>
                                                                </td>
                                                                ${['week1', 'week2', 'week3', 'week4', 'week5'].map(week => `
                                                                    <td class="px-2 py-2 text-center">
                                                                        <button 
                                                                            data-class="${studentKey}" 
                                                                            data-week="${week}"
                                                                            class="attendance-btn w-8 h-8 rounded border text-xs ${
                                                                                attendance[week] === 'Ã¢ÂÂ' ? 'bg-green-500 border-green-600 text-white' :
                                                                                attendance[week] === 'ÃÂ' ? 'bg-red-500 border-red-600 text-white' :
                                                                                attendance[week] === 'Ã¤Â¼ÂÃ¨Â¬Â' ? 'bg-gray-500 border-gray-600 text-white' :
                                                                                'bg-gray-100 border-gray-300 text-gray-400'
                                                                            } hover:opacity-80 transition font-bold">
                                                                            ${attendance[week] === 'Ã¤Â¼ÂÃ¨Â¬Â' ? 'Ã¤Â¼Â' : attendance[week] || '-'}
                                                                        </button>
                                                                    </td>
                                                                `).join('')}
                                                                <td class="px-2 py-2 text-center">
                                                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                                        rate >= 80 ? 'bg-green-100 text-green-800' :
                                                                        rate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                                        rate > 0 ? 'bg-red-100 text-red-800' :
                                                                        'bg-gray-100 text-gray-600'
                                                                    }">${rate > 0 ? rate + '%' : '-'}</span>
                                                                </td>
                                                                <td class="px-2 py-2 text-center">
                                                                    <div class="flex flex-col gap-1">
                                                                        <button 
                                                                            id="saveEditStudentBtn"
                                                                            class="text-green-600 hover:text-green-800 text-xs">
                                                                            Ã¤Â¿ÂÃ¥Â­Â
                                                                        </button>
                                                                        <button 
                                                                            id="cancelEditStudentBtn"
                                                                            class="text-gray-600 hover:text-gray-800 text-xs">
                                                                            Ã£ÂÂ­Ã£ÂÂ£Ã£ÂÂ³Ã£ÂÂ»Ã£ÂÂ«
                                                                        </button>
                                                                        <button 
                                                                            data-delete-day="${this.selectedDay}"
                                                                            data-delete-location="${classInfo.location}"
                                                                            data-delete-class="${classInfo.name}"
                                                                            data-delete-lastname="${student.lastName}"
                                                                            data-delete-firstname="${student.firstName}"
                                                                            class="delete-student-btn text-red-600 hover:text-red-800 text-xs">
                                                                            Ã¥ÂÂÃ©ÂÂ¤
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }
                                                    
                                                    return `
                                                        <tr class="border-b hover:bg-gray-50">
                                                            <td class="px-2 py-2 text-xs">${student.lastName} ${student.firstName}</td>
                                                            <td class="px-2 py-2 text-xs">${student.plan}</td>
                                                            ${['week1', 'week2', 'week3', 'week4', 'week5'].map(week => `
                                                                <td class="px-2 py-2 text-center">
                                                                    <button 
                                                                        data-class="${studentKey}" 
                                                                        data-week="${week}"
                                                                        class="attendance-btn w-8 h-8 rounded border text-xs ${
                                                                            attendance[week] === 'Ã¢ÂÂ' ? 'bg-green-500 border-green-600 text-white' :
                                                                            attendance[week] === 'ÃÂ' ? 'bg-red-500 border-red-600 text-white' :
                                                                            attendance[week] === 'Ã¤Â¼ÂÃ¨Â¬Â' ? 'bg-gray-500 border-gray-600 text-white' :
                                                                            'bg-gray-100 border-gray-300 text-gray-400'
                                                                        } hover:opacity-80 transition font-bold">
                                                                        ${attendance[week] === 'Ã¤Â¼ÂÃ¨Â¬Â' ? 'Ã¤Â¼Â' : attendance[week] || '-'}
                                                                    </button>
                                                                </td>
                                                            `).join('')}
                                                            <td class="px-2 py-2 text-center">
                                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                                    rate >= 80 ? 'bg-green-100 text-green-800' :
                                                                    rate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                                    rate > 0 ? 'bg-red-100 text-red-800' :
                                                                    'bg-gray-100 text-gray-600'
                                                                }">${rate > 0 ? rate + '%' : '-'}</span>
                                                            </td>
                                                            <td class="px-2 py-2 text-center">
                                                                <button 
                                                                    data-edit-student-day="${this.selectedDay}"
                                                                    data-edit-student-location="${classInfo.location}"
                                                                    data-edit-student-class="${classInfo.name}"
                                                                    data-edit-student-lastname="${student.lastName}"
                                                                    data-edit-student-firstname="${student.firstName}"
                                                                    class="edit-student-btn text-blue-600 hover:text-blue-800 text-xs">
                                                                    Ã§Â·Â¨Ã©ÂÂ
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        ${dayClasses.length === 0 ? `
                            <div class="bg-white rounded-lg shadow p-12 text-center">
                                <p class="text-gray-500 text-lg">Ã£ÂÂÃ£ÂÂ®Ã¦ÂÂÃ¦ÂÂ¥Ã£ÂÂ«Ã£ÂÂ¯Ã£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂ</p>
                            </div>
                        ` : ''}

                        ${(this.selectedDay === 'Ã¦ÂÂÃ¦ÂÂÃ¦ÂÂ¥' || this.selectedDay === 'Ã¦ÂÂ¨Ã¦ÂÂÃ¦ÂÂ¥') ? this.renderPracticeSession() : ''}
                    </div>
                `;
            }
            // Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼ÂÃ£ÂÂ»Ã£ÂÂ¯Ã£ÂÂ·Ã£ÂÂ§Ã£ÂÂ³Ã£ÂÂ®Ã£ÂÂ¬Ã£ÂÂ³Ã£ÂÂÃ£ÂÂªÃ£ÂÂ³Ã£ÂÂ°
            renderPracticeSession() {
                const practiceKey = `Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â_${this.selectedDay}`;
                const practiceData = this.attendanceData[practiceKey] || {};
                const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                const weekLabels = ['Ã§Â¬Â¬1Ã©ÂÂ±', 'Ã§Â¬Â¬2Ã©ÂÂ±', 'Ã§Â¬Â¬3Ã©ÂÂ±', 'Ã§Â¬Â¬4Ã©ÂÂ±', 'Ã¤ÂºÂÃ¥ÂÂ'];
                let totalParticipants = 0;
                weeks.forEach(w => { totalParticipants += (parseInt(practiceData[w]) || 0); });
                const totalRevenue = totalParticipants * 500;

                return `
                    <div class="bg-white rounded-lg shadow mb-3">
                        <div class="bg-purple-600 text-white px-4 py-2 rounded-t-lg flex justify-between items-center">
                            <h3 class="text-base font-bold">Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼ÂÃ¯Â¼ÂÃÂ¥500/Ã¤ÂºÂºÃ¯Â¼Â</h3>
                            <span class="text-xs opacity-90">Ã¥ÂÂÃ¨Â¨Â: ${totalParticipants}Ã¥ÂÂ / ÃÂ¥${totalRevenue.toLocaleString()}</span>
                        </div>
                        <div class="p-3">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="bg-gray-50 border-b">
                                        <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">Ã©Â ÂÃ§ÂÂ®</th>
                                        ${weekLabels.map(label => `
                                            <th class="px-2 py-2 text-center font-semibold" style="width: 70px;">${label}</th>
                                        `).join('')}
                                        <th class="px-2 py-2 text-center font-semibold" style="width: 70px;">Ã¥ÂÂÃ¨Â¨Â</th>
                                        <th class="px-2 py-2 text-right font-semibold" style="width: 90px;">Ã¥Â£Â²Ã¤Â¸Â</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b">
                                        <td class="px-2 py-2 font-medium">Ã¥ÂÂÃ¥ÂÂ Ã¤ÂºÂºÃ¦ÂÂ°</td>
                                        ${weeks.map(week => `
                                            <td class="px-2 py-2 text-center">
                                                <input
                                                    type="number"
                                                    min="0"
                                                    value="${parseInt(practiceData[week]) || 0}"
                                                    data-practice-day="${this.selectedDay}"
                                                    data-practice-week="${week}"
                                                    class="practice-input w-14 border rounded px-1 py-1 text-xs text-center focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                />
                                            </td>
                                        `).join('')}
                                        <td class="px-2 py-2 text-center">
                                            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-semibold">${totalParticipants}Ã¥ÂÂ</span>
                                        </td>
                                        <td class="px-2 py-2 text-right font-bold text-purple-700">ÃÂ¥${totalRevenue.toLocaleString()}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            renderAddStudentForm() {
                return `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                        <h3 class="text-base font-semibold mb-3 text-gray-800">Ã§ÂÂÃ¥Â¾ÂÃ¨Â¿Â½Ã¥ÂÂ </h3>
                        
                        <!-- Ã©Â¡Â§Ã¥Â®Â¢Ã¦Â¤ÂÃ§Â´Â¢ -->
                        <div class="mb-3">
                            <label class="block text-xs font-medium mb-1">Ã©Â¡Â§Ã¥Â®Â¢Ã¦Â¤ÂÃ§Â´Â¢Ã¯Â¼ÂÃ¦Â°ÂÃ¥ÂÂÃ£ÂÂ»Ã¨ÂªÂ­Ã£ÂÂ¿Ã£ÂÂ»Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·Ã¯Â¼Â</label>
                            <input 
                                type="text" 
                                id="student_search_input" 
                                value="${this.studentSearchTerm}"
                                class="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="Ã¤Â¾Â: Ã¤Â¸Â­Ã¥Â³Â¶Ã£ÂÂÃ£ÂÂªÃ£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂÃ£ÂÂ«Ã£ÂÂ·Ã£ÂÂÃ£ÂÂnakashimaÃ£ÂÂ0001"
                                autocomplete="off"
                            />
                            <div class="text-xs text-gray-500 mt-1">Ã°ÂÂÂ¡ Ã¦Â¼Â¢Ã¥Â­ÂÃ£ÂÂ»Ã£ÂÂ²Ã£ÂÂÃ£ÂÂÃ£ÂÂªÃ£ÂÂ»Ã£ÂÂ«Ã£ÂÂ¿Ã£ÂÂ«Ã£ÂÂÃ£ÂÂ»Ã¨ÂÂ±Ã¨ÂªÂÃ£ÂÂ»Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·Ã£ÂÂ§Ã¦Â¤ÂÃ§Â´Â¢Ã£ÂÂ§Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂ</div>
                            <!-- Ã¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ¨Â¡Â¨Ã§Â¤ÂºÃ§ÂÂ¨Ã£ÂÂ³Ã£ÂÂ³Ã£ÂÂÃ£ÂÂ -->
                            <div id="searchResultsContainer">
                                ${this.studentSearchResults.length > 0 ? `
                                    <div class="mt-2 border rounded bg-white student-search-results shadow-lg">
                                        ${this.studentSearchResults.map(customer => `
                                            <div 
                                                data-select-customer-id="${customer.id}"
                                                class="select-customer-btn p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm transition">
                                                <div class="font-medium text-blue-600">
                                                    ${customer.lastName} ${customer.firstName}
                                                    ${customer.memberNumber ? `<span class="text-xs text-gray-500 ml-2">[${customer.memberNumber}]</span>` : ''}
                                                </div>
                                                <div class="text-xs text-gray-600 mt-1">
                                                    ${customer.reading ? `Ã¨ÂªÂ­Ã£ÂÂ¿: ${customer.reading}` : ''}
                                                    ${customer.reading && customer.course ? ' | ' : ''}
                                                    ${customer.course ? `Ã£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹: ${customer.course}` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : this.studentSearchTerm.trim() && this.studentSearchResults.length === 0 ? `
                                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                                        Ã¢ÂÂ Ã¯Â¸Â Ã¨Â©Â²Ã¥Â½ÂÃ£ÂÂÃ£ÂÂÃ©Â¡Â§Ã¥Â®Â¢Ã£ÂÂÃ¨Â¦ÂÃ£ÂÂ¤Ã£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂÃ£ÂÂ§Ã£ÂÂÃ£ÂÂ
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ${this.selectedCustomerForStudent ? `
                            <div id="selectedCustomerInfo" class="mb-3 p-3 bg-green-50 border-2 border-green-400 rounded text-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-bold text-green-800">Ã¢ÂÂ Ã©ÂÂ¸Ã¦ÂÂÃ¤Â¸Â­: ${this.selectedCustomerForStudent.lastName} ${this.selectedCustomerForStudent.firstName}</div>
                                        <div class="text-xs text-gray-700 mt-1">
                                            ${this.selectedCustomerForStudent.memberNumber ? `Ã¤Â¼ÂÃ¥ÂÂ¡Ã§ÂÂªÃ¥ÂÂ·: ${this.selectedCustomerForStudent.memberNumber} | ` : ''}
                                            ${this.selectedCustomerForStudent.reading ? `Ã¨ÂªÂ­Ã£ÂÂ¿: ${this.selectedCustomerForStudent.reading} | ` : ''}
                                            Ã£ÂÂ³Ã£ÂÂ¼Ã£ÂÂ¹: ${this.selectedCustomerForStudent.course || 'Ã£ÂÂªÃ£ÂÂ'}
                                        </div>
                                    </div>
                                    <button 
                                        id="clearSelectedCustomer"
                                        class="text-red-600 hover:text-red-800 text-xs underline">
                                        Ã©ÂÂ¸Ã¦ÂÂÃ¨Â§Â£Ã©ÂÂ¤
                                    </button>
                                </div>
                            </div>
                        ` : '<div id="selectedCustomerInfo"></div>'}
                        <div class="grid grid-cols-3 gap-3 mb-3">
                            <div id="nameInputContainer" class="${!this.selectedCustomerForStudent ? 'col-span-2 grid grid-cols-2 gap-3' : 'hidden'}">
                                <div>
                                    <label class="block text-xs font-medium mb-1">Ã¥Â§Â *</label>
                                    <input type="text" id="new_student_lastName" class="w-full border rounded px-2 py-1 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">Ã¥ÂÂ *</label>
                                    <input type="text" id="new_student_firstName" class="w-full border rounded px-2 py-1 text-sm">
                                </div>
                            </div>
                            <div id="planSelectContainer" class="${!this.selectedCustomerForStudent ? '' : 'col-span-3'}">
                                <label class="block text-xs font-medium mb-1">Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³ *</label>
                                <select id="new_student_plan" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="">Ã©ÂÂ¸Ã¦ÂÂÃ£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂ</option>
                                    <option value="Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹" ${this.selectedCustomerForStudent?.course === 'Ã¯Â¼Â' ? 'selected' : ''}>Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</option>
                                    <option value="Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹" ${this.selectedCustomerForStudent?.course === 'Ã¯Â¼Â' ? 'selected' : ''}>Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</option>
                                    <option value="Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹" ${this.selectedCustomerForStudent?.course === 'Ã¯Â¼Â' ? 'selected' : ''}>Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</option>
                                    <option value="Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹" ${this.selectedCustomerForStudent?.course === 'Ã¯Â¼Â' ? 'selected' : ''}>Ã¯Â¼ÂÃ£ÂÂ¯Ã£ÂÂ©Ã£ÂÂ¹</option>
                                    <option value="Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â">Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â</option>
                                    <option value="Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â">Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ©ÂÂÃ¤Â¼ÂÃ¥ÂÂ¡Ã¯Â¼Â</option>
                                    <option value="Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¦ÂÂ¯Ã¦ÂÂ¿Ã¯Â¼Â">Ã£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã¯Â¼ÂÃ¦ÂÂ¯Ã¦ÂÂ¿Ã¯Â¼Â</option>
                                    <option value="Ã¥ÂÂÃ¥ÂÂÃ¤Â½ÂÃ©Â¨Â">Ã¥ÂÂÃ¥ÂÂÃ¤Â½ÂÃ©Â¨Â</option>
                                    <option value="Ã¥ÂÂÃ¥ÂÂÃ§ÂÂ¡Ã¦ÂÂ">Ã¥ÂÂÃ¥ÂÂÃ§ÂÂ¡Ã¦ÂÂ</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 mb-3">
                            Ã¢ÂÂ» Ã©Â¡Â§Ã¥Â®Â¢Ã§Â®Â¡Ã§ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã£ÂÂÃ¨ÂÂªÃ¥ÂÂÃ¥ÂÂÃ¦ÂÂ Ã£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¸Ã£ÂÂ¿Ã£ÂÂ¼Ã£ÂÂ¨Ã£ÂÂÃ£ÂÂ¦Ã¥ÂÂÃ¨Â¬ÂÃ£ÂÂÃ£ÂÂÃ¥Â Â´Ã¥ÂÂÃ£ÂÂ¯Ã¥Â¤ÂÃ¦ÂÂ´Ã£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂ
                        </div>
                        <div class="flex gap-2">
                            <button id="saveNewStudentBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">Ã¨Â¿Â½Ã¥ÂÂ </button>
                            <button id="cancelAddStudentBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition text-sm">Ã£ÂÂ­Ã£ÂÂ£Ã£ÂÂ³Ã£ÂÂ»Ã£ÂÂ«</button>
                        </div>
                    </div>
                `;
            }
            // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¥Â°ÂÃ§ÂÂ¨Ã£ÂÂ®Ã£ÂÂ¬Ã£ÂÂ³Ã£ÂÂÃ£ÂÂªÃ£ÂÂ³Ã£ÂÂ°
            renderEventRecord() {
                const [year, month] = this.selectedMonth.split('-');
                const total = this.calculateEventTotal();
                if (this.isLoading) {
                    return `
                        <div class="flex items-center justify-center h-96">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                                <p class="text-gray-600">Ã¨ÂªÂ­Ã£ÂÂ¿Ã¨Â¾Â¼Ã£ÂÂ¿Ã¤Â¸Â­...</p>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¥ÂÂºÃ¥Â¸Â­Ã¨Â¨ÂÃ©ÂÂ²</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>Ã¢ÂÂ Ã¥ÂÂÃ¦ÂÂ</button>
                                <input 
                                    type="month" 
                                    id="monthSelector" 
                                    value="${this.selectedMonth}" 
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>Ã¦Â¬Â¡Ã¦ÂÂ Ã¢ÂÂ¶</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow mb-4">
                            <div class="flex border-b overflow-x-auto">
                                ${['Ã¦ÂÂÃ¦ÂÂÃ¦ÂÂ¥', 'Ã§ÂÂ«Ã¦ÂÂÃ¦ÂÂ¥', 'Ã¦Â°Â´Ã¦ÂÂÃ¦ÂÂ¥', 'Ã¦ÂÂ¨Ã¦ÂÂÃ¦ÂÂ¥', 'Ã©ÂÂÃ¦ÂÂÃ¦ÂÂ¥', 'Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂ'].map(day => `
                                    <button id="day-${day}" class="px-4 py-2 text-sm font-medium whitespace-nowrap ${this.selectedDay === day ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'}">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-gray-800">Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¥ÂÂÃ¥ÂÂ Ã¨ÂÂÃ¤Â¸ÂÃ¨Â¦Â§</h3>
                                <button id="addEventParticipantBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-sm">
                                    + Ã¥ÂÂÃ¥ÂÂ Ã¨ÂÂÃ£ÂÂÃ¨Â¿Â½Ã¥ÂÂ 
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 100px;">Ã¦Â°ÂÃ¥ÂÂÃ¯Â¼ÂÃ¥Â§ÂÃ¯Â¼Â</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 100px;">Ã¦Â°ÂÃ¥ÂÂÃ¯Â¼ÂÃ¥ÂÂÃ¯Â¼Â</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">Ã¢ÂÂ </th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">Ã¢ÂÂ¡</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">Ã¢ÂÂ¢</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 120px;">Ã¦ÂÂÃ©ÂÂÃ¯Â¼ÂÃ¥ÂÂÃ¯Â¼Â</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 200px;">Ã¥ÂÂÃ¨ÂÂ</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 80px;">Ã¦ÂÂÃ¤Â½Â</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.eventAttendanceData.length === 0 ? `
                                            <tr>
                                                <td colspan="8" class="px-3 py-8 text-center text-gray-500">
                                                    Ã¥ÂÂÃ¥ÂÂ Ã¨ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ+ Ã¥ÂÂÃ¥ÂÂ Ã¨ÂÂÃ£ÂÂÃ¨Â¿Â½Ã¥ÂÂ Ã£ÂÂÃ£ÂÂÃ£ÂÂ¿Ã£ÂÂ³Ã£ÂÂÃ£ÂÂÃ¨Â¿Â½Ã¥ÂÂ Ã£ÂÂÃ£ÂÂ¦Ã£ÂÂÃ£ÂÂ Ã£ÂÂÃ£ÂÂÃ£ÂÂ
                                                </td>
                                            </tr>
                                        ` : this.eventAttendanceData.map((participant, index) => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="lastName" 
                                                        data-event-index="${index}"
                                                        value="${participant.lastName || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="Ã¥Â§Â"
                                                    />
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="firstName" 
                                                        data-event-index="${index}"
                                                        value="${participant.firstName || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="Ã¥ÂÂ"
                                                    />
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week1" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week1 === 'Ã¢ÂÂ' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week1 === 'Ã¢ÂÂ' ? 'Ã¢ÂÂ' : 'ÃÂ'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week2" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week2 === 'Ã¢ÂÂ' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week2 === 'Ã¢ÂÂ' ? 'Ã¢ÂÂ' : 'ÃÂ'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week3" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week3 === 'Ã¢ÂÂ' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week3 === 'Ã¢ÂÂ' ? 'Ã¢ÂÂ' : 'ÃÂ'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="number" 
                                                        data-event-field="fee" 
                                                        data-event-index="${index}"
                                                        value="${participant.fee || 0}"
                                                        class="w-full border rounded px-2 py-1 text-sm text-right"
                                                        placeholder="0"
                                                        min="0"
                                                    />
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="memo" 
                                                        data-event-index="${index}"
                                                        value="${participant.memo || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="Ã¥ÂÂÃ¨ÂÂ"
                                                    />
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-delete-event-index="${index}"
                                                        class="delete-event-participant-btn text-red-600 hover:text-red-800 text-xs">
                                                        Ã¥ÂÂÃ©ÂÂ¤
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-blue-50 border-t-2 border-blue-300">
                                            <td colspan="5" class="px-3 py-4 text-right font-bold text-gray-800">Ã¥ÂÂÃ¨Â¨ÂÃ©ÂÂÃ©Â¡Â:</td>
                                            <td class="px-3 py-4 font-bold text-blue-600 text-lg">ÃÂ¥${total.toLocaleString()}</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="mt-6 p-4 bg-gray-50 rounded border">
                                <h4 class="font-semibold mb-2 text-sm">Ã¤Â½Â¿Ã£ÂÂÃ¦ÂÂ¹</h4>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li>Ã¢ÂÂ¢ Ã¦Â°ÂÃ¥ÂÂÃ£ÂÂ»Ã¦ÂÂÃ©ÂÂÃ£ÂÂ»Ã¥ÂÂÃ¨ÂÂÃ£ÂÂ¯Ã§ÂÂ´Ã¦ÂÂ¥Ã¥ÂÂ¥Ã¥ÂÂÃ£ÂÂ§Ã£ÂÂÃ£ÂÂ¾Ã£ÂÂ</li>
                                    <li>Ã¢ÂÂ¢ Ã¢ÂÂ Ã¢ÂÂ¡Ã¢ÂÂ¢Ã£ÂÂ®Ã£ÂÂÃ£ÂÂ¿Ã£ÂÂ³Ã£ÂÂÃ£ÂÂ¯Ã£ÂÂªÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂÃ£ÂÂÃ£ÂÂ¨ <span class="text-green-600 font-bold">Ã¢ÂÂ</span> Ã¢ÂÂ <span class="text-red-600 font-bold">ÃÂ</span> Ã¢ÂÂ <span class="text-gray-600 font-bold">Ã¤Â¼Â</span> Ã¢ÂÂ <span class="text-gray-400 font-bold">-</span> Ã£ÂÂ¨Ã¥ÂÂÃ£ÂÂÃ¦ÂÂ¿Ã£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂ</li>
                                    <li>Ã¢ÂÂ¢ Ã¥ÂÂ¥Ã¥ÂÂÃ¥ÂÂÃ¥Â®Â¹Ã£ÂÂ¯Ã¨ÂÂªÃ¥ÂÂÃ¤Â¿ÂÃ¥Â­ÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂ</li>
                                    <li>Ã¢ÂÂ¢ Ã¦ÂÂÃ©ÂÂÃ£ÂÂ®Ã¥ÂÂÃ¨Â¨ÂÃ©ÂÂÃ©Â¡ÂÃ£ÂÂÃ¨ÂÂªÃ¥ÂÂÃ£ÂÂ§Ã¨Â¡Â¨Ã§Â¤ÂºÃ£ÂÂÃ£ÂÂÃ£ÂÂ¾Ã£ÂÂ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            setupAttendanceEvents() {
                document.getElementById('attendanceOverviewTab')?.addEventListener('click', () => {
                    this.attendanceTab = 'overview';
                    this.render();
                });
                document.getElementById('attendanceRecordTab')?.addEventListener('click', () => {
                    this.attendanceTab = 'record';
                    this.render();
                });
                // Ã¦ÂÂÃ©ÂÂ¸Ã¦ÂÂinputÃ£ÂÂ®Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¯Â¼ÂÃ¥ÂÂºÃ¥Â¸Â­Ã¨Â¨ÂÃ©ÂÂ²Ã¯Â¼Â
                const monthSelector = document.getElementById('monthSelector');
                if (monthSelector) {
                    monthSelector.addEventListener('change', (e) => {
                        this.selectMonth(e.target.value);
                    });
                }
                // Ã¦ÂÂÃ©ÂÂ¸Ã¦ÂÂinputÃ£ÂÂ®Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¯Â¼ÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ·Ã£ÂÂ¥Ã£ÂÂÃ£ÂÂ¼Ã£ÂÂÃ¯Â¼Â
                const monthSelectorOverview = document.getElementById('monthSelectorOverview');
                if (monthSelectorOverview) {
                    monthSelectorOverview.addEventListener('change', (e) => {
                        this.selectMonth(e.target.value);
                    });
                }
                const prevMonthBtn = document.getElementById('prevMonth');
                const nextMonthBtn = document.getElementById('nextMonth');
                const prevMonthRecordBtn = document.getElementById('prevMonthRecord');
                const nextMonthRecordBtn = document.getElementById('nextMonthRecord');
                if (prevMonthBtn) {
                    prevMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(-1);
                    });
                }
                if (nextMonthBtn) {
                    nextMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(1);
                    });
                }
                if (prevMonthRecordBtn) {
                    prevMonthRecordBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(-1);
                    });
                }
                if (nextMonthRecordBtn) {
                    nextMonthRecordBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(1);
                    });
                }
                ['Ã¦ÂÂÃ¦ÂÂÃ¦ÂÂ¥', 'Ã§ÂÂ«Ã¦ÂÂÃ¦ÂÂ¥', 'Ã¦Â°Â´Ã¦ÂÂÃ¦ÂÂ¥', 'Ã¦ÂÂ¨Ã¦ÂÂÃ¦ÂÂ¥', 'Ã©ÂÂÃ¦ÂÂÃ¦ÂÂ¥', 'Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂ'].forEach(day => {
                    document.getElementById(`day-${day}`)?.addEventListener('click', () => {
                        this.selectedDay = day;
                        this.render();
                    });
                });
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const classId = btn.getAttribute('data-class');
                        const week = btn.getAttribute('data-week');
                        this.toggleAttendance(classId, week);
                    });
                });
                document.querySelectorAll('.add-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-add-day');
                        const location = btn.getAttribute('data-add-location');
                        const className = btn.getAttribute('data-add-class');
                        this.addStudentToClass(day, location, className);
                    });
                });
                // Ã§ÂÂÃ¥Â¾ÂÃ§Â·Â¨Ã©ÂÂÃ£ÂÂÃ£ÂÂ¿Ã£ÂÂ³
                document.querySelectorAll('.edit-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-edit-student-day');
                        const location = btn.getAttribute('data-edit-student-location');
                        const className = btn.getAttribute('data-edit-student-class');
                        const lastName = btn.getAttribute('data-edit-student-lastname');
                        const firstName = btn.getAttribute('data-edit-student-firstname');
                        this.startEditStudent(day, location, className, lastName, firstName);
                    });
                });
                // Ã§ÂÂÃ¥Â¾ÂÃ¥ÂÂÃ©ÂÂ¤Ã£ÂÂÃ£ÂÂ¿Ã£ÂÂ³
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-delete-day');
                        const location = btn.getAttribute('data-delete-location');
                        const className = btn.getAttribute('data-delete-class');
                        const lastName = btn.getAttribute('data-delete-lastname');
                        const firstName = btn.getAttribute('data-delete-firstname');
                        this.deleteStudent(day, location, className, lastName, firstName);
                    });
                });
                // Ã§ÂÂÃ¥Â¾ÂÃ§Â·Â¨Ã©ÂÂÃ¤Â¿ÂÃ¥Â­ÂÃ£ÂÂ»Ã£ÂÂ­Ã£ÂÂ£Ã£ÂÂ³Ã£ÂÂ»Ã£ÂÂ«
                document.getElementById('saveEditStudentBtn')?.addEventListener('click', () => this.saveEditStudent());
                document.getElementById('cancelEditStudentBtn')?.addEventListener('click', () => {
                    this.editingStudent = null;
                    this.render();
                });
                // Ã§ÂÂÃ¥Â¾ÂÃ¦Â¤ÂÃ§Â´Â¢Ã¯Â¼ÂÃ£ÂÂªÃ£ÂÂ¢Ã£ÂÂ«Ã£ÂÂ¿Ã£ÂÂ¤Ã£ÂÂ Ã¯Â¼Â- Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ¼Ã£ÂÂ«Ã£ÂÂ¹Ã§Â¶Â­Ã¦ÂÂÃ£ÂÂ®Ã£ÂÂÃ£ÂÂÃ¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ£ÂÂ®Ã£ÂÂ¿Ã¦ÂÂ´Ã¦ÂÂ°
                const searchInput = document.getElementById('student_search_input');
                if (searchInput) {
                    // inputÃ£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂ§Ã¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ£ÂÂ®Ã£ÂÂ¿Ã¦ÂÂ´Ã¦ÂÂ°Ã¯Â¼ÂÃ¥ÂÂ¨Ã¤Â½ÂÃ£ÂÂÃ¥ÂÂÃ£ÂÂ¬Ã£ÂÂ³Ã£ÂÂÃ£ÂÂªÃ£ÂÂ³Ã£ÂÂ°Ã£ÂÂÃ£ÂÂªÃ£ÂÂÃ¯Â¼Â
                    searchInput.addEventListener('input', (e) => {
                        this.studentSearchTerm = e.target.value;
                        if (this.studentSearchTerm.trim()) {
                            this.studentSearchResults = this.searchCustomerByName(this.studentSearchTerm);
                        } else {
                            this.studentSearchResults = [];
                            this.selectedCustomerForStudent = null;
                        }
                        // Ã¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ£ÂÂ®Ã£ÂÂ¿Ã£ÂÂÃ¦ÂÂ´Ã¦ÂÂ°Ã¯Â¼ÂÃ£ÂÂÃ£ÂÂ©Ã£ÂÂ¼Ã£ÂÂ«Ã£ÂÂ¹Ã£ÂÂÃ§Â¶Â­Ã¦ÂÂÃ¯Â¼Â
                        this.updateSearchResults();
                    });
                    
                    // Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ¼Ã£ÂÂ«Ã£ÂÂ¹Ã¦ÂÂÃ£ÂÂ«Ã£ÂÂÃ¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ£ÂÂÃ¨Â¡Â¨Ã§Â¤Âº
                    searchInput.addEventListener('focus', (e) => {
                        if (this.studentSearchTerm.trim()) {
                            this.studentSearchResults = this.searchCustomerByName(this.studentSearchTerm);
                            this.updateSearchResults();
                        }
                    });
                }
                // Ã©Â¡Â§Ã¥Â®Â¢Ã©ÂÂ¸Ã¦ÂÂÃ¯Â¼ÂÃ¥ÂÂÃ¦ÂÂÃ£ÂÂ¬Ã£ÂÂ³Ã£ÂÂÃ£ÂÂªÃ£ÂÂ³Ã£ÂÂ°Ã¦ÂÂÃ¯Â¼Â
                document.querySelectorAll('.select-customer-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.getAttribute('data-select-customer-id');
                        const customer = this.customers.find(c => c.id === customerId);
                        if (customer) {
                            this.selectCustomerForStudent(customer);
                        }
                    });
                });
                // Ã©Â¡Â§Ã¥Â®Â¢Ã©ÂÂ¸Ã¦ÂÂÃ¨Â§Â£Ã©ÂÂ¤Ã¯Â¼ÂÃ¥ÂÂÃ¦ÂÂÃ£ÂÂ¬Ã£ÂÂ³Ã£ÂÂÃ£ÂÂªÃ£ÂÂ³Ã£ÂÂ°Ã¦ÂÂÃ¯Â¼Â
                document.getElementById('clearSelectedCustomer')?.addEventListener('click', () => {
                    this.selectedCustomerForStudent = null;
                    this.studentSearchTerm = '';
                    this.studentSearchResults = [];
                    this.updateSelectedCustomerInfo();
                    // Ã¦Â¤ÂÃ§Â´Â¢Ã¥ÂÂ¥Ã¥ÂÂÃ¦Â¬ÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂªÃ£ÂÂ¢
                    const searchInput = document.getElementById('student_search_input');
                    if (searchInput) searchInput.value = '';
                    // Ã¦Â¤ÂÃ§Â´Â¢Ã§ÂµÂÃ¦ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂªÃ£ÂÂ¢
                    this.updateSearchResults();
                    // Ã£ÂÂÃ£ÂÂ©Ã£ÂÂ³Ã£ÂÂÃ£ÂÂªÃ£ÂÂ»Ã£ÂÂÃ£ÂÂ
                    const planSelect = document.getElementById('new_student_plan');
                    if (planSelect) planSelect.value = '';
                });
                // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¥Â°ÂÃ§ÂÂ¨Ã£ÂÂ®Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂªÃ£ÂÂ¹Ã£ÂÂÃ£ÂÂ¼
                document.getElementById('addEventParticipantBtn')?.addEventListener('click', () => {
                    this.addEventParticipant();
                });
                // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¥ÂÂºÃ¥Â¸Â­Ã£ÂÂÃ£ÂÂ¿Ã£ÂÂ³
                document.querySelectorAll('.event-attendance-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-event-index'));
                        const week = btn.getAttribute('data-event-week');
                        const current = this.eventAttendanceData[index][week] || '';
                        const next = current === 'Ã¢ÂÂ' ? 'ÃÂ' : 'Ã¢ÂÂ';
                        this.eventAttendanceData[index][week] = next;
                        this.saveEventAttendance();
                        this.render();
                    });
                });
                // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ£ÂÂÃ£ÂÂ£Ã£ÂÂ¼Ã£ÂÂ«Ã£ÂÂÃ¥ÂÂ¥Ã¥ÂÂ
                document.querySelectorAll('[data-event-field]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-event-index'));
                        const field = e.target.getAttribute('data-event-field');
                        let value = e.target.value;
                        
                        // Ã¦ÂÂÃ©ÂÂÃ£ÂÂ¯Ã¦ÂÂ°Ã¥ÂÂ¤Ã£ÂÂ«Ã¥Â¤ÂÃ¦ÂÂ
                        if (field === 'fee') {
                            value = parseFloat(value) || 0;
                        }
                        
                        this.eventAttendanceData[index][field] = value;
                        this.saveEventAttendance();
                    });
                    // Ã£ÂÂªÃ£ÂÂ¢Ã£ÂÂ«Ã£ÂÂ¿Ã£ÂÂ¤Ã£ÂÂ Ã¦ÂÂ´Ã¦ÂÂ°Ã¯Â¼ÂÃ¦ÂÂÃ©ÂÂÃ£ÂÂ®Ã£ÂÂ¿Ã¯Â¼Â
                    if (input.getAttribute('data-event-field') === 'fee') {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-event-index'));
                            const value = parseFloat(e.target.value) || 0;
                            this.eventAttendanceData[index].fee = value;
                            this.render();
                        });
                    }
                });
                // Ã£ÂÂ¤Ã£ÂÂÃ£ÂÂ³Ã£ÂÂÃ¥ÂÂÃ¥ÂÂ Ã¨ÂÂÃ¥ÂÂÃ©ÂÂ¤
                document.querySelectorAll('.delete-event-participant-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-delete-event-index'));
                        this.deleteEventParticipant(index);
                    });
                });
                document.getElementById('saveNewStudentBtn')?.addEventListener('click', () => this.saveNewStudent());
                document.getElementById('cancelAddStudentBtn')?.addEventListener('click', () => {
                    this.showAddStudentForm = false;
                    this.selectedClassForAdd = null;
                    this.selectedCustomerForStudent = null;
                    this.studentSearchTerm = '';
                    this.studentSearchResults = [];
                    this.render();
                });
                // Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼ÂÃ£ÂÂ®Ã¥ÂÂÃ¥ÂÂ Ã¤ÂºÂºÃ¦ÂÂ°Ã¥ÂÂ¥Ã¥ÂÂ
                document.querySelectorAll('.practice-input').forEach(input => {
                    input.addEventListener('change', async (e) => {
                        const day = e.target.getAttribute('data-practice-day');
                        const week = e.target.getAttribute('data-practice-week');
                        const value = parseInt(e.target.value) || 0;
                        const practiceKey = `Ã§Â·Â´Ã§Â¿ÂÃ¤Â¼Â_${day}`;
                        if (!this.attendanceData[practiceKey]) {
                            this.attendanceData[practiceKey] = {};
                        }
                        this.attendanceData[practiceKey][week] = value;
                        await this.saveAttendance(practiceKey, this.attendanceData[practiceKey]);
                        this.render();
                    });
                });
                // Ã£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¢Ã£ÂÂÃ£ÂÂÃ£ÂÂÃ£ÂÂ¿Ã£ÂÂ³
                document.getElementById('backupBtn')?.addEventListener('click', async () => {
                    await this.createBackup();
                });
            }
            // Ã£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¢Ã£ÂÂÃ£ÂÂÃ¦Â©ÂÃ¨ÂÂ½
            async createBackup() {
                const statusEl = document.getElementById('backupStatus');
                if (statusEl) statusEl.textContent = 'Ã£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¢Ã£ÂÂÃ£ÂÂÃ¤Â½ÂÃ¦ÂÂÃ¤Â¸Â­...';
                try {
                    const backup = { timestamp: new Date().toISOString(), collections: {} };
                    // schedule
                    const scheduleSnap = await getDocs(collection(db, 'schedule'));
                    backup.collections.schedule = {};
                    scheduleSnap.docs.forEach(d => { backup.collections.schedule[d.id] = d.data(); });
                    // customers
                    const custSnap = await getDocs(collection(db, 'customers'));
                    backup.collections.customers = {};
                    custSnap.docs.forEach(d => { backup.collections.customers[d.id] = d.data(); });
                    // attendance months
                    const months = ['202509','202511','202512','202601','202602','202603'];
                    for (const m of months) {
                        try {
                            const snap = await getDocs(collection(db, `attendance_${m}`));
                            if (!snap.empty) {
                                backup.collections[`attendance_${m}`] = {};
                                snap.docs.forEach(d => { backup.collections[`attendance_${m}`][d.id] = d.data(); });
                            }
                        } catch(e) {}
                    }
                    // event_attendance months
                    for (const m of months) {
                        try {
                            const snap = await getDocs(collection(db, `event_attendance_${m}`));
                            if (!snap.empty) {
                                backup.collections[`event_attendance_${m}`] = {};
                                snap.docs.forEach(d => { backup.collections[`event_attendance_${m}`][d.id] = d.data(); });
                            }
                        } catch(e) {}
                    }
                    // Ã£ÂÂÃ£ÂÂ¦Ã£ÂÂ³Ã£ÂÂ­Ã£ÂÂ¼Ã£ÂÂ
                    const json = JSON.stringify(backup, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    if (statusEl) statusEl.textContent = `Ã¢ÂÂ Ã£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¢Ã£ÂÂÃ£ÂÂÃ¥Â®ÂÃ¤ÂºÂ (${new Date().toLocaleString('ja-JP')})`;
                } catch (error) {
                    console.error('Ã£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¢Ã£ÂÂÃ£ÂÂÃ£ÂÂ¨Ã£ÂÂ©Ã£ÂÂ¼:', error);
                    if (statusEl) statusEl.textContent = `Ã¢ÂÂ Ã£ÂÂÃ£ÂÂÃ£ÂÂ¯Ã£ÂÂ¢Ã£ÂÂÃ£ÂÂÃ¥Â¤Â±Ã¦ÂÂ: ${error.message}`;
                }
            }
        }
        window.app = new DanceStudioApp();
        app.init();
    </script>
</body>
</html>
