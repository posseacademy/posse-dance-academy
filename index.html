<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>posse dance academy 顧客管理システム（生徒データ保存対応版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; }
        .tab-active { border-bottom: 3px solid #3B82F6; color: #3B82F6; }
        .status-tab-active { background-color: #3B82F6; color: white; }
        .status-badge-active { background-color: #10B981; color: white; }
        .status-badge-paused { background-color: #F59E0B; color: white; }
        .status-badge-withdrawn { background-color: #6B7280; color: white; }
        .gender-male { color: #2563EB; font-weight: 600; }
        .gender-female { color: #DC2626; font-weight: 600; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #F3F4F6; }
        .sort-icon { display: inline-block; margin-left: 4px; font-size: 10px; }
        table { table-layout: fixed; }
        td, th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        td.memo-cell { white-space: normal !important; word-wrap: break-word; word-break: break-word; line-height: 1.5; padding-top: 12px !important; padding-bottom: 12px !important; vertical-align: top; }
        td.email-cell { white-space: nowrap !important; overflow: hidden; text-overflow: ellipsis; }
        .class-red { background-color: #DC2626; }
        .class-orange { background-color: #EA580C; }
        .class-blue { background-color: #2563EB; }
        .class-green { background-color: #16A34A; }
        .class-purple { background-color: #9333EA; }
        .bg-red-600 { background-color: #DC2626; }
        .bg-orange-600 { background-color: #EA580C; }
        .bg-blue-600 { background-color: #2563EB; }
        .bg-green-600 { background-color: #16A34A; }
        .bg-purple-600 { background-color: #9333EA; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .student-search-results { max-height: 300px; overflow-y: auto; z-index: 10; }
        .select-customer-btn:hover { background-color: #EFF6FF; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                <p class="text-gray-600">システムを読み込み中...</p>
            </div>
        </div>
    </div>
    
    <!-- 生徒データ保存機能追加の確認メッセージ -->
    <div id="saveStatus" style="position: fixed; bottom: 20px; right: 20px; background: #10B981; color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 9999; display: none;">
        ✅ 生徒データを保存しました
    </div>
    
    <script type="module">
        // Firebase設定とインポート
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBp3_3UwgOKkILJuWx8usYdQhGfB_bAD34",
            authDomain: "posse-dance-academy.firebaseapp.com",
            projectId: "posse-dance-academy",
            storageBucket: "posse-dance-academy.firebasestorage.app",
            messagingSenderId: "613497046871",
            appId: "1:613497046871:web:8a31cbc6b947617113e012"
        };
        
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        
        // 保存成功メッセージを表示する関数
        function showSaveSuccess() {
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.style.display = 'block';
            setTimeout(() => {
                saveStatus.style.display = 'none';
            }, 3000);
        }
        
        // メインアプリケーションクラス
        class DanceStudioApp {
            constructor() {
                this.currentTab = 'attendance';
                this.statusFilter = '入会中';
                this.customers = [];
                this.editingId = null;
                this.editForm = {};
                this.showAddForm = false;
                this.searchTerm = '';
                this.sortField = 'memberNumber';
                this.sortOrder = 'asc';
                this.newCustomer = this.getEmptyCustomer();
                this.attendanceTab = 'record';
                this.selectedMonth = new Date().toISOString().slice(0, 7);
                this.selectedDay = '月曜日';
                this.attendanceData = {};
                this.eventAttendanceData = [];
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.isLoading = false;
                this.editingStudent = null;
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.selectedCustomerForStudent = null;
                
                this.pricing = {
                    '4クラス': 18600, '４クラス': 18600,
                    '3クラス': 14400, '３クラス': 14400,
                    '2クラス': 10000, '２クラス': 10000,
                    '1クラス': 6000, '１クラス': 6000,
                    '1.5hクラス': 6600,
                    '初回体験': 1000, '初回無料': 0,
                    'ビジター（会員）': 2000, 'ビジター（非会員）': 2300,
                    'ビジター1.5h（会員）': 2200, 'ビジター1.5h（非会員）': 2500,
                    '月謝クラス振替': 1000
                };
                
                this.planOrder = {
                    '4クラス': 1, '４クラス': 1,
                    '3クラス': 2, '３クラス': 2,
                    '2クラス': 3, '２クラス': 3,
                    '1クラス': 4, '１クラス': 4,
                    '1.5hクラス': 5,
                    'ビジター（会員）': 6, 'ビジター（非会員）': 7,
                    'ビジター（振替）': 8,
                    '初回体験': 9, '初回無料': 10
                };
                
                // クラス構造（生徒は空配列で初期化）
                this.scheduleData = {
                    '月曜日': [
                        { location: '天神', name: 'アクロバット SOYA', color: 'red', students: []},
                        { location: '天神', name: 'ブレイキン入門 SOYA', color: 'orange', students: []},
                        { location: '天神', name: 'トップロック フットワーク DAZ', color: 'blue', students: []},
                        { location: '天神', name: 'K-POP AI', color: 'green', students: []},
                        { location: '天神', name: 'hiphop HIMEKA', color: 'purple', students: []},
                        { location: '大橋', name: 'hiphop HIMEKA', color: 'purple', students: []}
                    ],
                    '火曜日': [
                        { location: '大橋', name: 'キッズダンス AYANO', color: 'red', students: []},
                        { location: '大橋', name: 'Bgirlクラス AYANO HARUHIKO', color: 'orange', students: []},
                        { location: '照葉', name: 'ブレイキン入門 SOYA', color: 'blue', students: []},
                        { location: '照葉', name: 'アクロ＆パワー SOYA', color: 'green', students: []}
                    ],
                    '水曜日': [
                        { location: '天神', name: 'ブレイキン初級 HARUHIKO', color: 'red', students: []},
                        { location: '天神', name: 'ブレイキン中上級 HARUHIKO', color: 'orange', students: []}
                    ],
                    '木曜日': [
                        { location: '大橋', name: 'ブレイキン入門 SOYA', color: 'red', students: []},
                        { location: '大橋', name: 'アクロ＆パワー SOYA', color: 'orange', students: []},
                        { location: '照葉', name: 'ブレイキン入門 リュウセイ', color: 'blue', students: []},
                        { location: '照葉', name: 'アクロ＆パワー リュウセイ', color: 'green', students: []}
                    ],
                    '金曜日': [
                        { location: '天神', name: 'アクロ＆パワー SOYA', color: 'red', students: []},
                        { location: '天神', name: 'ブレイキン初中級 HARUHIKO', color: 'orange', students: []},
                        { location: '大橋', name: 'ブレイキン入門 HARUHIKO', color: 'blue', students: []},
                        { location: '大橋', name: 'アクロ＆パワー ryusei', color: 'green', students: []}
                    ]
                };
            }
            
            getEmptyCustomer() {
                return {
                    memberNumber: '', status: '入会中', course: '', annualFee: '',
                    lastName: '', firstName: '', reading: '', guardianName: '', hakomonoName: '',
                    gender: '', birthDate: '', phone1: '', email: '',
                    postalCode: '', prefecture: '', city: '', address: '', building: '',
                    joinDate: '', memo: ''
                };
            }
            
            async init() {
                try {
                    await this.loadCustomers();
                    await this.loadStudents();  // 生徒データを読み込み
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                    
                    // 全クラスの生徒をプラン順にソート
                    Object.keys(this.scheduleData).forEach(day => {
                        this.scheduleData[day].forEach(classInfo => {
                            classInfo.students = this.sortStudentsByPlan(classInfo.students);
                        });
                    });
                    
                    this.render();
                } catch (error) {
                    console.error('初期化エラー:', error);
                    alert('システムの初期化中にエラーが発生しました。ページを再読み込みしてください。');
                }
            }
            
            // 生徒データをFirestoreから読み込む（新規追加メソッド）
            async loadStudents() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'class_students'));
                    const studentsData = {};
                    
                    querySnapshot.docs.forEach(doc => {
                        studentsData[doc.id] = doc.data();
                    });
                    
                    // scheduleDataに生徒を配置
                    Object.keys(this.scheduleData).forEach(day => {
                        this.scheduleData[day].forEach(classInfo => {
                            const classKey = `${day}_${classInfo.location}_${classInfo.name}`;
                            if (studentsData[classKey]) {
                                classInfo.students = studentsData[classKey].students || [];
                            }
                        });
                    });
                    console.log('生徒データを読み込みました');
                } catch (error) {
                    console.error('生徒データ読み込みエラー:', error);
                }
            }
            
            // 生徒データをFirestoreに保存する（新規追加メソッド）
            async saveStudentsForClass(day, location, className, students) {
                try {
                    const classKey = `${day}_${location}_${className}`;
                    const docRef = doc(db, 'class_students', classKey);
                    await setDoc(docRef, {
                        day: day,
                        location: location,
                        className: className,
                        students: students,
                        updatedAt: new Date()
                    });
                    showSaveSuccess();
                    console.log(`生徒データを保存しました: ${classKey}`);
                } catch (error) {
                    console.error('生徒データ保存エラー:', error);
                    alert('生徒データの保存に失敗しました');
                }
            }
            
            async loadCustomers() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'customers'));
                    this.customers = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    this.customers.sort((a, b) => (a.memberNumber || '').localeCompare(b.memberNumber || ''));
                } catch (error) {
                    console.error('顧客データ読み込みエラー:', error);
                    this.customers = [];
                }
            }
            
            async loadAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const querySnapshot = await getDocs(collection(db, `attendance_${monthKey}`));
                    this.attendanceData = {};
                    querySnapshot.docs.forEach(doc => {
                        this.attendanceData[doc.id] = doc.data();
                    });
                } catch (error) {
                    console.error('出席データ読み込みエラー:', error);
                    this.attendanceData = {};
                }
            }
            
            async loadEventAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const querySnapshot = await getDocs(collection(db, `event_attendance_${monthKey}`));
                    this.eventAttendanceData = [];
                    querySnapshot.docs.forEach(doc => {
                        this.eventAttendanceData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    this.eventAttendanceData.sort((a, b) => (a.index || 0) - (b.index || 0));
                } catch (error) {
                    console.error('イベント出席データ読み込みエラー:', error);
                    this.eventAttendanceData = [];
                }
            }
            
            // 生徒追加（Firestore保存対応）
            async saveNewStudent() {
                let lastName, firstName, plan;
                
                if (this.selectedCustomerForStudent) {
                    lastName = this.selectedCustomerForStudent.lastName;
                    firstName = this.selectedCustomerForStudent.firstName;
                    plan = document.getElementById('new_student_plan')?.value || '';
                } else {
                    lastName = document.getElementById('new_student_lastName')?.value || '';
                    firstName = document.getElementById('new_student_firstName')?.value || '';
                    plan = document.getElementById('new_student_plan')?.value || '';
                }
                
                if (!lastName || !firstName || !plan) {
                    alert('姓名とプランを入力してください');
                    return;
                }
                
                const { day, location, className } = this.selectedClassForAdd;
                const classIndex = this.scheduleData[day].findIndex(c => 
                    c.location === location && c.name === className
                );
                
                if (classIndex !== -1) {
                    // 生徒を追加
                    this.scheduleData[day][classIndex].students.push({ lastName, firstName, plan });
                    this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(
                        this.scheduleData[day][classIndex].students
                    );
                    
                    // Firestoreに保存
                    await this.saveStudentsForClass(day, location, className, 
                        this.scheduleData[day][classIndex].students
                    );
                }
                
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.selectedCustomerForStudent = null;
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.render();
            }
            
            // 生徒編集（Firestore保存対応）
            async saveEditStudent() {
                const newPlan = document.getElementById('edit_student_plan')?.value;
                if (!newPlan) {
                    alert('プランを選択してください');
                    return;
                }
                
                const { day, location, className, lastName, firstName } = this.editingStudent;
                const classIndex = this.scheduleData[day].findIndex(c => 
                    c.location === location && c.name === className
                );
                
                if (classIndex !== -1) {
                    const studentIndex = this.scheduleData[day][classIndex].students.findIndex(
                        s => s.lastName === lastName && s.firstName === firstName
                    );
                    
                    if (studentIndex !== -1) {
                        this.scheduleData[day][classIndex].students[studentIndex].plan = newPlan;
                        this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(
                            this.scheduleData[day][classIndex].students
                        );
                        
                        // Firestoreに保存
                        await this.saveStudentsForClass(day, location, className, 
                            this.scheduleData[day][classIndex].students
                        );
                    }
                }
                
                this.editingStudent = null;
                this.render();
            }
            
            // 生徒削除（Firestore保存対応）
            async deleteStudent(day, location, className, lastName, firstName) {
                if (!confirm(`${lastName} ${firstName} を削除してもよろしいですか？`)) {
                    return;
                }
                
                const classIndex = this.scheduleData[day].findIndex(c => 
                    c.location === location && c.name === className
                );
                
                if (classIndex !== -1) {
                    this.scheduleData[day][classIndex].students = 
                        this.scheduleData[day][classIndex].students.filter(
                            s => !(s.lastName === lastName && s.firstName === firstName)
                        );
                    
                    // Firestoreに保存
                    await this.saveStudentsForClass(day, location, className, 
                        this.scheduleData[day][classIndex].students
                    );
                }
                
                // 出席データも削除
                const studentKey = `${day}_${location}_${className}_${lastName}${firstName}`;
                const monthKey = this.selectedMonth.replace('-', '');
                try {
                    await deleteDoc(doc(db, `attendance_${monthKey}`, studentKey));
                } catch (error) {
                    console.log('出席データ削除（データが存在しない可能性があります）');
                }
                
                await this.loadAttendance();
                this.render();
            }
            
            sortStudentsByPlan(students) {
                return students.sort((a, b) => {
                    const orderA = this.planOrder[a.plan] || 999;
                    const orderB = this.planOrder[b.plan] || 999;
                    return orderA - orderB;
                });
            }
            
            async changeMonth(direction) {
                this.isLoading = true;
                this.render();
                
                try {
                    const [currentYear, currentMonth] = this.selectedMonth.split('-').map(Number);
                    let newYear = currentYear;
                    let newMonth = currentMonth + direction;
                    
                    if (newMonth > 12) {
                        newMonth = 1;
                        newYear++;
                    } else if (newMonth < 1) {
                        newMonth = 12;
                        newYear--;
                    }
                    
                    this.selectedMonth = `${newYear}-${String(newMonth).padStart(2, '0')}`;
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('月切り替えエラー:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }
            
            async toggleAttendance(classId, week) {
                const current = this.attendanceData[classId]?.[week] || '';
                const next = current === '○' ? '×' : 
                            current === '×' ? '休講' : 
                            current === '休講' ? '' : '○';
                
                if (!this.attendanceData[classId]) {
                    this.attendanceData[classId] = {};
                }
                this.attendanceData[classId][week] = next;
                
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const docRef = doc(db, `attendance_${monthKey}`, classId);
                    await setDoc(docRef, this.attendanceData[classId], { merge: true });
                } catch (error) {
                    console.error('出席データ保存エラー:', error);
                }
                
                this.render();
            }
            
            getAttendanceRate(classId) {
                const data = this.attendanceData[classId] || {};
                const weeks = ['week1', 'week2', 'week3', 'week4'];
                const attended = weeks.filter(w => data[w] === '○').length;
                const recorded = weeks.filter(w => data[w] === '○' || data[w] === '×').length;
                return recorded > 0 ? Math.round((attended / recorded) * 100) : 0;
            }
            
            render() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="min-h-screen">
                        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
                            <div class="container mx-auto px-4 py-4">
                                <h1 class="text-2xl font-bold">posse dance academy</h1>
                                <p class="text-sm opacity-90">顧客管理システム（生徒データ保存対応版）</p>
                            </div>
                        </header>
                        
                        <nav class="bg-white shadow">
                            <div class="container mx-auto px-4">
                                <div class="flex space-x-8">
                                    <button onclick="app.currentTab='dashboard';app.render()" 
                                        class="py-4 px-2 font-medium ${this.currentTab === 'dashboard' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">
                                        ダッシュボード
                                    </button>
                                    <button onclick="app.currentTab='customers';app.render()" 
                                        class="py-4 px-2 font-medium ${this.currentTab === 'customers' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">
                                        顧客管理
                                    </button>
                                    <button onclick="app.currentTab='attendance';app.render()" 
                                        class="py-4 px-2 font-medium ${this.currentTab === 'attendance' ? 'tab-active' : 'text-gray-600 hover:text-blue-600'}">
                                        出席名簿
                                    </button>
                                </div>
                            </div>
                        </nav>
                        
                        <main class="container mx-auto px-4 py-8">
                            ${this.currentTab === 'dashboard' ? this.renderDashboard() : 
                              this.currentTab === 'customers' ? this.renderCustomers() : 
                              this.renderAttendance()}
                        </main>
                    </div>
                `;
                
                this.setupEvents();
            }
            
            renderDashboard() {
                return `
                    <div>
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">ダッシュボード</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">総顧客数</div>
                                <div class="text-4xl font-bold text-blue-600">${this.customers.length}</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">入会中</div>
                                <div class="text-4xl font-bold text-green-600">
                                    ${this.customers.filter(c => c.status === '入会中').length}
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-gray-600 text-sm mb-2">生徒総数</div>
                                <div class="text-4xl font-bold text-purple-600">
                                    ${Object.values(this.scheduleData).reduce((sum, classes) => 
                                        sum + classes.reduce((s, c) => s + c.students.length, 0), 0)}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">システム状態</h3>
                            <div class="space-y-2">
                                <p class="flex items-center">
                                    <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                    <span>生徒データ自動保存: 有効</span>
                                </p>
                                <p class="flex items-center">
                                    <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                    <span>Firestoreとの同期: 正常</span>
                                </p>
                                <p class="text-sm text-gray-600 mt-2">
                                    ※ 生徒を追加・編集・削除すると自動的にFirestoreに保存されます
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderCustomers() {
                return `
                    <div>
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">顧客管理</h2>
                        <div class="bg-white rounded-lg shadow p-6">
                            <p class="text-gray-600">顧客管理機能は別途実装済みです</p>
                        </div>
                    </div>
                `;
            }
            
            renderAttendance() {
                if (this.isLoading) {
                    return `
                        <div class="flex items-center justify-center h-96">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                                <p class="text-gray-600">読み込み中...</p>
                            </div>
                        </div>
                    `;
                }
                
                const dayClasses = this.scheduleData[this.selectedDay] || [];
                
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">出席記録</h2>
                            <div class="flex gap-2 items-center">
                                <button onclick="app.changeMonth(-1)" 
                                    class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded text-sm">
                                    ◀ 前月
                                </button>
                                <span class="px-3 py-2 bg-blue-50 text-blue-800 rounded font-medium">
                                    ${this.selectedMonth}
                                </span>
                                <button onclick="app.changeMonth(1)" 
                                    class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded text-sm">
                                    次月 ▶
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow mb-4">
                            <div class="flex border-b overflow-x-auto">
                                ${['月曜日', '火曜日', '水曜日', '木曜日', '金曜日'].map(day => `
                                    <button onclick="app.selectedDay='${day}';app.render()" 
                                        class="px-4 py-2 text-sm font-medium whitespace-nowrap 
                                        ${this.selectedDay === day ? 
                                            'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 
                                            'text-gray-600 hover:text-blue-600 hover:bg-gray-50'}">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        ${dayClasses.map((classInfo, idx) => this.renderClass(classInfo)).join('')}
                        
                        ${dayClasses.length === 0 ? `
                            <div class="bg-white rounded-lg shadow p-12 text-center">
                                <p class="text-gray-500 text-lg">この曜日にはクラスがありません</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            renderClass(classInfo) {
                const sortedStudents = this.sortStudentsByPlan([...classInfo.students]);
                
                return `
                    <div class="bg-white rounded-lg shadow mb-3">
                        <div class="bg-${classInfo.color}-600 text-white px-4 py-2 rounded-t-lg">
                            <div class="flex justify-between items-center">
                                <h3 class="text-base font-bold">
                                    ${classInfo.location} - ${classInfo.name}
                                </h3>
                                <div class="flex gap-2 items-center">
                                    <span class="text-xs opacity-90">${sortedStudents.length}名</span>
                                    <button onclick="app.showAddStudentDialog('${this.selectedDay}', '${classInfo.location}', '${classInfo.name}')" 
                                        class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-xs">
                                        + 生徒追加
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-3 overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="bg-gray-50 border-b">
                                        <th class="px-2 py-2 text-left">氏名</th>
                                        <th class="px-2 py-2 text-left">プラン</th>
                                        <th class="px-2 py-2 text-center">第1週</th>
                                        <th class="px-2 py-2 text-center">第2週</th>
                                        <th class="px-2 py-2 text-center">第3週</th>
                                        <th class="px-2 py-2 text-center">第4週</th>
                                        <th class="px-2 py-2 text-center">出席率</th>
                                        <th class="px-2 py-2 text-center">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedStudents.map(student => 
                                        this.renderStudent(student, classInfo)
                                    ).join('')}
                                    ${sortedStudents.length === 0 ? `
                                        <tr>
                                            <td colspan="8" class="px-2 py-4 text-center text-gray-500">
                                                生徒がいません
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            renderStudent(student, classInfo) {
                const studentKey = `${this.selectedDay}_${classInfo.location}_${classInfo.name}_${student.lastName}${student.firstName}`;
                const attendance = this.attendanceData[studentKey] || {};
                const rate = this.getAttendanceRate(studentKey);
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-2 py-2">${student.lastName} ${student.firstName}</td>
                        <td class="px-2 py-2">${student.plan}</td>
                        ${['week1', 'week2', 'week3', 'week4'].map(week => `
                            <td class="px-2 py-2 text-center">
                                <button onclick="app.toggleAttendance('${studentKey}', '${week}')" 
                                    class="w-8 h-8 rounded border text-xs font-bold
                                    ${attendance[week] === '○' ? 'bg-green-500 border-green-600 text-white' :
                                      attendance[week] === '×' ? 'bg-red-500 border-red-600 text-white' :
                                      attendance[week] === '休講' ? 'bg-gray-500 border-gray-600 text-white' :
                                      'bg-gray-100 border-gray-300 text-gray-400'} 
                                    hover:opacity-80">
                                    ${attendance[week] === '休講' ? '休' : attendance[week] || '-'}
                                </button>
                            </td>
                        `).join('')}
                        <td class="px-2 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold 
                                ${rate >= 80 ? 'bg-green-100 text-green-800' :
                                  rate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                  rate > 0 ? 'bg-red-100 text-red-800' :
                                  'bg-gray-100 text-gray-600'}">
                                ${rate > 0 ? rate + '%' : '-'}
                            </span>
                        </td>
                        <td class="px-2 py-2 text-center">
                            <button onclick="app.deleteStudent('${this.selectedDay}', '${classInfo.location}', '${classInfo.name}', '${student.lastName}', '${student.firstName}')" 
                                class="text-red-600 hover:text-red-800 text-xs">
                                削除
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            showAddStudentDialog(day, location, className) {
                const lastName = prompt('生徒の姓を入力してください：');
                if (!lastName) return;
                
                const firstName = prompt('生徒の名を入力してください：');
                if (!firstName) return;
                
                const plan = prompt('プランを入力してください（例: １クラス、２クラス、３クラス、４クラス、ビジター（会員）など）：');
                if (!plan) return;
                
                this.selectedClassForAdd = { day, location, className };
                const classIndex = this.scheduleData[day].findIndex(c => 
                    c.location === location && c.name === className
                );
                
                if (classIndex !== -1) {
                    this.scheduleData[day][classIndex].students.push({ lastName, firstName, plan });
                    this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(
                        this.scheduleData[day][classIndex].students
                    );
                    
                    // Firestoreに保存
                    this.saveStudentsForClass(day, location, className, 
                        this.scheduleData[day][classIndex].students
                    );
                }
                
                this.render();
            }
            
            setupEvents() {
                // イベントリスナーの設定が必要な場合はここに追加
            }
        }
        
        // アプリケーションの初期化
        window.app = new DanceStudioApp();
        app.init();
    </script>
</body>
</html>
