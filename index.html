<!DOCTYPE html>
<html lang="ja">
<head>
    <script>window.location.replace("new-app/app.html");</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>posse dance academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');

        :root {
            --bg: #f5f5f7;
            --sidebar-bg: #1d1d1f;
            --card: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --text-tertiary: #aeaeb2;
            --accent: #0071e3;
            --accent-hover: #0077ED;
            --green: #34c759;
            --orange: #ff9500;
            --red: #ff3b30;
            --purple: #af52de;
            --border: rgba(0,0,0,0.06);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 14px rgba(0,0,0,0.06), 0 2px 6px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            --radius: 16px;
            --radius-sm: 12px;
            --radius-xs: 8px;
            --transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans JP", sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        /* ===== SIDEBAR - Apple Style ===== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: var(--sidebar-bg);
            color: white;
            padding: 32px 0;
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo {
            padding: 0 20px;
            margin-bottom: 24px;
        }

        .sidebar-logo .logo-image {
            width: 100%;
            max-width: 140px;
            margin-bottom: 0px;
        }

        .sidebar-logo h1 {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.5px;
            line-height: 1.2;
            color: #fff;
        }

        .sidebar-logo p {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            margin-top: 2px;
            letter-spacing: 2px;
        }

        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0 12px;
        }

        .sidebar .nav-section-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: rgba(255,255,255,0.25);
            padding: 20px 16px 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.55);
            cursor: pointer;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            letter-spacing: -0.1px;
            font-family: inherit;
            text-align: left;
            width: 100%;
        }

        .nav-item:hover {
            color: rgba(255,255,255,0.85);
            background: rgba(255,255,255,0.06);
        }

        .nav-item.active {
            color: white;
            background: var(--accent);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,113,227,0.35);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            opacity: 0.7;
        }

        .nav-item.active svg {
            opacity: 1;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            padding: 40px 48px;
        }

        /* ===== PAGE HEADER ===== */
        .page-header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-bottom: 36px;
        }

        .page-header h2 {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -1px;
            line-height: 1.1;
        }

        .page-header .subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            margin-top: 6px;
            font-weight: 400;
        }

        .date-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: none;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        /* ===== STAT CARDS ===== */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .stat-icon svg { width: 20px; height: 20px; }
        .stat-icon.blue { background: rgba(0,113,227,0.1); color: var(--accent); }
        .stat-icon.green { background: rgba(52,199,89,0.1); color: var(--green); }
        .stat-icon.orange { background: rgba(255,149,0,0.1); color: var(--orange); }
        .stat-icon.red { background: rgba(255,59,48,0.1); color: var(--red); }
        .stat-icon.purple { background: rgba(175,82,222,0.1); color: var(--purple); }

        .stat-label { font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.2px; }
        .stat-value { font-size: 42px; font-weight: 700; letter-spacing: -2px; line-height: 1; }
        .stat-unit { font-size: 16px; font-weight: 500; color: var(--text-secondary); margin-left: 4px; letter-spacing: 0; }
        .stat-change { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; margin-top: 12px; padding: 4px 10px; border-radius: 20px; }
        .stat-change.up { background: rgba(52,199,89,0.1); color: var(--green); }
        .stat-change.down { background: rgba(255,59,48,0.1); color: var(--red); }

        /* ===== CONTENT GRID ===== */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }

        .content-grid.full { grid-template-columns: 1fr; }

        .content-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 32px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .content-card:hover { box-shadow: var(--shadow-md); }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .card-title { font-size: 18px; font-weight: 600; letter-spacing: -0.3px; }
        .card-action { font-size: 13px; font-weight: 500; color: var(--accent); cursor: pointer; transition: var(--transition); }
        .card-action:hover { opacity: 0.7; }

        /* ===== REVENUE BREAKDOWN ===== */
        .revenue-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .revenue-row:last-child { border-bottom: none; }
        .rev-label { display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; }
        .rev-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .rev-detail { font-size: 13px; color: var(--text-secondary); text-align: right; }
        .rev-amount { font-size: 16px; font-weight: 600; letter-spacing: -0.3px; }
        .revenue-total { display: flex; justify-content: space-between; align-items: center; padding: 20px 0 0; margin-top: 8px; border-top: 2px solid var(--text-primary); }
        .revenue-total .rev-label { font-size: 16px; font-weight: 600; }
        .revenue-total .rev-amount { font-size: 28px; font-weight: 700; letter-spacing: -1px; }

        /* ===== VISITOR REVENUE CARD ===== */
        .visitor-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--radius);
            padding: 32px;
            position: relative;
            overflow: hidden;
        }

        .visitor-highlight::after {
            content: '';
            position: absolute;
            top: -30%;
            right: -10%;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255,255,255,0.08);
        }

        .vh-label { font-size: 13px; font-weight: 500; opacity: 0.75; margin-bottom: 8px; }
        .vh-value { font-size: 48px; font-weight: 700; letter-spacing: -2px; line-height: 1; margin-bottom: 4px; }
        .vh-detail { font-size: 14px; opacity: 0.65; }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 22px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            letter-spacing: -0.1px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0,113,227,0.25);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 14px rgba(0,113,227,0.35);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(0,0,0,0.05);
            color: var(--text-primary);
            border: none;
            padding: 10px 22px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: rgba(0,0,0,0.08);
        }

        .btn-danger {
            background: var(--red);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(255,59,48,0.25);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-danger:hover {
            background: #ff453a;
            box-shadow: 0 4px 14px rgba(255,59,48,0.35);
            transform: translateY(-1px);
        }

        .btn-green {
            background: var(--green);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(52,199,89,0.25);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-green:hover {
            background: #3dd65f;
            box-shadow: 0 4px 14px rgba(52,199,89,0.35);
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 7px 14px;
            font-size: 12px;
            border-radius: var(--radius-xs);
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        .badge-green {
            background: rgba(52,199,89,0.1);
            color: var(--green);
        }

        .badge-yellow {
            background: rgba(255,149,0,0.1);
            color: var(--orange);
        }

        .badge-gray {
            background: rgba(142,142,147,0.1);
            color: #8e8e93;
        }

        .badge-red {
            background: rgba(255,59,48,0.1);
            color: var(--red);
        }

        .badge-blue {
            background: rgba(0,113,227,0.08);
            color: var(--accent);
        }

        /* ===== SEARCH BAR ===== */
        .search-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border-radius: var(--radius-sm);
            padding: 12px 20px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .search-bar:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(0,113,227,0.1);
        }

        .search-bar svg { color: var(--text-tertiary); flex-shrink: 0; }

        .search-bar input {
            border: none;
            outline: none;
            font-size: 15px;
            font-family: inherit;
            color: var(--text-primary);
            width: 100%;
            background: transparent;
        }

        .search-bar input::placeholder { color: var(--text-tertiary); }

        /* ===== FORM INPUTS ===== */
        .form-input {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-xs);
            font-size: 14px;
            font-family: inherit;
            transition: var(--transition);
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(0,113,227,0.1);
        }

        /* ===== TABLES ===== */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: rgba(0,0,0,0.02);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tr:hover td {
            background: rgba(0,113,227,0.02);
        }

        /* ===== TAB BAR (Apple Segmented Control) ===== */
        .tab-nav {
            display: flex;
            gap: 4px;
            background: rgba(0,0,0,0.04);
            padding: 4px;
            border-radius: var(--radius-sm);
            margin-bottom: 24px;
            width: fit-content;
            border-bottom: none;
        }

        .tab-btn {
            padding: 8px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: var(--radius-xs);
            transition: var(--transition);
            font-family: inherit;
            border-bottom: none;
        }

        .tab-btn.active {
            background: white;
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            font-weight: 600;
        }

        /* ===== CUSTOMER CARDS ===== */
        .customer-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .customer-row {
            background: white;
            border-radius: var(--radius-sm);
            padding: 20px 24px;
            display: grid;
            grid-template-columns: 48px 1fr 100px 140px 120px 80px;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            cursor: pointer;
        }

        .customer-row:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .customer-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .customer-info h4 { font-size: 15px; font-weight: 600; letter-spacing: -0.2px; margin-bottom: 3px; }
        .customer-info p { font-size: 12px; color: var(--text-secondary); }
        .customer-course { font-size: 13px; font-weight: 600; color: var(--accent); background: rgba(0,113,227,0.08); padding: 5px 12px; border-radius: 20px; text-align: center; }
        .customer-phone { font-size: 13px; color: var(--text-secondary); font-variant-numeric: tabular-nums; }
        .customer-date { font-size: 13px; color: var(--text-secondary); }

        /* ===== INSTRUCTOR CARDS ===== */
        .instructor-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: var(--transition);
            border: none;
        }

        .instructor-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .instructor-header {
            padding: 28px 28px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.01);
        }

        .instructor-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }

        .instructor-stage {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .instructor-body {
            padding: 24px 28px;
        }

        .instructor-section {
            margin-bottom: 16px;
        }

        .instructor-section:last-child {
            margin-bottom: 0;
        }

        .instructor-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge-active { background: rgba(52,199,89,0.1); color: var(--green); font-weight: 600; border-radius: 20px; padding: 4px 12px; }
        .status-badge-paused { background: rgba(255,149,0,0.1); color: var(--orange); font-weight: 600; border-radius: 20px; padding: 4px 12px; }
        .status-badge-withdrawn { background: rgba(142,142,147,0.1); color: #8e8e93; font-weight: 600; border-radius: 20px; padding: 4px 12px; }
        .gender-male { color: var(--accent); font-weight: 600; }
        .gender-female { color: var(--red); font-weight: 600; }

        /* ===== SORTABLE HEADERS ===== */
        .sortable-header { cursor: pointer; user-select: none; transition: var(--transition); }
        .sortable-header:hover { background: rgba(0,0,0,0.04); }
        .sort-icon { display: inline-block; margin-left: 4px; font-size: 10px; }

        /* ===== TEXT CELLS ===== */
        td.memo-cell {
            white-space: normal !important;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.5;
            padding-top: 14px !important;
            padding-bottom: 14px !important;
            vertical-align: top;
        }

        td.email-cell {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ===== CLASS COLORS ===== */
        .class-red { background-color: #DC2626; }
        .class-orange { background-color: #EA580C; }
        .class-blue { background-color: #2563EB; }
        .class-green { background-color: #16A34A; }
        .class-purple { background-color: #9333EA; }

        .border-red-500 { border-color: #EF4444; }
        .border-orange-500 { border-color: #F97316; }
        .border-blue-500 { border-color: #3B82F6; }
        .border-green-500 { border-color: #22C55E; }
        .border-purple-500 { border-color: #A855F7; }

        .text-red-600 { color: #DC2626; }
        .text-orange-600 { color: #EA580C; }
        .text-blue-600 { color: #2563EB; }
        .text-green-600 { color: #16A34A; }
        .text-purple-600 { color: #9333EA; }

        .bg-red-600 { background-color: #DC2626; }
        .bg-orange-600 { background-color: #EA580C; }
        .bg-blue-600 { background-color: #2563EB; }
        .bg-green-600 { background-color: #16A34A; }
        .bg-purple-600 { background-color: #9333EA; }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .student-search-results {
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
        }

        .select-customer-btn:hover {
            background: rgba(0,113,227,0.04);
        }

        /* Tab active state (for backward compatibility) */
        .tab-active { background: white; color: var(--text-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.08); font-weight: 600; border-radius: var(--radius-xs); }
        .status-tab-active { background: var(--accent); color: white; border-radius: var(--radius-xs); }
    </style>
</head>
<body>
    <div id="app"></div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const firebaseConfig = {
            apiKey: "AIzaSyBp3_3UwgOKkILJuWx8usYdQhGfB_bAD34",
            authDomain: "posse-dance-academy.firebaseapp.com",
            projectId: "posse-dance-academy",
            storageBucket: "posse-dance-academy.firebasestorage.app",
            messagingSenderId: "613497046871",
            appId: "1:613497046871:web:8a31cbc6b947617113e012"
        };
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        class DanceStudioApp {
            constructor() {
                this.currentTab = 'home';
                this.statusFilter = '入会中';
                this.customers = [];
                this.editingId = null;
                this.editForm = {};
                this.showAddForm = false;
                this.searchTerm = '';
                this.sortField = 'memberNumber';
                this.sortOrder = 'asc';
                this.newCustomer = this.getEmptyCustomer();
                
                // 出席簿用
                this.attendanceTab = 'overview';
                this.selectedMonth = new Date().toISOString().slice(0, 7);
                this.selectedDay = '月曜日';
                this.attendanceData = {};
                this.eventAttendanceData = []; // イベント専用データ
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.isLoading = false;
                this.editingStudent = null; // 編集中の生徒情報
                this.studentSearchTerm = ''; // 生徒検索用
                this.studentSearchResults = []; // 検索結果
                this.selectedCustomerForStudent = null; // 選択された顧客情報
                
                this.pricing = {
                    '4クラス': 18600,
                    '４クラス': 18600,
                    '3クラス': 14400,
                    '３クラス': 14400,
                    '2クラス': 10000,
                    '２クラス': 10000,
                    '1クラス': 6000,
                    '１クラス': 6000,
                    '1.5hクラス': 6600,
                    '初回体験': 1000,
                    '初回無料': 0,
                    'ビジター（会員）': 2000,
                    'ビジター（非会員）': 2300,
                    'ビジター1.5h（会員）': 2200,
                    'ビジター1.5h（非会員）': 2500,
                    '月謝クラス振替': 1000,
                    '練習会': 500
                };
                this.visitorRevenueOverrides = {'202511':{total:43200,visitor:41200,trial:2000},'202512':{total:38400,visitor:35400,trial:3000},'202601':{total:42800,visitor:39800,trial:3000},'202602':{total:4000,visitor:2000,trial:2000}};
                this.planOrder = {
                    '4クラス': 1,
                    '４クラス': 1,
                    '3クラス': 2,
                    '３クラス': 2,
                    '2クラス': 3,
                    '２クラス': 3,
                    '1クラス': 4,
                    '１クラス': 4,
                    '1.5hクラス': 5,
                    'ビジター（会員）': 6,
                    'ビジター（非会員）': 7,
                    'ビジター（振替）': 8,
                    '初回体験': 9,
                    '初回無料': 10
                };
                this.scheduleData = {
                    '月曜日': [
                        { location: '天神', name: 'アクロバット SOYA', color: 'red', students: [
                            { lastName: '中島', firstName: '竜吾', plan: '３クラス' },
                            { lastName: '伊藤', firstName: '和馬', plan: '1クラス' },
                            { lastName: '四井', firstName: '陽音', plan: '３クラス' },
                            { lastName: '津留', firstName: '創真', plan: '２クラス' },
                            { lastName: '三重野', firstName: '琉生', plan: '３クラス' },
                            { lastName: 'ひわたし', firstName: 'こうた', plan: '２クラス' },
                            { lastName: '嶋川', firstName: '陽大', plan: '３クラス' },
                            { lastName: '', firstName: '大空', plan: '３クラス' }
                        ]},
                        { location: '天神', name: 'ブレイキン入門 SOYA', color: 'orange', students: [
                            { lastName: '津留', firstName: '創真', plan: '２クラス' },
                            { lastName: '榊', firstName: '花梨', plan: '２クラス' },
                            { lastName: 'ひわたし', firstName: 'こうた', plan: '２クラス' }
                        ]},
                        { location: '天神', name: 'トップロック フットワーク DAZ', color: 'blue', students: [
                            { lastName: '中島', firstName: '竜吾', plan: '３クラス' },
                            { lastName: '四井', firstName: '陽音', plan: '３クラス' },
                            { lastName: '伊藤', firstName: '和馬', plan: '1クラス' },
                            { lastName: '三重野', firstName: '琉生', plan: '３クラス' },
                            { lastName: '戸田', firstName: '唯斗', plan: '1クラス' },
                            { lastName: '森脇', firstName: '鳳仁', plan: '1クラス' },
                            { lastName: '嶋川', firstName: '陽大', plan: '２クラス' },
                            { lastName: '', firstName: '大空', plan: '３クラス' }
                        ]},
                        { location: '天神', name: 'K-POP AI', color: 'green', students: [
                            { lastName: '平嶋', firstName: '彩佳', plan: '1クラス' },
                            { lastName: '杉村', firstName: '早紀', plan: '1クラス' },
                            { lastName: '石原', firstName: '美黎', plan: '２クラス' },
                            { lastName: '田代', firstName: '杏奈', plan: '1クラス' },
                            { lastName: '唯野', firstName: '萌維', plan: '1クラス' }
                        ]},
                        { location: '天神', name: 'hiphop HIMEKA', color: 'purple', students: [
                            { lastName: '石原', firstName: '美黎', plan: '1クラス' },
                            { lastName: '中川', firstName: '凛音', plan: '２クラス' }
                        ]},
                        { location: '大橋', name: 'hiphop HIMEKA', color: 'purple', students: [
                            { lastName: '清水', firstName: 'くるみ', plan: '1クラス' }
                        ]}
                    ],
                    '火曜日': [
                        { location: '大橋', name: 'キッズダンス AYANO', color: 'red', students: [
                            { lastName: '古賀', firstName: '文人', plan: '1クラス' },
                            { lastName: '古賀', firstName: '卯月妃', plan: '1クラス' },
                            { lastName: '原口', firstName: '省吾', plan: '1クラス' },
                            { lastName: 'わたなべ', firstName: 'いとし', plan: '1クラス' },
                            { lastName: '富井', firstName: '藍', plan: '1クラス' }
                        ]},
                        { location: '大橋', name: 'Bgirlクラス AYANO HARUHIKO', color: 'orange', students: [
                            { lastName: '愛甲', firstName: '大輪', plan: '1クラス' }
                        ]},
                        { location: '照葉', name: 'ブレイキン入門 SOYA', color: 'blue', students: [
                            { lastName: '西園', firstName: '千晃', plan: '1クラス' },
                            { lastName: '榊', firstName: '花梨', plan: '２クラス' }
                        ]},
                        { location: '照葉', name: 'アクロ＆パワー SOYA', color: 'green', students: [
                            { lastName: '堤', firstName: '勇仁', plan: '1クラス' },
                            { lastName: '吉武', firstName: '凛保', plan: '３クラス' }
                        ]}
                    ],
                    '水曜日': [
                        { location: '天神', name: 'ブレイキン初級 HARUHIKO', color: 'red', students: [
                            { lastName: '田島', firstName: '渚', plan: '1クラス' },
                            { lastName: '吉田', firstName: '智幸', plan: '1クラス' },
                            { lastName: '本橋', firstName: '廉士', plan: '1クラス' },
                            { lastName: '酒井', firstName: '天優', plan: '1クラス' },
                            { lastName: '新藤', firstName: '大希', plan: '1クラス' },
                            { lastName: '荒巻', firstName: '大和', plan: '1クラス' },
                            { lastName: 'しん', firstName: 'よしと', plan: '1クラス' },
                            { lastName: '藤野', firstName: '蒼士', plan: '1クラス' }
                        ]},
                        { location: '天神', name: 'ブレイキン中上級 HARUHIKO', color: 'orange', students: [
                            { lastName: '森田', firstName: '翔真', plan: '1クラス' },
                            { lastName: '中山', firstName: '結愛', plan: '1クラス' },
                            { lastName: '', firstName: '大空', plan: '３クラス' },
                            { lastName: '迫田', firstName: 'りりあ', plan: '1クラス' }
                        ]}
                    ],
                    '木曜日': [
                        { location: '大橋', name: 'ブレイキン入門 SOYA', color: 'red', students: [
                            { lastName: '豊福', firstName: '悠成', plan: '1クラス' },
                            { lastName: '吉村', firstName: '太壱', plan: '２クラス' },
                            { lastName: '池田', firstName: '全', plan: '1クラス' },
                            { lastName: '澤江', firstName: '悠', plan: '1クラス' },
                            { lastName: '原口', firstName: '賢伸', plan: '２クラス' },
                            { lastName: '渡邉', firstName: '創太', plan: '２クラス' },
                            { lastName: '藤田', firstName: '将舞', plan: '２クラス' },
                            { lastName: '藤田', firstName: '凌羽', plan: '２クラス' },
                            { lastName: '小柳', firstName: '友陽', plan: '２クラス' },
                            { lastName: '山下', firstName: '幸四郎', plan: '1クラス' }
                        ]},
                        { location: '大橋', name: 'アクロ＆パワー SOYA', color: 'orange', students: [
                            { lastName: '中山', firstName: '結愛', plan: '２クラス' },
                            { lastName: '豊福', firstName: '悠成', plan: '２クラス' },
                            { lastName: '吉村', firstName: '太壱', plan: '２クラス' },
                            { lastName: '原口', firstName: '賢伸', plan: '２クラス' },
                            { lastName: '四井', firstName: '陽音', plan: '２クラス' },
                            { lastName: '渡邉', firstName: '創太', plan: '２クラス' },
                            { lastName: '萩原', firstName: '聖香', plan: '1クラス' },
                            { lastName: '小柳', firstName: '友陽', plan: '２クラス' },
                            { lastName: '澤江', firstName: '悠', plan: '1クラス' }
                        ]},
                        { location: '照葉', name: 'ブレイキン入門 リュウセイ', color: 'blue', students: [
                            { lastName: '楊', firstName: 'ビンチェンエイデン', plan: '２クラス' },
                            { lastName: '楊', firstName: 'エクソ', plan: '２クラス' },
                            { lastName: 'しぎょう', firstName: 'とうま', plan: '1クラス' },
                            { lastName: 'しぎょう', firstName: 'ゆうま', plan: '1クラス' },
                            { lastName: '梅野', firstName: '壮大', plan: '２クラス' },
                            { lastName: '梅野', firstName: '絢音', plan: '２クラス' },
                            { lastName: '長谷川', firstName: '丈', plan: '２クラス' }
                        ]},
                        { location: '照葉', name: 'アクロ＆パワー リュウセイ', color: 'green', students: [
                            { lastName: '吉武', firstName: '凛保', plan: '２クラス' },
                            { lastName: '楊', firstName: 'ビンチェンエイデン', plan: '２クラス' },
                            { lastName: '楊', firstName: 'エクソ', plan: '２クラス' },
                            { lastName: '工藤', firstName: '大地', plan: '２クラス' },
                            { lastName: '長谷川', firstName: '丈', plan: '２クラス' },
                            { lastName: '梅野', firstName: '壮大', plan: '２クラス' },
                            { lastName: '梅野', firstName: '絢音', plan: '２クラス' }
                        ]}
                    ],
                    '金曜日': [
                        { location: '天神', name: 'アクロ＆パワー SOYA', color: 'red', students: [
                            { lastName: '中島', firstName: '竜吾', plan: '３クラス' },
                            { lastName: '伊藤', firstName: '和馬', plan: '３クラス' },
                            { lastName: '藤野', firstName: '蒼士', plan: '1クラス' },
                            { lastName: '中山', firstName: '隼', plan: '1クラス' },
                            { lastName: '三重野', firstName: '琉生', plan: '３クラス' },
                            { lastName: 'よこやま', firstName: 'ゆめ', plan: '２クラス' }
                        ]},
                        { location: '天神', name: 'ブレイキン初中級 HARUHIKO', color: 'orange', students: [
                            { lastName: '中島', firstName: '竜吾', plan: '３クラス' },
                            { lastName: '三重野', firstName: '琉生', plan: '３クラス' },
                            { lastName: 'よこやま', firstName: 'ゆめ', plan: '２クラス' },
                            { lastName: '伊藤', firstName: '和馬', plan: '３クラス' }
                        ]},
                        { location: '大橋', name: 'ブレイキン入門 HARUHIKO', color: 'blue', students: [
                            { lastName: '萩尾', firstName: '郁海', plan: '２クラス' },
                            { lastName: '矢野', firstName: '新', plan: '1クラス' },
                            { lastName: '伊豆永', firstName: '晄逢', plan: '1クラス' },
                            { lastName: '藤川', firstName: '悠利', plan: '２クラス' },
                            { lastName: '藤川', firstName: '柊利', plan: '２クラス' },
                            { lastName: '三重野', firstName: 'かな', plan: '２クラス' },
                            { lastName: '久保田', firstName: '朱里', plan: '1クラス' },
                            { lastName: '古賀', firstName: '心太郎', plan: '1クラス' }
                        ]},
                        { location: '大橋', name: 'アクロ＆パワー ryusei', color: 'green', students: [
                            { lastName: '萩尾', firstName: '郁海', plan: '２クラス' },
                            { lastName: '藤川', firstName: '悠利', plan: '２クラス' },
                            { lastName: '藤川', firstName: '柊利', plan: '２クラス' },
                            { lastName: '三重野', firstName: 'かな', plan: '２クラス' },
                            { lastName: '児玉', firstName: '蛍斗', plan: '1クラス' }
                        ]}
                    ],
                    'イベント': []
                };

                // 講師プロフィールデータ
                this.instructorData = [
                    {
                        name: '邑本 康祐', stageName: 'Mottchmen', genre: "BREAKIN'", birthDate: '1975/3/31',
                        careerStart: '1997年よりブレイクダンスを中心にダンスを始める',
                        profile: '', message: '',
                        awards: ['2013年 UK bboy championships 九州予選 準優勝','2014年 UK bboy championships 九州予選 準優勝','2015年 WDC 九州大会 best4','2016年 UK bboy championships japan final best8','2017年 WDC 九州大会 best4','2018年 UK bboy championships japan final best4','2018年 Superman grand championships 準優勝','2019,2020年 PARTY×LINE crewbattle 優勝'],
                        otherExperience: ['SUNSET LIVE 2017,2018,2019','RHYMESTER BBOYイズム バックダンサーとして出演'],
                        lessons: ['K2JAM ダンススタジオ 2010年〜','スターリー69 ダンススタジオ 2021年9月〜']
                    },
                    {
                        name: '中島 春彦', stageName: 'HARUHIKO aka WATCHM3N', genre: "BREAKIN'", birthDate: '1982/03/10',
                        careerStart: '1999年よりダンス（ブレイキング）のキャリアスタート',
                        profile: '2000年からブレイキンのオリジナリティスタートし、ダンスバトルやショウケース、審査員などで九州内外で活動しています。',
                        message: 'ブレイキンは非常に運動量の多いダンスです。子供たちの身体能力、柔軟性、体幹を無理なく鍛え、挫折なく効率的に上達できるようなカリキュラムを組んでいます。',
                        awards: ['2005年 UK B-BOY CHAMPIONSHIPS JAPAN ELIMINATION 準優勝','2006年 UK B-BOY CHAMPIONSHIPS JAPAN ELIMINATION BEST4','2012年 Red Bull BC One japanfinal best4','2015年 World Dance Colosseum ワールドファイナル世界大会審査員','2018年 Red Bull BC One japanfinal best16','2020年 SUPER BREAK 世界大会審査員'],
                        otherExperience: ['JAPAN DANCE DELIGHT ファイナリスト','GARAND CHAMPION CARNIVAL ファイナリスト複数回','SUNSET LIVE 2017,2018,2019','RHYMESTER BBOYイズム バックダンサー','RHYMESTER 全国ツアー 福岡バックダンサー'],
                        lessons: ['FEELダンススタジオ 指導歴10年以上','スタジオMJ（世界No.1ブレイクダンサーISSEIを輩出したスタジオ）']
                    },
                    {
                        name: '甲斐 僧耶', stageName: 'SOYA', genre: 'アクロバット・ブレイキン', birthDate: '1995/11/22',
                        careerStart: '2012年よりブレイクダンスを中心にキャリアスタート',
                        profile: '小学生の頃、テレビ番組「スーパーチャンプル」を見てダンスに興味を持ち、高2年の冬に本格的にブレイクダンスを始めました。',
                        message: 'パワームーブやフリーズ、アクロバットも得意としています。生徒一人ひとりに合わせて指導し、楽しみながら本人の目標に向けてレベルアップしていくことを大切にしています。',
                        awards: ['2017年 SASEBO DANCE FES 特別賞STEEZ PRIZE','2018年 Kirafes Cup Battle Jam Vol.12 Breakin Side 優勝','2018年 GABANERO Vol.19 優勝','2019年 GABANEROVol.20 準優勝','2019年 UK九州予選 Best 4','2019年 GRAND CHAMPION CARNIVAL Free Style ファイナリスト','2020年 GABANERO Vol.22 優勝'],
                        otherExperience: ['TBS系列ナイナイお見合い大作戦in八女出演','Emotion rise kyushu支部 フラッシュモブ 元キャスト','RKBTV【チャギハ】Xperia商品PR ダンサー出演'],
                        lessons: ['TUDIO COLOR 2015〜2020','STUDIO TRAX 2015〜2018','FUNKFUNDANCECOMPANY 2015〜2022','SPROUT production 2019〜現在']
                    },
                    {
                        name: '伊藤 厚史', stageName: 'Ryce', genre: "BREAKIN'", birthDate: '1986/10/18',
                        careerStart: '2004年より中学の頃にブレイクダンスを始める',
                        profile: '福岡を拠点に九州をレベゼして活動しているBboy。',
                        message: '楽しみながら本人の目標に向けてレベルアップしていくことを大切にしています。',
                        awards: ['2007年 BIG WAX','2009年 Buzz Style','2011年 R-16 世界大会','2013年 UK bboy'],
                        otherExperience: ['オーストラリア・タイ・その他多数の海外経験'],
                        lessons: ['指導歴8年近く。福岡以外にも佐賀や熊本でもレッスン経験あり']
                    }
                ];

                // タイムスケジュールデータ
                this.timeScheduleData = {
                    '月曜日': [
                        { time: '18:00-19:00', venue: '天神校', name: 'アクロバット SOYA', color: '#DC2626' },
                        { time: '18:00-19:00', venue: '天神校', name: 'ブレイキン入門 SOYA', color: '#EA580C' },
                        { time: '19:00-20:00', venue: '天神校', name: 'hiphop HIMEKA', color: '#9333EA' },
                        { time: '20:00-21:00', venue: '天神校', name: 'K-POP AI', color: '#16A34A' },
                        { time: '19:00-20:00', venue: '大橋校', name: 'hiphop HIMEKA', color: '#9333EA' },
                        { time: '20:00-21:00', venue: '大橋校', name: 'トップロック フットワーク DAZ', color: '#2563EB' },
                        { time: '21:00-22:00', venue: '大橋校', name: '練習会', color: '#F59E0B' }
                    ],
                    '火曜日': [
                        { time: '16:50-17:50', venue: '大橋校', name: 'HIPHOP ヒメカ', color: '#DC2626' },
                        { time: '17:30-18:30', venue: '大橋校', name: 'キッズダンス AYANO', color: '#EA580C' },
                        { time: '18:40-19:40', venue: '大橋校', name: 'Bgirlクラス AYANO HARUHIKO', color: '#EA580C' },
                        { time: '19:00-20:00', venue: '照葉校', name: 'ブレイキン入門 SOYA', color: '#2563EB' },
                        { time: '20:00-21:00', venue: '照葉校', name: 'アクロ＆パワー SOYA', color: '#16A34A' }
                    ],
                    '水曜日': [
                        { time: '18:30-19:30', venue: '天神校', name: 'ブレイキン初級 HARUHIKO', color: '#DC2626' },
                        { time: '19:30-21:00', venue: '天神校', name: 'ブレイキン中上級 HARUHIKO', color: '#EA580C' }
                    ],
                    '木曜日': [
                        { time: '18:30-19:30', venue: '大橋校', name: 'ブレイキン入門 SOYA', color: '#DC2626' },
                        { time: '19:20-20:20', venue: '大橋校', name: 'アクロ＆パワー SOYA', color: '#EA580C' },
                        { time: '20:30-21:30', venue: '大橋校', name: 'パワームーブ＆アクロ SOYA', color: '#2563EB' },
                        { time: '18:30-19:30', venue: '照葉校', name: 'ブレイキン入門 リュウセイ', color: '#DC2626' },
                        { time: '19:30-20:30', venue: '照葉校', name: 'パワーアクロ リュウセイ', color: '#EA580C' },
                        { time: '21:30-23:10', venue: '照葉校', name: '練習会', color: '#F59E0B' }
                    ],
                    '金曜日': [
                        { time: '17:50-18:50', venue: '大橋校', name: 'ブレイキン入門 HARUHIKO', color: '#2563EB' },
                        { time: '19:00-20:00', venue: '天神校', name: 'アクロ＆パワー SOYA', color: '#DC2626' },
                        { time: '19:00-20:00', venue: '大橋校', name: 'パワーアクロ リュウセイ', color: '#EA580C' },
                        { time: '20:00-21:00', venue: '天神校', name: 'ブレイキン初中級 HARUHIKO', color: '#EA580C' },
                        { time: '20:00-21:00', venue: '大橋校', name: 'アクロ＆パワー ryusei', color: '#16A34A' }
                    ]
                };
            }
            getEmptyCustomer() {
                return {
                    memberNumber: '', status: '入会中', course: '', annualFee: '', hakomonoRegistration: '',
                    lastName: '', firstName: '', reading: '', guardianName: '', hakomonoName: '',
                    gender: '', birthDate: '', phone1: '', phone2: '', email: '',
                    postalCode: '', prefecture: '', city: '', address: '', building: '',
                    joinDate: '', memo: ''
                };
            }
            calculateAge(birthDate) {
                if (!birthDate) return '';
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age + '歳';
            }
            async init() {
                await this.loadCustomers();
                await this.loadScheduleData();
                await this.loadAttendance();
                await this.loadEventAttendance();
                
                // 全クラスの生徒をプラン順にソート
                Object.keys(this.scheduleData).forEach(day => {
                    this.scheduleData[day].forEach(classInfo => {
                        classInfo.students = this.sortStudentsByPlan(classInfo.students);
                    });
                });
                
                this.render();
            }
            async loadCustomers() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'customers'));
                    this.customers = querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            status: data.status || (data.active === '○' ? '入会中' : '休会中')
                        };
                    });
                    // クライアント側で会員番号順にソート
                    this.customers.sort((a, b) => {
                        const aNum = a.memberNumber || '';
                        const bNum = b.memberNumber || '';
                        return aNum > bNum ? 1 : -1;
                    });
                } catch (error) {
                    console.error('データ読み込みエラー:', error);
                    this.customers = [];
                }
            }
            async loadScheduleData() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'schedule'));
                    if (querySnapshot.empty) {
                        // Firestoreにデータがない場合は初期データを保存
                        console.log('スケジュールデータが見つかりません。初期データを保存します。');
                        await this.saveScheduleData();
                    } else {
                        // Firestoreからデータを読み込み
                        const loadedData = {};
                        querySnapshot.docs.forEach(doc => {
                            loadedData[doc.id] = doc.data().classes || [];
                        });
                        
                        // 読み込んだデータでscheduleDataを更新
                        if (Object.keys(loadedData).length > 0) {
                            this.scheduleData = loadedData;
                        }
                    }
                } catch (error) {
                    console.error('スケジュールデータ読み込みエラー:', error);
                    // エラーの場合は初期データを使用
                }
            }
            async saveScheduleData() {
                try {
                    // 各曜日のデータをFirestoreに保存
                    for (const day of Object.keys(this.scheduleData)) {
                        const docRef = doc(db, 'schedule', day);
                        await setDoc(docRef, {
                            classes: this.scheduleData[day]
                        });
                    }
                } catch (error) {
                    console.error('スケジュールデータ保存エラー:', error);
                }
            }
            async addCustomer() {
                if (!this.newCustomer.lastName || !this.newCustomer.firstName) {
                    alert('氏名を入力してください');
                    return;
                }
                if (!this.newCustomer.memberNumber) {
                    alert('会員番号を入力してください');
                    return;
                }
                try {
                    await addDoc(collection(db, 'customers'), this.newCustomer);
                    await this.loadCustomers();
                    this.newCustomer = this.getEmptyCustomer();
                    this.showAddForm = false;
                    this.render();
                    alert('登録しました');
                } catch (error) {
                    console.error('登録エラー:', error);
                    alert('登録エラー: ' + error.message);
                }
            }
            async saveEdit() {
                if (!this.editForm.id) {
                    alert('保存エラー: IDが見つかりません');
                    return;
                }
                try {
                    const customerRef = doc(db, 'customers', this.editForm.id);
                    const { id, ...dataToSave } = this.editForm;
                    await updateDoc(customerRef, dataToSave);
                    await this.loadCustomers();
                    this.editingId = null;
                    this.editForm = {};
                    this.render();
                    alert('更新しました');
                } catch (error) {
                    console.error('更新エラー:', error);
                    alert('更新エラー: ' + error.message);
                }
            }
            async deleteCustomer(id) {
                if (!confirm('この顧客を削除してもよろしいですか?')) return;
                try {
                    await deleteDoc(doc(db, 'customers', id));
                    await this.loadCustomers();
                    this.render();
                    alert('削除しました');
                } catch (error) {
                    console.error('削除エラー:', error);
                    alert('削除エラー: ' + error.message);
                }
            }
            startEdit(id) {
                this.editingId = id;
                const customer = this.customers.find(c => c.id === id);
                if (customer) {
                    this.editForm = { ...customer };
                    this.render();
                }
            }
            cancelEdit() {
                this.editingId = null;
                this.editForm = {};
                this.render();
            }
            updateEditField(field, value) {
                this.editForm[field] = value;
            }
            handleExport() {
                const headers = ['No', '会員番号', '会員ステータス', 'コース', '年会費更新日', '氏名', '読み', '保護者名', 'ハコモノ登録名', '性別', '生年月日', '年齢', '電話番号', 'メール', '入会日', '郵便番号', '都道府県', '市区町村', '番地', '建物・部屋番号', '備考'];
                const rows = this.customers.map((c, i) => [
                    i + 1, c.memberNumber || '', c.status, c.course, c.annualFee,
                    `${c.lastName} ${c.firstName}`, c.reading, c.guardianName, c.hakomonoName, c.gender,
                    c.birthDate, this.calculateAge(c.birthDate), c.phone1, c.email, c.joinDate,
                    c.postalCode, c.prefecture, c.city, c.address, c.building, c.memo
                ].map(f => `"${f || ''}"`).join(','));
                const csv = [headers.join(','), ...rows].join('\n');
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `顧客一覧_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }
            sortBy(field) {
                if (this.sortField === field) {
                    this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortField = field;
                    this.sortOrder = 'asc';
                }
                this.render();
            }
            getFilteredCustomers() {
                const s = this.searchTerm.toLowerCase();
                let filtered = this.customers.filter(c => 
                    c.status === this.statusFilter &&
                    ((c.lastName || '').toLowerCase().includes(s) ||
                    (c.firstName || '').toLowerCase().includes(s) ||
                    (c.reading || '').toLowerCase().includes(s) ||
                    (c.course || '').toLowerCase().includes(s) ||
                    (c.phone1 || '').includes(s) ||
                    (c.email || '').toLowerCase().includes(s) ||
                    (c.memberNumber || '').includes(s))
                );
                filtered.sort((a, b) => {
                    let aVal = a[this.sortField] || '';
                    let bVal = b[this.sortField] || '';
                    if (this.sortOrder === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
                return filtered;
            }
            render() {
                const filteredCustomers = this.getFilteredCustomers();
                document.getElementById('app').innerHTML = `
                    <div style="display:flex;">
                        <aside class="sidebar">
                            <div class="sidebar-logo">
                                <svg class="logo-image" viewBox="0 0 280 100" xmlns="http://www.w3.org/2000/svg"><text x="6" y="68" font-family="'Futura','Trebuchet MS','Arial Black',sans-serif" font-weight="900" font-size="76" fill="#e42313" letter-spacing="-2">posse</text><text x="8" y="93" font-family="'Futura','Trebuchet MS',Arial,sans-serif" font-weight="300" font-size="24" fill="rgba(255,255,255,0.85)" letter-spacing="5.5">dance academy</text></svg>
                            </div>
                            <nav>
                                <button id="homeTab" class="nav-item ${this.currentTab === 'home' ? 'active' : ''}">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                    <span>HOME</span>
                                </button>
                                <button id="customersTab" class="nav-item ${this.currentTab === 'customers' ? 'active' : ''}">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                                    <span>顧客一覧</span>
                                </button>
                                <button id="attendanceTab" class="nav-item ${this.currentTab === 'attendance' ? 'active' : ''}">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14l2 2 4-4"/></svg>
                                    <span>出席名簿</span>
                                </button>
                                <div class="nav-section-label">スケジュール</div>
                                <button id="timeScheduleTab" class="nav-item ${this.currentTab === 'timeSchedule' ? 'active' : ''}">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    <span>タイムスケジュール</span>
                                </button>
                                <button id="monthlyScheduleTab" class="nav-item ${this.currentTab === 'monthlySchedule' ? 'active' : ''}">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    <span>月間スケジュール</span>
                                </button>
                                <button id="instructorsTab" class="nav-item ${this.currentTab === 'instructors' ? 'active' : ''}">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4-4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                    <span>講師プロフィール</span>
                                </button>
                            </nav>
                        </aside>
                        <main class="main-content">
                            ${this.currentTab === 'home' ? this.renderDashboard() :
                              this.currentTab === 'customers' ? this.renderCustomers(filteredCustomers) :
                              this.currentTab === 'attendance' ? this.renderAttendance() :
                              this.currentTab === 'timeSchedule' ? this.renderTimeSchedule() :
                              this.currentTab === 'monthlySchedule' ? this.renderMonthlySchedule() :
                              this.currentTab === 'instructors' ? this.renderInstructors() :
                              this.renderDashboard()}
                        </main>
                    </div>
                `;
                document.getElementById('homeTab')?.addEventListener('click', () => { this.currentTab = 'home'; this.render(); });
                document.getElementById('customersTab')?.addEventListener('click', () => { this.currentTab = 'customers'; this.render(); });
                document.getElementById('attendanceTab')?.addEventListener('click', () => { this.currentTab = 'attendance'; this.render(); });
                document.getElementById('timeScheduleTab')?.addEventListener('click', () => { this.currentTab = 'timeSchedule'; this.render(); });
                document.getElementById('monthlyScheduleTab')?.addEventListener('click', () => { this.currentTab = 'monthlySchedule'; this.render(); });
                document.getElementById('instructorsTab')?.addEventListener('click', () => { this.currentTab = 'instructors'; this.render(); });
                if (this.currentTab === 'customers') {
                    this.setupCustomerPageEvents();
                } else if (this.currentTab === 'attendance') {
                    this.setupAttendanceEvents();
                }
            }
            setupCustomerPageEvents() {
                document.getElementById('exportBtn')?.addEventListener('click', () => this.handleExport());
                document.getElementById('toggleAddFormBtn')?.addEventListener('click', () => { this.showAddForm = !this.showAddForm; this.render(); });
                document.getElementById('searchInput')?.addEventListener('input', (e) => { this.searchTerm = e.target.value; this.render(); });
                document.getElementById('addCustomerBtn')?.addEventListener('click', () => this.addCustomer());
                document.getElementById('cancelAddBtn')?.addEventListener('click', () => { this.showAddForm = false; this.render(); });
                
                ['入会中', '休会中', '退会済み'].forEach(status => {
                    document.getElementById(`status-${status}`)?.addEventListener('click', () => {
                        this.statusFilter = status;
                        this.render();
                    });
                });
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', () => {
                        this.sortBy(header.getAttribute('data-field'));
                    });
                });
                this.setupFormEvents();
                this.setupEditEvents();
            }
            setupFormEvents() {
                const fields = ['memberNumber', 'status', 'course', 'annualFee', 'lastName', 'firstName', 'reading', 'guardianName', 'hakomonoName', 'gender', 'birthDate', 'phone1', 'email', 'postalCode', 'prefecture', 'city', 'address', 'building', 'joinDate', 'memo'];
                fields.forEach(field => {
                    const el = document.getElementById(`new_${field}`);
                    if (el) {
                        el.addEventListener('change', (e) => { this.newCustomer[field] = e.target.value; });
                        el.addEventListener('input', (e) => { this.newCustomer[field] = e.target.value; });
                    }
                });
            }
            setupEditEvents() {
                document.querySelectorAll('[data-edit-action="start"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.startEdit(btn.getAttribute('data-id'));
                    });
                });
                document.querySelectorAll('[data-edit-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.deleteCustomer(btn.getAttribute('data-id'));
                    });
                });
                document.getElementById('saveEditBtn')?.addEventListener('click', () => this.saveEdit());
                document.getElementById('cancelEditBtn')?.addEventListener('click', () => this.cancelEdit());
                const editFields = ['memberNumber', 'status', 'course', 'annualFee', 'reading', 'guardianName', 'hakomonoName', 'gender', 'birthDate', 'phone1', 'email', 'postalCode', 'prefecture', 'city', 'address', 'building', 'joinDate', 'memo'];
                editFields.forEach(field => {
                    const el = document.getElementById(`edit_${field}`);
                    if (el) {
                        el.addEventListener('change', (e) => { this.updateEditField(field, e.target.value); });
                        el.addEventListener('input', (e) => { this.updateEditField(field, e.target.value); });
                    }
                });
                const nameField = document.getElementById('edit_fullName');
                if (nameField) {
                    nameField.addEventListener('input', (e) => {
                        const parts = e.target.value.split(' ');
                        this.editForm.lastName = parts[0] || '';
                        this.editForm.firstName = parts[1] || '';
                    });
                }
            }
            renderDashboard() {
                const total = this.customers.length;
                const activeCount = this.customers.filter(c => c.status === '入会中').length;
                const pausedCount = this.customers.filter(c => c.status === '休会中').length;
                const withdrawnCount = this.customers.filter(c => c.status === '退会済み').length;

                const coursePrices = {
                    '１': 6000, '1': 6000,
                    '２': 10000, '2': 10000,
                    '３': 14400, '3': 14400,
                    '４': 18600, '4': 18600
                };
                const courseColors = { '４': '#5856d6', '4': '#5856d6', '３': '#0071e3', '3': '#0071e3', '２': '#34c759', '2': '#34c759', '１': '#ff9500', '1': '#ff9500' };

                const courseCounts = {};
                this.customers.filter(c => c.status === '入会中').forEach(c => {
                    if (c.course) courseCounts[c.course] = (courseCounts[c.course] || 0) + 1;
                });

                let totalRevenue = 0;
                Object.entries(courseCounts).forEach(([course, count]) => {
                    if (coursePrices[course]) totalRevenue += coursePrices[course] * count;
                });

                // ビジター売上計算
                let visitorVisits = 0;
                const currentMonth = this.selectedMonth || new Date().toISOString().slice(0, 7);
                const monthKey = currentMonth.replace('-', '');
                const visitorPlans = ['ビジター（会員）', 'ビジター（一般）', 'ビジター', 'ビジター(会員)', 'ビジター(一般)'];
                Object.keys(this.scheduleData || {}).forEach(day => {
                    if (day === 'イベント') return;
                    (this.scheduleData[day] || []).forEach(cls => {
                        (cls.students || []).forEach(s => {
                            if (visitorPlans.includes(s.plan)) {
                                const key = day + '_' + (cls.students.indexOf(s)) + '_' + s.lastName + '_' + s.firstName;
                                const att = this.attendanceData[key];
                                if (att) {
                                    Object.values(att).forEach(v => { if (v === '○') visitorVisits++; });
                                }
                            }
                        });
                    });
                });
                const visitorRevenue = this.calculateVisitorRevenue();

                // 総クラス数・総生徒数
                let totalClasses = 0;
                let totalStudents = 0;
                Object.keys(this.scheduleData || {}).forEach(day => {
                    if (day === 'イベント') return;
                    const classes = this.scheduleData[day] || [];
                    totalClasses += classes.length;
                    classes.forEach(cls => { totalStudents += (cls.students || []).length; });
                });

                const now = new Date();
                const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];

                return `
                    <div>
                        <div class="page-header">
                            <div>
                                <h2>HOME</h2>
                                <p class="subtitle">posse dance academy の概要</p>
                            </div>
                            <div class="date-badge">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                ${now.getFullYear()}年${monthNames[now.getMonth()]}
                            </div>
                        </div>

                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-icon blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                                </div>
                                <div class="stat-label">総顧客数</div>
                                <div class="stat-value">${total}<span class="stat-unit">名</span></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon green">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                </div>
                                <div class="stat-label">入会中</div>
                                <div class="stat-value" style="color:var(--green);">${activeCount}<span class="stat-unit">名</span></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon orange">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="10" y1="15" x2="10" y2="9"/><line x1="14" y1="15" x2="14" y2="9"/></svg>
                                </div>
                                <div class="stat-label">休会中</div>
                                <div class="stat-value" style="color:var(--orange);">${pausedCount}<span class="stat-unit">名</span></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon red">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                                </div>
                                <div class="stat-label">退会済み</div>
                                <div class="stat-value" style="color:var(--text-secondary);">${withdrawnCount}<span class="stat-unit">名</span></div>
                            </div>
                        </div>

                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-header">
                                    <h3 class="card-title">コース別内訳（入会中）</h3>
                                    <span class="card-action" onclick="app.currentTab='customers';app.render();">詳細 →</span>
                                </div>
                                ${Object.keys(courseCounts).length > 0 ?
                                    Object.entries(courseCounts).sort((a,b) => {
                                        const order = {'４':0,'4':0,'３':1,'3':1,'２':2,'2':2,'１':3,'1':3};
                                        return (order[a[0]]||9) - (order[b[0]]||9);
                                    }).map(([course, count]) => {
                                        const price = coursePrices[course] || 0;
                                        const subtotal = price * count;
                                        const color = courseColors[course] || 'var(--text-secondary)';
                                        return `
                                            <div class="revenue-row">
                                                <span class="rev-label"><span class="rev-dot" style="background:${color};"></span>コース ${course}</span>
                                                <div>
                                                    <div class="rev-amount">¥${subtotal.toLocaleString()}</div>
                                                    <div class="rev-detail">¥${price.toLocaleString()} × ${count}名</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')
                                : '<p style="color:var(--text-secondary);font-size:14px;">データがありません</p>'}
                                ${Object.keys(courseCounts).length > 0 ? `
                                    <div class="revenue-total">
                                        <span class="rev-label">月謝合計</span>
                                        <span class="rev-amount">¥${totalRevenue.toLocaleString()}</span>
                                    </div>
                                ` : ''}
                            </div>

                            <div>
                                <div class="visitor-highlight" style="margin-bottom:20px;">
                                    <div class="vh-label">ビジター売上（今月）</div>
                                    <div class="vh-value">¥${visitorRevenue.toLocaleString()}</div>
                                    <div class="vh-detail">ビジター・振替 合計</div>
                                </div>
                                <div class="content-card">
                                    <div class="card-header">
                                        <h3 class="card-title">今月の概要</h3>
                                    </div>
                                    <div class="revenue-row">
                                        <span class="rev-label">総クラス数</span>
                                        <span class="rev-amount">${totalClasses}</span>
                                    </div>
                                    <div class="revenue-row">
                                        <span class="rev-label">総生徒数（延べ）</span>
                                        <span class="rev-amount">${totalStudents}</span>
                                    </div>
                                    <div class="revenue-row">
                                        <span class="rev-label">練習会売上</span>
                                        <span class="rev-amount">¥0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            renderCustomers(filteredCustomers) {
                const getSortIcon = (field) => {
                    if (this.sortField === field) return this.sortOrder === 'asc' ? '▲' : '▼';
                    return '⬍';
                };
                return `
                    <div>
                        <div class="page-header">
                            <div>
                                <h2>顧客一覧</h2>
                                <p class="subtitle">会員情報の一覧と管理</p>
                            </div>
                            <div style="display:flex;gap:10px;">
                                <button id="exportBtn" class="btn btn-secondary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    CSV
                                </button>
                                <button id="toggleAddFormBtn" class="btn btn-primary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    ${this.showAddForm ? 'フォームを閉じる' : '新規登録'}
                                </button>
                            </div>
                        </div>

                        <div class="tab-nav">
                            <button id="status-入会中" class="tab-btn ${this.statusFilter === '入会中' ? 'active' : ''}">入会中 (${this.customers.filter(c => c.status === '入会中').length})</button>
                            <button id="status-休会中" class="tab-btn ${this.statusFilter === '休会中' ? 'active' : ''}">休会中 (${this.customers.filter(c => c.status === '休会中').length})</button>
                            <button id="status-退会済み" class="tab-btn ${this.statusFilter === '退会済み' ? 'active' : ''}">退会済み (${this.customers.filter(c => c.status === '退会済み').length})</button>
                        </div>

                        <div class="search-bar">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            <input type="text" id="searchInput" placeholder="会員番号、氏名、コース、電話番号、メールで検索..." value="${this.searchTerm}">
                        </div>

                        ${this.showAddForm ? this.renderAddForm() : ''}
                        <div class="content-card" style="padding:0;overflow:hidden;">
                            <div style="overflow-x:auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width:50px;padding-left:20px;">No</th>
                                            <th class="sortable-header" data-field="memberNumber" style="width:80px;">会員番号<span class="sort-icon">${getSortIcon('memberNumber')}</span></th>
                                            <th class="sortable-header" data-field="status" style="width:100px;">ステータス<span class="sort-icon">${getSortIcon('status')}</span></th>
                                            <th class="sortable-header" data-field="course" style="width:80px;">コース<span class="sort-icon">${getSortIcon('course')}</span></th>
                                            <th class="sortable-header" data-field="annualFee" style="width:110px;">年会費更新日<span class="sort-icon">${getSortIcon('annualFee')}</span></th>
                                            <th class="sortable-header" data-field="lastName" style="width:140px;">氏名<span class="sort-icon">${getSortIcon('lastName')}</span></th>
                                            <th class="sortable-header" data-field="reading" style="width:140px;">読み<span class="sort-icon">${getSortIcon('reading')}</span></th>
                                            <th class="sortable-header" data-field="guardianName" style="width:110px;">保護者名<span class="sort-icon">${getSortIcon('guardianName')}</span></th>
                                            <th class="sortable-header" data-field="hakomonoName" style="width:110px;">ハコモノ登録名<span class="sort-icon">${getSortIcon('hakomonoName')}</span></th>
                                            <th class="sortable-header" data-field="gender" style="width:60px;">性別<span class="sort-icon">${getSortIcon('gender')}</span></th>
                                            <th class="sortable-header" data-field="birthDate" style="width:110px;">生年月日<span class="sort-icon">${getSortIcon('birthDate')}</span></th>
                                            <th style="width:60px;">年齢</th>
                                            <th class="sortable-header" data-field="phone1" style="width:130px;">電話番号<span class="sort-icon">${getSortIcon('phone1')}</span></th>
                                            <th class="sortable-header" data-field="email" style="width:200px;">メール<span class="sort-icon">${getSortIcon('email')}</span></th>
                                            <th class="sortable-header" data-field="joinDate" style="width:110px;">入会日<span class="sort-icon">${getSortIcon('joinDate')}</span></th>
                                            <th class="sortable-header" data-field="postalCode" style="width:100px;">郵便番号<span class="sort-icon">${getSortIcon('postalCode')}</span></th>
                                            <th class="sortable-header" data-field="prefecture" style="width:90px;">都道府県<span class="sort-icon">${getSortIcon('prefecture')}</span></th>
                                            <th class="sortable-header" data-field="city" style="width:110px;">市区町村<span class="sort-icon">${getSortIcon('city')}</span></th>
                                            <th class="sortable-header" data-field="address" style="width:140px;">番地<span class="sort-icon">${getSortIcon('address')}</span></th>
                                            <th class="sortable-header" data-field="building" style="width:140px;">建物・部屋番号<span class="sort-icon">${getSortIcon('building')}</span></th>
                                            <th style="width:300px;">備考</th>
                                            <th style="width:100px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredCustomers.map((c, i) => this.renderCustomerRow(c, i + 1)).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div style="padding:16px 24px;font-size:13px;color:var(--text-secondary);border-top:1px solid var(--border);">
                                ${this.statusFilter}: ${filteredCustomers.length}名
                            </div>
                        </div>
                    </div>
                `;
            }
            renderAddForm() {
                return `
                    <div class="content-card" style="margin-bottom:24px;background:rgba(0,113,227,0.03);border:2px solid rgba(0,113,227,0.1);">
                        <div class="card-header">
                            <h3 class="card-title">新規顧客登録</h3>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px;">
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">会員番号 *</label><input type="text" id="new_memberNumber" class="form-input" style="width:100%;" placeholder="例: 0001"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">会員ステータス</label><select id="new_status" class="form-input" style="width:100%;"><option value="入会中">入会中</option><option value="休会中">休会中</option><option value="退会済み">退会済み</option></select></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">コース</label><select id="new_course" class="form-input" style="width:100%;"><option value="">選択してください</option><option value="ビジター">ビジター</option><option value="１">１</option><option value="２">２</option><option value="３">３</option><option value="４">４</option></select></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">年会費更新日</label><input type="date" id="new_annualFee" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">氏名(姓) *</label><input type="text" id="new_lastName" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">氏名(名) *</label><input type="text" id="new_firstName" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">読み</label><input type="text" id="new_reading" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">保護者名</label><input type="text" id="new_guardianName" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">ハコモノ登録名</label><input type="text" id="new_hakomonoName" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">性別</label><select id="new_gender" class="form-input" style="width:100%;"><option value="">選択</option><option value="男">男</option><option value="女">女</option></select></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">生年月日</label><input type="date" id="new_birthDate" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">電話番号</label><input type="tel" id="new_phone1" class="form-input" style="width:100%;"></div>
                            <div style="grid-column:span 2;"><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">メール</label><input type="email" id="new_email" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">入会日</label><input type="date" id="new_joinDate" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">郵便番号</label><input type="text" id="new_postalCode" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">都道府県</label><input type="text" id="new_prefecture" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">市区町村</label><input type="text" id="new_city" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">番地</label><input type="text" id="new_address" class="form-input" style="width:100%;"></div>
                            <div><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">建物・部屋番号</label><input type="text" id="new_building" class="form-input" style="width:100%;"></div>
                            <div style="grid-column:span 3;"><label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.3px;">備考</label><input type="text" id="new_memo" class="form-input" style="width:100%;"></div>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button id="addCustomerBtn" class="btn btn-primary">登録</button>
                            <button id="cancelAddBtn" class="btn btn-secondary">キャンセル</button>
                        </div>
                    </div>
                `;
            }
            renderCustomerRow(customer, no) {
                const statusBadgeClass = customer.status === '入会中' ? 'status-badge-active' : customer.status === '休会中' ? 'status-badge-paused' : 'status-badge-withdrawn';
                const genderClass = customer.gender === '男' ? 'gender-male' : customer.gender === '女' ? 'gender-female' : '';
                const age = this.calculateAge(customer.birthDate);
                
                if (this.editingId === customer.id) {
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-2 py-3">${no}</td>
                            <td class="px-2 py-3"><input type="text" id="edit_memberNumber" value="${this.editForm.memberNumber || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><select id="edit_status" class="w-full border rounded px-1 py-1 text-xs"><option value="入会中" ${this.editForm.status === '入会中' ? 'selected' : ''}>入会中</option><option value="休会中" ${this.editForm.status === '休会中' ? 'selected' : ''}>休会中</option><option value="退会済み" ${this.editForm.status === '退会済み' ? 'selected' : ''}>退会済み</option></select></td>
                            <td class="px-2 py-3"><select id="edit_course" class="w-full border rounded px-1 py-1 text-xs"><option value="">選択</option><option value="ビジター" ${this.editForm.course === 'ビジター' ? 'selected' : ''}>ビジター</option><option value="１" ${this.editForm.course === '１' ? 'selected' : ''}>１</option><option value="２" ${this.editForm.course === '２' ? 'selected' : ''}>２</option><option value="３" ${this.editForm.course === '３' ? 'selected' : ''}>３</option><option value="４" ${this.editForm.course === '４' ? 'selected' : ''}>４</option></select></td>
                            <td class="px-2 py-3"><input type="date" id="edit_annualFee" value="${this.editForm.annualFee || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_fullName" value="${this.editForm.lastName || ''} ${this.editForm.firstName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_reading" value="${this.editForm.reading || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_guardianName" value="${this.editForm.guardianName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_hakomonoName" value="${this.editForm.hakomonoName || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><select id="edit_gender" class="w-full border rounded px-1 py-1 text-xs"><option value="">-</option><option value="男" ${this.editForm.gender === '男' ? 'selected' : ''}>男</option><option value="女" ${this.editForm.gender === '女' ? 'selected' : ''}>女</option></select></td>
                            <td class="px-2 py-3"><input type="date" id="edit_birthDate" value="${this.editForm.birthDate || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3 text-center">${this.calculateAge(this.editForm.birthDate)}</td>
                            <td class="px-2 py-3"><input type="tel" id="edit_phone1" value="${this.editForm.phone1 || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="email" id="edit_email" value="${this.editForm.email || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="date" id="edit_joinDate" value="${this.editForm.joinDate || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_postalCode" value="${this.editForm.postalCode || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_prefecture" value="${this.editForm.prefecture || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_city" value="${this.editForm.city || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_address" value="${this.editForm.address || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3"><input type="text" id="edit_building" value="${this.editForm.building || ''}" class="w-full border rounded px-1 py-1 text-xs" /></td>
                            <td class="px-2 py-3 memo-cell"><textarea id="edit_memo" class="w-full border rounded px-1 py-1 text-xs" rows="2">${this.editForm.memo || ''}</textarea></td>
                            <td class="px-2 py-3"><div class="flex flex-col gap-1"><button id="saveEditBtn" class="text-green-600 hover:text-green-800 text-xs">保存</button><button id="cancelEditBtn" class="text-gray-600 hover:text-gray-800 text-xs">キャンセル</button><button data-edit-action="delete" data-id="${customer.id}" class="text-red-600 hover:text-red-800 text-xs">削除</button></div></td>
                        </tr>
                    `;
                }
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-2 py-3">${no}</td>
                        <td class="px-2 py-3 font-mono">${customer.memberNumber || ''}</td>
                        <td class="px-2 py-3"><span class="px-2 py-1 rounded text-xs font-semibold ${statusBadgeClass}">${customer.status || ''}</span></td>
                        <td class="px-2 py-3">${customer.course || ''}</td>
                        <td class="px-2 py-3">${customer.annualFee || ''}</td>
                        <td class="px-2 py-3 font-medium">${customer.lastName || ''} ${customer.firstName || ''}</td>
                        <td class="px-2 py-3">${customer.reading || ''}</td>
                        <td class="px-2 py-3">${customer.guardianName || ''}</td>
                        <td class="px-2 py-3">${customer.hakomonoName || ''}</td>
                        <td class="px-2 py-3 text-center ${genderClass}">${customer.gender || ''}</td>
                        <td class="px-2 py-3">${customer.birthDate || ''}</td>
                        <td class="px-2 py-3 text-center">${age}</td>
                        <td class="px-2 py-3">${customer.phone1 || ''}</td>
                        <td class="px-2 py-3 email-cell">${customer.email || ''}</td>
                        <td class="px-2 py-3">${customer.joinDate || ''}</td>
                        <td class="px-2 py-3">${customer.postalCode || ''}</td>
                        <td class="px-2 py-3">${customer.prefecture || ''}</td>
                        <td class="px-2 py-3">${customer.city || ''}</td>
                        <td class="px-2 py-3">${customer.address || ''}</td>
                        <td class="px-2 py-3">${customer.building || ''}</td>
                        <td class="px-2 py-3 memo-cell">${customer.memo || ''}</td>
                        <td class="px-2 py-3"><button data-edit-action="start" data-id="${customer.id}" class="text-blue-600 hover:text-blue-800 text-xs">編集</button></td>
                    </tr>
                `;
            }
            sortStudentsByPlan(students) {
                return students.sort((a, b) => {
                    // プラン名を正規化（全角数字を半角に変換）
                    const normalizePlan = (plan) => {
                        return plan.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                    };
                    
                    const planA = normalizePlan(a.plan);
                    const planB = normalizePlan(b.plan);
                    
                    const orderA = this.planOrder[planA] || 999;
                    const orderB = this.planOrder[planB] || 999;
                    return orderA - orderB;
                });
            }
            // 月謝プラン（毎月引き継ぐ）かどうかを判定
            isRegularPlan(plan) {
                const regularPlans = ['1クラス', '１クラス', '2クラス', '２クラス', '3クラス', '３クラス', '4クラス', '４クラス', '1.5hクラス'];
                return regularPlans.includes(plan);
            }
            // 選択された顧客情報の表示のみを更新
            updateSelectedCustomerInfo() {
                const selectedInfoContainer = document.getElementById('selectedCustomerInfo');
                const planSelect = document.getElementById('new_student_plan');
                const nameInputContainer = document.getElementById('nameInputContainer');
                const planSelectContainer = document.getElementById('planSelectContainer');
                
                if (!selectedInfoContainer) return;
                
                if (this.selectedCustomerForStudent) {
                    selectedInfoContainer.innerHTML = `
                        <div class="mb-3 p-3 bg-green-50 border-2 border-green-400 rounded text-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold text-green-800">✓ 選択中: ${this.selectedCustomerForStudent.lastName} ${this.selectedCustomerForStudent.firstName}</div>
                                    <div class="text-xs text-gray-700 mt-1">
                                        ${this.selectedCustomerForStudent.memberNumber ? `会員番号: ${this.selectedCustomerForStudent.memberNumber} | ` : ''}
                                        ${this.selectedCustomerForStudent.reading ? `読み: ${this.selectedCustomerForStudent.reading} | ` : ''}
                                        コース: ${this.selectedCustomerForStudent.course || 'なし'}
                                    </div>
                                </div>
                                <button 
                                    id="clearSelectedCustomer"
                                    class="text-red-600 hover:text-red-800 text-xs underline">
                                    選択解除
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // 姓名入力欄を非表示
                    if (nameInputContainer) {
                        nameInputContainer.classList.add('hidden');
                        nameInputContainer.classList.remove('col-span-2', 'grid', 'grid-cols-2', 'gap-3');
                    }
                    
                    // プランセレクトのスタイルを調整
                    if (planSelectContainer) {
                        planSelectContainer.classList.add('col-span-3');
                    }
                    
                    // 選択解除ボタンのイベントを再設定
                    document.getElementById('clearSelectedCustomer')?.addEventListener('click', () => {
                        this.selectedCustomerForStudent = null;
                        this.studentSearchTerm = '';
                        this.studentSearchResults = [];
                        this.updateSelectedCustomerInfo();
                        // 検索入力欄をクリア
                        const searchInput = document.getElementById('student_search_input');
                        if (searchInput) searchInput.value = '';
                        // 検索結果をクリア
                        this.updateSearchResults();
                        // プランをリセット
                        if (planSelect) planSelect.value = '';
                    });
                    
                    // プランを自動設定
                    if (planSelect && this.selectedCustomerForStudent.course) {
                        const courseMap = {'１': '１クラス', '２': '２クラス', '３': '３クラス', '４': '４クラス'};
                        const planValue = courseMap[this.selectedCustomerForStudent.course] || '';
                        if (planValue) planSelect.value = planValue;
                    }
                } else {
                    selectedInfoContainer.innerHTML = '';
                    
                    // 姓名入力欄を表示
                    if (nameInputContainer) {
                        nameInputContainer.classList.remove('hidden');
                        nameInputContainer.classList.add('col-span-2', 'grid', 'grid-cols-2', 'gap-3');
                    }
                    
                    // プランセレクトのスタイルを元に戻す
                    if (planSelectContainer) {
                        planSelectContainer.classList.remove('col-span-3');
                    }
                }
            }
            // 検索結果のみを更新（フォーカスを維持）
            updateSearchResults() {
                const resultsContainer = document.getElementById('searchResultsContainer');
                if (!resultsContainer) return;
                if (this.studentSearchResults.length > 0) {
                    resultsContainer.innerHTML = `
                        <div class="mt-2 border rounded bg-white student-search-results shadow-lg">
                            ${this.studentSearchResults.map(customer => `
                                <div 
                                    data-select-customer-id="${customer.id}"
                                    class="select-customer-btn p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm transition">
                                    <div class="font-medium text-blue-600">
                                        ${customer.lastName} ${customer.firstName}
                                        ${customer.memberNumber ? `<span class="text-xs text-gray-500 ml-2">[${customer.memberNumber}]</span>` : ''}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        ${customer.reading ? `読み: ${customer.reading}` : ''}
                                        ${customer.reading && customer.course ? ' | ' : ''}
                                        ${customer.course ? `コース: ${customer.course}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // 検索結果のクリックイベントを再設定
                    resultsContainer.querySelectorAll('.select-customer-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const customerId = btn.getAttribute('data-select-customer-id');
                            const customer = this.customers.find(c => c.id === customerId);
                            if (customer) {
                                this.selectCustomerForStudent(customer);
                            }
                        });
                    });
                } else if (this.studentSearchTerm.trim()) {
                    resultsContainer.innerHTML = `
                        <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                            ⚠️ 該当する顧客が見つかりませんでした
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '';
                }
            }
            // ひらがな→カタカナ変換
            hiraganaToKatakana(str) {
                return str.replace(/[\u3041-\u3096]/g, (match) => {
                    const chr = match.charCodeAt(0) + 0x60;
                    return String.fromCharCode(chr);
                });
            }
            // カタカナ→ひらがな変換
            katakanaToHiragana(str) {
                return str.replace(/[\u30a1-\u30f6]/g, (match) => {
                    const chr = match.charCodeAt(0) - 0x60;
                    return String.fromCharCode(chr);
                });
            }
            // 顧客検索機能（強化版）
            searchCustomerByName(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                if (!term) {
                    return [];
                }
                
                // ひらがな・カタカナ両方で検索できるように
                const termHiragana = this.katakanaToHiragana(term);
                const termKatakana = this.hiraganaToKatakana(term);
                
                return this.customers.filter(c => {
                    // 氏名（姓名別々・フルネーム）
                    const lastName = (c.lastName || '').toLowerCase();
                    const firstName = (c.firstName || '').toLowerCase();
                    const fullName = `${lastName}${firstName}`;
                    const fullNameWithSpace = `${lastName} ${firstName}`;
                    
                    // 読み（ひらがな・カタカナ両対応）
                    const reading = (c.reading || '').toLowerCase();
                    const readingHiragana = this.katakanaToHiragana(reading);
                    const readingKatakana = this.hiraganaToKatakana(reading);
                    
                    // 会員番号
                    const memberNumber = (c.memberNumber || '').toLowerCase();
                    
                    // 複数の条件で検索
                    return lastName.includes(term) ||
                           firstName.includes(term) ||
                           fullName.includes(term) ||
                           fullNameWithSpace.includes(term) ||
                           reading.includes(term) ||
                           reading.includes(termHiragana) ||
                           reading.includes(termKatakana) ||
                           readingHiragana.includes(term) ||
                           readingHiragana.includes(termHiragana) ||
                           readingKatakana.includes(term) ||
                           readingKatakana.includes(termKatakana) ||
                           memberNumber.includes(term);
                }).slice(0, 10); // 最大10件まで表示
            }
            // 顧客を選択して生徒情報を自動入力
            selectCustomerForStudent(customer) {
                this.selectedCustomerForStudent = customer;
                this.studentSearchResults = [];
                this.studentSearchTerm = `${customer.lastName} ${customer.firstName}`;
                
                // 検索入力欄を更新
                const searchInput = document.getElementById('student_search_input');
                if (searchInput) {
                    searchInput.value = this.studentSearchTerm;
                }
                
                // 検索結果をクリア
                this.updateSearchResults();
                
                // 選択された顧客情報を表示
                this.updateSelectedCustomerInfo();
            }
            async addStudentToClass(day, location, className) {
                this.selectedClassForAdd = { day, location, className };
                this.showAddStudentForm = true;
                this.selectedCustomerForStudent = null;
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.render();
            }
            async saveNewStudent() {
                let lastName, firstName, plan;
                
                // 顧客が選択されている場合
                if (this.selectedCustomerForStudent) {
                    lastName = this.selectedCustomerForStudent.lastName;
                    firstName = this.selectedCustomerForStudent.firstName;
                    plan = document.getElementById('new_student_plan')?.value || '';
                } else {
                    lastName = document.getElementById('new_student_lastName')?.value || '';
                    firstName = document.getElementById('new_student_firstName')?.value || '';
                    plan = document.getElementById('new_student_plan')?.value || '';
                }
                if (!lastName || !firstName || !plan) {
                    alert('姓名とプランを入力してください');
                    return;
                }
                const { day, location, className } = this.selectedClassForAdd;
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);

                if (classIndex !== -1) {
                    // 既にスケジュールに存在するかチェック
                    const exists = this.scheduleData[day][classIndex].students.some(
                        s => s.lastName === lastName && s.firstName === firstName
                    );

                    if (!exists) {
                        // 新規追加
                        this.scheduleData[day][classIndex].students.push({ lastName, firstName, plan });
                        this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(this.scheduleData[day][classIndex].students);
                        await this.saveScheduleData();
                    }

                    // ビジター等の非月謝プランの場合、当月の出席データにプレースホルダーを作成して表示されるようにする
                    if (!this.isRegularPlan(plan)) {
                        const studentKey = `${day}_${location}_${className}_${lastName}${firstName}`;
                        if (!this.attendanceData[studentKey]) {
                            this.attendanceData[studentKey] = {};
                            // Firestoreにも保存して永続化
                            await this.saveAttendance(studentKey, { _active: true });
                        }
                    }
                }
                this.showAddStudentForm = false;
                this.selectedClassForAdd = null;
                this.selectedCustomerForStudent = null;
                this.studentSearchTerm = '';
                this.studentSearchResults = [];
                this.render();
                alert('生徒を追加しました');
            }
            // 生徒の編集を開始
            startEditStudent(day, location, className, lastName, firstName) {
                this.editingStudent = { day, location, className, lastName, firstName };
                this.render();
            }
            // 生徒情報の保存
            async saveEditStudent() {
                const newPlan = document.getElementById('edit_student_plan')?.value;
                if (!newPlan) {
                    alert('プランを選択してください');
                    return;
                }
                const { day, location, className, lastName, firstName } = this.editingStudent;
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    const studentIndex = this.scheduleData[day][classIndex].students.findIndex(
                        s => s.lastName === lastName && s.firstName === firstName
                    );
                    
                    if (studentIndex !== -1) {
                        this.scheduleData[day][classIndex].students[studentIndex].plan = newPlan;
                        this.scheduleData[day][classIndex].students = this.sortStudentsByPlan(this.scheduleData[day][classIndex].students);
                        
                        // Firestoreに保存
                        await this.saveScheduleData();
                    }
                }
                // attendanceDataにもプランを保存（出席データのみの生徒でも確実に反映）
                const studentKey = `${day}_${location}_${className}_${lastName}${firstName}`;
                if (!this.attendanceData[studentKey]) {
                    this.attendanceData[studentKey] = {};
                }
                this.attendanceData[studentKey]._plan = newPlan;
                await this.saveAttendance(studentKey, this.attendanceData[studentKey]);
                this.editingStudent = null;
                this.render();
                alert('生徒情報を更新しました');
            }
            // 生徒の削除
            async deleteStudent(day, location, className, lastName, firstName) {
                if (!confirm(`${lastName} ${firstName} を削除してもよろしいですか？`)) {
                    return;
                }
                const classIndex = this.scheduleData[day].findIndex(c => c.location === location && c.name === className);
                
                if (classIndex !== -1) {
                    this.scheduleData[day][classIndex].students = this.scheduleData[day][classIndex].students.filter(
                        s => !(s.lastName === lastName && s.firstName === firstName)
                    );
                    
                    // Firestoreに保存
                    await this.saveScheduleData();
                }
                // 出席データも削除
                const studentKey = `${day}_${location}_${className}_${lastName}${firstName}`;
                const monthKey = this.selectedMonth.replace('-', '');
                try {
                    await deleteDoc(doc(db, `attendance_${monthKey}`, studentKey));
                } catch (error) {
                    console.log('出席データの削除エラー（データが存在しない可能性があります）');
                }
                await this.loadAttendance();
                this.render();
                alert('生徒を削除しました');
            }
            calculateVisitorRevenue() {
            const _ovr=this.visitorRevenueOverrides?.[(this.selectedMonth||'').replace(/-/g,'')]; if(_ovr) return _ovr.total;
                let revenue = 0;
                const monthKey = this.selectedMonth.replace('-', '');
                
                Object.keys(this.attendanceData).forEach(key => {
                    const attendance = this.attendanceData[key];
                    const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                    
                    weeks.forEach(week => {
                        if (attendance[week] === '○') {
                            // keyからプラン情報を取得する必要があるため、scheduleDataから検索
                            const parts = key.split('_');
                            const day = parts[0];
                            const location = parts[1];
                            const className = parts[2];
                            const studentName = parts.slice(3).join('_');
                            
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            const student = classData?.students.find(s => `${s.lastName}${s.firstName}` === studentName);
                            
                            // ビジター、体験、無料プランのみ売上に計上
                            if (student && (student.plan.includes('ビジター') || student.plan.includes('体験') || student.plan.includes('無料'))) {
                                if (this.pricing[student.plan]) {
                                    revenue += this.pricing[student.plan];
                                }
                            } else if (!student) {
                                const attPlan = attendance._plan;
                                const _isVT=attPlan&&(attPlan.includes('ビジター')||attPlan.includes('体験')||attPlan.includes('無料')||attPlan==='月謝クラス振替'||attPlan==='練習会');
                        if (_isVT && this.pricing[attPlan]) {
                            revenue += this.pricing[attPlan];
                        } else if (!attPlan) {
                                const pMap = {'初回体験':'初回体験','初回無料':'初回無料','ビジター会員':'ビジター（会員）','ビジター非会員':'ビジター（非会員）','ビジター1.5h会員':'ビジター1.5h（会員）','ビジター1.5h非会員':'ビジター1.5h（非会員）','ビジター（会員）':'ビジター（会員）','ビジター（非会員）':'ビジター（非会員）','月謝クラス振替':'月謝クラス振替'};
                                const plan = pMap[studentName];
                    if (plan && this.pricing[plan]) { revenue += this.pricing[plan]; }
                    else if (!plan && studentName) { let _m=false;['月曜日','火曜日','水曜日','木曜日','金曜日'].forEach(d=>{const dd=this.scheduleData?.[d];if(dd)Object.values(dd).forEach(c=>{if(c.students?.some(s=>(s.lastName+(s.firstName||'')).trim()===studentName))_m=true})}); revenue += _m ? (this.pricing['月謝クラス振替']||1000) : (this.pricing['ビジター（会員）']||2000); }
                                }
                            }
                        }
                    });
                });
                
                return revenue;
            }
            // 練習会の売上計算
            calculatePracticeRevenue() {
                let totalParticipants = 0;
                const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                const details = {};
                ['月曜日', '木曜日'].forEach(day => {
                    const key = `練習会_${day}`;
                    const data = this.attendanceData[key];
                    let dayTotal = 0;
                    if (data) {
                        weeks.forEach(week => {
                            const count = parseInt(data[week]) || 0;
                            dayTotal += count;
                        });
                    }
                    details[day] = dayTotal;
                    totalParticipants += dayTotal;
                });
                return { participants: totalParticipants, revenue: totalParticipants * 500, details };
            }
            // 詳細売上計算（全カテゴリ別）
            calculateDetailedRevenue() {
            const _ovr=this.visitorRevenueOverrides?.[(this.selectedMonth||'').replace(/-/g,'')]; if(_ovr){const r={};['練習会','ビジター（会員）','ビジター（非会員）','ビジター1.5h（会員）','ビジター1.5h（非会員）','月謝クラス振替','初回体験','初回無料'].forEach(k=>r[k]={count:0,revenue:0}); if(_ovr.visitor>0) r['ビジター（会員）']={count:Math.round(_ovr.visitor/2000),revenue:_ovr.visitor}; if(_ovr.trial>0) r['初回体験']={count:Math.round(_ovr.trial/1000),revenue:_ovr.trial}; return r;}
                const categories = {
                    '練習会': { count: 0, revenue: 0 },
                    'ビジター（会員）': { count: 0, revenue: 0 },
                    'ビジター（非会員）': { count: 0, revenue: 0 },
                    'ビジター1.5h（会員）': { count: 0, revenue: 0 },
                    'ビジター1.5h（非会員）': { count: 0, revenue: 0 },
                    '月謝クラス振替': { count: 0, revenue: 0 },
                    '初回体験': { count: 0, revenue: 0 },
                    '初回無料': { count: 0, revenue: 0 }
                };
                // 練習会
                const practice = this.calculatePracticeRevenue();
                categories['練習会'] = { count: practice.participants, revenue: practice.revenue };
                // ビジター・体験系
                const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                Object.keys(this.attendanceData).forEach(key => {
                    if (key.startsWith('練習会_')) return; // 練習会は別処理済み
                    const attendance = this.attendanceData[key];
                    weeks.forEach(week => {
                        if (attendance[week] === '○') {
                            const parts = key.split('_');
                            const day = parts[0];
                            const location = parts[1];
                            const className = parts[2];
                            const studentName = parts.slice(3).join('_');
                            const classData = this.scheduleData[day]?.find(c => c.location === location && c.name === className);
                            const student = classData?.students.find(s => `${s.lastName}${s.firstName}` === studentName);
                            let plan = student?.plan;
                            if (!plan) {
                                plan = attendance._plan;
                            }
                            if (!plan) {
                                const pMap = {'初回体験':'初回体験','初回無料':'初回無料','ビジター会員':'ビジター（会員）','ビジター非会員':'ビジター（非会員）','ビジター1.5h会員':'ビジター1.5h（会員）','ビジター1.5h非会員':'ビジター1.5h（非会員）','ビジター（会員）':'ビジター（会員）','ビジター（非会員）':'ビジター（非会員）','月謝クラス振替':'月謝クラス振替'};
                                plan = pMap[studentName] || (()=>{let _m2=false;['月曜日','火曜日','水曜日','木曜日','金曜日'].forEach(d=>{const dd=this.scheduleData?.[d];if(dd)Object.values(dd).forEach(c=>{if(c.students?.some(s=>(s.lastName+(s.firstName||'')).trim()===studentName))_m2=true})});return _m2?'月謝クラス振替':'ビジター（会員）';})();
                            }
                            if (plan && categories[plan] !== undefined) {
                                const price = this.pricing[plan] || 0;
                                categories[plan].count++;
                                categories[plan].revenue += price;
                            }
                        }
                    });
                });
                return categories;
            }
            // 出席簿関連のメソッド
            async loadAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const querySnapshot = await getDocs(collection(db, `attendance_${monthKey}`));
                    this.attendanceData = {};
                    querySnapshot.docs.forEach(doc => {
                        this.attendanceData[doc.id] = doc.data();
                    });
                } catch (error) {
                    console.error('出席データ読み込みエラー:', error);
                    this.attendanceData = {};
                }
            }
            // イベント専用の出席データ読み込み
            async loadEventAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const querySnapshot = await getDocs(collection(db, `event_attendance_${monthKey}`));
                    this.eventAttendanceData = [];
                    querySnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        this.eventAttendanceData.push({
                            id: doc.id,
                            isMember: data.isMember || false,
                            ...data
                        });
                    });
                    // 並び順を保持するため、indexでソート
                    this.eventAttendanceData.sort((a, b) => (a.index || 0) - (b.index || 0));
                } catch (error) {
                    console.error('イベント出席データ読み込みエラー:', error);
                    this.eventAttendanceData = [];
                }
            }
            // イベント出席データを保存
            async saveEventAttendance() {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    // 全データを保存（indexを追加）
                    for (let i = 0; i < this.eventAttendanceData.length; i++) {
                        const data = this.eventAttendanceData[i];
                        const docId = data.id || `event_${Date.now()}_${i}`;
                        const docRef = doc(db, `event_attendance_${monthKey}`, docId);
                        await setDoc(docRef, {
                            isMember: data.isMember || false,
                            lastName: data.lastName || '',
                            firstName: data.firstName || '',
                            week1: data.week1 || '×',
                            week2: data.week2 || '×',
                            week3: data.week3 || '×',
                            fee: data.fee || 0,
                            memo: data.memo || '',
                            index: i
                        });
                        if (!data.id) {
                            this.eventAttendanceData[i].id = docId;
                        }
                    }
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('イベント出席データ保存エラー:', error);
                }
            }
            // イベント参加者を追加
            addEventParticipant() {
                this.eventAttendanceData.push({
                    id: null,
                    isMember: false,
                    lastName: '',
                    firstName: '',
                    week1: '×',
                    week2: '×',
                    week3: '×',
                    fee: 0,
                    memo: ''
                });
                this.render();
            }
            // イベント参加者を削除
            async deleteEventParticipant(index) {
                if (!confirm('この参加者を削除してもよろしいですか？')) {
                    return;
                }
                
                const participant = this.eventAttendanceData[index];
                if (participant.id) {
                    try {
                        const monthKey = this.selectedMonth.replace('-', '');
                        await deleteDoc(doc(db, `event_attendance_${monthKey}`, participant.id));
                    } catch (error) {
                        console.error('削除エラー:', error);
                    }
                }
                
                this.eventAttendanceData.splice(index, 1);
                await this.saveEventAttendance();
                this.render();
            }
            // イベントの合計金額を計算
            calculateEventTotal() {
                return this.eventAttendanceData.reduce((sum, p) => sum + (parseFloat(p.fee) || 0), 0);
            }
            async saveAttendance(studentId, weekData) {
                try {
                    const monthKey = this.selectedMonth.replace('-', '');
                    const docRef = doc(db, `attendance_${monthKey}`, studentId);
                    await setDoc(docRef, weekData, { merge: true });
                    await this.loadAttendance();
                } catch (error) {
                    console.error('出席データ保存エラー:', error);
                }
            }
            toggleAttendance(classId, week) {
                const current = this.attendanceData[classId]?.[week] || '';
                const next = current === '○' ? '×' : current === '×' ? '休講' : current === '休講' ? '' : '○';
                
                if (!this.attendanceData[classId]) {
                    this.attendanceData[classId] = {};
                }
                this.attendanceData[classId][week] = next;
                
                this.saveAttendance(classId, this.attendanceData[classId]);
                this.render();
            }
            getAttendanceRate(classId) {
                const data = this.attendanceData[classId] || {};
                const weeks = ['week1', 'week2', 'week3', 'week4']; // 予備週を除外
                const attended = weeks.filter(w => data[w] === '○').length;
                const recorded = weeks.filter(w => data[w] === '○' || data[w] === '×').length; // 休講を除外
                return recorded > 0 ? Math.round((attended / recorded) * 100) : 0;
            }
            // 月切り替え機能を修正
            async changeMonth(direction) {
                this.isLoading = true;
                this.render();
                
                try {
                    // 現在の年月を取得
                    const [currentYear, currentMonth] = this.selectedMonth.split('-').map(Number);
                    
                    // 新しい年月を計算
                    let newYear = currentYear;
                    let newMonth = currentMonth + direction;
                    
                    // 月の範囲チェックと年の調整
                    if (newMonth > 12) {
                        newMonth = 1;
                        newYear++;
                    } else if (newMonth < 1) {
                        newMonth = 12;
                        newYear--;
                    }
                    
                    // YYYY-MM形式に変換（月は2桁にゼロパディング）
                    this.selectedMonth = `${newYear}-${String(newMonth).padStart(2, '0')}`;
                    
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('月切り替えエラー:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }
            // 月を直接選択
            async selectMonth(monthValue) {
                if (!monthValue) return;
                
                this.isLoading = true;
                this.selectedMonth = monthValue;
                this.render();
                
                try {
                    await this.loadAttendance();
                    await this.loadEventAttendance();
                } catch (error) {
                    console.error('月選択エラー:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }
            // イベントクラス追加機能
            addClassToEvent() {
                this.showAddClassForm = true;
                this.render();
            }
            async saveNewClass() {
                const className = document.getElementById('new_class_name')?.value || '';
                const location = document.getElementById('new_class_location')?.value || '天神';
                const color = document.getElementById('new_class_color')?.value || 'red';
                if (!className) {
                    alert('クラス名を入力してください');
                    return;
                }
                this.scheduleData['イベント'].push({
                    location,
                    name: className,
                    color,
                    students: []
                });
                
                // Firestoreに保存
                await this.saveScheduleData();
                
                this.showAddClassForm = false;
                this.render();
                alert('クラスを追加しました');
            }
            renderAttendance() {
                return `
                    <div>
                        <div class="page-header">
                            <div>
                                <h2>出席名簿</h2>
                                <p class="subtitle">${this.selectedMonth.replace('-', '年')}月の出席記録</p>
                            </div>
                        </div>
                        <div class="tab-nav" style="margin-bottom:28px;">
                            <button id="attendanceOverviewTab" class="tab-btn ${this.attendanceTab === 'overview' ? 'active' : ''}">HOME</button>
                            <button id="attendanceRecordTab" class="tab-btn ${this.attendanceTab === 'record' ? 'active' : ''}">出席記録</button>
                        </div>
                        ${this.attendanceTab === 'overview' ? this.renderAttendanceOverview() : this.renderAttendanceRecord()}
                    </div>
                `;
            }
            renderAttendanceOverview() {
                const [year, month] = this.selectedMonth.split('-');

                // 全曜日のクラス数と生徒数を集計
                let totalClasses = 0;
                let totalStudents = 0;
                Object.keys(this.scheduleData).forEach(day => {
                    totalClasses += this.scheduleData[day].length;
                    this.scheduleData[day].forEach(cls => {
                        totalStudents += cls.students.length;
                    });
                });
                const dayStats = Object.keys(this.scheduleData).map(day => {
                    const classes = this.scheduleData[day];
                    const studentCount = classes.reduce((sum, cls) => sum + cls.students.length, 0);
                    return { day, classCount: classes.length, studentCount };
                });

                // 詳細売上計算
                const detailed = this.calculateDetailedRevenue();
                const visitorRevenue = this.calculateVisitorRevenue();
                const practiceRevenue = detailed['練習会'].revenue;
                const totalExtraRevenue = Object.values(detailed).reduce((sum, d) => sum + d.revenue, 0);

                // 表示順序を定義
                const displayOrder = ['練習会', 'ビジター（会員）', 'ビジター（非会員）', 'ビジター1.5h（会員）', 'ビジター1.5h（非会員）', '月謝クラス振替', '初回体験', '初回無料'];

                // 各レッスン受講人数 & インストラクター別データ
                const lessonData = [];
                const instructorMap = {};
                const dayOrder = ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日'];
                const dayColors = { '月曜日': 'blue', '火曜日': 'red', '水曜日': 'green', '木曜日': 'orange', '金曜日': 'purple' };

                for (const day of dayOrder) {
                    const classes = this.scheduleData[day] || [];
                    for (const cls of classes) {
                        if (cls.students.length === 0) continue;
                        const parts = cls.name.split(' ');
                        const instructor = parts[parts.length - 1];
                        lessonData.push({ day, location: cls.location, name: cls.name, instructor, count: cls.students.length, color: cls.color });
                        if (!instructorMap[instructor]) {
                            instructorMap[instructor] = { classes: 0, students: 0, classList: [] };
                        }
                        instructorMap[instructor].classes++;
                        instructorMap[instructor].students += cls.students.length;
                        instructorMap[instructor].classList.push(`${day.charAt(0)} ${cls.location} ${cls.name.replace(' ' + instructor, '')}`);
                    }
                }
                const sortedInstructors = Object.entries(instructorMap).sort((a, b) => b[1].students - a[1].students);
                const lessonTotal = lessonData.reduce((s, l) => s + l.count, 0);

                return `
                    <div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;">
                            <div></div>
                            <div style="display:flex;gap:10px;align-items:center;">
                                <button id="prevMonth" class="btn btn-secondary btn-sm">◀ 前月</button>
                                <input type="month" id="monthSelectorOverview" value="${this.selectedMonth}" class="form-input" style="padding:8px 14px;font-size:14px;font-weight:500;"/>
                                <button id="nextMonth" class="btn btn-secondary btn-sm">次月 ▶</button>
                            </div>
                        </div>

                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-icon blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                </div>
                                <div class="stat-label">総クラス数</div>
                                <div class="stat-value" style="font-size:36px;">${totalClasses}<span class="stat-unit">クラス</span></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon green">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/></svg>
                                </div>
                                <div class="stat-label">総生徒数（延べ）</div>
                                <div class="stat-value" style="font-size:36px;color:var(--accent);">${totalStudents}<span class="stat-unit">名</span></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon purple">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                                </div>
                                <div class="stat-label">ビジター売上</div>
                                <div class="stat-value" style="font-size:36px;color:var(--green);">¥${visitorRevenue.toLocaleString()}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon orange">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                </div>
                                <div class="stat-label">練習会売上</div>
                                <div class="stat-value" style="font-size:36px;color:var(--text-secondary);">¥${practiceRevenue.toLocaleString()}</div>
                                <div style="font-size:12px;color:var(--text-tertiary);margin-top:8px;">${detailed['練習会'].count}名参加</div>
                            </div>
                        </div>

                        <div class="content-card" style="margin-bottom:24px;padding:0;overflow:hidden;">
                            <div style="padding:24px 28px 0;">
                                <h3 class="card-title">売上内訳（受講人数・売上）</h3>
                            </div>
                            <div style="overflow-x:auto;padding:16px 0 0;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="padding-left:28px;">カテゴリ</th>
                                            <th style="text-align:center;">単価</th>
                                            <th style="text-align:center;">受講人数</th>
                                            <th style="text-align:right;padding-right:28px;">売上</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${displayOrder.map(plan => {
                                            const data = detailed[plan] || { count: 0, revenue: 0 };
                                            const price = this.pricing[plan] || 0;
                                            return `
                                                <tr>
                                                    <td style="padding-left:28px;font-weight:500;">${plan}</td>
                                                    <td style="text-align:center;color:var(--text-secondary);">¥${price.toLocaleString()}</td>
                                                    <td style="text-align:center;">
                                                        ${data.count > 0 ? `<span class="badge badge-blue">${data.count}${plan === '練習会' ? '名' : '回'}</span>` : '<span style="color:var(--text-tertiary);">-</span>'}
                                                    </td>
                                                    <td style="text-align:right;padding-right:28px;font-weight:600;color:${data.revenue > 0 ? 'var(--green)' : 'var(--text-tertiary)'};">
                                                        ${data.revenue > 0 ? '¥' + data.revenue.toLocaleString() : '-'}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr style="border-top:2px solid var(--text-primary);">
                                            <td style="padding-left:28px;font-weight:700;" colspan="3">合計</td>
                                            <td style="text-align:right;padding-right:28px;font-weight:700;font-size:18px;color:var(--accent);">¥${totalExtraRevenue.toLocaleString()}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="content-card" style="margin-bottom:24px;padding:0;overflow:hidden;">
                            <div style="padding:24px 28px 0;">
                                <h3 class="card-title">各レッスン受講人数</h3>
                            </div>
                            <div style="overflow-x:auto;padding:16px 0 0;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="padding-left:28px;">曜日</th>
                                            <th>場所</th>
                                            <th>クラス名</th>
                                            <th style="text-align:center;">講師</th>
                                            <th style="text-align:center;padding-right:28px;">受講人数</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${lessonData.map(l => `
                                            <tr>
                                                <td style="padding-left:28px;"><span class="badge badge-blue">${l.day}</span></td>
                                                <td style="color:var(--text-secondary);">${l.location}</td>
                                                <td style="font-weight:500;">${l.name}</td>
                                                <td style="text-align:center;"><span class="badge" style="background:rgba(175,82,222,0.1);color:var(--purple);">${l.instructor}</span></td>
                                                <td style="text-align:center;padding-right:28px;"><span class="badge badge-green">${l.count}名</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr style="border-top:2px solid var(--text-primary);">
                                            <td style="padding-left:28px;font-weight:700;" colspan="4">合計</td>
                                            <td style="text-align:center;padding-right:28px;font-weight:700;color:var(--accent);">${lessonTotal}名</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="content-card" style="margin-bottom:24px;">
                            <div class="card-header">
                                <h3 class="card-title">インストラクター別 生徒数</h3>
                            </div>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
                                ${sortedInstructors.map(([name, data]) => `
                                    <div class="card" style="padding:20px;">
                                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                            <span style="font-size:16px;font-weight:700;color:var(--purple);letter-spacing:-0.3px;">${name}</span>
                                            <span class="badge" style="background:var(--purple);color:white;">${data.students}名</span>
                                        </div>
                                        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">${data.classes}クラス担当</div>
                                        <div style="display:flex;flex-wrap:wrap;gap:4px;">
                                            ${data.classList.map(c => `<span style="background:rgba(0,0,0,0.04);color:var(--text-secondary);padding:3px 8px;border-radius:6px;font-size:11px;">${c}</span>`).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-header">
                                    <h3 class="card-title">曜日別クラス数</h3>
                                </div>
                                ${dayStats.map(stat => `
                                    <div class="revenue-row">
                                        <span class="rev-label">${stat.day}</span>
                                        <div style="display:flex;gap:16px;align-items:center;">
                                            <span style="font-size:13px;color:var(--text-secondary);">${stat.classCount}クラス</span>
                                            <span class="badge badge-blue">${stat.studentCount}名</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="content-card">
                                <div class="card-header">
                                    <h3 class="card-title">バックアップ</h3>
                                </div>
                                <p style="font-size:14px;color:var(--text-secondary);margin-bottom:20px;">データの安全のため、定期的にバックアップを取得してください。</p>
                                <button id="backupBtn" class="btn btn-green" style="width:100%;justify-content:center;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    バックアップを取得
                                </button>
                                <div id="backupStatus" style="font-size:12px;color:var(--text-tertiary);text-align:center;margin-top:12px;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            renderAttendanceRecord() {
                // イベントタブは専用のレンダリング
                if (this.selectedDay === 'イベント') {
                    return this.renderEventRecord();
                }
                const [year, month] = this.selectedMonth.split('-');
                const dayClasses = this.scheduleData[this.selectedDay] || [];
                if (this.isLoading) {
                    return `
                        <div class="flex items-center justify-center h-96">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                                <p class="text-gray-600">読み込み中...</p>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">出席記録</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>◀ 前月</button>
                                <input 
                                    type="month" 
                                    id="monthSelector" 
                                    value="${this.selectedMonth}" 
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>次月 ▶</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow mb-4">
                            <div class="flex border-b overflow-x-auto">
                                ${['月曜日', '火曜日', '水曜日', '木曜日', '金曜日', 'イベント'].map(day => `
                                    <button id="day-${day}" class="px-4 py-2 text-sm font-medium whitespace-nowrap ${this.selectedDay === day ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'}">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        ${this.showAddStudentForm ? this.renderAddStudentForm() : ''}
                        ${dayClasses.map((classInfo, idx) => {
                            const sortedStudents = this.sortStudentsByPlan([...classInfo.students]);
                            // 月謝プランの生徒は常に表示、それ以外は当月の出席データがある場合のみ表示
                            const filteredStudents = sortedStudents.filter(student => {
                                if (this.isRegularPlan(student.plan)) return true;
                                const key = `${this.selectedDay}_${classInfo.location}_${classInfo.name}_${student.lastName}${student.firstName}`;
                                return this.attendanceData.hasOwnProperty(key);
                            });
                            // 出席データにのみ存在するビジター・初回体験等のエントリーも追加
                            const classPrefix = `${this.selectedDay}_${classInfo.location}_${classInfo.name}_`;
                            const existingNames = new Set(filteredStudents.map(s => s.lastName + s.firstName));
                            const knownTypes = {'初回体験':'初回体験','初回無料':'初回無料','ビジター会員':'ビジター（会員）','ビジター非会員':'ビジター（非会員）','ビジター1.5h会員':'ビジター1.5h（会員）','ビジター1.5h非会員':'ビジター1.5h（非会員）','ビジター（会員）':'ビジター（会員）','ビジター（非会員）':'ビジター（非会員）','ビジター（振替）':'ビジター（振替）','月謝クラス振替':'月謝クラス振替'};
                            Object.keys(this.attendanceData).forEach(key => {
                                if (key.startsWith(classPrefix)) {
                                    const studentName = key.substring(classPrefix.length);
                                    if (!existingNames.has(studentName)) {
                const plan = this.attendanceData[key]?._plan || knownTypes[studentName] || (()=>{let _m3=false;['月曜日','火曜日','水曜日','木曜日','金曜日'].forEach(d=>{const dd=this.scheduleData?.[d];if(dd)Object.values(dd).forEach(c=>{if(c.students?.some(s=>(s.lastName+(s.firstName||'')).trim()===studentName))_m3=true})});return _m3?'月謝クラス振替':'ビジター（会員）';})();
                                        filteredStudents.push({lastName: studentName, firstName: '', plan: plan});
                                        existingNames.add(studentName);
                                    }
                                }
                            });
                            return `
                                <div class="bg-white rounded-lg shadow mb-3">
                                    <div class="bg-${classInfo.color}-600 text-white px-4 py-2 rounded-t-lg flex justify-between items-center">
                                        <h3 class="text-base font-bold">${classInfo.location} - ${classInfo.name}</h3>
                                        <div class="flex gap-2 items-center">
                                            <span class="text-xs opacity-90">${filteredStudents.length}名</span>
                                            <button 
                                                data-add-day="${this.selectedDay}" 
                                                data-add-location="${classInfo.location}" 
                                                data-add-class="${classInfo.name}"
                                                class="add-student-btn bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-xs transition">
                                                + 生徒追加
                                            </button>
                                        </div>
                                    </div>
                                    <div class="p-3 overflow-x-auto">
                                        <table class="w-full text-xs">
                                            <thead>
                                                <tr class="bg-gray-50 border-b">
                                                    <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">氏名</th>
                                                    <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">プラン</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">第1週</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">第2週</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">第3週</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">第4週</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">予備</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 60px;">出席率</th>
                                                    <th class="px-2 py-2 text-center font-semibold" style="width: 50px;">編集</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${filteredStudents.map(student => {
                                                    const studentKey = `${this.selectedDay}_${classInfo.location}_${classInfo.name}_${student.lastName}${student.firstName}`;
                                                    const attendance = this.attendanceData[studentKey] || {};
                                                    const rate = this.getAttendanceRate(studentKey);
                                                    const isEditing = this.editingStudent && 
                                                                     this.editingStudent.day === this.selectedDay &&
                                                                     this.editingStudent.location === classInfo.location &&
                                                                     this.editingStudent.className === classInfo.name &&
                                                                     this.editingStudent.lastName === student.lastName &&
                                                                     this.editingStudent.firstName === student.firstName;
                                                    
                                                    if (isEditing) {
                                                        return `
                                                            <tr class="border-b bg-blue-50">
                                                                <td class="px-2 py-2 text-xs">${student.lastName} ${student.firstName}</td>
                                                                <td class="px-2 py-2 text-xs">
                                                                    <select id="edit_student_plan" class="w-full border rounded px-1 py-1 text-xs">
                                                                        <option value="４クラス" ${student.plan === '４クラス' ? 'selected' : ''}>４クラス</option>
                                                                        <option value="３クラス" ${student.plan === '３クラス' ? 'selected' : ''}>３クラス</option>
                                                                        <option value="２クラス" ${student.plan === '２クラス' ? 'selected' : ''}>２クラス</option>
                                                                        <option value="１クラス" ${student.plan === '１クラス' ? 'selected' : ''}>１クラス</option>
                                                                        <option value="ビジター（会員）" ${student.plan === 'ビジター（会員）' ? 'selected' : ''}>ビジター（会員）</option>
                                                                        <option value="ビジター（非会員）" ${student.plan === 'ビジター（非会員）' ? 'selected' : ''}>ビジター（非会員）</option>
                                                                        <option value="ビジター（振替）" ${student.plan === 'ビジター（振替）' ? 'selected' : ''}>ビジター（振替）</option>
                                                                        <option value="初回体験" ${student.plan === '初回体験' ? 'selected' : ''}>初回体験</option>
                                                                        <option value="初回無料" ${student.plan === '初回無料' ? 'selected' : ''}>初回無料</option>
                                                                    </select>
                                                                </td>
                                                                ${['week1', 'week2', 'week3', 'week4', 'week5'].map(week => `
                                                                    <td class="px-2 py-2 text-center">
                                                                        <button 
                                                                            data-class="${studentKey}" 
                                                                            data-week="${week}"
                                                                            class="attendance-btn w-8 h-8 rounded border text-xs ${
                                                                                attendance[week] === '○' ? 'bg-green-500 border-green-600 text-white' :
                                                                                attendance[week] === '×' ? 'bg-red-500 border-red-600 text-white' :
                                                                                attendance[week] === '休講' ? 'bg-gray-500 border-gray-600 text-white' :
                                                                                'bg-gray-100 border-gray-300 text-gray-400'
                                                                            } hover:opacity-80 transition font-bold">
                                                                            ${attendance[week] === '休講' ? '休' : attendance[week] || '-'}
                                                                        </button>
                                                                    </td>
                                                                `).join('')}
                                                                <td class="px-2 py-2 text-center">
                                                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                                        rate >= 80 ? 'bg-green-100 text-green-800' :
                                                                        rate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                                        rate > 0 ? 'bg-red-100 text-red-800' :
                                                                        'bg-gray-100 text-gray-600'
                                                                    }">${rate > 0 ? rate + '%' : '-'}</span>
                                                                </td>
                                                                <td class="px-2 py-2 text-center">
                                                                    <div class="flex flex-col gap-1">
                                                                        <button 
                                                                            id="saveEditStudentBtn"
                                                                            class="text-green-600 hover:text-green-800 text-xs">
                                                                            保存
                                                                        </button>
                                                                        <button 
                                                                            id="cancelEditStudentBtn"
                                                                            class="text-gray-600 hover:text-gray-800 text-xs">
                                                                            キャンセル
                                                                        </button>
                                                                        <button 
                                                                            data-delete-day="${this.selectedDay}"
                                                                            data-delete-location="${classInfo.location}"
                                                                            data-delete-class="${classInfo.name}"
                                                                            data-delete-lastname="${student.lastName}"
                                                                            data-delete-firstname="${student.firstName}"
                                                                            class="delete-student-btn text-red-600 hover:text-red-800 text-xs">
                                                                            削除
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }
                                                    
                                                    return `
                                                        <tr class="border-b hover:bg-gray-50">
                                                            <td class="px-2 py-2 text-xs">${student.lastName} ${student.firstName}</td>
                                                            <td class="px-2 py-2 text-xs">${student.plan}</td>
                                                            ${['week1', 'week2', 'week3', 'week4', 'week5'].map(week => `
                                                                <td class="px-2 py-2 text-center">
                                                                    <button 
                                                                        data-class="${studentKey}" 
                                                                        data-week="${week}"
                                                                        class="attendance-btn w-8 h-8 rounded border text-xs ${
                                                                            attendance[week] === '○' ? 'bg-green-500 border-green-600 text-white' :
                                                                            attendance[week] === '×' ? 'bg-red-500 border-red-600 text-white' :
                                                                            attendance[week] === '休講' ? 'bg-gray-500 border-gray-600 text-white' :
                                                                            'bg-gray-100 border-gray-300 text-gray-400'
                                                                        } hover:opacity-80 transition font-bold">
                                                                        ${attendance[week] === '休講' ? '休' : attendance[week] || '-'}
                                                                    </button>
                                                                </td>
                                                            `).join('')}
                                                            <td class="px-2 py-2 text-center">
                                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                                    rate >= 80 ? 'bg-green-100 text-green-800' :
                                                                    rate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                                    rate > 0 ? 'bg-red-100 text-red-800' :
                                                                    'bg-gray-100 text-gray-600'
                                                                }">${rate > 0 ? rate + '%' : '-'}</span>
                                                            </td>
                                                            <td class="px-2 py-2 text-center">
                                                                <button 
                                                                    data-edit-student-day="${this.selectedDay}"
                                                                    data-edit-student-location="${classInfo.location}"
                                                                    data-edit-student-class="${classInfo.name}"
                                                                    data-edit-student-lastname="${student.lastName}"
                                                                    data-edit-student-firstname="${student.firstName}"
                                                                    class="edit-student-btn text-blue-600 hover:text-blue-800 text-xs">
                                                                    編集
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        ${dayClasses.length === 0 ? `
                            <div class="bg-white rounded-lg shadow p-12 text-center">
                                <p class="text-gray-500 text-lg">この曜日にはクラスがありません</p>
                            </div>
                        ` : ''}

                        ${(this.selectedDay === '月曜日' || this.selectedDay === '木曜日') ? this.renderPracticeSession() : ''}
                    </div>
                `;
            }
            // 練習会セクションのレンダリング
            renderPracticeSession() {
                const practiceKey = `練習会_${this.selectedDay}`;
                const practiceData = this.attendanceData[practiceKey] || {};
                const weeks = ['week1', 'week2', 'week3', 'week4', 'week5'];
                const weekLabels = ['第1週', '第2週', '第3週', '第4週', '予備'];
                let totalParticipants = 0;
                weeks.forEach(w => { totalParticipants += (parseInt(practiceData[w]) || 0); });
                const totalRevenue = totalParticipants * 500;

                return `
                    <div class="bg-white rounded-lg shadow mb-3">
                        <div class="bg-purple-600 text-white px-4 py-2 rounded-t-lg flex justify-between items-center">
                            <h3 class="text-base font-bold">練習会（¥500/人）</h3>
                            <span class="text-xs opacity-90">合計: ${totalParticipants}名 / ¥${totalRevenue.toLocaleString()}</span>
                        </div>
                        <div class="p-3">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="bg-gray-50 border-b">
                                        <th class="px-2 py-2 text-left font-semibold" style="width: 100px;">項目</th>
                                        ${weekLabels.map(label => `
                                            <th class="px-2 py-2 text-center font-semibold" style="width: 70px;">${label}</th>
                                        `).join('')}
                                        <th class="px-2 py-2 text-center font-semibold" style="width: 70px;">合計</th>
                                        <th class="px-2 py-2 text-right font-semibold" style="width: 90px;">売上</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b">
                                        <td class="px-2 py-2 font-medium">参加人数</td>
                                        ${weeks.map(week => `
                                            <td class="px-2 py-2 text-center">
                                                <input
                                                    type="number"
                                                    min="0"
                                                    value="${parseInt(practiceData[week]) || 0}"
                                                    data-practice-day="${this.selectedDay}"
                                                    data-practice-week="${week}"
                                                    class="practice-input w-14 border rounded px-1 py-1 text-xs text-center focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                />
                                            </td>
                                        `).join('')}
                                        <td class="px-2 py-2 text-center">
                                            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-semibold">${totalParticipants}名</span>
                                        </td>
                                        <td class="px-2 py-2 text-right font-bold text-purple-700">¥${totalRevenue.toLocaleString()}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            renderAddStudentForm() {
                return `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                        <h3 class="text-base font-semibold mb-3 text-gray-800">生徒追加</h3>
                        
                        <!-- 顧客検索 -->
                        <div class="mb-3">
                            <label class="block text-xs font-medium mb-1">顧客検索（氏名・読み・会員番号）</label>
                            <input 
                                type="text" 
                                id="student_search_input" 
                                value="${this.studentSearchTerm}"
                                class="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="例: 中島、なかしま、ナカシマ、nakashima、0001"
                                autocomplete="off"
                            />
                            <div class="text-xs text-gray-500 mt-1">💡 漢字・ひらがな・カタカナ・英語・会員番号で検索できます</div>
                            <!-- 検索結果表示用コンテナ -->
                            <div id="searchResultsContainer">
                                ${this.studentSearchResults.length > 0 ? `
                                    <div class="mt-2 border rounded bg-white student-search-results shadow-lg">
                                        ${this.studentSearchResults.map(customer => `
                                            <div 
                                                data-select-customer-id="${customer.id}"
                                                class="select-customer-btn p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm transition">
                                                <div class="font-medium text-blue-600">
                                                    ${customer.lastName} ${customer.firstName}
                                                    ${customer.memberNumber ? `<span class="text-xs text-gray-500 ml-2">[${customer.memberNumber}]</span>` : ''}
                                                </div>
                                                <div class="text-xs text-gray-600 mt-1">
                                                    ${customer.reading ? `読み: ${customer.reading}` : ''}
                                                    ${customer.reading && customer.course ? ' | ' : ''}
                                                    ${customer.course ? `コース: ${customer.course}` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : this.studentSearchTerm.trim() && this.studentSearchResults.length === 0 ? `
                                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                                        ⚠️ 該当する顧客が見つかりませんでした
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ${this.selectedCustomerForStudent ? `
                            <div id="selectedCustomerInfo" class="mb-3 p-3 bg-green-50 border-2 border-green-400 rounded text-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-bold text-green-800">✓ 選択中: ${this.selectedCustomerForStudent.lastName} ${this.selectedCustomerForStudent.firstName}</div>
                                        <div class="text-xs text-gray-700 mt-1">
                                            ${this.selectedCustomerForStudent.memberNumber ? `会員番号: ${this.selectedCustomerForStudent.memberNumber} | ` : ''}
                                            ${this.selectedCustomerForStudent.reading ? `読み: ${this.selectedCustomerForStudent.reading} | ` : ''}
                                            コース: ${this.selectedCustomerForStudent.course || 'なし'}
                                        </div>
                                    </div>
                                    <button 
                                        id="clearSelectedCustomer"
                                        class="text-red-600 hover:text-red-800 text-xs underline">
                                        選択解除
                                    </button>
                                </div>
                            </div>
                        ` : '<div id="selectedCustomerInfo"></div>'}
                        <div class="grid grid-cols-3 gap-3 mb-3">
                            <div id="nameInputContainer" class="${!this.selectedCustomerForStudent ? 'col-span-2 grid grid-cols-2 gap-3' : 'hidden'}">
                                <div>
                                    <label class="block text-xs font-medium mb-1">姓 *</label>
                                    <input type="text" id="new_student_lastName" class="w-full border rounded px-2 py-1 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1">名 *</label>
                                    <input type="text" id="new_student_firstName" class="w-full border rounded px-2 py-1 text-sm">
                                </div>
                            </div>
                            <div id="planSelectContainer" class="${!this.selectedCustomerForStudent ? '' : 'col-span-3'}">
                                <label class="block text-xs font-medium mb-1">プラン *</label>
                                <select id="new_student_plan" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="">選択してください</option>
                                    <option value="４クラス" ${this.selectedCustomerForStudent?.course === '４' ? 'selected' : ''}>４クラス</option>
                                    <option value="３クラス" ${this.selectedCustomerForStudent?.course === '３' ? 'selected' : ''}>３クラス</option>
                                    <option value="２クラス" ${this.selectedCustomerForStudent?.course === '２' ? 'selected' : ''}>２クラス</option>
                                    <option value="１クラス" ${this.selectedCustomerForStudent?.course === '１' ? 'selected' : ''}>１クラス</option>
                                    <option value="ビジター（会員）">ビジター（会員）</option>
                                    <option value="ビジター（非会員）">ビジター（非会員）</option>
                                    <option value="ビジター（振替）">ビジター（振替）</option>
                                    <option value="初回体験">初回体験</option>
                                    <option value="初回無料">初回無料</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 mb-3">
                            ※ 顧客一覧からプランが自動反映されますが、ビジターとして受講する場合は変更してください
                        </div>
                        <div class="flex gap-2">
                            <button id="saveNewStudentBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">追加</button>
                            <button id="cancelAddStudentBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition text-sm">キャンセル</button>
                        </div>
                    </div>
                `;
            }
            // イベント専用のレンダリング
            renderEventRecord() {
                const [year, month] = this.selectedMonth.split('-');
                const total = this.calculateEventTotal();
                if (this.isLoading) {
                    return `
                        <div class="flex items-center justify-center h-96">
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                                <p class="text-gray-600">読み込み中...</p>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">イベント出席記録</h2>
                            <div class="flex gap-2 items-center">
                                <button id="prevMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>◀ 前月</button>
                                <input 
                                    type="month" 
                                    id="monthSelector" 
                                    value="${this.selectedMonth}" 
                                    class="px-3 py-2 border border-blue-300 bg-blue-50 text-blue-800 rounded font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button id="nextMonthRecord" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded transition text-sm" ${this.isLoading ? 'disabled' : ''}>次月 ▶</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow mb-4">
                            <div class="flex border-b overflow-x-auto">
                                ${['月曜日', '火曜日', '水曜日', '木曜日', '金曜日', 'イベント'].map(day => `
                                    <button id="day-${day}" class="px-4 py-2 text-sm font-medium whitespace-nowrap ${this.selectedDay === day ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'}">
                                        ${day}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-gray-800">イベント参加者一覧</h3>
                                <button id="addEventParticipantBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-sm">
                                    + 参加者を追加
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 100px;">氏名（姓）</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 100px;">氏名（名）</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">①</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">②</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 60px;">③</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 120px;">料金（円）</th>
                                            <th class="px-3 py-3 text-left font-semibold" style="width: 200px;">備考</th>
                                            <th class="px-3 py-3 text-center font-semibold" style="width: 80px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.eventAttendanceData.length === 0 ? `
                                            <tr>
                                                <td colspan="8" class="px-3 py-8 text-center text-gray-500">
                                                    参加者がいません。「+ 参加者を追加」ボタンから追加してください。
                                                </td>
                                            </tr>
                                        ` : this.eventAttendanceData.map((participant, index) => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="lastName" 
                                                        data-event-index="${index}"
                                                        value="${participant.lastName || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="姓"
                                                    />
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="firstName" 
                                                        data-event-index="${index}"
                                                        value="${participant.firstName || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="名"
                                                    />
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week1" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week1 === '○' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week1 === '○' ? '○' : '×'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week2" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week2 === '○' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week2 === '○' ? '○' : '×'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-event-week="week3" 
                                                        data-event-index="${index}"
                                                        class="event-attendance-btn w-10 h-10 rounded border text-sm ${
                                                            participant.week3 === '○' ? 'bg-green-500 border-green-600 text-white' :
                                                            'bg-red-500 border-red-600 text-white'
                                                        } hover:opacity-80 transition font-bold">
                                                        ${participant.week3 === '○' ? '○' : '×'}
                                                    </button>
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="number" 
                                                        data-event-field="fee" 
                                                        data-event-index="${index}"
                                                        value="${participant.fee || 0}"
                                                        class="w-full border rounded px-2 py-1 text-sm text-right"
                                                        placeholder="0"
                                                        min="0"
                                                    />
                                                </td>
                                                <td class="px-3 py-3">
                                                    <input 
                                                        type="text" 
                                                        data-event-field="memo" 
                                                        data-event-index="${index}"
                                                        value="${participant.memo || ''}"
                                                        class="w-full border rounded px-2 py-1 text-sm"
                                                        placeholder="備考"
                                                    />
                                                </td>
                                                <td class="px-3 py-3 text-center">
                                                    <button 
                                                        data-delete-event-index="${index}"
                                                        class="delete-event-participant-btn text-red-600 hover:text-red-800 text-xs">
                                                        削除
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-blue-50 border-t-2 border-blue-300">
                                            <td colspan="5" class="px-3 py-4 text-right font-bold text-gray-800">合計金額:</td>
                                            <td class="px-3 py-4 font-bold text-blue-600 text-lg">¥${total.toLocaleString()}</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="mt-6 p-4 bg-gray-50 rounded border">
                                <h4 class="font-semibold mb-2 text-sm">使い方</h4>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li>• 氏名・料金・備考は直接入力できます</li>
                                    <li>• ①②③のボタンをクリックすると <span class="text-green-600 font-bold">○</span> → <span class="text-red-600 font-bold">×</span> → <span class="text-gray-600 font-bold">休</span> → <span class="text-gray-400 font-bold">-</span> と切り替わります</li>
                                    <li>• 入力内容は自動保存されます</li>
                                    <li>• 料金の合計金額が自動で表示されます</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            renderTimeSchedule() {
                const days = ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日'];
                const dayLabels = {'月曜日':'MON','火曜日':'TUE','水曜日':'WED','木曜日':'THU','金曜日':'FRI'};
                const hours = ['16:00','17:00','18:00','19:00','20:00','21:00','22:00'];

                return `
                    <div>
                        <div class="page-header">
                            <div>
                                <h2>タイムスケジュール</h2>
                                <p class="subtitle">週間レッスンスケジュール</p>
                            </div>
                        </div>
                        <div class="content-card" style="overflow-x:auto;padding:0;">
                            <table style="width:100%;border-collapse:collapse;table-layout:fixed;">
                                <thead>
                                    <tr>
                                        <th style="width:70px;padding:16px 8px;text-align:center;background:rgba(0,0,0,0.02);border-bottom:1px solid var(--border);font-size:11px;color:var(--text-secondary);">時間</th>
                                        ${days.map(d => `<th style="padding:16px 8px;text-align:center;background:rgba(0,0,0,0.02);border-bottom:1px solid var(--border);font-size:13px;font-weight:600;letter-spacing:-0.2px;">${d}<br><span style="font-size:10px;color:var(--text-tertiary);font-weight:500;">${dayLabels[d]}</span></th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${hours.map(hour => {
                                        const hourNum = parseInt(hour);
                                        return `<tr>
                                            <td style="padding:10px 8px;text-align:center;background:rgba(0,0,0,0.01);border-bottom:1px solid var(--border);font-size:12px;font-weight:500;color:var(--text-tertiary);vertical-align:top;">${hour}</td>
                                            ${days.map(day => {
                                                const classes = (this.timeScheduleData[day] || []).filter(c => {
                                                    const startHour = parseInt(c.time.split(':')[0]);
                                                    return startHour >= hourNum && startHour < hourNum + 1;
                                                });
                                                return `<td style="padding:4px 6px;border-bottom:1px solid var(--border);vertical-align:top;">
                                                    ${classes.map(c => `
                                                        <div style="background:${c.color};color:#fff;border-radius:var(--radius-xs);padding:8px 10px;margin:3px 0;font-size:11px;box-shadow:0 2px 6px ${c.color}40;transition:var(--transition);">
                                                            <div style="font-weight:600;font-size:12px;">${c.time}</div>
                                                            <div style="opacity:0.9;margin-top:3px;font-weight:500;">${c.name}</div>
                                                            <div style="opacity:0.65;font-size:10px;margin-top:2px;">${c.venue}</div>
                                                        </div>
                                                    `).join('')}
                                                </td>`;
                                            }).join('')}
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            renderMonthlySchedule() {
                const [year, month] = this.selectedMonth.split('-').map(Number);
                const daysInMonth = new Date(year, month, 0).getDate();
                const firstDayOfWeek = new Date(year, month - 1, 1).getDay();
                const dayNames = ['日','月','火','水','木','金','土'];
                const venues = ['天神校','大橋校','照葉校'];

                // Determine which venues have classes on which day of week
                const dayOfWeekVenues = {};
                const dayMap = {'月曜日':1,'火曜日':2,'水曜日':3,'木曜日':4,'金曜日':5};
                Object.entries(this.scheduleData).forEach(([dayName, classes]) => {
                    const dow = dayMap[dayName];
                    if (dow) {
                        const venueSet = new Set();
                        classes.forEach(c => {
                            if (c.location === '天神') venueSet.add('天神校');
                            else if (c.location === '大橋') venueSet.add('大橋校');
                            else if (c.location === '照葉') venueSet.add('照葉校');
                        });
                        dayOfWeekVenues[dow] = venueSet;
                    }
                });

                let rows = '';
                for (let d = 1; d <= daysInMonth; d++) {
                    const dow = new Date(year, month - 1, d).getDay();
                    const isWeekend = dow === 0 || dow === 6;
                    const dayColor = isWeekend ? '#ff3b30' : dow === 3 ? '#34c759' : '#1d1d1f';
                    const bgColor = isWeekend ? '#fef2f2' : '#fff';

                    rows += `<tr style="background:${bgColor};">
                        <td style="padding:10px 16px;border-bottom:1px solid var(--border);text-align:center;font-weight:500;font-size:14px;">${d}</td>
                        <td style="padding:10px 16px;border-bottom:1px solid var(--border);text-align:center;color:${dayColor};font-weight:600;font-size:13px;">${dayNames[dow]}</td>
                        ${venues.map(v => {
                            const hasClass = dayOfWeekVenues[dow]?.has(v);
                            return `<td style="padding:10px 16px;border-bottom:1px solid var(--border);text-align:center;font-size:14px;">
                                ${isWeekend ? '<span style="color:var(--red);font-size:12px;font-weight:500;">休校</span>' : hasClass ? '<span style="color:var(--accent);font-weight:600;font-size:16px;">○</span>' : '<span style="color:var(--text-tertiary);">-</span>'}
                            </td>`;
                        }).join('')}
                    </tr>`;
                }

                return `
                    <div>
                        <div class="page-header">
                            <div>
                                <h2>月間スケジュール</h2>
                                <p class="subtitle">${year}年${month}月のスケジュール</p>
                            </div>
                            <div style="display:flex;gap:10px;align-items:center;">
                                <button id="prevMonth" class="btn btn-secondary btn-sm">◀ 前月</button>
                                <input type="month" id="monthSelectorOverview" value="${this.selectedMonth}" class="form-input" style="padding:8px 14px;font-size:14px;" />
                                <button id="nextMonth" class="btn btn-secondary btn-sm">次月 ▶</button>
                            </div>
                        </div>
                        <div class="content-card" style="overflow-x:auto;padding:0;">
                            <table style="width:100%;border-collapse:collapse;">
                                <thead>
                                    <tr>
                                        <th style="padding:14px 16px;width:60px;text-align:center;">日</th>
                                        <th style="padding:14px 16px;width:60px;text-align:center;">曜日</th>
                                        ${venues.map(v => `<th style="padding:14px 16px;text-align:center;">${v}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            renderInstructors() {
                return `
                    <div>
                        <div class="page-header">
                            <div>
                                <h2>講師プロフィール</h2>
                                <p class="subtitle">posse dance academy のインストラクター</p>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px;">
                            ${this.instructorData.map(inst => `
                                <div class="instructor-card">
                                    <div class="instructor-header">
                                        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                            <div>
                                                <div class="instructor-name">${inst.name}</div>
                                                <div class="instructor-stage">${inst.stageName}</div>
                                            </div>
                                            <span class="badge badge-blue">${inst.genre}</span>
                                        </div>
                                        <div style="margin-top:14px;font-size:12px;color:var(--text-secondary);display:flex;gap:20px;">
                                            <span>生年月日: ${inst.birthDate}</span>
                                            <span>キャリア: ${inst.careerStart}</span>
                                        </div>
                                    </div>
                                    <div class="instructor-body">
                                        ${inst.profile ? `
                                            <div class="instructor-section">
                                                <div class="instructor-section-title">プロフィール</div>
                                                <p style="font-size:13px;line-height:1.7;color:var(--text-primary);opacity:0.85;">${inst.profile}</p>
                                            </div>
                                        ` : ''}
                                        ${inst.message ? `
                                            <div class="instructor-section">
                                                <div class="instructor-section-title">メッセージ</div>
                                                <p style="font-size:13px;line-height:1.7;color:var(--text-primary);opacity:0.85;">${inst.message}</p>
                                            </div>
                                        ` : ''}
                                        <div class="instructor-section">
                                            <div class="instructor-section-title">受賞歴</div>
                                            <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                                ${inst.awards.map(a => `<span style="display:inline-block;font-size:11px;background:rgba(0,0,0,0.04);padding:5px 10px;border-radius:8px;color:var(--text-primary);font-weight:500;">${a}</span>`).join('')}
                                            </div>
                                        </div>
                                        ${inst.otherExperience.length > 0 ? `
                                            <div class="instructor-section">
                                                <div class="instructor-section-title">その他経歴</div>
                                                <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                                    ${inst.otherExperience.map(e => `<span style="display:inline-block;font-size:11px;background:rgba(0,113,227,0.06);padding:5px 10px;border-radius:8px;color:var(--accent);font-weight:500;">${e}</span>`).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        <div class="instructor-section">
                                            <div class="instructor-section-title">レッスン経歴</div>
                                            <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                                ${inst.lessons.map(l => `<span style="display:inline-block;font-size:11px;background:rgba(52,199,89,0.08);padding:5px 10px;border-radius:8px;color:var(--green);font-weight:500;">${l}</span>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            setupAttendanceEvents() {
                document.getElementById('attendanceOverviewTab')?.addEventListener('click', () => {
                    this.attendanceTab = 'overview';
                    this.render();
                });
                document.getElementById('attendanceRecordTab')?.addEventListener('click', () => {
                    this.attendanceTab = 'record';
                    this.render();
                });
                // 月選択inputのイベント（出席記録）
                const monthSelector = document.getElementById('monthSelector');
                if (monthSelector) {
                    monthSelector.addEventListener('change', (e) => {
                        this.selectMonth(e.target.value);
                    });
                }
                // 月選択inputのイベント（ダッシュボード）
                const monthSelectorOverview = document.getElementById('monthSelectorOverview');
                if (monthSelectorOverview) {
                    monthSelectorOverview.addEventListener('change', (e) => {
                        this.selectMonth(e.target.value);
                    });
                }
                const prevMonthBtn = document.getElementById('prevMonth');
                const nextMonthBtn = document.getElementById('nextMonth');
                const prevMonthRecordBtn = document.getElementById('prevMonthRecord');
                const nextMonthRecordBtn = document.getElementById('nextMonthRecord');
                if (prevMonthBtn) {
                    prevMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(-1);
                    });
                }
                if (nextMonthBtn) {
                    nextMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(1);
                    });
                }
                if (prevMonthRecordBtn) {
                    prevMonthRecordBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(-1);
                    });
                }
                if (nextMonthRecordBtn) {
                    nextMonthRecordBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.changeMonth(1);
                    });
                }
                ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日', 'イベント'].forEach(day => {
                    document.getElementById(`day-${day}`)?.addEventListener('click', () => {
                        this.selectedDay = day;
                        this.render();
                    });
                });
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const classId = btn.getAttribute('data-class');
                        const week = btn.getAttribute('data-week');
                        this.toggleAttendance(classId, week);
                    });
                });
                document.querySelectorAll('.add-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-add-day');
                        const location = btn.getAttribute('data-add-location');
                        const className = btn.getAttribute('data-add-class');
                        this.addStudentToClass(day, location, className);
                    });
                });
                // 生徒編集ボタン
                document.querySelectorAll('.edit-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-edit-student-day');
                        const location = btn.getAttribute('data-edit-student-location');
                        const className = btn.getAttribute('data-edit-student-class');
                        const lastName = btn.getAttribute('data-edit-student-lastname');
                        const firstName = btn.getAttribute('data-edit-student-firstname');
                        this.startEditStudent(day, location, className, lastName, firstName);
                    });
                });
                // 生徒削除ボタン
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const day = btn.getAttribute('data-delete-day');
                        const location = btn.getAttribute('data-delete-location');
                        const className = btn.getAttribute('data-delete-class');
                        const lastName = btn.getAttribute('data-delete-lastname');
                        const firstName = btn.getAttribute('data-delete-firstname');
                        this.deleteStudent(day, location, className, lastName, firstName);
                    });
                });
                // 生徒編集保存・キャンセル
                document.getElementById('saveEditStudentBtn')?.addEventListener('click', () => this.saveEditStudent());
                document.getElementById('cancelEditStudentBtn')?.addEventListener('click', () => {
                    this.editingStudent = null;
                    this.render();
                });
                // 生徒検索（リアルタイム）- フォーカス維持のため検索結果のみ更新
                const searchInput = document.getElementById('student_search_input');
                if (searchInput) {
                    // inputイベントで検索結果のみ更新（全体を再レンダリングしない）
                    searchInput.addEventListener('input', (e) => {
                        this.studentSearchTerm = e.target.value;
                        if (this.studentSearchTerm.trim()) {
                            this.studentSearchResults = this.searchCustomerByName(this.studentSearchTerm);
                        } else {
                            this.studentSearchResults = [];
                            this.selectedCustomerForStudent = null;
                        }
                        // 検索結果のみを更新（フォーカスを維持）
                        this.updateSearchResults();
                    });
                    
                    // フォーカス時にも検索結果を表示
                    searchInput.addEventListener('focus', (e) => {
                        if (this.studentSearchTerm.trim()) {
                            this.studentSearchResults = this.searchCustomerByName(this.studentSearchTerm);
                            this.updateSearchResults();
                        }
                    });
                }
                // 顧客選択（初期レンダリング時）
                document.querySelectorAll('.select-customer-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.getAttribute('data-select-customer-id');
                        const customer = this.customers.find(c => c.id === customerId);
                        if (customer) {
                            this.selectCustomerForStudent(customer);
                        }
                    });
                });
                // 顧客選択解除（初期レンダリング時）
                document.getElementById('clearSelectedCustomer')?.addEventListener('click', () => {
                    this.selectedCustomerForStudent = null;
                    this.studentSearchTerm = '';
                    this.studentSearchResults = [];
                    this.updateSelectedCustomerInfo();
                    // 検索入力欄をクリア
                    const searchInput = document.getElementById('student_search_input');
                    if (searchInput) searchInput.value = '';
                    // 検索結果をクリア
                    this.updateSearchResults();
                    // プランをリセット
                    const planSelect = document.getElementById('new_student_plan');
                    if (planSelect) planSelect.value = '';
                });
                // イベント専用のイベントリスナー
                document.getElementById('addEventParticipantBtn')?.addEventListener('click', () => {
                    this.addEventParticipant();
                });
                // イベント出席ボタン
                document.querySelectorAll('.event-attendance-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-event-index'));
                        const week = btn.getAttribute('data-event-week');
                        const current = this.eventAttendanceData[index][week] || '';
                        const next = current === '○' ? '×' : '○';
                        this.eventAttendanceData[index][week] = next;
                        this.saveEventAttendance();
                        this.render();
                    });
                });
                // イベントフィールド入力
                document.querySelectorAll('[data-event-field]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-event-index'));
                        const field = e.target.getAttribute('data-event-field');
                        let value = e.target.value;
                        
                        // 料金は数値に変換
                        if (field === 'fee') {
                            value = parseFloat(value) || 0;
                        }
                        
                        this.eventAttendanceData[index][field] = value;
                        this.saveEventAttendance();
                    });
                    // リアルタイム更新（料金のみ）
                    if (input.getAttribute('data-event-field') === 'fee') {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-event-index'));
                            const value = parseFloat(e.target.value) || 0;
                            this.eventAttendanceData[index].fee = value;
                            this.render();
                        });
                    }
                });
                // イベント参加者削除
                document.querySelectorAll('.delete-event-participant-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-delete-event-index'));
                        this.deleteEventParticipant(index);
                    });
                });
                document.getElementById('saveNewStudentBtn')?.addEventListener('click', () => this.saveNewStudent());
                document.getElementById('cancelAddStudentBtn')?.addEventListener('click', () => {
                    this.showAddStudentForm = false;
                    this.selectedClassForAdd = null;
                    this.selectedCustomerForStudent = null;
                    this.studentSearchTerm = '';
                    this.studentSearchResults = [];
                    this.render();
                });
                // 練習会の参加人数入力
                document.querySelectorAll('.practice-input').forEach(input => {
                    input.addEventListener('change', async (e) => {
                        const day = e.target.getAttribute('data-practice-day');
                        const week = e.target.getAttribute('data-practice-week');
                        const value = parseInt(e.target.value) || 0;
                        const practiceKey = `練習会_${day}`;
                        if (!this.attendanceData[practiceKey]) {
                            this.attendanceData[practiceKey] = {};
                        }
                        this.attendanceData[practiceKey][week] = value;
                        await this.saveAttendance(practiceKey, this.attendanceData[practiceKey]);
                        this.render();
                    });
                });
                // バックアップボタン
                document.getElementById('backupBtn')?.addEventListener('click', async () => {
                    await this.createBackup();
                });
            }
            // バックアップ機能
            async createBackup() {
                const statusEl = document.getElementById('backupStatus');
                if (statusEl) statusEl.textContent = 'バックアップ作成中...';
                try {
                    const backup = { timestamp: new Date().toISOString(), collections: {} };
                    // schedule
                    const scheduleSnap = await getDocs(collection(db, 'schedule'));
                    backup.collections.schedule = {};
                    scheduleSnap.docs.forEach(d => { backup.collections.schedule[d.id] = d.data(); });
                    // customers
                    const custSnap = await getDocs(collection(db, 'customers'));
                    backup.collections.customers = {};
                    custSnap.docs.forEach(d => { backup.collections.customers[d.id] = d.data(); });
                    // attendance months
                    const months = ['202509','202511','202512','202601','202602','202603'];
                    for (const m of months) {
                        try {
                            const snap = await getDocs(collection(db, `attendance_${m}`));
                            if (!snap.empty) {
                                backup.collections[`attendance_${m}`] = {};
                                snap.docs.forEach(d => { backup.collections[`attendance_${m}`][d.id] = d.data(); });
                            }
                        } catch(e) {}
                    }
                    // event_attendance months
                    for (const m of months) {
                        try {
                            const snap = await getDocs(collection(db, `event_attendance_${m}`));
                            if (!snap.empty) {
                                backup.collections[`event_attendance_${m}`] = {};
                                snap.docs.forEach(d => { backup.collections[`event_attendance_${m}`][d.id] = d.data(); });
                            }
                        } catch(e) {}
                    }
                    // ダウンロード
                    const json = JSON.stringify(backup, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    if (statusEl) statusEl.textContent = `✅ バックアップ完了 (${new Date().toLocaleString('ja-JP')})`;
                } catch (error) {
                    console.error('バックアップエラー:', error);
                    if (statusEl) statusEl.textContent = `❌ バックアップ失敗: ${error.message}`;
                }
            }
        }
        window.app = new DanceStudioApp();
        app.init();
    </script>
</body>
</html>
