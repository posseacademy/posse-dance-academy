<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ビジター履歴復元ツール</title>
</head>
<body>
    <h1>ビジター履歴復元ツール</h1>
    <p>attendanceDataからscheduleDataに存在しない生徒を抽出し、ビジター参加者として復元します。</p>
    <button onclick="restoreVisitorData()">復元を実行</button>
    <div id="result"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDy77p65fQrN7kBlHoQRc6nA7tKKFSYf7s",
            authDomain: "posse-dance-academy.firebaseapp.com",
            projectId: "posse-dance-academy",
            storageBucket: "posse-dance-academy.firebasestorage.app",
            messagingSenderId: "350833826506",
            appId: "1:350833826506:web:28889e7bfe6b7821bdf4e6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.restoreVisitorData = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>処理中...</p>';

            try {
                // 1. scheduleDataを読み込み
                const scheduleSnapshot = await getDocs(collection(db, 'schedule'));
                const scheduleData = {};
                scheduleSnapshot.docs.forEach(doc => {
                    scheduleData[doc.id] = doc.data().classes || [];
                });

                console.log('Schedule Data:', scheduleData);

                // 2. attendance_202601を読み込み
                const attendanceSnapshot = await getDocs(collection(db, 'attendance_202601'));
                const attendanceData = {};
                attendanceSnapshot.docs.forEach(doc => {
                    attendanceData[doc.id] = doc.data();
                });

                console.log('Attendance Data:', attendanceData);

                // 3. attendanceDataのキーを解析して、scheduleDataに存在しない生徒を抽出
                const missingStudents = [];
                Object.keys(attendanceData).forEach(key => {
                    const parts = key.split('_');
                    if (parts.length >= 4) {
                        const day = parts[0];
                        const location = parts[1];
                        const className = parts[2];
                        const studentName = parts.slice(3).join('_');

                        // scheduleDataに該当するクラスを検索
                        const classData = scheduleData[day]?.find(c => c.location === location && c.name === className);

                        if (classData) {
                            // 生徒が存在するか確認
                            const student = classData.students?.find(s => `${s.lastName}${s.firstName}` === studentName);

                            if (!student) {
                                // 生徒が見つからない場合、ビジター参加者として記録
                                missingStudents.push({
                                    key: key,
                                    day: day,
                                    location: location,
                                    className: className,
                                    studentName: studentName,
                                    attendance: attendanceData[key]
                                });
                            }
                        }
                    }
                });

                console.log('Missing Students:', missingStudents);

                // 4. 見つからない生徒をscheduleDataに追加
                let restoredCount = 0;
                const updates = {};

                missingStudents.forEach(student => {
                    // 名前を姓と名に分割（仮）
                    const lastName = student.studentName.slice(0, -2) || student.studentName;
                    const firstName = student.studentName.slice(-2) || '';

                    // scheduleDataに追加
                    if (!updates[student.day]) {
                        updates[student.day] = JSON.parse(JSON.stringify(scheduleData[student.day] || []));
                    }

                    const classIndex = updates[student.day].findIndex(c => c.location === student.location && c.name === student.className);
                    if (classIndex !== -1) {
                        if (!updates[student.day][classIndex].students) {
                            updates[student.day][classIndex].students = [];
                        }

                        // デフォルトのビジタープランを設定
                        updates[student.day][classIndex].students.push({
                            lastName: lastName,
                            firstName: firstName,
                            plan: 'ビジター（会員）'  // デフォルト値
                        });

                        restoredCount++;
                    }
                });

                console.log('Updates:', updates);

                // 5. Firestoreに保存
                for (const day of Object.keys(updates)) {
                    const docRef = doc(db, 'schedule', day);
                    await setDoc(docRef, {
                        classes: updates[day]
                    });
                }

                resultDiv.innerHTML = `
                    <h2>復元完了</h2>
                    <p>復元された生徒数: ${restoredCount}名</p>
                    <h3>復元された生徒一覧:</h3>
                    <ul>
                        ${missingStudents.map(s => `
                            <li>${s.day} - ${s.location} - ${s.className}: ${s.studentName} (デフォルトプラン: ビジター（会員）)</li>
                        `).join('')}
                    </ul>
                    <p style="color: green;">✅ Firebaseに保存しました。ページを再読み込みしてビジター売上を確認してください。</p>
                    <p style="color: orange;">⚠️ 注意: すべてのビジター参加者のプランは「ビジター（会員）」に設定されています。必要に応じて、出席記録画面で個別に編集してください。</p>
                `;

            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `<p style="color: red;">エラーが発生しました: ${error.message}</p>`;
            }
        };
    </script>
</body>
</html>
